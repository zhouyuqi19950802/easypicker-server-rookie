{"version":3,"sources":["../src/constants/index.ts","../src/utils/localFileUtil.ts","../src/index.ts","../src/config/index.ts","../src/routes/modules/people.ts","../src/service/qiniuService.ts","../src/service/behaviorService.ts","../src/db/logDb.ts","../src/lib/dbConnect/mongodb.ts","../src/utils/user-local-db.ts","../src/utils/stringUtil.ts","../src/lib/dbConnect/redis.ts","../src/utils/storageUtil.ts","../src/db/redisDb.ts","../src/utils/qiniuUtil.ts","../src/service/super.ts","../src/service/localFileService.ts","../src/service/taskInfoService.ts","../src/db/taskInfoDb.ts","../src/lib/dbConnect/mysql.ts","../src/utils/sqlUtil.ts","../src/db/model/public.ts","../src/db/entity/User.ts","../src/db/entity/Category.ts","../src/db/entity/Files.ts","../src/db/entity/People.ts","../src/db/entity/Task.ts","../src/db/entity/TaskInfo.ts","../src/db/entity/index.ts","../src/db/index.ts","../src/db/taskDb.ts","../src/constants/errorMsg.ts","../src/service/tokenService.ts","../src/db/model/user.ts","../src/utils/index.ts","../src/service/userService.ts","../src/db/userDb.ts","../src/utils/regExp.ts","../src/service/taskService.ts","../src/service/fileService.ts","../src/db/fileDb.ts","../src/db/actionDb.ts","../src/db/model/action.ts","../src/utils/time-utils.ts","../src/db/peopleDb.ts","../src/service/publicService.ts","../src/utils/randUtil.ts","../src/utils/mailUtil.ts","../src/service/categoryService.ts","../src/db/categoryDb.ts","../src/service/superUserService.ts","../src/service/peopleService.ts","../src/utils/tokenUtil.ts","../src/utils/userUtil.ts","../src/routes/index.ts","../src/controllers/wish.ts","../src/db/model/wish.ts","../src/db/wishDb.ts","../src/decorator/index.ts","../src/controllers/super/overview.ts","../src/controllers/people.ts","../src/utils/context.ts","../src/controllers/file.ts","../src/controllers/taskInfo.ts","../src/controllers/public.ts","../src/controllers/super/user.ts","../src/service/file.ts","../src/db/model/message.ts","../src/service/message.ts","../src/controllers/user.ts","../src/controllers/config.ts","../src/utils/patch.ts","../src/controllers/action.ts","../src/controllers/task.ts","../src/controllers/category.ts","../src/controllers/index.ts","../src/middleware/routeInterceptor.ts","../src/middleware/serverInterceptor.ts","../src/middleware/beforeRouterInterceptor.ts","../src/middleware/beforeRuntimeErrorInterceptor.ts"],"names":["codeMsg","code","msg","uploadFileDir","filesManageDir","filesUploadDir","filesThumbnailsDir","filesCompressedDir","filesTempDir","UserConfigLabels","LocalEnvMap","process","cwd","mysql","host","port","database","user","password","qiniu","accessKey","secretKey","bucketName","bucketDomain","imageCoverStyle","imagePreviewStyle","bucketZone","mongo","auth","uri","redis","mail","smtpHost","smtpPort","useSSL","account","from","senderName","subject","template","keyToLocalPath","key","path","join","localPathToKey","localPath","relativePath","relative","replace","ensureDir","dirPath","fs","existsSync","mkdirSync","recursive","initDirectories","getFileInfo","filePath","stats","statSync","ext","extname","toLowerCase","mimeType","getMimeType","hash","fsize","size","putTime","Math","floor","mtimeMs","type","isDirectory","status","md5","error","console","mimeTypes","generateDownloadToken","expiredTime","token","crypto","randomBytes","toString","downloadTokens","set","verifyDownloadToken","tokenInfo","get","now","Date","delete","cleanExpiredTokens","info","entries","createDownloadUrl","req","log","origin","headers","referer","baseUrl","URL","url","getThumbnailPath","createHash","update","digest","getPreviewPath","getThumbnailKey","getPreviewKey","getCompressedPath","zipName","checkLocalCompressStatus","archiveKey","fileName","getCompressedFileInfo","getTempPath","filename","import_node_path","import_node_fs","import_node_crypto","Map","setInterval","import_flash_wolves","serverConfig","env","SERVER_PORT","hostname","SERVER_HOST","mysqlConfig","MYSQL_DB_HOST","MYSQL_DB_PORT","MYSQL_DB_NAME","MYSQL_DB_USER","MYSQL_DB_PWD","mongodbConfig","MONGO_DB_HOST","MONGO_DB_PORT","MONGO_DB_NAME","MONGO_DB_USER","MONGO_DB_PWD","String","MONGO_DB_NEED_AUTH","redisConfig","REDIS_DB_HOST","REDIS_DB_PORT","REDIS_DB_PASSWORD","REDIS_DB_NEED_AUTH","qiniuConfig","QINIU_ACCESS_KEY","QINIU_SECRET_KEY","QINIU_BUCKET_NAME","QINIU_BUCKET_DOMAIN","QINIU_BUCKET_IMAGE_COVER_STYLE","QINIU_BUCKET_IMAGE_PREVIEW_STYLE","QINIU_BUCKET_ZONE","import_node_process","import_qiniu","import_mongodb","JSONDbFile","LocalUserDB","initUserConfig","promises","writeFile","data","JSON","parse","readFile","updateLocalEnv","localEnvFile","isExist","content","forEach","item","value","originEnvKey","RegExp","split","filter","Boolean","updateCfg","stringify","addUserConfigData","push","setUserConfig","index","findIndex","next","lastUpdate","findUserConfig","query","Object","keys","every","updateUserConfig","getUserConfigByType","reduce","prev","curr","getSiteConfig","config","needBindEmail","undefined","needBindPhone","refreshMongoDb","cfg","getDBConnection","Promise","res","rej","MongoClient","connect","useUnifiedTopology","useNewUrlParser","then","db","Db","catch","err","getMongoDBStatus","r","close","errMsg","message","callback","p","resolve","e","finally","mongoDbQuery","updateCollection","collection","many","updateMany","updateOne","insertCollection","Array","isArray","insertMany","insertOne","findCollection","find","toArray","findCollectionCount","countDocuments","encryption","str","lowCamel2Underscore","word","letters","pre","letter","test","getUniqueKey","ObjectId","toHexString","formatDate","d","fmt","o","getMonth","getDate","getHours","getMinutes","getSeconds","getMilliseconds","$1","getFullYear","substr","length","k","formatSize","pointLength","units","unit","shift","toFixed","B2GB","formatPrice","prices","cur","isSameInfo","userInfo","dbInfo","userItems","dbItems","userItem","text","normalizeFileName","name","getObjectIdDate","id","getTimestamp","getTipImageKey","uid","shortLink","percentageValue","A","B","getLogData","addRequestLog","params","method","body","Buffer","userAgent","refer","ip","getClientIp","getUserInfo","userId","startTime","endTime","duration","on","addBehavior","addErrorLog","stack","addPvLog","connection","remoteAddress","socket","timeToObjId","s","getTime","findLogCount","q","findLogWithTimeRange","start","end","_id","$gt","$lt","findLogWithPageOffset","startIdx","pageSize","sort","skip","limit","findLog","findLogReserve","$natural","findPvLogWithRange","BehaviorService","Ctx","add","module","addPV","InjectCtx","Provide","getClient","client","createClient","quit","getRedisStatus","c","_a","LocalStorage","constructor","map","loop","setTimeout","expiredCheck","setItem","removeItem","expireItem","getItem","clearItem","clear","getInstance","instance","setRedisValue","v","storage","expire","warn","getRedisVal","originCallback","reply","localValue","getRedisValueJSON","defaultValue","expiredRedisKey","privateBucketDomain","bucketZoneMap","huadong","zone","Zone_z0","huabei","Zone_z1","huanan","Zone_z2","beimei","Zone_na0","SoutheastAsia","Zone_as0","bucket","mac","Mac","urlsafeBase64Encode","util","refreshQinNiuConfig","assign","getUploadToken","putPolicy","rs","PutPolicy","scope","returnBody","uploadToken","batchDeleteFiles","conf","Config","delOptions","deleteOp","bucketManager","BucketManager","batch","respBody","respInfo","Number","parseInt","statusCode","deleteusCode","deleteObjByKey","mergeRequest","delay","pMap","cb","args","getOSSFiles","prefix","marker","ops","analyze","listPrefix","concat","items","getFileKeys","batchFileStatus","reject","statOperations","statOp","getQiniuStatus","startsWith","checkRegion","formUploader","form_up","FormUploader","putExtra","PutExtra","random","put","respErr","SuperService","getOssFiles","systemUser","USER","cacheKey","ossFiles","getOssFilesByPrefix","_ts_decorate","QiniuService","ctx","behaviorService","deleteFiles","files","f","getFilesMap","filesMap","oldPrefixList","Set","category_key","includes","ossSources","expireTime","time","Inject","LocalFileService","getOssKey","file","task_key","taskKey","saveFile","dirname","copyFileSync","unlinkSync","thumbnailPath","previewPath","count","prefixPath","listFilesByPrefix","judgeFileIsExist","results","all","listFiles","dir","baseKey","readdirSync","itemPath","allFiles","oldFiles","generateThumbnail","width","height","sharp","resize","fit","position","jpeg","quality","toFile","generatePreview","maxWidth","maxHeight","withoutEnlargement","getImagePreviewUrl","thumbnailKey","previewKey","makeZipWithKeys","zipPath","output","createWriteStream","archive","archiver","zlib","level","zipKey","pipe","basename","finalize","getFileStream","createReadStream","getDownloadUrl","import_typeorm","pool","refreshPool","createPool","getConnection","coon","sql","result","release","getMysqlStatus","removeUndefKey","obj","isObject","isOkModel","model","selectTableByModel","table","options","columns","order","column","where","createWhereSql","values","flat","limitStr","ceil","trim","deleteTableByModel","insertTableByModel","fill","insertTableByModelMany","sqlValues","updateTableByModel","updateModelKeys","queryModelKeys","Error","BOOLEAN","FALSE","TRUE","User","email","power","joinTime","loginTime","loginCount","openTime","wallet","PrimaryGeneratedColumn","comment","Column","nullable","default","precision","scale","Entity","Category","unsigned","Files","taskName","categoryKey","date","people","originName","del","ossDelTime","delTime","lastUpdateTime","UpdateDateColumn","People","submitDate","submitCount","Task","TaskInfo","rewrite","format","ddl","shareKey","limitPeople","bindField","tip","entities","AppDataSource","initTypeORM","DataSource","username","synchronize","logging","NODE_ENV","initialize","BaseRepository","repository","entityName","findOne","findMany","findWithSpecifyColumn","createQueryBuilder","select","getMany","findWithLimitCount","take","insert","save","updateSpecifyFields","execute","TaskInfoRepository","getRepository","TaskInfoEntity","selectTasks","TaskRepository","TaskEntity","UserError","fault","exist","noExist","notExist","freeze","ban","bindEmail","pwd","system","CategoryError","publicError","notSupport","request","errorParams","notLogin","taskError","fileError","noPower","noOssFile","ossFileRepeat","peopleError","TaskInfoService","taskInfoRepository","taskRepository","localFileService","getUseFullTemplate","infoList","taskInfo","In","v2","delTipImage","payload","task","tipImageKey","getTaskInfo","share","updateTaskInfo","logAccount","ks","bType","createTaskInfo","USER_POWER","NORMAL","SUPER","SYSTEM","USER_STATUS","FREEZE","BAN","throttle","func","timers","flag","apply","TokenService","checkOnlineUser","cacheUser","manager","expiredToken","onlineTokens","getAllTokens","newTokenList","_","idx","onlineTokenKey","realToken","TOKEN_PREFIX","createTokenByUser","timeout","refreshToken","setVerifyCode","identifier","getVerifyCode","expiredVerifyCode","createToken","checkAllToken","selectUserByAccount","selectUserByEmail","selectUserById","mapUserToDbPayload","phone","insertUser","updateUser","selectAllUser","UserRepository","UserEntity","rEmail","rAccount","rPassword","rVerCode","UserService","userRepository","tokenService","register","rightCode","u","login","isEmail","checkUserStatus","loginByCode","maskedEmail","suffix","updatePassword","openDate","import_dayjs","selectFilesNew","selectFiles","updateFileInfo","_query","FileRepository","addAction","action","addDownloadAction","findActionCount","findActionWithPageOffset","findAction","updateAction","ActionType","PRAISE","Download","Compress","DisabledRoute","TemplateDownload","DownloadStatus","ARCHIVE","EXPIRED","SUCCESS","FAIL","diffMonth","dayjs","diff","selectPeople","insertPeople","defaultData","deletePeople","updatePeople","PeopleRepository","PeopleEntity","FileService","fileRepository","taskInfoService","peopleRepository","selectFilesLimitCount","getFileUsage","ossFilesMap","ossKey","downloadOne","fileId","getQiniuFileUrlExpiredTime","downloadOneExpired","originUrl","thingId","link","insertedId","ids","ObjectID","$set","batchDownload","isOldExist","filesStatus","downloadTemplate","fileInfo","downloadCount","idList","actions","$in","actionsIds","logs","baseCount","logCount","downloadActionId","downloadLog","$gte","$lte","$regex","getOSSFileSizeUntilNow","fileList","sum","fileSize","ossSize","max","round","analyzeDownloadLog","oneFile","compressFile","templateFile","limitUploadBySpace","limitSize","limitSpace","limitUploadByWallet","balance","limitWallet","calculateQiniuPrice","download","qiniuBackhaulTrafficPercentage","qiniuCompressPrice","qiniuBackhaulTrafficPrice","qiniuOSSPrice","qiniuCDNPrice","OSSPrice","compressPrice","compress","downloadSize","one","backhaulTrafficPrice","cdnPrice","ossPrice","total","addFile","getUserFiles","findOneFile","deleteOneFile","sameRecord","isRepeat","getUserOverview","moneyStartDay","ossCount","originFileSize","AMonthAgoSize","AQuarterAgoSize","AHalfYearAgoSize","isBefore","subtract","userTokens","calculateSize","limitUpload","percentage","price","isAdmin","fileCount","maxSize","resources","monthAgoSize","quarterAgoSize","halfYearSize","onlineCount","usage","lastLoginTime","cost","withdrawFile","peopleName","passFiles","isDelOss","filesCount","passFilesCount","batchDelete","dbCount","delCount","checkSubmitInfo","isSubmit","txt","TaskService","fileService","createTask","getTasks","tasks","t","category","recentLog","recentSubmitLogCount","getTaskByKey","delTask","logTaskName","updateTask","oldName","newName","randomNumStr","i","transporter","transporterKey","getConfig","buildTransporterKey","createTransporter","nodemailer","createTransport","secure","pass","ensureTransporter","sendMail","overrideConfig","tp","html","fromAddress","sender","to","getMailConfig","resetMailTransporter","PublicService","scene","htmlTemplate","reportPV","handler","Response","plain","checkEmailIsExist","failWithError","getTipImage","tipKey","cover","preview","CategoryRepository","CategoryEntity","CategoryService","categoryRepository","createCategory","categories","getList","deleteCategory","SuperUserService","logout","tokens","PeopleService","addPeople","checkPeopleIsExist","getUsefulTemplate","taskKeyList","importPeopleFromTpl","tplKey","fail","success","nowPeople","TokenUtil","tokenUtil","router","Router","fileDir","supportType","post","filepath","fileContent","readFileSync","encoding","unlink","peopleData","alreadyPeople","needLogin","detail","showDetail","lastDate","submit_date","submit_count","existPeopleSubmitFiles","ossStatus","alreadyCount","routers","getRoutes","WishStatus","REVIEW","WAIT","START","END","CLOSE","addWishData","wish","findWish","updateWish","ReqIp","RequestValue","ReqUserInfo","adminPower","userPower","WishController","addWish","getAllWish","wishes","a","b","aDate","bDate","title","des","contact","createDate","updateWishStatus","startDate","endDate","updateWishData","getDocsWish","$or","alreadyPraise","praiseWis","praiseData","Post","CORS","ReqBody","Get","Put","ReqParams","RouterController","tempTxtFileReg","OverviewController","cacheLogs","filterLog","isExpiredCompressSource","downloadCompressExpired","getLogDetail","getDataOverview","nowDate","users","userRecent","join_time","fileRecent","logRecent","pvList","uv","pv","todayPv","todayUv","compressData","tempTxtFilesData","recent","server","oss","today","expired","clearExpiredCompress","txtFiles","expiredTxt","getAllLog","getPartLog","search","changeDisabledRoute","route","checkDisabledRoute","actionStatus","Delete","ReqQuery","wrapperCatchError","PeopleController","peopleService","noLogin","FileController","taskService","getPreviewURL","rewriteFilename","newOssKey","isNewExist","oldPath","newPath","renameSync","listWithUrl","downloadFile","fileKey","downloadRecord","writeHead","Location","tipName","logMap","downloadType","encodeURIComponent","fileStream","chunk","headersSent","destroy","destroyed","downloadUrl","downloadCompressFile","decodedKey","decodeURIComponent","uploadUrl","uploadFile","form","formidable","multiples","keepExtensions","maxFileSize","uploadDir","fields","saved","mimetype","submitInfo","getAllUserFiles","origin_name","task_name","compressStatus","desc","TaskInfoController","PublicController","publicService","getVerCode","targetEmail","sceneKey","reportPv","MessageType","GLOBAL_PUSH","USER_PUSH","MessageStyle","Dialog","Notification","MESSAGE","Link","MessageService","sendMessage","source","target","style","read","sendGlobalMessage","getMessageList","readMessage","msgId","clearMessageFormat","lines","callMe","SuperUserController","superUserService","qiniuService","messageList","getUserList","overviewData","sumCost","acc","list","clearOssFiles","months","month","quarter","half","beforeDate","oss_del_time","delKeys","changeStatus","resetPassword","resetEmail","operator","realCode","otherUser","changeSize","oldSize","newSize","updateWalletValue","oldValue","newValue","newFileService","UserController","userService","systemUserConfigs","isSystemAccount","some","systemUsers","configCount","systemPwdConfigs","isRightPwd","pwdLength","pwdConfigCount","tokenError","isSuperPower","isLogin","getUsage","userOverview","space","import_promises","import_mysql","import_redis","addTableField","tableName","field","dbName","fieldName","fieldType","checkFieldCountSql","modifyTableField","getColumnTypeSql","COLUMN_TYPE","originType","patchTable","TenK","getRandomUser","slice","getRandomPassword","userAccount","userPWD","isSecret","storeDbInfo","configList","oldConfig","site","maxInputLength","openPraise","formLength","compressSizeLimit","appName","readyServerDepService","initTokenUtil","appendFile","AUTO_SQL_PATH","cachedAutoCreateSql","loadAutoCreateSql","normalizeMysqlPayload","normalizeRedisPayload","parseMongoUri","parsed","pathname","createMysqlConnection","useDb","connectionConfig","charset","multipleStatements","createConnection","exec","ensureMysqlSchema","dbPayload","dbConnection","saveConfigEntries","entry","persistMysqlConfig","testMysqlConnection","createRedisClient","testRedisConnection","persistRedisConfig","testMongoConnection","command","ping","persistMongoConfig","getServiceStatus","rest","testMysql","initializeMysql","testRedis","initializeRedis","testMongo","initializeMongo","cleanUserConfig","label","getUserConfig","configureAdmin","admin","passwordHash","sendAdminVerification","finishInitialization","configureMail","sendMailTest","sendMailLiveTest","mailConfig","wrapperValue","num","bool","boolString","getGlobalConfig","globalConfig","siteConfig","filterKey","getAllGlobalConfig","updateGlobalConfig","ActionController","getDownloadActionList","pageIndex","extraIds","expiredHours","oneHour","needUpdate","encodedKey","TaskController","CategoryController","categoryService","Wish","Overview","Public","SuperUser","ConfigService","Action","systemWhiteList","interceptor","_handled","meta","setHeader","loginUserInfo","import_formidable","allowOrigins","newFilename","defineProperty","app","App","serverInterceptor","beforeMathRoute","beforeRouteMatchInterceptor","beforeRunRoute","routeInterceptor","beforeReturnRuntimeError","beforeRuntimeErrorInterceptor","addRoutes","routes","addController","controllers","listen","toLocaleString","timeEnd"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;AAIA;;;;;;;;;;;;AAAO,SAASA,QAAQC,MAAcC,KAAW;AAC/C,SAAO;IACLD;IACAC;EACF;AACF;AALA,IAOaC,eAGAC,gBACAC,gBACAC,oBACAC,oBACAC,cAEAC,kBA6CAC;AA7Db;;AAAgBV;AAOT,IAAMG,gBAAgB,GAAGQ,QAAQC,IAAG,CAAA;AAGpC,IAAMR,iBAAiB,GAAGO,QAAQC,IAAG,CAAA;AACrC,IAAMP,iBAAiB,GAAGD,cAAAA;AAC1B,IAAME,qBAAqB,GAAGF,cAAAA;AAC9B,IAAMG,qBAAqB,GAAGH,cAAAA;AAC9B,IAAMI,eAAe,GAAGJ,cAAAA;AAExB,IAAMK,mBAAmB;MAC9BI,OAAO;QACLC,MAAM;QACNC,MAAM;QACNC,UAAU;QACVC,MAAM;QACNC,UAAU;MACZ;MACAC,OAAO;QACLC,WAAW;QACXC,WAAW;QACXC,YAAY;QACZC,cAAc;QACdC,iBAAiB;QACjBC,mBAAmB;QACnBC,YAAY;MACd;MACAC,OAAO;QACLb,MAAM;QACNC,MAAM;QACNC,UAAU;QACVC,MAAM;QACNC,UAAU;QACVU,MAAM;QACNC,KAAK;MACP;MACAC,OAAO;QACLhB,MAAM;QACNC,MAAM;QACNG,UAAU;QACVU,MAAM;MACR;MACAG,MAAM;QACJC,UAAU;QACVC,UAAU;QACVC,QAAQ;QACRC,SAAS;QACTjB,UAAU;QACVkB,MAAM;QACLC,YAAY;QACbC,SAAS;QACTC,UAAU;MACZ;IACF;AAEO,IAAM7B,cAAc;MACzBG,OAAO;QACLC,MAAM;QACNC,MAAM;QACNC,UAAU;QACVC,MAAM;QACNC,UAAU;MACZ;MACAS,OAAO;QACLb,MAAM;QACNC,MAAM;QACNC,UAAU;QACVC,MAAM;QACNC,UAAU;QACVU,MAAM;MACR;MACAE,OAAO;QACLhB,MAAM;QACNC,MAAM;QACNG,UAAU;QACVU,MAAM;MACR;MACAT,OAAO;QACLC,WAAW;QACXC,WAAW;QACXC,YAAY;QACZC,cAAc;QACdC,iBAAiB;QACjBC,mBAAmB;QACnBC,YAAY;MACd;IACF;;;;;AChGA;;;;;;;;;;;;;;;;;;;;AAkCO,SAASc,eAAeC,KAAW;AACxC,SAAOC,kBAAAA,QAAKC,KAAKtC,gBAAgBoC,GAAAA;AACnC;AAOO,SAASG,eAAeC,WAAiB;AAC9C,QAAMC,eAAeJ,kBAAAA,QAAKK,SAAS1C,gBAAgBwC,SAAAA;AACnD,SAAOC,aAAaE,QAAQ,OAAO,GAAA;AACrC;AAKO,SAASC,UAAUC,SAAe;AACvC,MAAI,CAACC,gBAAAA,QAAGC,WAAWF,OAAAA,GAAU;AAC3BC,oBAAAA,QAAGE,UAAUH,SAAS;MAAEI,WAAW;IAAK,CAAA;EAC1C;AACF;AAKO,SAASC,kBAAAA;AACdN,YAAU5C,cAAAA;AACV4C,YAAU3C,kBAAAA;AACV2C,YAAU1C,kBAAAA;AACV0C,YAAUzC,YAAAA;AACZ;AAOO,SAASgD,YAAYC,UAAgB;AAC1C,MAAI;AACF,QAAI,CAACN,gBAAAA,QAAGC,WAAWK,QAAAA,GAAW;AAC5B,aAAO;IACT;AAEA,UAAMC,QAAQP,gBAAAA,QAAGQ,SAASF,QAAAA;AAC1B,UAAMhB,MAAMG,eAAea,QAAAA;AAC3B,UAAMG,MAAMlB,kBAAAA,QAAKmB,QAAQJ,QAAAA,EAAUK,YAAW;AAC9C,UAAMC,WAAWC,YAAYJ,GAAAA;AAE7B,WAAO;MACLnB;MACAwB,MAAM;MACNC,OAAOR,MAAMS;MACbJ;MACAK,SAASC,KAAKC,MAAMZ,MAAMa,UAAU,GAAA;MACpCC,MAAMd,MAAMe,YAAW,IAAK,IAAI;MAChCC,QAAQ;MACRC,KAAK;IACP;EACF,SACOC,OAAO;AACZC,YAAQD,MAAM,qDAAaA,KAAAA;AAC3B,WAAO;EACT;AACF;AAKA,SAASZ,YAAYJ,KAAW;AAC9B,QAAMkB,YAAoC;IACxC,QAAQ;IACR,SAAS;IACT,QAAQ;IACR,QAAQ;IACR,SAAS;IACT,QAAQ;IACR,QAAQ;IACR,SAAS;IACT,QAAQ;IACR,SAAS;IACT,QAAQ;IACR,QAAQ;IACR,QAAQ;IACR,QAAQ;EACV;AACA,SAAOA,UAAUlB,GAAAA,KAAQ;AAC3B;AAQO,SAASmB,sBAAsBtC,KAAauC,aAAmB;AACpE,QAAMC,QAAQC,oBAAAA,QAAOC,YAAY,EAAA,EAAIC,SAAS,KAAA;AAC9CC,iBAAeC,IAAIL,OAAO;IACxBxC;IACAuC;EACF,CAAA;AACA,SAAOC;AACT;AAOO,SAASM,oBAAoBN,OAAa;AAC/C,QAAMO,YAAYH,eAAeI,IAAIR,KAAAA;AACrC,MAAI,CAACO,WAAW;AACd,WAAO;EACT;AAEA,QAAME,MAAMrB,KAAKC,MAAMqB,KAAKD,IAAG,IAAK,GAAA;AACpC,MAAIA,MAAMF,UAAUR,aAAa;AAC/BK,mBAAeO,OAAOX,KAAAA;AACtB,WAAO;EACT;AAEA,SAAOO,UAAU/C;AACnB;AAKO,SAASoD,qBAAAA;AACd,QAAMH,MAAMrB,KAAKC,MAAMqB,KAAKD,IAAG,IAAK,GAAA;AACpC,aAAW,CAACT,OAAOa,IAAAA,KAAST,eAAeU,QAAO,GAAI;AACpD,QAAIL,MAAMI,KAAKd,aAAa;AAC1BK,qBAAeO,OAAOX,KAAAA;IACxB;EACF;AACF;AASO,SAASe,kBAAkBvD,KAAauC,aAAqBiB,KAAe;AACjF,QAAMhB,QAAQF,sBAAsBtC,KAAKuC,WAAAA;AACzCH,UAAQqB,IAAI,wCAAoBzD,KAAK,UAAUwC,OAAO,gBAAgBD,WAAAA;AACtE,MAAIiB,KAAK;AACP,UAAME,SAASF,IAAIG,QAAQD,UAAUF,IAAIG,QAAQC,WAAW;AAC5D,UAAMC,UAAU,IAAIC,IAAIJ,MAAAA,EAAQA;AAChC,UAAMK,OAAM,GAAGF,OAAAA,sBAA6BrB,KAAAA;AAC5CJ,YAAQqB,IAAI,uCAAcM,IAAAA;AAC1B,WAAOA;EACT;AACA,QAAMA,OAAM,sBAAsBvB,KAAAA;AAClCJ,UAAQqB,IAAI,oDAAsBM,IAAAA;AAClC,SAAOA;AACT;AAOO,SAASC,iBAAiBhE,KAAW;AAC1C,QAAMwB,OAAOiB,oBAAAA,QAAOwB,WAAW,KAAA,EAAOC,OAAOlE,GAAAA,EAAKmE,OAAO,KAAA;AACzD,SAAOlE,kBAAAA,QAAKC,KAAKrC,oBAAoB,GAAG2D,IAAAA,MAAU;AACpD;AAOO,SAAS4C,eAAepE,KAAW;AACxC,QAAMwB,OAAOiB,oBAAAA,QAAOwB,WAAW,KAAA,EAAOC,OAAOlE,GAAAA,EAAKmE,OAAO,KAAA;AACzD,SAAOlE,kBAAAA,QAAKC,KAAKrC,oBAAoB,GAAG2D,IAAAA,cAAkB;AAC5D;AAOO,SAAS6C,gBAAgBrE,KAAW;AACzC,QAAMwB,OAAOiB,oBAAAA,QAAOwB,WAAW,KAAA,EAAOC,OAAOlE,GAAAA,EAAKmE,OAAO,KAAA;AACzD,SAAO,cAAc3C,IAAAA;AACvB;AAOO,SAAS8C,cAActE,KAAW;AACvC,QAAMwB,OAAOiB,oBAAAA,QAAOwB,WAAW,KAAA,EAAOC,OAAOlE,GAAAA,EAAKmE,OAAO,KAAA;AACzD,SAAO,cAAc3C,IAAAA;AACvB;AAOO,SAAS+C,kBAAkBC,SAAe;AAC/C,SAAOvE,kBAAAA,QAAKC,KAAKpC,oBAAoB0G,OAAAA;AACvC;AAOO,SAASC,yBAAyBC,YAAkB;AACzD,MAAI;AACFtC,YAAQqB,IAAI,iEAAyBiB,UAAAA;AAGrC,UAAMC,WAAWD,WAAWnE,QAAQ,eAAe,EAAA;AACnD,UAAMH,YAAYH,kBAAAA,QAAKC,KAAKpC,oBAAoB6G,QAAAA;AAChDvC,YAAQqB,IAAI,qDAAarD,SAAAA;AACzBgC,YAAQqB,IAAI,yCAAW/C,gBAAAA,QAAGC,WAAWP,SAAAA,CAAAA;AAErC,QAAIM,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC5B,YAAMa,QAAQP,gBAAAA,QAAGQ,SAASd,SAAAA;AAC1BgC,cAAQqB,IAAI,yCAAWxC,MAAMS,IAAI;AACjC,aAAO;QACLlE,MAAM;QACNwC,KAAK0E;MACP;IACF,OACK;AACHtC,cAAQD,MAAM,+CAAY/B,SAAAA;AAC1B,aAAO;QACL5C,MAAM;QACN2E,OAAO;MACT;IACF;EACF,SACOA,OAAO;AACZC,YAAQD,MAAM,iEAAeA,KAAAA;AAC7B,WAAO;MACL3E,MAAM;MACN2E,OAAO,iEAAeA,KAAAA;IACxB;EACF;AACF;AAOO,SAASyC,sBAAsBF,YAAkB;AACtD,MAAI;AACF,UAAMC,WAAWD,WAAWnE,QAAQ,eAAe,EAAA;AACnD,UAAMH,YAAYH,kBAAAA,QAAKC,KAAKpC,oBAAoB6G,QAAAA;AAEhD,QAAI,CAACjE,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC7B,aAAO;IACT;AAEA,UAAMa,QAAQP,gBAAAA,QAAGQ,SAASd,SAAAA;AAC1B,UAAMe,MAAMlB,kBAAAA,QAAKmB,QAAQhB,SAAAA,EAAWiB,YAAW;AAC/C,UAAMC,WAAWC,YAAYJ,GAAAA;AAE7B,WAAO;MACLnB,KAAK0E;MACLlD,MAAM;MACNC,OAAOR,MAAMS;MACbJ;MACAK,SAASC,KAAKC,MAAMZ,MAAMa,UAAU,GAAA;MACpCC,MAAM;MACNE,QAAQ;MACRC,KAAK;IACP;EACF,SACOC,OAAO;AACZC,YAAQD,MAAM,iEAAeA,KAAAA;AAC7B,WAAO;EACT;AACF;AAOO,SAAS0C,YAAYC,UAAgB;AAC1C,SAAO7E,kBAAAA,QAAKC,KAAKnC,cAAc+G,QAAAA;AACjC;AAnUA,IAAAC,mBACAC,iBACAC,qBAsBMrC;AAxBN;;IAAAmC,oBAAiB;AACjB,IAAAC,kBAAe;AACf,IAAAC,sBAAmB;AAEnB;AAoBA,IAAMrC,iBAAiB,oBAAIsC,IAAAA;AAUXnF;AASAI;AAQAK;AASAM;AAYAC;AA+BPQ;AA0BOe;AAcAQ;AAkBAM;AAgBAG;AAoBAS;AAUAI;AAUAC;AAUAC;AAUAC;AASAE;AAwCAG;AAmCAC;AAKhBM,gBAAY,MAAA;AACV/B,yBAAAA;IACF,GAAG,IAAA;;;;;ACxUH,8BAAO;AACP,IAAAgC,wBAAoB;;;ACDb,IAAMC,eAAe;EAC1B/G,MAAM,CAACJ,QAAQoH,IAAIC;EACnBC,UAAUtH,QAAQoH,IAAIG;AACxB;AAGO,IAAMC,cAAc;EACzBrH,MAAMH,QAAQoH,IAAIK;EAClBrH,MAAM,CAACJ,QAAQoH,IAAIM;EACnBrH,UAAUL,QAAQoH,IAAIO;EACtBrH,MAAMN,QAAQoH,IAAIQ;EAClBrH,UAAUP,QAAQoH,IAAIS;AACxB;AAEO,IAAMC,gBAAgB;EAC3B3H,MAAMH,QAAQoH,IAAIW;EAClB3H,MAAM,CAACJ,QAAQoH,IAAIY;EACnB3H,UAAUL,QAAQoH,IAAIa;EACtB3H,MAAMN,QAAQoH,IAAIc;EAClB3H,UAAUP,QAAQoH,IAAIe;EACtBlH,MAAMmH,OAAO,IAAA,MAAUpI,QAAQoH,IAAIiB;AACrC;AAEO,IAAMC,cAAc;EACzBnI,MAAMH,QAAQoH,IAAImB;EAClBnI,MAAM,CAACJ,QAAQoH,IAAIoB;EACnBjI,UAAUP,QAAQoH,IAAIqB;EACtBxH,MAAMmH,OAAO,IAAA,MAAUpI,QAAQoH,IAAIsB;AACrC;AAIO,IAAMC,cAAc;EACzBlI,WAAWT,QAAQoH,IAAIwB;EACvBlI,WAAWV,QAAQoH,IAAIyB;EACvBlI,YAAYX,QAAQoH,IAAI0B;EACxBlI,cAAcZ,QAAQoH,IAAI2B;EAC1BlI,iBACEb,QAAQoH,IAAI4B,mCAAmC,UAC3C,KACAhJ,QAAQoH,IAAI4B;EAClBlI,mBACEd,QAAQoH,IAAI6B,qCAAqC,UAC7C,KACAjJ,QAAQoH,IAAI6B;EAClBlI,YAAYf,QAAQoH,IAAI8B;AAC1B;;;AC5CA,IAAArC,oBAAiB;AACjB,IAAAC,kBAAe;AACf,IAAAqC,uBAAoB;AACpB,IAAAjC,wBAAuB;;;ACHvB,IAAAA,uBAA2C;AAC3C,IAAAkC,gBAAkB;;;ACHlB,0BAA4C;;;ACE5C,IAAAC,kBAAyB;;;ACFzB,qBAQO;;;ACRP,qBAA+B;AAC/B,uBAAiB;AACjB,0BAAoB;AAEpB;AAGA,IAAMC,aAAavH,iBAAAA,QAAKC,KAAKhC,oBAAAA,QAAQC,IAAG,GAAI,kBAAA;AAE5C,IAAqBsJ,eAArB,MAAqBA,aAAAA;EAGnB,aAAaC,iBAAiB;AAC5B,QAAI,KAAC/G,2BAAW6G,UAAAA,GAAa;AAC3B,YAAM9G,eAAAA,QAAGiH,SAASC,UAAUJ,YAAY,MAAM,OAAA;AAC9C,WAAKK,OAAO,CAAA;AACZ;IACF;AACA,QAAI;AACF,WAAKA,OAAOC,KAAKC,MAAM,MAAMrH,eAAAA,QAAGiH,SAASK,SAASR,YAAY,OAAA,CAAA;IAChE,SACOrF,OAAO;AACZ,WAAK0F,OAAO,CAAA;AACZzF,cAAQqB,IAAI,4HAAA;AACZ,YAAM/C,eAAAA,QAAGiH,SAASC,UAAUJ,YAAY,MAAM,OAAA;IAChD;EACF;EAEA,aAAaS,iBAAiB;AAC5B,UAAMC,eAAe,GAAGhK,oBAAAA,QAAQC,IAAG,CAAA;AACnC,UAAMgK,UAAUzH,eAAAA,QAAGC,WAAWuH,YAAAA;AAC9B,QAAIE,UAAU;AACd,QAAID,SAAS;AACXC,gBAAU,MAAM1H,eAAAA,QAAGiH,SAASK,SAASE,cAAc,OAAA;IACrD;AACA,SAAKL,KAAKQ,QAAQ,CAACC,SAAAA;AACjB,YAAM,EAAEvG,MAAM/B,KAAKuI,MAAK,IAAKD;AAC7B,YAAME,eAAevK,cAAc8D,IAAAA,IAAQ/B,GAAAA;AAC3C,UAAI,CAACwI,cAAc;AACjB;MACF;AACA,UAAItK,oBAAAA,QAAQoH,IAAIkD,YAAAA,MAAkB,GAAGD,KAAAA,IAAS;AAC5CH,kBAAUA,QAAQ7H,QAAQ,IAAIkI,OAAO,GAAGD,YAAAA,KAAiB,GAAG,EAAA;AAC5DJ,mBAAW;EAAKI,YAAAA,IAAgBD,KAAAA;MAClC;IACF,CAAA;AACAH,cAAUA,QAAQM,MAAM,IAAA,EAAMC,OAAOC,OAAAA,EAAS1I,KAAK,IAAA;AACnD,UAAMQ,eAAAA,QAAGiH,SAASC,UAAUM,cAAcE,SAAS,OAAA;EACrD;EAEA,OAAOS,YAAY;AACjB,WAAOnI,eAAAA,QAAGiH,SAASC,UACjBJ,YACAM,KAAKgB,UAAU,KAAKjB,MAAM,MAAM,CAAA,GAChC,OAAA;EAEJ;EAEA,OAAOkB,kBAAkBlB,MAAkB;AACzC,SAAKA,KAAKmB,KAAKnB,IAAAA;EACjB;EAEA,aAAaoB,cAAcpB,MAAkB;AAC3C,UAAMqB,QAAQ,KAAKrB,KAAKsB,UACtBb,CAAAA,SAAQA,KAAKvG,SAAS8F,KAAK9F,QAAQuG,KAAKtI,QAAQ6H,KAAK7H,GAAG;AAE1D,UAAMoJ,OAAO;MAAE,GAAGvB;MAAMwB,YAAY,oBAAInG,KAAAA;IAAO;AAC/C,QAAIgG,QAAQ,IAAI;AACd,WAAKrB,KAAKqB,KAAAA,IAAS;QAAE,GAAG,KAAKrB,KAAKqB,KAAAA;QAAQ,GAAGE;MAAK;IACpD,OACK;AACH,WAAKvB,KAAKmB,KAAKI,IAAAA;IACjB;AACA,UAAM,KAAKP,UAAS;EACtB;EAEA,OAAOS,eAAeC,QAA4B;AAChD,WAAO,KAAK1B,KAAKc,OAAOL,CAAAA,SACtBkB,OAAOC,KAAKF,MAAAA,EAAOG,MAAM1J,CAAAA,QAAOsI,KAAKtI,GAAAA,MAASuJ,OAAMvJ,GAAAA,CAAI,CAAA;EAE5D;EAEA,OAAO2J,iBACLJ,QACA1B,MACA;AACA,UAAMqB,QAAQ,KAAKrB,KAAKsB,UAAUb,CAAAA,SAChCkB,OAAOC,KAAKF,MAAAA,EAAOG,MAAM1J,CAAAA,QAAOsI,KAAKtI,GAAAA,MAASuJ,OAAMvJ,GAAAA,CAAI,CAAA;AAE1D,QAAIkJ,QAAQ,IAAI;AACd,WAAKrB,KAAKqB,KAAAA,IAAS;QAAE,GAAG,KAAKrB,KAAKqB,KAAAA;QAAQ,GAAGrB;MAAK;AAClD,aAAO,KAAKgB,UAAS;IACvB;EACF;EAEA,OAAOe,oBAAoB7H,MAA2C;AACpE,WAAO,KAAKuH,eAAe;MAAEvH;IAAK,CAAA,EAAG8H,OAAO,CAACC,MAAMC,SAAAA;AACjDD,WAAKC,KAAK/J,GAAG,IAAI+J,KAAKxB;AACtB,aAAOuB;IACT,GAAG,CAAC,CAAA;EACN;EAEA,OAAOE,gBAAgB;AACrB,UAAMC,SAAS,KAAKX,eAAe;MAAEvH,MAAM;MAAU/B,KAAK;IAAO,CAAA,EAAG,CAAA,GAChEuI;AACJ,QAAI0B,UAAUA,OAAOC,kBAAkBC,QAAW;AAChDF,aAAOC,gBAAgBD,OAAOG,iBAAiB;IACjD;AACA,WAAOH;EACT;AACF;AArGqBxC;AACnB,cADmBA,cACJI,QAAqB,CAAA;AADtC,IAAqBJ,cAArB;;;ADGA,IAAM,EAAEpJ,MAAMC,MAAME,MAAMC,UAAUF,UAAUY,KAAI,IAAK6G;AAEvD,IAAIjC,MAAM5E,OACN,aAAaX,IAAAA,IAAQC,QAAAA,IAAYJ,IAAAA,IAAQC,IAAAA,IAAQC,QAAAA,KACjD,aAAaF,IAAAA,IAAQC,IAAAA,IAAQC,QAAAA;AAM1B,SAAS8L,iBAAAA;AACd,QAAMC,MAAM7C,YAAYmC,oBAAoB,OAAA;AAC5C,QAAM,EAAEvL,MAAAA,OAAMC,MAAAA,OAAME,MAAAA,OAAMC,UAAAA,WAAUF,UAAAA,WAAUY,MAAAA,MAAI,IAAKmL;AACvDvG,QAAM5E,QACF,aAAaX,KAAAA,IAAQC,SAAAA,IAAYJ,KAAAA,IAAQC,KAAAA,IAAQC,SAAAA,KACjD,aAAaF,KAAAA,IAAQC,KAAAA,IAAQC,SAAAA;AACnC;AANgB8L;AAQT,SAASE,kBAAAA;AACd,SAAO,IAAIC,QAAQ,CAACC,KAAKC,QAAAA;AACvBC,+BAAYC,QAAQ7G,KAAK;MACvB8G,oBAAoB;MACpBC,iBAAiB;IACnB,CAAA,EACGC,KAAK,CAACC,OAAAA;AACLP,UAAI;QACFO;QACAC,IAAID,GAAGA,GAAGzM,QAAAA;MACZ,CAAA;IACF,CAAA,EACC2M,MAAM,CAACC,QAAAA;AACNT,UAAIS,GAAAA;IACN,CAAA;EACJ,CAAA;AACF;AAhBgBZ;AAkBT,SAASa,mBAAAA;AACd,SAAO,IAAIZ,QAAuB,CAACC,QAAAA;AACjCF,oBAAAA,EACGQ,KAAK,CAACM,MAAAA;AACLA,QAAEL,GAAGM,MAAK;AACVb,UAAI;QACF1I,MAAM;QACNE,QAAQ;MACV,CAAA;IACF,CAAA,EACCiJ,MAAM,CAACC,QAAAA;AACNV,UAAI;QACFc,QAAQJ,IAAIK;QACZzJ,MAAM;QACNE,QAAQ;MACV,CAAA;IACF,CAAA;EACJ,CAAA;AACF;AAlBgBmJ;AAyBT,SAAS7B,MAASkC,UAAqB;AAC5C,QAAMC,IAAI,IAAIlB,QAAW,CAACmB,SAASjB,QAAAA;AACjCH,oBAAAA,EAAkBQ,KAAK,CAAC,EAAEC,IAAIC,GAAE,MAAE;AAEhCQ,eAASR,IAAIU,OAAAA;AAEbD,QAAER,MAAM,CAACU,MAAMlB,IAAIkB,CAAAA,CAAAA,EAAIC,QAAQ,MAAA;AAC7Bb,WAAGM,MAAK;MACV,CAAA;IACF,CAAA;EACF,CAAA;AACA,SAAOI;AACT;AAZgBnC;AAcT,IAAMuC,eAAevC;AACrB,SAASwC,iBACdC,YACAzC,QACA1B,MACAoE,OAAO,OAAK;AAEZ,SAAOH,aAAkC,CAACd,IAAIW,YAAAA;AAC5C,QAAIM,MAAM;AACRjB,SAAGgB,WAAcA,UAAAA,EAAYE,WAAW3C,QAAO1B,IAAAA,EAAMkD,KAAKY,OAAAA;AAC1D;IACF;AACAX,OAAGgB,WAAcA,UAAAA,EAAYG,UAAU5C,QAAO1B,IAAAA,EAAMkD,KAAKY,OAAAA;EAC3D,CAAA;AACF;AAbgBI;AAeT,SAASK,iBACdJ,YACAnE,MACAoE,OAAO,OAAK;AAEZ,SAAOH,aAAgD,CAACd,IAAIW,YAAAA;AAC1D,QAAIM,QAAQI,MAAMC,QAAQzE,IAAAA,GAAO;AAC/BmD,SAAGgB,WAAcA,UAAAA,EACdO,WAAW1E,IAAAA,EACXkD,KAAKY,OAAAA;AACR;IACF;AACAX,OAAGgB,WAAcA,UAAAA,EACdQ,UAAU3E,IAAAA,EACVkD,KAAKY,OAAAA;EACV,CAAA;AACF;AAhBgBS;AAiBT,SAASK,eACdT,YACAzC,QAAqB;AAErB,SAAOuC,aAAkB,CAACd,IAAIW,YAAAA;AAC5BX,OAAGgB,WAAcA,UAAAA,EAAYU,KAAKnD,MAAAA,EAAOoD,QAAO,EAAG5B,KAAKY,OAAAA;EAC1D,CAAA;AACF;AAPgBc;AAST,SAASG,oBACdZ,YACAzC,QAAqB;AAErB,SAAOuC,aAAqB,CAACd,IAAIW,YAAAA;AAC/BX,OAAGgB,WAAcA,UAAAA,EAAYa,eAAetD,MAAAA,EAAOwB,KAAKY,OAAAA;EAC1D,CAAA;AACF;AAPgBiB;;;AE/HhB,yBAAmB;AACnB,IAAA7H,oBAAiB;AACjB,IAAAwC,kBAAyB;AAMlB,SAASuF,WAAWC,KAAW;AACpC,SAAOtK,mBAAAA,QAAOwB,WAAW,KAAA,EAAOC,OAAO6I,GAAAA,EAAK5I,OAAO,QAAA;AACrD;AAFgB2I;AAIT,SAASE,oBAAoBC,MAAY;AAC9C,QAAMC,UAAUD,KAAKvE,MAAM,EAAA;AAC3B,SAAOwE,QAAQrD,OACb,CAACsD,KAAKC,WACJD,OAAO,QAAQE,KAAKD,MAAAA,IAAU,IAAIA,OAAO/L,YAAW,CAAA,KAAO+L,SAC7D,EAAA;AAEJ;AAPgBJ;AAST,SAASM,eAAAA;AACd,SAAO,IAAIC,yBAAAA,EAAWC,YAAW;AACnC;AAFgBF;AAYT,SAASG,WAAWC,GAASC,MAAM,uBAAqB;AAC7D,QAAMC,IAAS;IACb,MAAMF,EAAEG,SAAQ,IAAK;IACrB,MAAMH,EAAEI,QAAO;IACf,MAAMJ,EAAEK,SAAQ;IAChB,MAAML,EAAEM,WAAU;IAClB,MAAMN,EAAEO,WAAU;IAClB,MAAMrM,KAAKC,OAAO6L,EAAEG,SAAQ,IAAK,KAAK,CAAA;IACtC,KAAKH,EAAEQ,gBAAe;EACxB;AACA,MAAI,OAAOb,KAAKM,GAAAA,GAAM;AACpBA,UAAMA,IAAIpN,QACRkI,OAAO0F,IACP,GAAGT,EAAEU,YAAW,CAAA,GAAKC,OAAO,IAAI5F,OAAO0F,GAAGG,MAAM,CAAA;EAEpD;AAEA,aAAWC,KAAKX,GAAG;AACjB,QAAI,IAAInF,OAAO,IAAI8F,CAAAA,GAAI,EAAElB,KAAKM,GAAAA,GAAM;AAClCA,YAAMA,IAAIpN,QACRkI,OAAO0F,IACP1F,OAAO0F,GAAGG,WAAW,IAAIV,EAAEW,CAAAA,IAAK,KAAKX,EAAEW,CAAAA,CAAE,GAAGF,OAAO,GAAGT,EAAEW,CAAAA,CAAE,GAAGD,MAAM,CAAA;IAEvE;EACF;AACA,SAAOX;AACT;AA1BgBF;AA4BT,SAASe,WACd9M,MACA+M,aACAC,OAAgB;AAEhB,MAAIC;AACJD,UAAQA,SAAS;IAAC;IAAK;IAAK;IAAK;IAAK;IAAM;;AAE5C,UAAQC,OAAOD,MAAME,MAAK,MAAOlN,OAAO,MAAM;AAC5CA,YAAQ;EACV;AACA,UACGiN,SAAS,MACNjN,OACAA,KAAKmN,QAAQJ,gBAAgBtE,SAAY,IAAIsE,WAAAA,KAAgBE;AAErE;AAhBgBH;AAkBT,SAASM,KAAKpN,MAAY;AAC/B,SAAOA,OAAO,OAAO,OAAO;AAC9B;AAFgBoN;AAIT,SAASC,eAAeC,QAAgB;AAC7C,SAAOA,OAAOnF,OAAO,CAACsD,KAAK8B,QAAQ9B,MAAM8B,KAAK,CAAA,EAAGJ,QAAQ,CAAA;AAC3D;AAFgBE;AAcT,SAASG,WAAWC,UAAkBC,QAAc;AACzD,MAAI;AACF,UAAMC,YAAwBvH,KAAKC,MAAMoH,QAAAA;AACzC,UAAMG,UAAsBxH,KAAKC,MAAMqH,MAAAA;AACvC,QAAIC,UAAUf,WAAW,GAAG;AAC1B,aAAO;IACT;AACA,QAAIe,UAAUf,WAAWgB,QAAQhB,QAAQ;AACvC,aAAO;IACT;AACA,QACE,CAACgB,QAAQ5F,MAAMpB,CAAAA,SACb+G,UAAU3C,KACR6C,CAAAA,aACEA,SAASC,SAASlH,KAAKkH,QAAQD,SAAShH,UAAUD,KAAKC,KAAK,CAAA,GAGlE;AACA,aAAO;IACT;EACF,SACOpG,OAAO;AACZC,YAAQqB,IAAItB,KAAAA;AACZ,WAAO;EACT;AACA,SAAO;AACT;AA1BgB+M;AA+BT,SAASO,kBAAkBC,MAAY;AAC5C,SAAOA,KAAKnP,QAAQ,iBAAiB,GAAA;AACvC;AAFgBkP;AAIT,SAASE,gBAAgBC,IAAU;AACxC,SAAO,CAAC,IAAIrC,yBAASqC,EAAAA,EAAIC,aAAY;AACvC;AAFgBF;AAIT,SAASG,eACd9P,KACA0P,MACAK,KAAqB;AAErB,SAAO,mBAAmB/P,GAAAA,IAAO+P,OAAO7M,KAAKD,IAAG,CAAA,IAAMyM,IAAAA;AACxD;AANgBI;AAQT,SAASE,UAAUhQ,KAAawD,KAAc;AACnD,SAAO,GAAG,IAAIM,IAAIN,IAAIG,QAAQC,OAAO,EAAEF,MAAM,sBAAsB1D,GAAAA;AACrE;AAFgBgQ;AAST,SAASC,gBAAgBC,GAAWC,GAAS;AAClD,UAASD,IAAIC,IAAK,KAAKtB,QAAQ,CAAA;AACjC;AAFgBoB;;;AH3IhB,SAASG,WAAWrO,MAAe8F,MAAa;AAC9C,SAAO;IACL+H,IAAItC,aAAAA;IACJvL;IACA8F;EACF;AACF;AANSuI;AAWT,eAAsBC,cAAc7M,KAAgBiH,KAAe;AACjE,QAAM,EAAElB,OAAAA,SAAQ,CAAC,GAAG+G,SAAS,CAAC,GAAGC,QAAQxM,KAAAA,KAAG,IAAKP;AACjD,MAAI,EAAEgN,OAAO,CAAC,EAAC,IAAKhN;AACpB,MAAK+M,WAAW,SAAS,CAACC,QAASA,gBAAgBC,QAAQ;AACzDD,WAAO,CAAC;EACV;AACA,QAAM,EAAE7M,QAAO,IAAKH;AACpB,QAAMkN,YAAY/M,QAAQ,YAAA;AAC1B,QAAMgN,QAAQhN,QAAQC;AACtB,QAAMgN,KAAKC,YAAYrN,GAAAA;AACvB,QAAMhF,QAAO,MAAMsS,YAAYtN,GAAAA;AAC/B,MAAIuN,SAAS;AACb,MAAIvS,OAAMoR,IAAI;AACZmB,aAASvS,MAAKoR;EAChB;AACA,QAAM/H,OAAuB;IAC3B0I;IACAxM,KAAAA;IACAwF,OAAAA;IACA+G;IACAE;IACAE;IACAC;IACAC;IACAG;IACAC,WAAWxN,IAAIwN;IACfC,SAAS/N,KAAKD,IAAG;IACjBiO,UAAUhO,KAAKD,IAAG,IAAKO,IAAIwN;EAC7B;AACAvG,MAAI0G,GAAG,SAAS,MAAA;AACd/E,qBAAiB,OAAOgE,WAAW,WAAWvI,IAAAA,CAAAA;EAChD,CAAA;AACF;AAhCsBwI;AAqCtB,eAAsBe,YAAY5N,KAAgBH,MAA0B;AAC1E,QAAM,EAAEU,KAAAA,KAAG,IAAKP;AAEhB,QAAM,EAAEG,SAAS4M,OAAM,IAAK/M;AAC5B,QAAMkN,YAAY/M,QAAQ,YAAA;AAC1B,QAAMgN,QAAQhN,QAAQC;AACtB,QAAMgN,KAAKC,YAAYrN,GAAAA;AACvB,QAAMhF,QAAO,MAAMsS,YAAYtN,GAAAA;AAC/B,MAAIuN,SAAS;AACb,MAAIvS,OAAMoR,IAAI;AACZmB,aAASvS,MAAKoR;EAChB;AACA,QAAM/H,OAAwB;IAC5BrE,KAAK;MACH+M;MACAtQ,MAAM8D;MACN2M;MACAC;MACAC;IACF;IACApS,MAAM;MACJuS;IACF;IACA1N;EACF;AACA+I,mBAAiB,OAAOgE,WAAW,YAAYvI,IAAAA,CAAAA;AACjD;AA1BsBuJ;AA+BtB,eAAsBC,YACpB7N,KACA/F,KACA6T,QAAa,CAAC,GAAC;AAEf,QAAM,EAAE/H,OAAAA,SAAQ,CAAC,GAAG+G,SAAS,CAAC,GAAGC,QAAQxM,KAAAA,KAAG,IAAKP;AACjD,MAAI,EAAEgN,OAAO,CAAC,EAAC,IAAKhN;AACpB,MAAK+M,WAAW,SAAS,CAACC,QAASA,gBAAgBC,QAAQ;AACzDD,WAAO,CAAC;EACV;AACA,QAAM,EAAE7M,QAAO,IAAKH;AACpB,QAAMkN,YAAY/M,QAAQ,YAAA;AAC1B,QAAMgN,QAAQhN,QAAQC;AACtB,QAAMgN,KAAKC,YAAYrN,GAAAA;AACvB,QAAMhF,QAAO,MAAMsS,YAAYtN,GAAAA;AAC/B,MAAIuN,SAAS;AACb,MAAIvS,OAAMoR,IAAI;AACZmB,aAASvS,MAAKoR;EAChB;AACA,QAAM/H,OAAqB;IACzBrE,KAAK;MACH+M;MACAxM,KAAAA;MACAwF,OAAAA;MACA+G;MACAE;MACAE;MACAC;MACAC;MACAG;IACF;IACAtT;IACA6T;EACF;AACAlF,mBAAiB,OAAOgE,WAAW,SAASvI,IAAAA,CAAAA;AAC9C;AAnCsBwJ;AAwCf,SAASE,SAAS/N,KAAgBvD,OAAY;AACnD,QAAM,EAAE0D,QAAO,IAAKH;AACpB,QAAMkN,YAAY/M,QAAQ,YAAA;AAC1B,QAAMgN,QAAQhN,QAAQC;AACtB,QAAMgN,KAAKC,YAAYrN,GAAAA;AACvB,QAAMqE,OAAe;IACnB6I;IACAC;IACAC;IACA3Q,MAAAA;EACF;AACAmM,mBAAiB,OAAOgE,WAAW,MAAMvI,IAAAA,CAAAA;AAC3C;AAZgB0J;AAcT,SAASV,YAAYrN,KAAc;AACxC,SAAQA,IAAIG,QAAQ,iBAAA,KACfH,IAAIgO,WAAWC,iBACfjO,IAAIkO,OAAOD;AAClB;AAJgBZ;AAMT,SAASc,YAAYjE,GAAO;AACjC,QAAMkE,IAAIlE,EAAEmE,QAAO,IAAK;AACxB,SAAO,GAAGD,EAAEjP,SAAS,EAAA,CAAA;AACvB;AAHgBgP;AAKT,SAASG,aAAaC,GAAmB;AAC9C,SAAOjG,aAAqB,CAACd,IAAIW,YAAAA;AAC/BX,OAAGgB,WAAgB,KAAA,EAAOa,eAAekF,CAAAA,EAAGhH,KAAKY,OAAAA;EACnD,CAAA;AACF;AAJgBmG;AAKT,SAASE,qBAAqBC,OAAaC,KAAU;AAC1D,MAAIA,KAAK;AACP,WAAOpG,aAAoB,CAACd,IAAIW,YAAAA;AAC9BX,SAAGgB,WAAgB,KAAA,EAChBU,KAAK;QACJyF,KAAK;UACHC,KAAK,IAAI7E,yBAASoE,YAAYM,KAAAA,CAAAA;UAC9BI,KAAK,IAAI9E,yBAASoE,YAAYO,GAAAA,CAAAA;QAChC;MACF,CAAA,EACCvF,QAAO,EACP5B,KAAKY,OAAAA;IACV,CAAA;EACF;AACA,SAAOG,aAAoB,CAACd,IAAIW,YAAAA;AAC9BX,OAAGgB,WAAgB,KAAA,EAChBU,KAAK;MACJyF,KAAK;QACHC,KAAK,IAAI7E,yBAASoE,YAAYM,KAAAA,CAAAA;MAChC;IACF,CAAA,EACCtF,QAAO,EACP5B,KAAKY,OAAAA;EACV,CAAA;AACF;AAxBgBqG;AA0BT,SAASM,sBACdC,UACAC,UACAjJ,QAAuB;AAEvB,SAAOuC,aAAoB,CAACd,IAAIW,YAAAA;AAC9BX,OAAGgB,WAAgB,KAAA,EAChBU,KAAKnD,MAAAA,EACLkJ,KAAK;MAAEN,KAAK;IAAG,CAAA,EACfO,KAAKH,QAAAA,EACLI,MAAMH,QAAAA,EACN7F,QAAO,EACP5B,KAAKY,OAAAA;EACV,CAAA;AACF;AAdgB2G;AAeT,SAASM,QAAQrJ,QAAuB;AAC7C,SAAOuC,aAAoB,CAACd,IAAIW,YAAAA;AAC9BX,OAAGgB,WAAgB,KAAA,EAAOU,KAAKnD,MAAAA,EAAOoD,QAAO,EAAG5B,KAAKY,OAAAA;EACvD,CAAA;AACF;AAJgBiH;AAMT,SAASC,eAAed,GAAM;AACnC,SAAOjG,aAAoB,CAACd,IAAIW,YAAAA;AAC9BX,OAAGgB,WAAgB,KAAA,EAChBU,KAAKqF,CAAAA,EACLU,KAAK;MAAEK,UAAU;IAAG,CAAA,EACpBnG,QAAO,EACP5B,KAAKY,OAAAA;EACV,CAAA;AACF;AARgBkH;AAUT,SAASE,mBAAmBd,OAAaC,KAAU;AACxD,MAAIA,KAAK;AACP,WAAOpG,aAAoB,CAACd,IAAIW,YAAAA;AAC9BX,SAAGgB,WAAgB,KAAA,EAChBU,KAAK;QACJ3K,MAAM;QACNoQ,KAAK;UACHC,KAAK,IAAI7E,yBAASoE,YAAYM,KAAAA,CAAAA;UAC9BI,KAAK,IAAI9E,yBAASoE,YAAYO,GAAAA,CAAAA;QAChC;MACF,CAAA,EACCvF,QAAO,EACP5B,KAAKY,OAAAA;IACV,CAAA;EACF;AACA,SAAOG,aAAoB,CAACd,IAAIW,YAAAA;AAC9BX,OAAGgB,WAAgB,KAAA,EAChBU,KAAK;MACJ3K,MAAM;MACNoQ,KAAK;QACHC,KAAK,IAAI7E,yBAASoE,YAAYM,KAAAA,CAAAA;MAChC;IACF,CAAA,EACCtF,QAAO,EACP5B,KAAKY,OAAAA;EACV,CAAA;AACF;AA1BgBoH;;;;;;;;;;;;;;;;;;;;IDzNKC,mBAAN,WAAA;EAAA;AAELC;;EAERC,IAAIC,SAA4C1V,KAAaoK,MAAY;AACvE,WAAOuJ,YAAY,KAAK6B,IAAIzP,KAAK;MAC/B2P,QAAAA;MACA1V;MACAoK;IACF,CAAA;EACF;EAEAuL,MAAMnT,OAAc;AAClB,WAAOsR,SAAS,KAAK0B,IAAIzP,KAAKvD,KAAAA;EAChC;EAEAkC,MAAM1E,KAAa6T,OAAa;AAC9B,WAAOD,YAAY,KAAK4B,IAAIzP,KAAK/F,KAAK6T,SAAS,CAAC,CAAA;EAClD;AACF,GAnBe,+BAAA;;MACZ+B,+BAAAA;qCACY,gCAAA,cAAA,SAAA,2BAAA;GAFML,gBAAAA,WAAAA,OAAAA,MAAAA;AAAAA,kBAAAA,aAAAA;MADpBM,6BAAAA;GACoBN,eAAAA;;;AKLrB,mBAAmC;AAGnC,IAAM,EAAE1U,MAAAA,OAAMD,MAAAA,OAAMI,UAAAA,WAAUU,MAAAA,MAAI,IAAKqH;AAEhC,SAAS+M,YAAAA;AACd,SAAO,IAAI/I,QAAqB,CAACC,KAAKC,QAAAA;AACpC,UAAM8I,SAASnU,aAAAA,QAAMoU,aACnBnV,OACAD,OACAc,QACI;MACEV,UAAAA;IACF,IACA,CAAC,CAAA;AAGP+U,WAAOrC,GAAG,SAAS,MAAA;AACjB1G,UAAI+I,MAAAA;IACN,CAAA;AACAA,WAAOrC,GAAG,SAAS,CAAChG,QAAAA;AAClBqI,aAAOE,KAAI;AACXhJ,UAAIS,GAAAA;IACN,CAAA;EACF,CAAA;AACF;AApBgBoI;AAsBT,SAASI,iBAAAA;AACd,SAAO,IAAInJ,QAAuB,CAACC,KAAKC,QAAAA;AACtC6I,cAAAA,EACGxI,KAAK,CAAC6I,MAAAA;AACLA,QAAEF,KAAI;AACNjJ,UAAI;QACF1I,MAAM;QACNE,QAAQ;MACV,CAAA;IACF,CAAA,EACCiJ,MAAM,CAACC,QAAAA;AACNV,UAAI;QACFc,QAAQJ,IAAIK;QACZzJ,MAAM;QACNE,QAAQ;MACV,CAAA;IACF,CAAA;EACJ,CAAA;AACF;AAlBgB0R;;;ACtBhB,IAAAE;AAGA,IAAMC,gBAAND,MAAA,MAAMC;EAYJC,cAAc;AAXNC;AAYN,SAAKA,MAAM,oBAAI9O,IAAAA;EACjB;EAXQ+O,OAAO;AACbC,eAAW,MAAA;AACT,WAAKC,aAAY;AACjB,UAAI,KAAKH,IAAItS,OAAO,GAAG;AACrB,aAAKuS,KAAI;MACX;IACF,GAAG,GAAA;EACL;;;;;;;EAYOG,QAAQpU,KAAauI,OAAgB2I,WAAW,IAAI;AACzD,QAAI,KAAK8C,IAAItS,SAAS,GAAG;AACvB,WAAKuS,KAAI;IACX;AAEA,SAAKD,IAAInR,IAAI7C,KAAK;MAAEuI;MAAO2I;IAAS,CAAA;EACtC;;;;EAKAmD,WAAWrU,KAAa;AACtB,SAAKgU,IAAI7Q,OAAOnD,GAAAA;EAClB;;;;EAKAsU,WAAWtU,KAAa;AACtB,SAAKoU,QAAQpU,KAAK,MAAM,CAAA;EAC1B;;;;EAKAuU,QAAQvU,KAAa;AAEnB,WAAO,KAAKgU,IAAIhR,IAAIhD,GAAAA;EACtB;;;;EAKAwU,YAAY;AACV,SAAKR,IAAIS,MAAK;EAChB;;;;EAKAN,eAAe;AACb,UAAM1K,OAAO,KAAKuK,IAAIvK,KAAI;AAC1B,eAAWzJ,OAAOyJ,MAAM;AACtB,YAAMlB,QAAQ,KAAKyL,IAAIhR,IAAIhD,GAAAA;AAC3B,UAAIuI,MAAM2I,aAAa,GAAG;AAExB9O,gBAAQqB,IAAI,kCAAczD,GAAAA,EAAK;AAC/B,aAAKqU,WAAWrU,GAAAA;MAClB,OAAO;AACLuI,cAAM2I,YAAY;MACpB;IACF;EACF;;;;EAOA,OAAOwD,cAAc;AACnB,QAAI,CAACZ,IAAaa,UAAU;AAC1Bb,MAAAA,IAAaa,WAAW,IAAIb,IAAAA;IAC9B;AACA,WAAOA,IAAaa;EACtB;AACF,GAvFMb,OAAAA,KAAAA,iBA4EJ,cA5EFD,KA4ESc,YAAyB,OA5ElCd;AAyFA,IAAA,sBAAeC,aAAaY,YAAW;;;AC5FhC,SAASE,cAAcrG,GAAWsG,GAAWtS,cAAc,IAAE;AAClEuS,sBAAQV,QAAQ7F,GAAGsG,GAAGtS,WAAAA;AACtBgR,YAAAA,EAAYxI,KAAK,CAACyI,WAAAA;AAChBA,WAAO3Q,IAAI0L,GAAGsG,GAAG,MAAA;AACf,UAAItS,gBAAgB,IAAI;AACtBiR,eAAOuB,OAAOxG,GAAGhM,aAAa,MAAA;AAC5BiR,iBAAOE,KAAI;QACb,CAAA;AACA;MACF;AACAF,aAAOE,KAAI;IACb,CAAA;EACF,CAAA,EAAGxI,MAAM,CAACC,QAAAA;AAER/I,YAAQ4S,KAAK,+EAAwB7J,KAAKK,WAAWL,GAAAA;EACvD,CAAA;AACF;AAhBgByJ;AAkBT,SAASK,YAAY1G,GAAW2G,gBAAoB;AACzD,SAAO,IAAI1K,QAAQ,CAACmB,YAAAA;AAClB,UAAMkJ,IAAIC,oBAAQP,QAAQhG,CAAAA;AAC1B,QAAIsG,GAAGtM,OAAO;AACZoD,cAAQkJ,EAAEtM,KAAK;AAEf,UAAI,OAAO2M,mBAAmB,YAAY;AACxCA,uBAAAA,EAAiBnK,KAAK,CAAC8J,OAAAA;AACrBD,wBAAcrG,GAAGzG,KAAKgB,UAAU+L,EAAAA,GAAI,KAAK,KAAK,KAAK,CAAA;QACrD,CAAA;MACF;AACA;IACF;AACAtB,cAAAA,EAAYxI,KAAK,CAACyI,WAAAA;AAChBA,aAAOxQ,IAAIuL,GAAG,CAACpD,KAAKgK,UAAAA;AAClBL,4BAAQV,QAAQ7F,GAAG4G,OAAO,KAAK,KAAK,KAAK,CAAA;AACzC3B,eAAOE,KAAI;AACX,YAAIyB,UAAU,QAAQ,OAAOD,mBAAmB,YAAY;AAC1DA,yBAAAA,EACGnK,KAAK,CAAC8J,OAAAA;AACL,kBAAM9H,MAAMjF,KAAKgB,UAAU+L,EAAAA;AAC3BD,0BAAcrG,GAAGxB,KAAK,KAAK,KAAK,KAAK,CAAA;AACrCpB,oBAAQoB,GAAAA;UACV,CAAA,EACC7B,MAAM,MAAA;AACLS,oBAAQwJ,KAAAA;UACV,CAAA;QACJ,OAAO;AACLxJ,kBAAQwJ,KAAAA;QACV;MACF,CAAA;IACF,CAAA,EAAGjK,MAAM,CAACC,QAAAA;AAER/I,cAAQ4S,KAAK,qFAAyB7J,KAAKK,WAAWL,GAAAA;AACtD,YAAMiK,aAAaN,oBAAQP,QAAQhG,CAAAA;AACnC,UAAI6G,YAAY7M,OAAO;AACrBoD,gBAAQyJ,WAAW7M,KAAK;MAC1B,WAAW,OAAO2M,mBAAmB,YAAY;AAE/CA,uBAAAA,EACGnK,KAAK,CAAC8J,OAAAA;AACL,gBAAM9H,MAAMjF,KAAKgB,UAAU+L,EAAAA;AAC3BD,wBAAcrG,GAAGxB,KAAK,KAAK,KAAK,KAAK,CAAA;AACrCpB,kBAAQoB,GAAAA;QACV,CAAA,EACC7B,MAAM,MAAA;AACLS,kBAAQ,IAAA;QACV,CAAA;MACJ,OAAO;AACLA,gBAAQ,IAAA;MACV;IACF,CAAA;EACF,CAAA;AACF;AArDgBsJ;AAuDT,SAASI,kBACd9G,GACA+G,cACAJ,gBAAoB;AAEpB,SAAOD,YAAY1G,GAAG2G,cAAAA,EAAgBnK,KAAK,CAAC8J,MAAAA;AAC1C,QAAIA,GAAG;AACL,aAAO/M,KAAKC,MAAM8M,CAAAA;IACpB;AACA,WAAOS,gBAAgB;EACzB,CAAA;AACF;AAXgBD;AAaT,SAASE,gBAAgBhH,GAAS;AACvCqG,gBAAcrG,GAAG,IAAI,CAAA;AACrBuG,sBAAQR,WAAW/F,CAAAA;AACrB;AAHgBgH;;;ACvFhB,mBAAkB;AAMlB,IAAIC,sBAAsB3O,YAAY/H;AAEtC,IAAM2W,gBAAgB;EACpBC,SAAShX,aAAAA,QAAMiX,KAAKC;EACpBC,QAAQnX,aAAAA,QAAMiX,KAAKG;EACnBC,QAAQrX,aAAAA,QAAMiX,KAAKK;EACnBC,QAAQvX,aAAAA,QAAMiX,KAAKO;EACnBC,eAAezX,aAAAA,QAAMiX,KAAKS;AAC5B;AACA,IAAInX,aAAawW,cAAc5O,YAAY5H,UAAU,KAAKP,aAAAA,QAAMiX,KAAKK;AAKrE,IAAIK,SAASxP,YAAYhI;AACzB,IAAIyX,MAAM,IAAI5X,aAAAA,QAAMS,KAAKgF,OAAOoS,IAAI1P,YAAYlI,WAAWkI,YAAYjI,SAAS;AAChF,IAAM,EAAE4X,oBAAmB,IAAK9X,aAAAA,QAAM+X;AAEtC,eAAsBC,sBAAAA;AACpB,QAAMpM,MAAM7C,YAAYmC,oBAAoB,OAAA;AAC5CJ,SAAOmN,OAAO9P,aAAayD,GAAAA;AAC3BkL,wBAAsB3O,YAAY/H;AAClCG,eAAawW,cAAc5O,YAAY5H,UAAU,KAAKP,aAAAA,QAAMiX,KAAKK;AACjEK,WAASxP,YAAYhI;AACrByX,QAAM,IAAI5X,aAAAA,QAAMS,KAAKgF,OAAOoS,IAAI1P,YAAYlI,WAAWkI,YAAYjI,SAAS;AAC9E;AAPsB8X;AA0Bf,SAASE,iBAAAA;AACd,QAAMC,YAAY,IAAInY,aAAAA,QAAMoY,GAAGC,UAAU;IACvCC,OAAOX;;IAEPY,YAAY;EACd,CAAA;AACA,SAAOJ,UAAUK,YAAYZ,GAAAA;AAC/B;AAPgBM;AAsBT,SAASO,iBAAiB1N,MAAgBjG,KAAe;AAC9D,MAAI,CAACiG,KAAK6E;AACR;AACF,QAAMrE,SAAS,IAAIvL,aAAAA,QAAM0Y,KAAKC,OAAM;AACpC,QAAMC,aAAa7N,KAAKuK,IAAIzF,CAAAA,MAAK7P,aAAAA,QAAMoY,GAAGS,SAASlB,QAAQ9H,CAAAA,CAAAA;AAC3D,QAAMiJ,gBAAgB,IAAI9Y,aAAAA,QAAMoY,GAAGW,cAAcnB,KAAKrM,MAAAA;AACtDuN,gBAAcE,MAAMJ,YAAY,CAACnM,KAAKwM,UAAUC,aAAAA;AAC9C,QAAIzM,KAAK;AACP/I,cAAQqB,IAAI0H,GAAAA;AACZkG,kBAAY7N,KAAK,yCAAW2H,IAAIK,OAAO,IAAIL,IAAImG,KAAK;IAEtD,OACK;AAEH,UAAIuG,OAAOC,SAAS,GAAGF,SAASG,aAAa,GAAA,IAAO,EAAA,MAAQ,GAAG;AAC7DJ,iBAAStP,QAAQ,CAACC,SAAAA;AAChB,cAAK,CAACA,KAAK9K,SAAU,KAAK;AACxB,gBAAIgG,KAAK;AACP6N,0BAAY7N,KAAK,GAAG8E,KAAK9K,IAAI,IAAK8K,KAAKT,KAAK1F,KAAK,IAAImG,IAAAA;YACvD;UACF;QACF,CAAA;MACF,OACK;AACHlG,gBAAQqB,IAAImU,SAASI,YAAY;AACjC5V,gBAAQqB,IAAIkU,QAAAA;AACZtG,oBAAY7N,KAAK,yCAAWoU,SAASI,YAAY,IAAIL,QAAAA;MACvD;IACF;EACF,CAAA;AACF;AA9BgBR;AAgCT,SAASc,eAAejY,KAAawD,KAAe;AACzD,QAAMyG,SAAS,IAAIvL,aAAAA,QAAM0Y,KAAKC,OAAM;AACpC,QAAMG,gBAAgB,IAAI9Y,aAAAA,QAAMoY,GAAGW,cAAcnB,KAAKrM,MAAAA;AACtDuN,gBAAcrU,OAAOkT,QAAQrW,KAAK,CAACmL,QAAAA;AACjC,QAAIA,KAAK;AACP/I,cAAQqB,IAAI,6CAAA;AACZrB,cAAQqB,IAAIzD,GAAAA;AACZoC,cAAQqB,IAAI0H,GAAAA;AACZ/I,cAAQqB,IAAI,2CAAA;AACZ,UAAID,KAAK;AACP6N,oBAAY7N,KAAK,4BAAQxD,GAAAA,GAAMmL,KAAKK,OAAAA,IAAWL,KAAKmG,KAAAA;MACtD;IACF;EACF,CAAA;AACF;AAdgB2G;AA+BhB,SAASC,aAAiCzM,UAAa0M,QAAQ,KAAI;AACjE,QAAMC,OAAO,oBAAIlT,IAAAA;AACjB,QAAMmT,KAAU,2BAAIC,SAAAA;AAClB,UAAMtY,MAAM8H,KAAKgB,UAAUwP,IAAAA;AAC3B,QAAI5M,IAAI0M,KAAKpV,IAAIhD,GAAAA;AACjB,QAAI,CAAC0L,GAAG;AACNA,UAAID,SAAAA,GAAY6M,IAAAA;AAChBF,WAAKvV,IAAI7C,KAAK0L,CAAAA;AACdwI,iBAAW,MAAA;AACTkE,aAAKjV,OAAOnD,GAAAA;MACd,GAAGmY,KAAAA;IACL;AACA,WAAOzM;EACT,GAXgB;AAYhB,SAAO2M;AACT;AAfSH;AAkBF,IAAMK,cAAcL,aAAa,CAACM,WAAAA;AACvC,MAAI3Q,OAAO,CAAA;AACX,MAAI4Q,SAAS;AACb,QAAMC,MAAW;IACf/F,OAAO;IACP6F;EACF;AACA,SAAO,IAAIhO,QAAQ,CAACC,QAAAA;AAClB,UAAMkO,UAAU,6BAAA;AACd,YAAM1O,SAAS,IAAIvL,aAAAA,QAAM0Y,KAAKC,OAAM;AACpC,YAAMG,gBAAgB,IAAI9Y,aAAAA,QAAMoY,GAAGW,cAAcnB,KAAKrM,MAAAA;AACtD,UAAIyO,KAAK;AACPA,YAAID,SAASA;MACf;AACAjB,oBAAcoB,WAAWvC,QAAQqC,KAAK,CAACvN,KAAKwM,aAAAA;AAC1C9P,eAAOA,KAAKgR,OAAOlB,UAAUmB,SAAS,CAAA,CAAE;AACxC,YAAInB,UAAUc,QAAQ;AACpBA,mBAASd,SAASc;AAClBE,kBAAAA;QACF,OACK;AACHlO,cAAI5C,IAAAA;QACN;MACF,CAAA;IACF,GAhBgB;AAiBhB8Q,YAAAA;EACF,CAAA;AACF,CAAA;AAEO,SAASI,YAAYP,QAAc;AACxC,SAAO,IAAIhO,QAAQ,CAACC,QAAAA;AAClB,UAAMR,SAAS,IAAIvL,aAAAA,QAAM0Y,KAAKC,OAAM;AACpC,UAAMG,gBAAgB,IAAI9Y,aAAAA,QAAMoY,GAAGW,cAAcnB,KAAKrM,MAAAA;AACtDuN,kBAAcoB,WAAWvC,QAAQ;MAC/BmC;IACF,GAAG,CAACrN,KAAKwM,aAAAA;AACPlN,UAAIkN,UAAUmB,SAAS,CAAA,CAAE;IAC3B,CAAA;EACF,CAAA;AACF;AAVgBC;AAqMT,SAASC,gBAAgBvP,MAAc;AAC5C,SAAO,IAAIe,QAAQ,CAACmB,SAASsN,WAAAA;AAC3B,QAAIxP,KAAK6E,WAAW,GAAG;AACrB,aAAO,CAAA;IACT;AACA,UAAM4K,iBAAiBzP,KAAKuK,IAAIzF,CAAAA,MAAK7P,aAAAA,QAAMoY,GAAGqC,OAAO9C,QAAQ9H,CAAAA,CAAAA;AAC7D,UAAMtE,SAAS,IAAIvL,aAAAA,QAAM0Y,KAAKC,OAAM;AACpC,UAAMG,gBAAgB,IAAI9Y,aAAAA,QAAMoY,GAAGW,cAAcnB,KAAKrM,MAAAA;AACtDuN,kBAAcE,MAAMwB,gBAAgB,CAAC/N,KAAKwM,UAAUC,aAAAA;AAClD,UAAIzM,KAAK;AACP8N,eAAO9N,GAAAA;MACT,OACK;AAEH,YAAI0M,OAAOC,SAAS,GAAGF,SAASG,aAAa,GAAA,EAAK,KAAK,GAAG;AACxDpM,kBAAQgM,QAAAA;QACV,OACK;AACHvV,kBAAQqB,IAAImU,SAASG,UAAU;AAC/B3V,kBAAQqB,IAAIkU,QAAAA;QACd;MACF;IACF,CAAA;EACF,CAAA;AACF;AAxBgBqB;AA0BT,SAASI,iBAAAA;AACd,SAAO,IAAI5O,QAAuB,CAACC,QAAAA;AACjC,QAAI,CAAC5D,YAAY/H,aAAaua,WAAW,MAAA,GAAS;AAChD5O,UAAI;QACF1I,MAAM;QACNE,QAAQ;QACRsJ,QAAQ;MACV,CAAA;AACA;IACF;AACA,UAAMtB,SAAS,IAAIvL,aAAAA,QAAM0Y,KAAKC,OAAO;MAAE1B,MAAM1W;IAAW,CAAA;AAExD,UAAMqa,cAAc,IAAI9O,QAAQ,CAACC,MAAKC,QAAAA;AACpC,YAAM6O,eAAe,IAAI7a,aAAAA,QAAM8a,QAAQC,aAAaxP,MAAAA;AACpD,YAAMyP,WAAW,IAAIhb,aAAAA,QAAM8a,QAAQG,SAAQ;AAC3C,YAAM3Z,MAAM,GAAGkD,KAAKD,IAAG,CAAA,IAAM,CAAC,EAAErB,KAAKgY,OAAM,IAAK,IAAG;AACnDL,mBAAaM,IAAIjD,eAAAA,GAAkB5W,KAAK,eAAe0Z,UAAU,CAACI,SAASnC,UAAUC,aAAAA;AACnF,cAAMzM,MAAM2O,WAAWnC,UAAUxV;AACjC,YAAIgJ,KAAK;AACPT,cAAIS,GAAAA;AACJ;QACF;AACA8M,uBAAejY,GAAAA;AACfyK,QAAAA,KAAIzK,GAAAA;MACN,CAAA;IACF,CAAA;AAEA,UAAMwX,gBAAgB,IAAI9Y,aAAAA,QAAMoY,GAAGW,cAAcnB,KAAKrM,MAAAA;AACtDuN,kBAAcoB,WAAWvC,QAAQ;MAC/BmC,QAAQ;MACR7F,OAAO;IACT,GAAG,CAACxH,KAAKwM,aAAAA;AACP,YAAMpM,SAASJ,KAAKK,WAAWmM,UAAUxV;AACzC,UAAIoJ,QAAQ;AACVd,YAAI;UACF1I,MAAM;UACNE,QAAQ;UACRsJ;QACF,CAAA;AACA;MACF;AACA+N,kBACGvO,KAAK,MAAA;AACJN,YAAI;UACF1I,MAAM;UACNE,QAAQ;QACV,CAAA;MACF,CAAA,EACCiJ,MAAM,CAACC,SAAAA;AACNV,YAAI;UACF1I,MAAM;UACNE,QAAQ;UACRsJ,QAAQ,GAAGJ,IAAAA;QACb,CAAA;MACF,CAAA;IACJ,CAAA;EACF,CAAA;AACF;AAzDgBiO;;;ACzZhB,IAAAvF;AAIA,IAAMkG,gBAANlG,MAAA,MAAMkG;EACJ,MAAMC,cAAc;AAClB,UAAMC,aAAaxS,YAAYmC,oBAAoB,QAAA,EAAUsQ,QAAQ;AACrE,UAAMC,WAAW,GAAGF,UAAAA;AAGpB,UAAMG,WAAW,MAAM/E,kBACrB8E,UACA,CAAA,GACA,MAAM5B,YAAY,cAAA,CAAA;AAEpB,WAAO6B;EACT;EAEA,MAAMC,oBAAoB7B,QAAgB;AACxC,QAAI,CAACA,QAAQ;AACX;IACF;AACA,UAAMyB,aAAaxS,YAAYmC,oBAAoB,QAAA,EAAUsQ,QAAQ;AACrE,UAAMC,WAAW,GAAGF,UAAAA,cAAwBzB,MAAAA;AAG5C,UAAM4B,WAAW,MAAM/E,kBACrB8E,UACA,CAAA,GACA,MAAM5B,YAAYC,MAAAA,CAAAA;AAEpB,WAAO4B;EACT;AACF,GA7BML,OAAAA,KAAAA,iBAANlG;AA+BA,IAAA,gBAAe,IAAIkG,aAAAA;;;AVnCwB,SAAAO,cAAA,YAAA,QAAA,KAAA,MAAA;;;;;;;;;;AAAA,OAAAA,eAAA;;;;;;AAA3C,IAAAzG;IAWqB0G,gBAAN1G,MAAA,MAAA;EAAA;AAEL2G;AAGAC;AAEAxQ,kCAASpD;;EAEjB,IAAIwP,SAAS;AACX,WAAO,KAAKpM,OAAOpL;EACrB;EAEA,IAAIyX,MAAM;AACR,WAAO,IAAI5X,cAAAA,QAAMS,KAAKgF,OAAOoS,IAC3B,KAAKtM,OAAOtL,WACZ,KAAKsL,OAAOrL,SAAS;EAEzB;EAEAqZ,eAAejY,KAAa;AAC1B,UAAMiK,SAAS,IAAIvL,cAAAA,QAAM0Y,KAAKC,OAAM;AACpC,UAAMG,gBAAgB,IAAI9Y,cAAAA,QAAMoY,GAAGW,cAAc,KAAKnB,KAAKrM,MAAAA;AAE3DuN,kBAAcrU,OAAO,KAAKkT,QAAQrW,KAAK,CAACmL,QAAAA;AACtC,UAAIA,KAAK;AACP/I,gBAAQqB,IAAI,6CAAA;AACZrB,gBAAQqB,IAAIzD,GAAAA;AACZoC,gBAAQqB,IAAI0H,GAAAA;AACZ/I,gBAAQqB,IAAI,2CAAA;AACZ,YAAI,KAAK+W,KAAK;AACZ,eAAKC,gBAAgBtY,MACnB,4BAAQnC,GAAAA,GAAMmL,KAAKK,OAAAA,IACnBL,KAAKmG,KAAAA;QAET;MACF;IACF,CAAA;EACF;EAEAxB,eAAe9P,KAAa0P,MAAcK,KAAa;AACrD,WAAOD,eAAe9P,KAAK0P,MAAMK,GAAAA;EACnC;EAEA2K,YAAYlC,QAAsB;AAChC,UAAMvO,SAAS,IAAIvL,cAAAA,QAAM0Y,KAAKC,OAAM;AACpC,UAAMG,gBAAgB,IAAI9Y,cAAAA,QAAMoY,GAAGW,cAAc,KAAKnB,KAAKrM,MAAAA;AAC3DuN,kBAAcoB,WACZ,KAAKvC,QACL;MACE1D,OAAO;MACP6F;IACF,GACA,CAACrN,KAAKwM,aAAAA;AACJ,YAAMgD,QAAehD,SAASmB;AAE9B,WAAK3B,iBAAiBwD,MAAM3G,IAAI4G,CAAAA,MAAKA,EAAE5a,GAAG,CAAA;IAC5C,CAAA;EAEJ;EAEAmX,iBAAiB1N,MAAgB;AAC/B,QAAI,CAACA,KAAK6E;AACR;AACF,UAAM,EAAE+H,QAAAA,SAAQC,KAAAA,KAAG,IAAK;AACxB,UAAMrM,SAAS,IAAIvL,cAAAA,QAAM0Y,KAAKC,OAAM;AACpC,UAAMC,aAAa7N,KAAKuK,IAAIzF,CAAAA,MAAK7P,cAAAA,QAAMoY,GAAGS,SAASlB,SAAQ9H,CAAAA,CAAAA;AAC3D,UAAMiJ,gBAAgB,IAAI9Y,cAAAA,QAAMoY,GAAGW,cAAcnB,MAAKrM,MAAAA;AACtDuN,kBAAcE,MAAMJ,YAAY,CAACnM,KAAKwM,UAAUC,aAAAA;AAC9C,UAAIzM,KAAK;AACP/I,gBAAQqB,IAAI0H,GAAAA;AACZ,aAAKsP,gBAAgBtY,MAAM,yCAAWgJ,IAAIK,OAAO,IAAIL,IAAImG,KAAK;MAEhE,OACK;AAGH,YAAIuG,OAAOC,SAAS,GAAGF,SAASG,aAAa,GAAA,IAAO,EAAA,MAAQ,GAAG;AAC7DJ,mBAAStP,QAAQ,CAACC,SAAAA;AAChB,gBAAI,CAACA,KAAK9K,SAAS,KAAK;AACtB,mBAAKid,gBAAgBtY,MACnB,GAAGmG,KAAK9K,IAAI,IAAK8K,KAAKT,KAAK1F,KAAK,IAChCmG,IAAAA;YAEJ;UACF,CAAA;QACF,OACK;AACHlG,kBAAQqB,IAAImU,SAASI,YAAY;AACjC5V,kBAAQqB,IAAIkU,QAAAA;AACZ,eAAK8C,gBAAgBtY,MACnB,yCAAWyV,SAASI,YAAY,IAChCL,QAAAA;QAEJ;MACF;IACF,CAAA;EACF;EAEA,MAAMkD,YAAYF,OAAe;AAC/B,UAAMG,WAAW,oBAAI5V,IAAAA;AACrB,UAAM8L,YAAY9N,KAAKD,IAAG;AAC1B,UAAMmX,WAAW,MAAML,cAAaC,YAAW;AAE/CI,aAAS/R,QAAQ,CAACwM,MAAAA;AAChBiG,eAASjY,IAAIgS,EAAE7U,KAAK6U,CAAAA;IACtB,CAAA;AAGA,UAAMkG,gBAAgB,IAAIC,IACxBL,MACGhS,OAAOkM,CAAAA,MAAKA,EAAEoG,YAAY,EAC1BjH,IAAI,CAACa,MAAAA;AACJ,aAAOA,EAAEoG,aAAavS,MAAM,GAAA,EAAK,CAAA;IACnC,CAAA,EACCC,OAAOkM,CAAAA,MAAK,CAACA,EAAEqG,SAAS,GAAA,CAAA,EACxBvS,OAAOkM,CAAAA,MAAK,CAACA,EAAEwE,WAAW,aAAA,CAAA,CAAA;AAG/B,eAAWb,UAAUuC,eAAe;AAClC,YAAMI,aAAa,MAAMpB,cAAaM,oBAAoB,GAAG7B,MAAAA,GAAS;AACtE2C,iBAAW9S,QAAQ,CAACwM,MAAAA;AAClBiG,iBAASjY,IAAIgS,EAAE7U,KAAK6U,CAAAA;MACtB,CAAA;IACF;AACA,UAAMuG,aAAalY,KAAKD,IAAG,IAAK+N;AAChC,SAAKyJ,gBAAgBvH,IAAI,QAAQ,6CAAekI,UAAAA,MAAgB;MAC9DC,MAAMD;IACR,CAAA;AAEA,WAAON;EACT;AACF,GApIe,OAAAjH,KAAA,iBAAAA;;MACZR,gCAAAA;sCACY,YAAA,cAAA,SAAA,OAAA;GAFMkH,aAAAA,WAAAA,OAAAA,MAAAA;;MAIlBe,6BAAOtI,eAAAA;sCACiB,oBAAA,cAAA,SAAA,eAAA;GALNuH,aAAAA,WAAAA,mBAAAA,MAAAA;AAAAA,eAAAA,cAAAA;MADpBjH,8BAAAA;GACoBiH,YAAAA;;;AWVrB,IAAAnV,uBAA2C;AAC3C,IAAAJ,kBAAe;AACf,IAAAD,oBAAiB;AAEjB,mBAAkB;AAClB,sBAAqB;AAIrB;;;;;;;;;;;;;;;;;;IAkBqBwW,oBAAN1H,MAAA,MAAA;EAObE,cAAc;AALNyG;AAGAC;AAIN3Z,oBAAAA;EACF;;;;EAKA0a,UAAUC,MAAoB;AAC5B,WAAO,eAAeA,KAAKC,YAAYD,KAAKE,OAAO,IAAIF,KAAKja,IAAI,IAAIia,KAAK/L,IAAI;EAC/E;;;;EAKAI,eAAe9P,KAAa0P,MAAcK,KAAqB;AAC7D,WAAOD,eAAe9P,KAAK0P,MAAMK,GAAAA;EACnC;;;;;;;EAQA,MAAM6L,SAAS5b,KAAagB,UAAoC;AAC9D,QAAI;AACF,YAAMZ,YAAYL,eAAeC,GAAAA;AACjCoC,cAAQqB,IAAI,kCAAczD,KAAK,cAAcI,WAAW,eAAeY,QAAAA;AAGvE,UAAI,CAACN,gBAAAA,QAAGC,WAAWK,QAAAA,GAAW;AAC5BoB,gBAAQD,MAAM,yCAAWnB,QAAAA;AACzB,eAAO;MACT;AAGAR,gBAAUP,kBAAAA,QAAK4b,QAAQzb,SAAAA,CAAAA;AAGvBM,sBAAAA,QAAGob,aAAa9a,UAAUZ,SAAAA;AAG1B,UAAI,CAACM,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC7BgC,gBAAQD,MAAM,2DAAc/B,SAAAA;AAC5B,eAAO;MACT;AAEAgC,cAAQqB,IAAI,+CAAiB/C,gBAAAA,QAAGQ,SAASd,SAAAA,EAAWsB,IAAI;AACxD,aAAO;IACT,SACOS,OAAO;AACZC,cAAQD,MAAM,yCAAWA,OAAO,QAAQnC,KAAK,aAAagB,QAAAA;AAC1D,UAAI,KAAKwZ,KAAK;AACZ,aAAKC,gBAAgBtY,MAAM,wCAAUnC,GAAAA,IAAOsG,OAAOnE,KAAAA,CAAAA;MACrD;AACA,aAAO;IACT;EACF;;;;;EAMA8V,eAAejY,KAAmB;AAChC,QAAI;AACF,YAAMI,YAAYL,eAAeC,GAAAA;AACjC,UAAIU,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC5BM,wBAAAA,QAAGqb,WAAW3b,SAAAA;MAChB;AAEA,YAAM4b,gBAAgBhY,iBAAiBhE,GAAAA;AACvC,YAAMic,cAAc7X,eAAepE,GAAAA;AACnC,UAAIU,gBAAAA,QAAGC,WAAWqb,aAAAA,GAAgB;AAChCtb,wBAAAA,QAAGqb,WAAWC,aAAAA;MAChB;AACA,UAAItb,gBAAAA,QAAGC,WAAWsb,WAAAA,GAAc;AAC9Bvb,wBAAAA,QAAGqb,WAAWE,WAAAA;MAChB;IACF,SACO9Z,OAAO;AACZC,cAAQD,MAAM,yCAAWA,KAAAA;AACzB,UAAI,KAAKqY,KAAK;AACZ,aAAKC,gBAAgBtY,MAAM,4BAAQnC,GAAAA,GAAMmC,OAAOqJ,OAAAA,IAAWlF,OAAOnE,KAAAA,CAAAA;MACpE;IACF;EACF;;;;;EAMAgV,iBAAiB1N,MAAsB;AACrC,QAAI,CAACA,KAAK6E,QAAQ;AAChB;IACF;AAEA,eAAWtO,OAAOyJ,MAAM;AACtB,WAAKwO,eAAejY,GAAAA;IACtB;AAEA,QAAI,KAAKwa,KAAK;AACZ,WAAKC,gBAAgBvH,IAAI,QAAQ,wCAAUzJ,KAAK6E,MAAM,WAAM;QAC1D4N,OAAOzS,KAAK6E;QACZ7E;MACF,CAAA;IACF;EACF;;;;;EAMAiR,YAAYlC,QAAsB;AAChC,QAAI;AACF,YAAM2D,aAAapc,eAAeyY,MAAAA;AAClC,UAAI,CAAC9X,gBAAAA,QAAGC,WAAWwb,UAAAA,GAAa;AAC9B;MACF;AAEA,YAAMxB,QAAQ,KAAKyB,kBAAkB5D,MAAAA;AACrC,WAAKrB,iBAAiBwD,MAAM3G,IAAI4G,CAAAA,MAAKA,EAAE5a,GAAG,CAAA;IAC5C,SACOmC,OAAO;AACZC,cAAQD,MAAM,yCAAWA,KAAAA;AACzB,UAAI,KAAKqY,KAAK;AACZ,aAAKC,gBAAgBtY,MAAM,wCAAUqW,MAAAA,IAAUlS,OAAOnE,KAAAA,CAAAA;MACxD;IACF;EACF;;;;;;EAOA,MAAMka,iBAAiBrc,KAA+B;AACpD,UAAMI,YAAYL,eAAeC,GAAAA;AACjC,WAAOU,gBAAAA,QAAGC,WAAWP,SAAAA;EACvB;;;;;;EAOA,MAAMW,YAAYf,KAA4C;AAC5D,UAAMI,YAAYL,eAAeC,GAAAA;AACjC,WAAOe,YAAYX,SAAAA;EACrB;;;;;;EAOA,MAAM4Y,gBAAgBvP,MAAwF;AAC5G,UAAM6S,UAAU,MAAM9R,QAAQ+R,IAC5B9S,KAAKuK,IAAI,OAAOhU,QAAAA;AACd,YAAMqD,OAAO,MAAM,KAAKtC,YAAYf,GAAAA;AACpC,UAAIqD,MAAM;AACR,eAAO;UAAE7F,MAAM;UAAKqK,MAAMxE;QAAK;MACjC;AACA,aAAO;QAAE7F,MAAM;QAAK2E,OAAO;MAAQ;IACrC,CAAA,CAAA;AAEF,WAAOma;EACT;;;;;;EAOAF,kBAAkB5D,QAAiC;AACjD,UAAM2D,aAAapc,eAAeyY,MAAAA;AAClC,UAAMmC,QAAyB,CAAA;AAE/B,QAAI,CAACja,gBAAAA,QAAGC,WAAWwb,UAAAA,GAAa;AAC9B,aAAOxB;IACT;AAEA,UAAM6B,YAAY,wBAACC,KAAaC,YAAAA;AAC9B,YAAM5D,QAAQpY,gBAAAA,QAAGic,YAAYF,GAAAA;AAC7B,iBAAWnU,QAAQwQ,OAAO;AACxB,cAAM8D,WAAW3c,kBAAAA,QAAKC,KAAKuc,KAAKnU,IAAAA;AAChC,cAAMrH,QAAQP,gBAAAA,QAAGQ,SAAS0b,QAAAA;AAE1B,YAAI3b,MAAMe,YAAW,GAAI;AACvBwa,oBAAUI,UAAU,GAAGF,OAAAA,GAAUpU,IAAAA,GAAO;QAC1C,OACK;AACH,gBAAMtI,MAAM,GAAG0c,OAAAA,GAAUpU,IAAAA;AACzB,gBAAMjF,OAAOtC,YAAY6b,QAAAA;AACzB,cAAIvZ,MAAM;AACRsX,kBAAM3R,KAAK3F,IAAAA;UACb;QACF;MACF;IACF,GAjBkB;AAmBlB,QAAI3C,gBAAAA,QAAGQ,SAASib,UAAAA,EAAYna,YAAW,GAAI;AACzCwa,gBAAUL,YAAY3D,MAAAA;IACxB,OACK;AACH,YAAMnV,OAAOtC,YAAYob,UAAAA;AACzB,UAAI9Y,MAAM;AACRsX,cAAM3R,KAAK3F,IAAAA;MACb;IACF;AAEA,WAAOsX;EACT;;;;;;EAOA,MAAME,YAAYF,OAAoD;AACpE,UAAMG,WAAW,oBAAI5V,IAAAA;AACrB,UAAM8L,YAAY9N,KAAKD,IAAG;AAG1B,UAAM4Z,WAAW,KAAKT,kBAAkB,cAAA;AACxCS,aAASxU,QAAQ,CAACwM,MAAAA;AAChBiG,eAASjY,IAAIgS,EAAE7U,KAAK6U,CAAAA;IACtB,CAAA;AAGA,UAAMkG,gBAAgB,IAAIC,IACxBL,MACGhS,OAAOkM,CAAAA,MAAKA,EAAEoG,YAAY,EAC1BjH,IAAI,CAACa,MAAAA;AACJ,aAAOA,EAAEoG,aAAcvS,MAAM,GAAA,EAAK,CAAA;IACpC,CAAA,EACCC,OAAOkM,CAAAA,MAAK,CAACA,EAAEqG,SAAS,GAAA,CAAA,EACxBvS,OAAOkM,CAAAA,MAAK,CAACA,EAAEwE,WAAW,aAAA,CAAA,CAAA;AAG/B,eAAWb,UAAUuC,eAAe;AAClC,YAAM+B,WAAW,KAAKV,kBAAkB,GAAG5D,MAAAA,GAAS;AACpDsE,eAASzU,QAAQ,CAACwM,MAAAA;AAChBiG,iBAASjY,IAAIgS,EAAE7U,KAAK6U,CAAAA;MACtB,CAAA;IACF;AAEA,UAAMuG,aAAalY,KAAKD,IAAG,IAAK+N;AAChC,SAAKyJ,gBAAgBvH,IAAI,QAAQ,sDAAckI,UAAAA,MAAgB;MAC7DC,MAAMD;IACR,CAAA;AAEA,WAAON;EACT;;;;;;;;EASA,MAAMiC,kBAAkB/c,KAAagd,QAAQ,KAAKC,SAAS,KAAuB;AAChF,QAAI;AACF,YAAM7c,YAAYL,eAAeC,GAAAA;AACjC,UAAI,CAACU,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC7B,eAAO;MACT;AAEA,YAAM4b,gBAAgBhY,iBAAiBhE,GAAAA;AACvCQ,gBAAUP,kBAAAA,QAAK4b,QAAQG,aAAAA,CAAAA;AAEvB,gBAAMkB,aAAAA,SAAM9c,SAAAA,EACT+c,OAAOH,OAAOC,QAAQ;QACrBG,KAAK;QACLC,UAAU;MACZ,CAAA,EACCC,KAAK;QAAEC,SAAS;MAAG,CAAA,EACnBC,OAAOxB,aAAAA;AAEV,aAAO;IACT,SACO7Z,OAAO;AACZC,cAAQD,MAAM,+CAAYA,KAAAA;AAC1B,aAAO;IACT;EACF;;;;;;;;EASA,MAAMsb,gBAAgBzd,KAAa0d,WAAW,MAAMC,YAAY,MAAwB;AACtF,QAAI;AACF,YAAMvd,YAAYL,eAAeC,GAAAA;AACjC,UAAI,CAACU,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC7B,eAAO;MACT;AAEA,YAAM6b,cAAc7X,eAAepE,GAAAA;AACnCQ,gBAAUP,kBAAAA,QAAK4b,QAAQI,WAAAA,CAAAA;AAEvB,gBAAMiB,aAAAA,SAAM9c,SAAAA,EACT+c,OAAOO,UAAUC,WAAW;QAC3BP,KAAK;QACLQ,oBAAoB;MACtB,CAAA,EACCN,KAAK;QAAEC,SAAS;MAAG,CAAA,EACnBC,OAAOvB,WAAAA;AAEV,aAAO;IACT,SACO9Z,OAAO;AACZC,cAAQD,MAAM,+CAAYA,KAAAA;AAC1B,aAAO;IACT;EACF;;;;;;;;;EAUA,MAAM0b,mBACJ7d,KACA+B,MACAQ,aACAiB,KACiB;AACjB,UAAMpD,YAAYL,eAAeC,GAAAA;AACjC,QAAI,CAACU,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC7B,aAAO;IACT;AAGA,UAAMiD,OAAO,MAAM,KAAKtC,YAAYf,GAAAA;AACpC,QAAI,CAACqD,QAAQ,CAACA,KAAK/B,SAAS4Z,SAAS,OAAA,GAAU;AAC7C,aAAO;IACT;AAGA,QAAInZ,SAAS,SAAS;AACpB,YAAMia,gBAAgBhY,iBAAiBhE,GAAAA;AACvC,UAAI,CAACU,gBAAAA,QAAGC,WAAWqb,aAAAA,GAAgB;AACjC,cAAM,KAAKe,kBAAkB/c,GAAAA;MAC/B;AACA,YAAM8d,eAAezZ,gBAAgBrE,GAAAA;AACrC,UAAIU,gBAAAA,QAAGC,WAAWqb,aAAAA,GAAgB;AAChC,eAAOzY,kBAAkBua,cAAcvb,aAAaiB,GAAAA;MACtD;IACF,OACK;AACH,YAAMyY,cAAc7X,eAAepE,GAAAA;AACnC,UAAI,CAACU,gBAAAA,QAAGC,WAAWsb,WAAAA,GAAc;AAC/B,cAAM,KAAKwB,gBAAgBzd,GAAAA;MAC7B;AACA,YAAM+d,aAAazZ,cAActE,GAAAA;AACjC,UAAIU,gBAAAA,QAAGC,WAAWsb,WAAAA,GAAc;AAC9B,eAAO1Y,kBAAkBwa,YAAYxb,aAAaiB,GAAAA;MACpD;IACF;AACA,WAAO;EACT;;;;;;;EAQA,MAAMwa,gBAAgBvU,MAAgBjF,SAAkC;AACtE,WAAO,IAAIgG,QAAQ,CAACmB,SAASsN,WAAAA;AAC3B,YAAMgF,UAAU1Z,kBAAkB,GAAGC,OAAAA,MAAa;AAClDhE,gBAAUP,kBAAAA,QAAK4b,QAAQoC,OAAAA,CAAAA;AAEvB,YAAMC,SAASxd,gBAAAA,QAAGyd,kBAAkBF,OAAAA;AACpC,YAAMG,cAAUC,gBAAAA,SAAS,OAAO;QAC9BC,MAAM;UAAEC,OAAO;QAAE;MACnB,CAAA;AAEAL,aAAO/M,GAAG,SAAS,MAAA;AACjB,cAAMqN,SAAS,cAAcha,OAAAA;AAC7BmH,gBAAQ6S,MAAAA;MACV,CAAA;AAEAJ,cAAQjN,GAAG,SAAS,CAAChG,QAAAA;AACnB8N,eAAO9N,GAAAA;MACT,CAAA;AAEAiT,cAAQK,KAAKP,MAAAA;AAGb,iBAAWle,OAAOyJ,MAAM;AACtB,cAAMrJ,YAAYL,eAAeC,GAAAA;AACjC,YAAIU,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC5B,gBAAMuE,WAAW1E,kBAAAA,QAAKye,SAAS1e,GAAAA;AAC/Boe,kBAAQ3C,KAAKrb,WAAW;YAAEsP,MAAM/K;UAAS,CAAA;QAC3C;MACF;AAEAyZ,cAAQO,SAAQ;IAClB,CAAA;EACF;;;;;;EAOAC,cAAc5e,KAAmC;AAC/C,QAAI;AACF,YAAMI,YAAYL,eAAeC,GAAAA;AACjC,UAAIU,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC5B,eAAOM,gBAAAA,QAAGme,iBAAiBze,SAAAA;MAC7B;AACA,aAAO;IACT,SACO+B,OAAO;AACZC,cAAQD,MAAM,+CAAYA,KAAAA;AAC1B,aAAO;IACT;EACF;;;;;;;;EASA2c,eAAe9e,KAAauC,aAAqBiB,KAAyB;AACxE,WAAOD,kBAAkBvD,KAAKuC,aAAaiB,GAAAA;EAC7C;AACF,GA9be,OAAAqQ,KAAA,qBAAAA;;MACZR,gCAAAA;sCACY,YAAA,cAAA,SAAA,OAAA;GAFMkI,iBAAAA,WAAAA,OAAAA,MAAAA;;MAIlBD,6BAAOtI,eAAAA;sCACiB,oBAAA,cAAA,SAAA,eAAA;GALNuI,iBAAAA,WAAAA,mBAAAA,MAAAA;AAAAA,mBAAAA,cAAAA;MADpBjI,8BAAAA;;;GACoBiI,gBAAAA;;;AC3BrB,IAAAnW,uBAA2C;AAC3C,IAAA2Z,kBAAmB;;;ACDnB,IAAA3Z,uBAAwB;;;ACDxB,mBAAkB;AAIlB,IAAI4Z;AAEG,SAASC,cAAAA;AACd,QAAM3U,MAAM7C,YAAYmC,oBAAoB,OAAA;AAC5CoV,QAAM9M,IAAAA;AACNxM,cAAYrH,OAAOiM,IAAIjM;AACvBqH,cAAYpH,OAAOgM,IAAIhM;AACvBoH,cAAYlH,OAAO8L,IAAI9L;AACvBkH,cAAYjH,WAAW6L,IAAI7L;AAC3BiH,cAAYnH,WAAW+L,IAAI/L;AAE3BygB,SAAO5gB,aAAAA,QAAM8gB,WAAWxZ,WAAAA;AACxBsZ,OAAK7N,GAAG,SAAS,CAAChG,QAAAA;AAChB/I,YAAQqB,IAAI,oBAAA;AACZrB,YAAQD,MAAMgJ,GAAAA;EAChB,CAAA;AACF;AAdgB8T;AAgBT,SAASE,gBAAAA;AACd,SAAO,IAAI3U,QAAQ,CAACC,KAAKC,QAAAA;AACvBsU,SAAKG,cAAc,CAAChU,KAAKiU,SAAAA;AACvB,UAAIjU,KAAK;AACP/I,gBAAQD,MAAM,oCAAA;AACdC,gBAAQD,MAAMgJ,IAAIK,OAAO;AACzBd,YAAIS,GAAAA;AACJ;MACF;AACAV,UAAI2U,IAAAA;IACN,CAAA;EACF,CAAA;AACF;AAZgBD;AAoBT,SAAS5V,OAAS8V,QAAgB/O,QAAe;AACtD,SAAO,IAAI9F,QAAW,CAACmB,SAASsN,WAAAA;AAC9BkG,kBAAAA,EACGpU,KAAK,CAACqU,SAAAA;AACLA,WAAK7V,MAAM8V,KAAK/O,QAAQ,CAACnF,KAAKmU,WAAAA;AAC5B,YAAInU,KAAK;AACP8N,iBAAO9N,GAAAA;AACP;QACF;AAEAiU,aAAKG,QAAO;AACZ5T,gBAAQ2T,MAAAA;MACV,CAAA;IACF,CAAA,EACCpU,MAAM,CAACC,QAAAA;AACN8N,aAAO9N,GAAAA;IACT,CAAA;EACJ,CAAA;AACF;AAlBgB5B,OAAAA,QAAAA;AAoBT,SAASiW,iBAAAA;AACd,SAAO,IAAIhV,QAAuB,CAACC,KAAKC,QAAAA;AACtCsU,SAAKG,cAAc,CAAChU,KAAKiU,SAAAA;AACvB,UAAIjU,KAAK;AACPV,YAAI;UACFc,QAAQJ,IAAIK;UACZzJ,MAAM;UACNE,QAAQ;QACV,CAAA;AACA;MACF;AACAwI,UAAI;QACF1I,MAAM;QACNE,QAAQ;MACV,CAAA;AACAmd,WAAKG,QAAO;IACd,CAAA;EACF,CAAA;AACF;AAlBgBC;;;ACjDhB,SAASC,eAAeC,KAAG;AACzB,SAAOlW,OAAOC,KAAKiW,GAAAA,EAAK7V,OAAO,CAACsD,KAAKoB,MAAAA;AACnC,QAAImR,IAAInR,CAAAA,MAAOpE,QAAW;AACxBgD,UAAIoB,CAAAA,IAAKmR,IAAInR,CAAAA;IACf;AACA,WAAOpB;EACT,GAAG,CAAC,CAAA;AACN;AAPSsS;AAST,SAASE,SAAS9X,MAAI;AACpB,SAAOA,gBAAgB2B,UAAU,OAAO3B,SAAS;AACnD;AAFS8X;AAIT,SAASC,UAAUC,OAAK;AACtB,SAAOF,SAASE,KAAAA,KAAUrW,OAAOC,KAAKgW,eAAeI,KAAAA,CAAAA,EAAQvR,WAAW;AAC1E;AAFSsR;AAIF,SAASE,mBACdC,OACAC,UAAmB,CAAC,GAAC;AAErB,QAAM,EAAEC,UAAU,CAAA,GAAIC,QAAQ,GAAE,IAAKF;AACrC,MAAI,EAAEnY,OAAO,CAAC,GAAG8K,MAAK,IAAKqN;AAC3BrN,UAAQA,SAAS;AACjB,MAAI,CAACgN,SAAS9X,IAAAA;AAAO,WAAO;MAAEwX,KAAK;MAAI/O,QAAQ,CAAA;IAAG;AAClDzI,SAAO4X,eAAe5X,IAAAA;AAEtB,QAAMsY,SAASF,QAAQ3R,SAAS,IAAI,GAAG2R,QAAQ/f,KAAK,GAAA,CAAA,KAAS;AAC7D,QAAMuJ,OAAOD,OAAOC,KAAK5B,IAAAA;AACzB,QAAMuY,QACJ3W,KAAK6E,SAAS,IACV,SAAS7E,KACNuK,IAAI,CAAChU,QAAQqgB,eAAergB,KAAK6H,KAAK7H,GAAAA,CAAI,CAAA,EAC1CE,KAAK,OAAA,CAAA,KACR;AACN,QAAMogB,SAAS7W,KAAKuK,IAAI,CAAChU,QAAQ6H,KAAK7H,GAAAA,CAAI,EAAEugB,KAAI;AAChD,QAAMC,WACJ,OAAO7N,UAAU,YAAYA,QAAQ,IAAI,SAAS/Q,KAAK6e,KAAK9N,KAAAA,CAAAA,KAAW;AACzE,QAAM0M,MACJ,UAAUc,MAAAA,SAAeJ,KAAAA,IAASK,KAAAA,IAASF,KAAAA,IAASM,QAAAA,GAAWE,KAAI;AACrE,SAAO;IACLrB;IACA/O,QAAQgQ;EACV;AACF;AA3BgBR;AA6BT,SAASa,mBAAmBZ,OAAeF,OAAc;AAC9D,MAAI,CAACD,UAAUC,KAAAA;AAAQ,WAAO;MAAER,KAAK;MAAI/O,QAAQ,CAAA;IAAG;AACpDuP,UAAQJ,eAAeI,KAAAA;AAEvB,QAAMpW,OAAOD,OAAOC,KAAKoW,KAAAA;AACzB,QAAMO,QAAQ,SAAS3W,KACpBuK,IAAI,CAAChU,QAAQqgB,eAAergB,KAAK6f,MAAM7f,GAAAA,CAAI,CAAA,EAC3CE,KAAK,OAAA,CAAA;AACR,QAAMogB,SAAS7W,KAAKuK,IAAI,CAAChU,QAAQ6f,MAAM7f,GAAAA,CAAI,EAAEugB,KAAI;AACjD,QAAMlB,MAAM,eAAeU,KAAAA,IAASK,KAAAA,GAAQM,KAAI;AAChD,SAAO;IACLrB;IACA/O,QAAQgQ;EACV;AACF;AAdgBK;AAgBT,SAASC,mBAAmBb,OAAeF,OAAc;AAC9D,MAAI,CAACD,UAAUC,KAAAA;AAAQ,WAAO;MAAER,KAAK;MAAI/O,QAAQ,CAAA;IAAG;AACpDuP,UAAQJ,eAAeI,KAAAA;AAEvB,QAAMpW,OAAOD,OAAOC,KAAKoW,KAAAA;AACzB,QAAMS,SAAS7W,KAAKuK,IAAI,CAAChU,QAAQ6f,MAAM7f,GAAAA,CAAI;AAE3C,QAAMqf,MAAM,eAAeU,KAAAA,KAAUtW,KAClCuK,IAAIhH,mBAAAA,EACJ9M,KAAK,GAAA,CAAA,aAAiB,IAAImM,MAAM5C,KAAK6E,MAAM,EAAEuS,KAAK,GAAA,EAAK3gB,KAAK,GAAA,CAAA;AAC/D,SAAO;IACLmf;IACA/O,QAAQgQ;EACV;AACF;AAdgBM;AAgBT,SAASE,uBACdf,OACAF,OAAgB;AAEhB,MAAIA,MAAMvR,WAAW,KAAK,CAACsR,UAAUC,MAAM,CAAA,CAAE;AAAG,WAAO;MAAER,KAAK;MAAI/O,QAAQ,CAAA;IAAG;AAC7E,QAAM7G,OAAOD,OAAOC,KAAKoW,MAAM,CAAA,CAAE;AAEjC,QAAMS,SAAST,MAAMhW,OACnB,CAACsD,KAAK5E,UAAU4E,IAAI0L,OAAOpP,KAAKuK,IAAI,CAAChU,QAAQuI,MAAMvI,GAAAA,CAAI,CAAA,GACvD,CAAA,CAAE;AAEJ,QAAM+gB,YAAY,UAAU1U,MAAM1M,KAAK;IAAE2O,QAAQuR,MAAMvR;EAAO,CAAA,EAC3D0F,IAAI,MAAM,IAAI,IAAI3H,MAAM5C,KAAK6E,MAAM,EAAEuS,KAAK,GAAA,EAAK3gB,KAAK,GAAA,CAAA,GAAO,EAC3DA,KAAK,GAAA,CAAA;AACR,QAAMmf,MAAM,eAAeU,KAAAA,KAAUtW,KAClCuK,IAAIhH,mBAAAA,EACJ9M,KAAK,GAAA,CAAA,KAAS6gB,SAAAA;AACjB,SAAO;IACL1B;IACA/O,QAAQgQ;EACV;AACF;AArBgBQ;AAuBT,SAASE,mBACdjB,OACAF,OACAtW,QAAc;AAEd,MAAI,CAACqW,UAAUC,KAAAA,KAAU,CAACD,UAAUrW,MAAAA;AAAQ,WAAO;MAAE8V,KAAK;MAAI/O,QAAQ,CAAA;IAAG;AACzEuP,UAAQJ,eAAeI,KAAAA;AACvBtW,EAAAA,SAAQkW,eAAelW,MAAAA;AAEvB,QAAM0X,kBAAkBzX,OAAOC,KAAKoW,KAAAA;AACpC,MAAIS,SAASW,gBAAgBjN,IAAI,CAAChU,QAAQ6f,MAAM7f,GAAAA,CAAI;AACpD,QAAMkhB,iBAAiB1X,OAAOC,KAAKF,MAAAA;AACnC+W,WAASA,OAAOzH,OAAOqI,eAAelN,IAAI,CAAChU,QAAQuJ,OAAMvJ,GAAAA,CAAI,EAAEugB,KAAI,CAAA;AAEnE,QAAMH,QAAQ,SAASc,eACpBlN,IAAI,CAAChU,QAAQqgB,eAAergB,KAAKuJ,OAAMvJ,GAAAA,CAAI,CAAA,EAC3CE,KAAK,OAAA,CAAA;AACR,QAAMmf,MAAM,UAAUU,KAAAA,QAAakB,gBAChCjN,IAAI,CAAChU,QAAQ,GAAGgN,oBAAoBhN,GAAAA,CAAAA,MAAU,EAC9CE,KAAK,GAAA,CAAA,IAAQkgB,KAAAA;AAChB,SAAO;IACLf;IACA/O,QAAQgQ;EACV;AACF;AAxBgBU;AA0BT,SAASX,eAAe9R,GAAGsG,GAAC;AACjC,MAAI,CAAC8K,SAAS9K,CAAAA,GAAI;AAChB,WAAO,GAAG7H,oBAAoBuB,CAAAA,CAAAA;EAChC;AACA,MAAIlC,MAAMC,QAAQuI,CAAAA,GAAI;AACpB,WAAO,GAAG7H,oBAAoBuB,CAAAA,CAAAA,QAAUlC,MAAM1M,KAAK;MAAE2O,QAAQuG,EAAEvG;IAAO,CAAA,EACnEuS,KAAK,GAAA,EACL3gB,KAAK,GAAA,CAAA;EACV;AACA,QAAM,IAAIihB,MAAM,oBAAA;AAClB;AAVgBd;;;IC5IT;UAAKe,UAAO;AAAPA,EAAAA,SAAAA,SACVC,OAAAA,IAAAA,CAAAA,IAAAA;AADUD,EAAAA,SAAAA,SAEVE,MAAAA,IAAAA,CAAAA,IAAAA;GAFUF,YAAAA,UAAAA,CAAAA,EAAAA;;;ACAZ,qBAAuD;;;;;;;;;;;;;;;;;;AAGvD,IAAaG,SAAN1N,MAAA,MAAA;EAAA;AAELjE;AAGAlQ;AAQA8hB;AAGA/iB;AAGAgjB;AAGAxf;AAOAyf;AAOAC;AAGAC;AAOAC;AAGAngB;AAGAogB;;AACF,GArDO,OAAAjO,KAAA,SAAAA;;MACJkO,uCAAuB;IAAEhgB,MAAM;IAAOigB,SAAS;EAAO,CAAA;;GAD5CT,MAAAA,WAAAA,MAAAA,MAAAA;;MAIVU,uBAAO,WAAW;IAAE3T,QAAQ;IAAI4T,UAAU;IAAMF,SAAS;EAAU,CAAA;;GAJzDT,MAAAA,WAAAA,WAAAA,MAAAA;;MAOVU,uBAAO,WAAW;IACjB3T,QAAQ;IACR4T,UAAU;IACVF,SAAS;IACTtS,MAAM;EACR,CAAA;;GAZW6R,MAAAA,WAAAA,SAAAA,MAAAA;;MAeVU,uBAAO,WAAW;IAAE3T,QAAQ;IAAK0T,SAAS;EAAK,CAAA;;GAfrCT,MAAAA,WAAAA,YAAAA,MAAAA;;MAkBVU,uBAAO,WAAW;IAAEE,SAAS;IAAGH,SAAS;EAAO,CAAA;;GAlBtCT,MAAAA,WAAAA,SAAAA,MAAAA;;MAqBVU,uBAAO,WAAW;IAAEE,SAAS;IAAGH,SAAS;EAAO,CAAA;;GArBtCT,MAAAA,WAAAA,UAAAA,MAAAA;;MAwBVU,uBAAO,aAAa;IACnBE,SAAS;IACTH,SAAS;IACTtS,MAAM;EACR,CAAA;sCACU,SAAA,cAAA,SAAA,IAAA;GA7BC6R,MAAAA,WAAAA,YAAAA,MAAAA;;MA+BVU,uBAAO,aAAa;IACnBC,UAAU;IACVF,SAAS;IACTtS,MAAM;EACR,CAAA;sCACW,SAAA,cAAA,SAAA,IAAA;GApCA6R,MAAAA,WAAAA,aAAAA,MAAAA;;MAsCVU,uBAAO,OAAO;IAAEE,SAAS;IAAGH,SAAS;IAAQtS,MAAM;EAAc,CAAA;;GAtCvD6R,MAAAA,WAAAA,cAAAA,MAAAA;;MAyCVU,uBAAO,aAAa;IACnBC,UAAU;IACVF,SAAS;IACTtS,MAAM;EACR,CAAA;sCACU,SAAA,cAAA,SAAA,IAAA;GA9CC6R,MAAAA,WAAAA,YAAAA,MAAAA;;MAgDVU,uBAAO,OAAO;IAAEE,SAAS;IAAGH,SAAS;EAAY,CAAA;;GAhDvCT,MAAAA,WAAAA,QAAAA,MAAAA;;MAmDVU,uBAAO;IAAElgB,MAAM;IAAWqgB,WAAW;IAAIC,OAAO;EAAE,CAAA;;GAnDxCd,MAAAA,WAAAA,UAAAA,MAAAA;AAAAA,QAAAA,cAAAA;MADZe,uBAAO,MAAA;GACKf,KAAAA;;;ACHb,IAAAxC,kBAAuD;;;;;;;;;;;;;;;;;;AAGvD,IAAawD,YAAN1O,MAAA,MAAA;EAAA;AAELjE;AAGAF;AAGAqB;AAMAxC;;AAIF,GAlBO,OAAAsF,KAAA,aAAAA;;MACJkO,wCAAuB;IAAEhgB,MAAM;IAAOygB,UAAU;IAAMR,SAAS;EAAO,CAAA;;GAD5DO,SAAAA,WAAAA,MAAAA,MAAAA;;MAIVN,wBAAO,WAAW;IAAE3T,QAAQ;IAAK0T,SAAS;EAAO,CAAA;;GAJvCO,SAAAA,WAAAA,QAAAA,MAAAA;;MAOVN,wBAAO,OAAO;IAAEvS,MAAM;IAAWsS,SAAS;EAAO,CAAA;;GAPvCO,SAAAA,WAAAA,UAAAA,MAAAA;;MAUVN,wBAAO,WAAW;IACjB3T,QAAQ;IACR0T,SAAS;EACX,CAAA;;GAbWO,SAAAA,WAAAA,KAAAA,MAAAA;AAAAA,WAAAA,cAAAA;MADZD,wBAAO,UAAA;GACKC,QAAAA;;;ACHb,IAAAxD,kBAAyE;;;;;;;;;;;;;;;;;;AAGzE,IAAa0D,UAAN5O,MAAA,MAAA;EAAA;AAELjE;AAGA+L;AAOA+G;AAGAC;AAGA5R;AAGArB;AAGArM;AAGA7B;AAMAohB;AAGAlhB;AAGAmhB;AAQAC;AAGAC;AAGAC;AAGAC;AAGAC;;AACF,GA5DO,OAAArP,KAAA,UAAAA;;MACJkO,wCAAuB;IAAEhgB,MAAM;EAAM,CAAA;;GAD3B0gB,OAAAA,WAAAA,MAAAA,MAAAA;;MAIVR,wBAAO,WAAW;IAAE3T,QAAQ;IAAKoB,MAAM;IAAYsS,SAAS;EAAO,CAAA;;GAJzDS,OAAAA,WAAAA,WAAAA,MAAAA;;MAOVR,wBAAO,WAAW;IACjB3T,QAAQ;IACRoB,MAAM;IACNsS,SAAS;EACX,CAAA;;GAXWS,OAAAA,WAAAA,YAAAA,MAAAA;;MAcVR,wBAAO,WAAW;IAAE3T,QAAQ;IAAKoB,MAAM;IAAgBsS,SAAS;EAAO,CAAA;;GAd7DS,OAAAA,WAAAA,eAAAA,MAAAA;;MAiBVR,wBAAO,OAAO;IAAEvS,MAAM;IAAWsS,SAAS;EAAO,CAAA;;GAjBvCS,OAAAA,WAAAA,UAAAA,MAAAA;;MAoBVR,wBAAO,WAAW;IAAE3T,QAAQ;IAAMoB,MAAM;IAAQsS,SAAS;EAAM,CAAA;;GApBrDS,OAAAA,WAAAA,QAAAA,MAAAA;;MAuBVR,wBAAO,WAAW;IAAE3T,QAAQ;IAAO4T,UAAU;IAAMF,SAAS;EAAO,CAAA;;GAvBzDS,OAAAA,WAAAA,QAAAA,MAAAA;;MA0BVR,wBAAO,WAAW;IAAE3T,QAAQ;IAAK0T,SAAS;EAAS,CAAA;;GA1BzCS,OAAAA,WAAAA,QAAAA,MAAAA;;MA6BVR,wBAAO,aAAa;IACnBD,SAAS;IACTG,SAAS,MAAM;EACjB,CAAA;sCACM,SAAA,cAAA,SAAA,IAAA;GAjCKM,OAAAA,WAAAA,QAAAA,MAAAA;;MAmCVR,wBAAO,UAAU;IAAED,SAAS;EAAO,CAAA;;GAnCzBS,OAAAA,WAAAA,QAAAA,MAAAA;;MAsCVR,wBAAO,WAAW;IAAE3T,QAAQ;IAAK4T,UAAU;IAAMF,SAAS;EAAO,CAAA;;GAtCvDS,OAAAA,WAAAA,UAAAA,MAAAA;;MAyCVR,wBAAO,WAAW;IACjB3T,QAAQ;IACR6T,SAAS;IACTzS,MAAM;IACNsS,SAAS;EACX,CAAA;;GA9CWS,OAAAA,WAAAA,cAAAA,MAAAA;;MAiDVR,wBAAO,WAAW;IAAEE,SAAS;IAAGH,SAAS;EAAO,CAAA;;GAjDtCS,OAAAA,WAAAA,OAAAA,MAAAA;;MAoDVR,wBAAO,aAAa;IAAEvS,MAAM;IAAgBwS,UAAU;IAAMF,SAAS;EAAU,CAAA;;GApDrES,OAAAA,WAAAA,cAAAA,MAAAA;;MAuDVR,wBAAO,aAAa;IAAEvS,MAAM;IAAYwS,UAAU;IAAMF,SAAS;EAAO,CAAA;;GAvD9DS,OAAAA,WAAAA,WAAAA,MAAAA;;MA0DVU,kCAAiB;IAAEzT,MAAM;IAAoBsS,SAAS;EAAS,CAAA;sCAChD,SAAA,cAAA,SAAA,IAAA;GA3DLS,OAAAA,WAAAA,kBAAAA,MAAAA;AAAAA,SAAAA,cAAAA;MADZH,wBAAO,OAAA;GACKG,MAAAA;;;ACHb,IAAA1D,kBAAuD;;;;;;;;;;;;;;;;;;AAGvD,IAAaqE,UAANvP,MAAA,MAAA;EAAA;AAELjE;AAGA+L;AAGA5K;AAGArB;AAGAzN;AAOAohB;AAOAC;;AACF,GA7BO,OAAAzP,KAAA,WAAAA;;MACJkO,wCAAuB;IAAEhgB,MAAM;EAAM,CAAA;;GAD3BqhB,OAAAA,WAAAA,MAAAA,MAAAA;;MAIVnB,wBAAO,WAAW;IAAE3T,QAAQ;IAAKoB,MAAM;IAAYsS,SAAS;EAAS,CAAA;;GAJ3DoB,OAAAA,WAAAA,WAAAA,MAAAA;;MAOVnB,wBAAO,OAAO;IAAEvS,MAAM;IAAWsS,SAAS;EAAS,CAAA;;GAPzCoB,OAAAA,WAAAA,UAAAA,MAAAA;;MAUVnB,wBAAO,WAAW;IAAE3T,QAAQ;IAAK4T,UAAU;IAAMF,SAAS;EAAO,CAAA;;GAVvDoB,OAAAA,WAAAA,QAAAA,MAAAA;;MAaVnB,wBAAO,WAAW;IAAED,SAAS;IAAQG,SAAS;EAAE,CAAA;;GAbtCiB,OAAAA,WAAAA,UAAAA,MAAAA;;MAgBVnB,wBAAO,aAAa;IACnBD,SAAS;IACTtS,MAAM;IACNyS,SAAS,MAAM;EACjB,CAAA;sCACY,SAAA,cAAA,SAAA,IAAA;GArBDiB,OAAAA,WAAAA,cAAAA,MAAAA;;MAuBVnB,wBAAO,OAAO;IACbvS,MAAM;IACNyS,SAAS;IACTH,SAAS;EACX,CAAA;;GA3BWoB,OAAAA,WAAAA,eAAAA,MAAAA;AAAAA,SAAAA,cAAAA;MADZd,wBAAO,QAAA;GACKc,MAAAA;;;ACHb,IAAArE,kBAAuD;;;;;;;;;;;;;;;;;;AAGvD,IAAawE,QAAN1P,OAAA,MAAA;EAAA;AAELjE;AAGAmB;AAOA4R;AAGAjT;AAGAnB;AAGAwU;;AACF,GAtBO,OAAAlP,MAAA,SAAAA;;MACJkO,wCAAuB;IAAEhgB,MAAM;IAAOigB,SAAS;EAAK,CAAA;;GAD1CuB,KAAAA,WAAAA,MAAAA,MAAAA;;MAIVtB,wBAAO,OAAO;IAAEvS,MAAM;IAAWsS,SAAS;EAAS,CAAA;;GAJzCuB,KAAAA,WAAAA,UAAAA,MAAAA;;MAOVtB,wBAAO,WAAW;IACjB3T,QAAQ;IACRoB,MAAM;IACNsS,SAAS;EACX,CAAA;;GAXWuB,KAAAA,WAAAA,eAAAA,MAAAA;;MAcVtB,wBAAO,WAAW;IAAE3T,QAAQ;IAAK0T,SAAS;EAAO,CAAA;;GAdvCuB,KAAAA,WAAAA,QAAAA,MAAAA;;MAiBVtB,wBAAO,WAAW;IAAE3T,QAAQ;IAAK0T,SAAS;EAAS,CAAA;;GAjBzCuB,KAAAA,WAAAA,KAAAA,MAAAA;;MAoBVtB,wBAAO,WAAW;IAAEE,SAAS;IAAGH,SAAS;EAAO,CAAA;;GApBtCuB,KAAAA,WAAAA,OAAAA,MAAAA;AAAAA,OAAAA,cAAAA;MADZjB,wBAAO,MAAA;GACKiB,IAAAA;;;ACHb,IAAAxE,kBAAuD;;;;;;;;;;;;;;;;;;AAGvD,IAAayE,YAAN3P,OAAA,MAAA;EAAA;AAELjE;AAGAmB;AAOA4K;AAGA7b;AAGA2jB;AAGAC;AAOArgB;AAGAsgB;AAOAC;AAOAC;AAQAC;AAGAC;;AACF,GAzDO,OAAAlQ,MAAA,aAAAA;;MACJkO,wCAAuB;IAAEhgB,MAAM;EAAM,CAAA;;GAD3ByhB,SAAAA,WAAAA,MAAAA,MAAAA;;MAIVvB,wBAAO,OAAO;IAAEvS,MAAM;IAAWsS,SAAS;EAAY,CAAA;;GAJ5CwB,SAAAA,WAAAA,UAAAA,MAAAA;;MAOVvB,wBAAO,WAAW;IACjB3T,QAAQ;IACRoB,MAAM;IACNsS,SAAS;EACX,CAAA;;GAXWwB,SAAAA,WAAAA,WAAAA,MAAAA;;MAcVvB,wBAAO,WAAW;IAAE3T,QAAQ;IAAM4T,UAAU;IAAMF,SAAS;EAAS,CAAA;;GAd1DwB,SAAAA,WAAAA,YAAAA,MAAAA;;MAiBVvB,wBAAO,WAAW;IAAED,SAAS;IAASG,SAAS;EAAE,CAAA;;GAjBvCqB,SAAAA,WAAAA,WAAAA,MAAAA;;MAoBVvB,wBAAO,WAAW;IAAE3T,QAAQ;IAAM4T,UAAU;IAAMF,SAAS;EAAQ,CAAA;;GApBzDwB,SAAAA,WAAAA,UAAAA,MAAAA;;MAuBVvB,wBAAO,WAAW;IACjB3T,QAAQ;IACR4T,UAAU;IACVF,SAAS;EACX,CAAA;;GA3BWwB,SAAAA,WAAAA,QAAAA,MAAAA;;MA8BVvB,wBAAO,aAAa;IAAEC,UAAU;IAAMF,SAAS;EAAO,CAAA;;GA9B5CwB,SAAAA,WAAAA,OAAAA,MAAAA;;MAiCVvB,wBAAO,WAAW;IACjBvS,MAAM;IACNpB,QAAQ;IACR0T,SAAS;EACX,CAAA;;GArCWwB,SAAAA,WAAAA,YAAAA,MAAAA;;MAwCVvB,wBAAO,WAAW;IACjBvS,MAAM;IACNsS,SAAS;IACTG,SAAS;EACX,CAAA;;GA5CWqB,SAAAA,WAAAA,eAAAA,MAAAA;;MA+CVvB,wBAAO,WAAW;IACjBvS,MAAM;IACNpB,QAAQ;IACR0T,SAAS;IACTG,SAAS;EACX,CAAA;;GApDWqB,SAAAA,WAAAA,aAAAA,MAAAA;;MAuDVvB,wBAAO,QAAQ;IAAEC,UAAU;EAAK,CAAA;;GAvDtBsB,SAAAA,WAAAA,OAAAA,MAAAA;AAAAA,WAAAA,cAAAA;MADZlB,wBAAO,WAAA;GACKkB,QAAAA;;;ACMN,IAAMQ,WAAW;EAACzC;EAAMgB;EAAUE;EAAOW;EAAQG;EAAMC;;;;ACT9D,IAAAnc,uBAAoB;AAQpB,IAAA0X,kBAEO;AAKA,IAAIkF;AAEX,eAAsBC,cAAAA;AACpB,QAAM5Z,MAAM7C,YAAYmC,oBAAoB,OAAA;AAC5Cqa,kBAAgB,IAAIE,2BAAW;IAC7BpiB,MAAM;IACN1D,MAAMiM,IAAIjM;IACVC,MAAMgM,IAAIhM;IACV8lB,UAAU9Z,IAAI9L;IACdC,UAAU6L,IAAI7L;IACdF,UAAU+L,IAAI/L;IACdylB;IACAK,aAAa;IACbC,SAASpmB,qBAAAA,QAAQoH,IAAIif,aAAa;EACpC,CAAA;AAEA,QAAMN,cAAcO,WAAU;AAChC;AAfsBN;AAoBf,IAAMO,kBAAN,MAAMA,gBAAAA;EAAN;AACKC;AAEAC;;EAEVC,QAAQxE,OAAmC;AACzC,WAAO,KAAKsE,WAAWE,QAAQ;MAC7BxE;IACF,CAAA;EACF;EAEAyE,SAASzE,OAAoC1H,KAA0B;AACrE,WAAO,KAAKgM,WAAWhY,KAAK;MAC1B0T;MACA,GAAG1H;IACL,CAAA;EACF;EAEAoM,sBACE1E,OACAH,SACA;AACA,WAAO,KAAKyE,WACTK,mBAAmB,KAAKJ,UAAU,EAClCK,OAAO/E,QAAQjM,IAAIa,CAAAA,MAAK,GAAG,KAAK8P,UAAU,IAAIre,OAAOuO,CAAAA,CAAAA,EAAI,CAAA,EACzDuL,MAAMA,KAAAA,EACN6E,QAAO;EACZ;EAEAC,mBACE9E,OACAzN,OACAuN,OACA;AACA,WAAO,KAAKwE,WAAWhY,KAAK;MAC1B0T;MACA+E,MAAMxS;MACNuN;IACF,CAAA;EACF;EAEAkF,OAAOpF,SAAY;AACjB,WAAO,KAAK0E,WAAWW,KAAKrF,OAAAA;EAC9B;EAEA9b,OAAO8b,SAAY;AACjB,WAAO,KAAK0E,WAAWW,KAAKrF,OAAAA;EAC9B;EAEAzT,WAAWyT,SAAc;AACvB,WAAO,KAAK0E,WAAWW,KAAKrF,OAAAA;EAC9B;EAEAsF,oBACElF,OACA7X,OACA;AACA,WAAO,KAAKmc,WACTK,mBAAmB,KAAKJ,UAAU,EAClCzgB,OAAM,EACNrB,IAAI0F,KAAAA,EACJ6X,MAAMA,KAAAA,EACNmF,QAAO;EACZ;EAEApiB,OAAO6c,SAA8B;AACnC,WAAO,KAAK0E,WAAWvhB,OAAO6c,OAAAA;EAChC;EAEA9D,MAAMkE,OAA4B;AAChC,WAAO,KAAKsE,WAAWxI,MAAM;MAC3BkE;IACF,CAAA;EACF;AACF;AA1EaqE;AAAN,IAAMA,iBAAN;;;;;;;;;;;;;;;AXSP,IAAae,sBAAN3R,OAAA,cAAiC4Q,eAAAA;EAAjC;;AACKC,sCAAaT,cAAcwB,cAAcC,QAAAA;AAEzCf,sCAAae,SAAehW;;AAGxC,GANwC+U,OAAAA,MAAAA,uBAAjC5Q;AAAM2R,qBAAAA,eAAAA;MADZlS,8BAAAA;GACYkS,kBAAAA;;;AY7Cb,IAAApgB,uBAAwB;;;;;;;;;;;;AAyBjB,SAASugB,YAAY3F,SAAwBC,UAAoB,CAAA,GAAE;AACxE,QAAM,EAAEZ,KAAK/O,OAAM,IAAKwP,mBAAmB,QAAQ;IACjDjY,MAAMmY;IACNC;EACF,CAAA;AACA,SAAO1W,OAAc8V,KAAAA,GAAQ/O,MAAAA;AAC/B;AANgBqV;;AAmBhB,IAAaC,kBAAN/R,OAAA,cAA6B4Q,eAAAA;EAA7B;;AACKC,sCAAaT,cAAcwB,cAAcI,IAAAA;AAEzClB,sCAAakB,KAAWnW;;AACpC,GAJoC+U,OAAAA,MAAAA,mBAA7B5Q;AAAM+R,iBAAAA,eAAAA;MADZtS,8BAAAA;GACYsS,cAAAA;;;AC7Cb;AAEO,IAAME,YAAY;EACvBtE,OAAO;IACLuE,OAAOxoB,QAAQ,MAAM,oBAAA;IACrByoB,OAAOzoB,QAAQ,MAAM,qBAAA;IACrB0oB,SAAS1oB,QAAQ,MAAM,iBAAA;EACzB;EACAmC,SAAS;IACPsmB,OAAOzoB,QAAQ,MAAM,uBAAA;IACrB2oB,UAAU3oB,QAAQ,MAAM,mBAAA;IACxBwoB,OAAOxoB,QAAQ,MAAM,kBAAA;IACrB4oB,QAAQ5oB,QAAQ,MAAM,mBAAA;IACtB6oB,KAAK7oB,QAAQ,MAAM,gBAAA;IACnB8oB,WAAW9oB,QAAQ,MAAM,mBAAA;EAC3B;EACAC,MAAM;IACJuoB,OAAOxoB,QAAQ,MAAM,YAAA;EACvB;EACA+oB,KAAK;IACHP,OAAOxoB,QAAQ,MAAM,WAAA;EACvB;EACAgpB,QAAQ;IACNH,KAAK7oB,QAAQ,MAAM,4CAAA;EACrB;AACF;AAEO,IAAMipB,gBAAgB;EAC3BR,OAAOzoB,QAAQ,MAAM,wBAAA;AACvB;AAEO,IAAMkpB,cAAc;EACzBhL,MAAM;IACJiL,YAAYnpB,QAAQ,MAAM,0BAAA;IAC1B2oB,UAAU3oB,QAAQ,MAAM,gBAAA;EAC1B;EACAopB,SAAS;IACPC,aAAarpB,QAAQ,MAAM,sBAAA;IAC3BspB,UAAUtpB,QAAQ,MAAM,gBAAA;EAC1B;AACF;AAEO,IAAMupB,YAAY;EACvBb,SAAS1oB,QAAQ,MAAM,gBAAA;AACzB;AAEO,IAAMwpB,YAAY;EACvBC,SAASzpB,QAAQ,MAAM,UAAA;EACvB0pB,WAAW1pB,QAAQ,MAAM,aAAA;EACzB2pB,eAAe3pB,QAAQ,MAAM,iBAAA;AAC/B;AAEO,IAAM4pB,cAAc;EACzBnB,OAAOzoB,QAAQ,MAAM,eAAA;AACvB;;;;;;;;;;;;;;;;;;;;Id1CqB6pB,mBAANvT,OAAA,MAAA;EAAA;AAEL2G;AAGA6M;AAGAC;AAGAC;AAGA9M;;EAER,MAAM+M,mBAAmB7L,SAAiB;AACxC,UAAMnd,QAAO,KAAKgc,IAAIhX,IAAI2L;AAC1B,UAAMsY,YACJ,MAAM,KAAKJ,mBAAmBvC,sBAC5B;MACE/T,QAAQvS,MAAKoR;IACf,GACA;MAAC;MAAW;KAAO,GAErBjH,OAAOkM,CAAAA,MAAKA,EAAE8G,YAAYA,OAAAA;AAC5B,QAAI,CAAC8L,SAASnZ,QAAQ;AACpB,aAAO,CAAA;IACT;AAEA,UAAMoZ,WAAW,MAAM,KAAKJ,eAAexC,sBACzC;MACEvW,OAAGoZ,oBAAGF,SAASzT,IAAIa,CAAAA,MAAKA,EAAE8G,OAAO,CAAA;IACnC,GACA;MAAC;MAAK;KAAO;AAGf,UAAM9T,OAAO6f,SAAS1T,IAAI,CAACa,MAAAA;AACzB,YAAM,EAAExR,KAAI,IAAKokB,SAAS/a,KAAKkb,CAAAA,OAAMA,GAAGjM,YAAY9G,EAAEtG,CAAC;AACvD,aAAO;QACLoN,SAAS9G,EAAEtG;QACXmB,MAAMmF,EAAEnF;QACRrM;MACF;IACF,CAAA;AACA,WAAOwE;EACT;EAEA,MAAMggB,YAAYC,SAAqD;AACrE,UAAM,EAAE/X,KAAKL,MAAM1P,IAAG,IAAK8nB;AAC3B,UAAMC,OAAO,MAAM,KAAKT,eAAe1C,QAAQ;MAC7CrW,GAAGvO;MACH+Q,QAAQ,KAAKyJ,IAAIhX,IAAI2L,SAASS;IAChC,CAAA;AACA,QAAI,CAACmY,MAAM;AACT,YAAMtB,YAAYE,QAAQC;IAC5B;AACA,UAAMoB,cAAc,KAAKT,iBAAiBzX,eAAe9P,KAAK0P,MAAMK,GAAAA;AACpE,SAAK0K,gBAAgBvH,IACnB,YACA,GAAG,KAAKsH,IAAIhX,IAAI2L,SAASzP,OAAO,0CAAYsoB,WAAAA,IAC5C;MACEA;IACF,CAAA;AAEF,SAAKT,iBAAiBtP,eAAe+P,WAAAA;EACvC;EAEA,MAAMC,YAAYjoB,KAAa;AAC7B,UAAM0nB,WAAW,MAAM,KAAKL,mBAAmBzC,QAAQ;MACrDjJ,SAAS3b;IACX,CAAA;AACA,UAAM,EACJF,UACA2jB,SACAC,QACArgB,MACAugB,UAAUsE,OACVrE,aAAahB,QACbkB,KACAD,UAAS,IACP4D,YAAY,CAAC;AACjB,QAAI,EAAE/D,IAAG,IAAK+D,YAAY,CAAC;AAC3B,QAAI/D,OAAOA,KAAK9R,SAAS;AACvB8R,YAAM,IAAIzgB,KAAKygB,IAAI9R,QAAO,IAAK,IAAI,KAAK,KAAK,GAAA;IAC/C;AACA,SAAKyV,eACF1C,QAAQ;MACPrW,GAAGvO;IACL,CAAA,EACC+K,KAAK,CAACgd,SAAAA;AACL,UAAIA,MAAM;AACR,aAAKtN,gBAAgBvH,IACnB,YACA,qDAAa6U,KAAKrY,IAAI,iBACtB;UACE1P;UACA0P,MAAMqY,KAAKrY;QACb,CAAA;MAEJ;IACF,CAAA;AAEF,WAAO;MACL5P;MACA2jB;MACAC;MACArgB;MACA6kB;MACAvE;MACAd;MACAkB;MACAD;IACF;EACF;EAEA,MAAMqE,eAAeL,SAAS9nB,KAAa;AACzC,UAAM,EAAEF,UAAU2jB,SAASC,QAAQrgB,MAAMsgB,KAAKd,QAAQkB,KAAKD,UAAS,IAChEgE;AACJ,QAAI,EAAEI,MAAK,IAAKJ;AAChB,UAAM,EAAElY,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AAEzD,QAAI+Y,UAAU/d,QAAW;AACvB+d,cAAQ5a,aAAAA;IACV;AACA,QAAI,CAACxN,YAAYA,aAAaqK,QAAW;AAEvC,WAAKod,iBAAiB7M,YAAY,eAAe1a,GAAAA,YAAe;IAClE;AACA,UAAMggB,UAAU;MACdlgB;MACA2jB;MACAC;MACArgB;MACAsgB;MACAC,UAAUsE;MACVrE,aAAahB;MACbkB;MACAD;IACF;AACA,QAAIA,cAAc,IAAI;AACpB9D,cAAQ8D,YAAY3Z;IACtB;AACA,UAAM,KAAKkd,mBAAmB/B,oBAC5B;MACE3J,SAAS3b;MACT+Q;IACF,GACAiP,OAAAA;AAIF,SAAKsH,eAAe1C,QAAQ;MAAErW,GAAGvO;IAAI,CAAA,EAAG+K,KAAK,CAACgd,SAAAA;AAC5C,YAAM,CAACM,EAAAA,IAAM7e,OAAOC,KAAKuW,OAAAA,EAASrX,OAAOiF,CAAAA,MAAKoS,QAAQpS,CAAAA,MAAOzD,MAAAA;AAC7D,YAAMme,QAAQ;QACZxoB,UAAU;QACV2jB,SAAS;QACTpgB,MAAM;QACNsgB,KAAK;QACLE,aAAa;QACbE,KAAK;QACLD,WAAW;MACb;AAEA,UAAIiE,MAAM;AACR,aAAKtN,gBAAgBvH,IACnB,YACA,wCAAUoV,MAAMD,EAAAA,CAAG,iBAAOD,UAAAA,iBAAiBL,KAAKrY,IAAI,iBACpD;UACE1P;UACA0P,MAAMqY,KAAKrY;UACXhQ,SAAS0oB;UACTvgB,MAAMigB;QACR,CAAA;MAEJ;IACF,CAAA;EACF;EAEAS,eAAeb,UAAoB;AACjC,UAAM7f,OAA0B;MAC9Bgc,aAAazC,QAAQC;MACrBvhB,UAAU;MACV2jB,SAASrC,QAAQC;MACjBqC,QAAQ;MACRrgB,MAAMyE,KAAKgB,UAAU;QAAC;OAAK;MAC3B8a,UAAUtW,aAAAA;MACVqW,KAAK;IACP;AACAna,WAAOmN,OAAO+Q,UAAU7f,IAAAA;AAExB,WAAO,KAAKwf,mBAAmBjC,OAAOsC,QAAAA;EACxC;AACF,GAjMe,OAAA7T,MAAA,oBAAAA;;MACZR,gCAAAA;uCACY,YAAA,cAAA,SAAA,OAAA;GAFM+T,gBAAAA,WAAAA,OAAAA,MAAAA;;MAIlB9L,6BAAOkK,kBAAAA;uCACoB,uBAAA,cAAA,SAAA,kBAAA;GALT4B,gBAAAA,WAAAA,sBAAAA,MAAAA;;MAOlB9L,6BAAOsK,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GARLwB,gBAAAA,WAAAA,kBAAAA,MAAAA;;MAUlB9L,6BAAOC,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GAXP6L,gBAAAA,WAAAA,oBAAAA,MAAAA;;MAalB9L,6BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAdNoU,gBAAAA,WAAAA,mBAAAA,MAAAA;AAAAA,kBAAAA,eAAAA;MADpB9T,8BAAAA;GACoB8T,eAAAA;;;AeZrB,IAAA/f,uBAAoB;AACpB,IAAAjC,uBAAwB;;;ACCvB,IACM;UAAKojB,aAAU;AAAVA,EAAAA,YAAAA;;;;IAIVC;EAAAA,IAAS,CAAA,IAATA;AAJUD,EAAAA,YAAAA;;;;IAQVE;EAAAA,IAAQ,CAAA,IAARA;AARUF,EAAAA,YAAAA;;;;IAYVG;EAAAA,IAAAA,CAAAA,IAAAA;GAZUH,eAAAA,aAAAA,CAAAA,EAAAA;IAkBL;UAAKI,cAAW;AAAXA,EAAAA,aAAAA;;;;IAIVH;EAAAA,IAAAA,CAAAA,IAAAA;AAJUG,EAAAA,aAAAA;;;;IAQVC;EAAAA,IAAAA,CAAAA,IAAAA;AARUD,EAAAA,aAAAA;;;;IAYVE;EAAAA,IAAAA,CAAAA,IAAAA;GAZUF,gBAAAA,cAAAA,CAAAA,EAAAA;;;ACrBL,SAASG,SAASC,MAAM7Q,OAAa;AAC1C,QAAM8Q,SAAS,CAAC;AAEhB,SAAO,SAAUC,SAAS5Q,MAAI;AAC5B,QAAI,CAAC2Q,OAAOC,IAAAA,GAAO;AACjBF,WAAKG,MAAM,MAAM7Q,IAAAA;AACjB2Q,aAAOC,IAAAA,IAAQhV,WAAW,MAAA;AACxB,eAAO+U,OAAOC,IAAAA;MAChB,GAAG/Q,KAAAA;IACL;EACF;AACF;AAXgB4Q;;;;;;;;;;;;;;;IFUKK,gBAANvV,OAAA,MAAA;EAAA;AAwFbwV,2CAAkBN,SAAS,OAAOO,WAAiB9mB,UAAAA;AAEjD,YAAM2M,WAAW,MAAM8U,cAAcsF,QAAQ3E,QAAQrD,OAAM;QACzDnB,OAAO;UACLxQ,IAAI0Z,UAAU1Z;QAChB;MACF,CAAA;AAEA,UAAI,CAACT,UAAU;AACb,aAAKqa,aAAahnB,KAAAA;AAClB;MACF;AACA,YAAMinB,eAAe,MAAM,KAAKC,aAAava,SAASzP,OAAO;AAE7D,UAAI;QAACkpB,YAAYE;QAAKF,YAAYC;QAAQ3N,SAAS/L,SAASlN,MAAM,GAAG;AACnE,aAAKunB,aAAahnB,KAAAA;AAElBJ,gBAAQqB,IAAI,4BAAQ0L,SAASzP,SAAS,+BAAA;AACtC+pB,qBAAaphB,QAAQ,CAAC7F,WAAAA;AACpB+S,0BAAgB/S,MAAAA;QAClB,CAAA;AACA;MACF;AAGA,YAAM8d,SAAS,MAAM9V,QAAQ+R,IAC3BkN,aAAazV,IAAIxR,CAAAA,WAASyS,YAAYzS,MAAAA,CAAAA,CAAAA;AAExC,YAAMmnB,eAAeF,aAAa9gB,OAAO,CAACihB,GAAGC,QAAAA;AAC3C,eAAOvJ,OAAOuJ,GAAAA;MAChB,CAAA;AACA,UAAIF,aAAarb,WAAWmb,aAAanb,QAAQ;AAC/CsG,sBACE,KAAKkV,eAAe3a,SAASzP,OAAO,GACpCoI,KAAKgB,UAAU6gB,YAAAA,CAAAA;MAEnB;IACF,GAAG,GAAA;;EA5HHI,UAAUvnB,OAAO;AACf,WAAOtE,qBAAAA,QAAQoH,IAAI0kB,eAAexnB;EACpC;EAEAsnB,eAAepqB,SAAS;AACtB,WAAO,GAAGxB,qBAAAA,QAAQoH,IAAI0kB,YAAY,WAAWtqB,OAAAA;EAC/C;EAEA,MAAMuqB,kBAAkBzrB,OAAY0rB,UAAU,KAAK,KAAK,KAAK,GAAG;AAC9D,UAAM,EAAExqB,SAAS+hB,OAAAA,OAAK,IAAKjjB;AAC3B,UAAMgE,QAAQsK,WAAW;MAACpN;MAAS+hB;MAAOve,KAAKD,IAAG;MAAI/C,KAAI,CAAA;AAC1D,UAAM6pB,YAAY,KAAKA,UAAUvnB,KAAAA;AAEjCoS,kBAAcmV,WAAWjiB,KAAKgB,UAAUtK,KAAAA,GAAO0rB,OAAAA;AAE/C,UAAMT,eAAe,MAAM,KAAKC,aAAahqB,OAAAA;AAC7C+pB,iBAAazgB,KAAK+gB,SAAAA;AAClBnV,kBAAc,KAAKkV,eAAepqB,OAAAA,GAAUoI,KAAKgB,UAAU2gB,YAAAA,CAAAA;AAC3D,WAAOjnB;EACT;EAEAgnB,aAAahnB,OAAe;AAC1BJ,YAAQqB,IAAI,qBAAWjB,KAAAA;AACvB+S,oBAAgB,KAAKwU,UAAUvnB,KAAAA,CAAAA;EACjC;EAEA+S,gBAAgBvV,KAAa;AAC3BuV,oBAAgBvV,GAAAA;EAClB;EAEA,MAAM0pB,aAAahqB,SAAoC;AACrD,UAAMoqB,iBAAiB,KAAKA,eAAepqB,OAAAA;AAC3C,UAAMqN,MAAM,MAAMkI,YAAY6U,cAAAA;AAC9B,QAAI;AACF,UAAI/c,KAAK;AACP,eAAOjF,KAAKC,MAAMgF,GAAAA;MACpB;AACA,aAAO,CAAA;IACT,SACOnB,GAAG;AACR,aAAO,CAAA;IACT;EACF;EAEA,MAAMkF,YAAYtO,OAA8B;AAC9C,QAAI,CAACA,OAAO;AACV,aAAO;IACT;AACA,UAAMqS,IAAI,MAAMI,YAAY,KAAK8U,UAAUvnB,KAAAA,CAAAA;AAC3C,QAAIqS,GAAG;AACL,aAAO/M,KAAKC,MAAM8M,CAAAA;IACpB;AACA,WAAO;EACT;;EAGA,MAAMsV,aAAa3nB,OAAe0nB,UAAU,KAAK,KAAK,KAAK,GAAG;AAC5D,UAAM1rB,QAAO,MAAM,KAAKsS,YAAYtO,KAAAA;AACpCoS,kBAAc,KAAKmV,UAAUvnB,KAAAA,GAAQsF,KAAKgB,UAAUtK,KAAAA,GAAO0rB,OAAAA;EAC7D;EAEAE,cAAcC,YAAoB7sB,MAAc0sB,UAAU,KAAK,GAAG;AAChEtV,kBACE,GAAG1W,qBAAAA,QAAQoH,IAAI0kB,YAAY,SAASK,UAAAA,IACpC7sB,MACA0sB,OAAAA;EAEJ;EAEAI,cAAcD,YAAoB;AAChC,WAAOpV,YAAY,GAAG/W,qBAAAA,QAAQoH,IAAI0kB,YAAY,SAASK,UAAAA,EAAY;EACrE;EAEAE,kBAAkBF,YAAoB;AACpC,WAAO9U,gBAAgB,GAAGrX,qBAAAA,QAAQoH,IAAI0kB,YAAY,SAASK,UAAAA,EAAY;EACzE;;;;EAKAG,YAAYhsB,OAAY0rB,UAAU,KAAK,KAAK,KAAK,GAAG;AAClD,UAAM,EAAExqB,SAAS+hB,OAAAA,OAAK,IAAKjjB;AAC3B,UAAMgE,QAAQsK,WAAW;MAACpN;MAAS+hB;MAAOve,KAAKD,IAAG;MAAI/C,KAAI,CAAA;AAC1D0U,kBAAc,KAAKmV,UAAUvnB,KAAAA,GAAQsF,KAAKgB,UAAUtK,KAAAA,GAAO0rB,OAAAA;AAC3D,WAAO1nB;EACT;EAyCA,MAAMioB,cAAchB,cAAwB/pB,SAAiB;AAE3D,UAAM4gB,SAAS,MAAM9V,QAAQ+R,IAC3BkN,aAAazV,IAAIxR,CAAAA,UAASyS,YAAYzS,KAAAA,CAAAA,CAAAA;AAExC,UAAMmnB,eAAeF,aAAa9gB,OAAO,CAACihB,GAAGC,QAAAA;AAC3C,aAAOvJ,OAAOuJ,GAAAA;IAChB,CAAA;AACA,QAAIF,aAAarb,WAAWmb,aAAanb,QAAQ;AAC/C,YAAMsG,cACJ,KAAKkV,eAAepqB,OAAAA,GACpBoI,KAAKgB,UAAU6gB,YAAAA,CAAAA;IAEnB;EACF;AACF,GA9Ie,OAAA9V,MAAA,iBAAAA;AAAMuV,eAAAA,eAAAA;MADpB9V,8BAAAA;GACoB8V,YAAAA;;;AGTrB,IAAAhkB,uBAAgC;;;ACAhC,IAAAA,uBAAwB;;;;;;;;;;;;AAYjB,SAASslB,oBAAoBhrB,SAAe;AACjD,QAAM,EAAE2f,KAAK/O,OAAM,IAAKwP,mBAAmB,QAAQ;IACjDjY,MAAM;MACJnI;IACF;EACF,CAAA;AACA,SAAO6J,OAAc8V,KAAAA,GAAQ/O,MAAAA;AAC/B;AAPgBoa;AAST,SAASC,kBAAkBnJ,OAAa;AAC7C,QAAM,EAAEnC,KAAK/O,OAAM,IAAKwP,mBAAmB,QAAQ;IACjDjY,MAAM;MACJ2Z;IACF;EACF,CAAA;AACA,SAAOjY,OAAc8V,KAAAA,GAAQ/O,MAAAA;AAC/B;AAPgBqa;AAST,SAASC,eAAehb,IAAU;AACvC,QAAM,EAAEyP,KAAK/O,OAAM,IAAKwP,mBAAmB,QAAQ;IACjDjY,MAAM;MACJ+H;IACF;EACF,CAAA;AACA,SAAOrG,OAAc8V,KAAAA,GAAQ/O,MAAAA;AAC/B;AAPgBsa;AAShB,SAASC,mBAAmB7K,SAAa;AACvC,QAAM8H,UAAU;IAAE,GAAG9H;EAAQ;AAC7B,SAAO8H,QAAQgD;AACf,SAAOhD;AACT;AAJS+C;AAMF,SAASE,WAAW/K,SAAa;AACtC,QAAM,EAAEX,KAAK/O,OAAM,IAAKsQ,mBAAmB,QAAQ;IACjD3e,QAAQ2mB,YAAYH;IACpB,GAAGoC,mBAAmB7K,OAAAA;EACxB,CAAA;AACA,SAAOzW,OAAgB8V,KAAAA,GAAQ/O,MAAAA;AACjC;AANgBya;AAQT,SAASC,WAAWhL,SAAejO,GAAO;AAC/C,QAAM,EAAEsN,KAAK/O,OAAM,IAAK0Q,mBACtB,QACA6J,mBAAmB7K,OAAAA,GACnB6K,mBAAmB9Y,CAAAA,CAAAA;AAErB,SAAOxI,OAAgB8V,KAAAA,GAAQ/O,MAAAA;AACjC;AAPgB0a;AAST,SAASC,cAAchL,SAAiB;AAC7C,QAAM,EAAEZ,KAAK/O,OAAM,IAAKwP,mBAAmB,QAAQ;IACjDjY,MAAM,CAAC;IACPoY;IACAC,OAAO;EACT,CAAA;AACA,SAAO3W,OAAc8V,KAAAA,GAAQ/O,MAAAA;AAC/B;AAPgB2a;;AAUhB,IAAaC,kBAANrX,OAAA,cAA6B4Q,eAAAA;EAA7B;;AACKC,sCAAaT,cAAcwB,cAAc0F,KAAAA;AAEzCxG,sCAAawG,MAAWzb;;AACpC,GAJoC+U,OAAAA,MAAAA,mBAA7B5Q;AAAMqX,iBAAAA,eAAAA;MADZ5X,8BAAAA;GACY4X,cAAAA;;;ACxEN,IAAME,SACX;AAGK,IAAMC,WAAW;AAGjB,IAAMC,YAAY;AAGlB,IAAMC,WAAW;;;AFXW,SAAAjR,eAAA,YAAA,QAAA,KAAA,MAAA;;;;;;;;;;AAAA,OAAAA,gBAAA;;;;;;AAAnC,IAAAzG;IAaqB2X,eAAN3X,OAAA,MAAA;EAAA;AAEL4G;AAGAgR;AAGAC;;EAER,MAAMC,SAAS7D,SAAc;AAC3B,UAAM,EACJpoB,SACA4mB,KACAD,WACA7E,OACAhkB,KAAI,IACFsqB;AACJ,UAAM,EAAE5d,cAAa,IAAKzC,YAAYuC,cAAa;AAEnD,QAAIE,iBAAiB,CAACmc,WAAW;AAC/B,YAAMP,UAAUpmB,QAAQ2mB;IAC1B;AAGA,QAAI,CAACgF,SAAShe,KAAK3N,OAAAA,GAAU;AAC3B,WAAK+a,gBAAgBvH,IAAI,QAAQ,+CAAYxT,OAAAA,6BAAgB;QAC3DA;MACF,CAAA;AACA,YAAMomB,UAAUpmB,QAAQqmB;IAC1B;AACA,QAAI,CAACuF,UAAUje,KAAKiZ,GAAAA,GAAM;AACxB,WAAK7L,gBAAgBvH,IACnB,QACA,+CAAYxT,OAAAA,+CACZ;QACEA;MACF,CAAA;AAEF,YAAMomB,UAAUQ,IAAIP;IACtB;AAEA,QAAIvnB,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAAEllB;IAAQ,CAAA;AAEvD,QAAI0rB,OAAO/d,KAAK3N,OAAAA,KAAY,CAAClB,OAAM;AACjCA,MAAAA,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;QAAEpD,OAAO9hB;MAAQ,CAAA;IAC5D;AAEA,QAAIlB,OAAM;AACR,WAAKic,gBAAgBvH,IAAI,QAAQ,+CAAYxT,OAAAA,uBAAe;QAC1DA;MACF,CAAA;AACA,YAAMomB,UAAUpmB,QAAQsmB;IAC1B;AAGA,QAAIK,WAAW;AACb,UAAI,CAAC+E,OAAO/d,KAAKmU,KAAAA,GAAQ;AACvB,aAAK/G,gBAAgBvH,IACnB,QACA,+CAAYsO,KAAAA,6BACZ;UACEA;QACF,CAAA;AAEF,cAAMsE,UAAUtE,MAAMuE;MACxB;AACA,YAAM6F,YAAY,MAAM,KAAKF,aAAapB,cAAc9I,KAAAA;AACxD,UAAI,CAAChkB,QAAQA,SAASouB,WAAW;AAC/B,aAAKnR,gBAAgBvH,IAAI,QAAQ,6EAAiB1V,IAAAA,IAAQ;UACxDA;UACAouB;QACF,CAAA;AACA,cAAM9F,UAAUtoB,KAAKuoB;MACvB;AAEAvnB,MAAAA,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;QAAEpD;MAAM,CAAA;AAEjD,UAAI,CAAChjB,OAAM;AACTA,QAAAA,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;UAAEllB,SAAS8hB;QAAM,CAAA;MAC5D;AAEA,UAAIhjB,OAAM;AACR,aAAKic,gBAAgBvH,IAAI,QAAQ,+CAAYsO,KAAAA,qBAAW;AACxD,cAAMsE,UAAUtE,MAAMwE;MACxB;AAEA,WAAK0F,aAAalC,aAAahI,KAAAA;IACjC;AAEA,SAAK/G,gBAAgBvH,IACnB,QACA,+CAAYxT,OAAAA,6BAAgB2mB,YAAY,WAAM,QAAA,6BAC9C;MACE3mB;MACA2mB;IACF,CAAA;AAGF,UAAMwF,IAAI,IAAItK,MAAAA;AACdsK,MAAEnsB,UAAUA;AACZmsB,MAAEptB,WAAWqO,WAAWwZ,GAAAA;AACxB,QAAID,WAAW;AACbwF,QAAErK,QAAQA;IACZ;AAEA,WAAO,KAAKiK,eAAerG,OAAOyG,CAAAA;EACpC;EAEA,MAAMC,MAAMpsB,SAAiB4mB,KAAa;AACxC,UAAMyF,UAAUX,OAAO/d,KAAK3N,OAAAA;AAE5B,QAAI,CAAC4rB,UAAUje,KAAKiZ,GAAAA,GAAM;AACxB,WAAK7L,gBAAgBvH,IACnB,QACA,yCAAWxT,OAAAA,+CACX;QACEA;MACF,CAAA;AAGF,YAAMomB,UAAUQ,IAAIP;IACtB;AAIA,QAAIvnB,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAAEllB;IAAQ,CAAA;AAEvD,QAAI,CAAClB,SAAQ,CAACutB,SAAS;AACrB,WAAKtR,gBAAgBvH,IAAI,QAAQ,yCAAWxT,OAAAA,uBAAe;QACzDA;MACF,CAAA;AACA,YAAMomB,UAAUpmB,QAAQqmB;IAC1B;AAGA,QAAI,CAACvnB,SAAQutB,SAAS;AACpBvtB,MAAAA,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;QAAEpD,OAAO9hB;MAAQ,CAAA;IAC5D;AACA,QAAI,CAAClB,OAAM;AACT,WAAKic,gBAAgBvH,IAAI,QAAQ,yCAAWxT,OAAAA,uBAAe;QACzDA;MACF,CAAA;AAEA,YAAMqsB,UAAUjG,UAAUtE,MAAMuE,QAAQD,UAAUpmB,QAAQqmB;IAC5D;AACA,QAAIvnB,MAAKC,aAAaqO,WAAWwZ,GAAAA,GAAM;AACrC,WAAK7L,gBAAgBvH,IAAI,QAAQ,yCAAWxT,OAAAA,mCAAiB;QAC3DA;MACF,CAAA;AAEA,YAAMomB,UAAUQ,IAAIP;IACtB;AACA,SAAKiG,gBAAgBxtB,KAAAA;AACrB,SAAKic,gBAAgBvH,IAAI,QAAQ,yCAAWxT,OAAAA,6BAAgB;MAC1DA;IACF,CAAA;AACA,WAAO,KAAK+rB,eAAevnB,OAAO1F,KAAAA;EACpC;EAEA,MAAMytB,YAAYzK,OAAehkB,MAAc;AAC7C,QAAI,CAAC4tB,OAAO/d,KAAKmU,KAAAA,GAAQ;AACvB,YAAMsE,UAAUtE,MAAMuE;IACxB;AACA,UAAMmG,cAAc1K,OAAOjhB,QACzB,iBACA,CAACqpB,GAAGpR,QAAQ2T,WAAW,GAAG3T,MAAAA,MAAY2T,MAAAA,EAAQ;AAEhD,UAAMtX,IAAI,MAAM,KAAK6W,aAAapB,cAAc9I,KAAAA;AAChD,QAAIhkB,SAASqX,GAAG;AACd,WAAK4F,gBAAgBvH,IAAI,QAAQ,iEAAe1V,IAAAA,IAAQ;QACtDA;QACAouB,WAAW/W;MACb,CAAA;AACA,YAAMiR,UAAUtoB,KAAKuoB;IACvB;AACA,UAAMvnB,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAAEpD;IAAM,CAAA;AAEvD,QAAI,CAAChjB,OAAM;AACT,WAAKic,gBAAgBvH,IAAI,QAAQ,+CAAYgZ,WAAAA,uBAAmB;QAC9D1K,OAAO0K;MACT,CAAA;AACA,YAAMpG,UAAUtE,MAAMyE;IACxB;AAEA,SAAK+F,gBAAgBxtB,KAAAA;AACrB,SAAKic,gBAAgBvH,IAAI,QAAQ,+CAAYgZ,WAAAA,6BAAoB;MAC/D1K,OAAO0K;IACT,CAAA;AACA,SAAKR,aAAanB,kBAAkB/I,KAAAA;AACpC,WAAO,KAAKiK,eAAevnB,OAAO1F,KAAAA;EACpC;EAEA,MAAM4tB,eAAetE,SAAS;AAC5B,UAAM,EAAEtqB,MAAMgkB,OAAO8E,IAAG,IAAKwB;AAE7B,UAAMoE,cAAc1K,OAAOjhB,QACzB,iBACA,CAACqpB,GAAGpR,QAAQ2T,WAAW,GAAG3T,MAAAA,MAAY2T,MAAAA,EAAQ;AAEhD,UAAMtX,IAAI,MAAM,KAAK6W,aAAapB,cAAc9I,KAAAA;AAChD,QAAIhkB,SAASqX,GAAG;AACd,WAAK4F,gBAAgBvH,IACnB,QACA,yCAAWgZ,WAAAA,0CAAuB1uB,IAAAA,IAClC;QACEgkB,OAAO0K;QACP1uB;QACAouB,WAAW/W;MACb,CAAA;AAEF,YAAMiR,UAAUtoB,KAAKuoB;IACvB;AACA,UAAMvnB,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAAEpD;IAAM,CAAA;AAEvD,QAAI,CAAChjB,OAAM;AACT,WAAKic,gBAAgBvH,IAAI,QAAQ,yCAAWgZ,WAAAA,uBAAmB;QAC7D1K,OAAO0K;MACT,CAAA;AACA,YAAMpG,UAAUtE,MAAMyE;IACxB;AACA,QAAI,CAACqF,UAAUje,KAAKiZ,GAAAA,GAAM;AACxB,WAAK7L,gBAAgBvH,IACnB,QACA,yCAAWgZ,WAAAA,+CACX;QACE1K,OAAO0K;MACT,CAAA;AAEF,YAAMpG,UAAUQ,IAAIP;IACtB;AACAvnB,IAAAA,MAAKC,WAAWqO,WAAWwZ,GAAAA;AAC3B,SAAKoF,aAAanB,kBAAkB/I,KAAAA;AACpC,SAAK/G,gBAAgBvH,IAAI,QAAQ,yCAAWgZ,WAAAA,6BAAoB;MAC9D1K,OAAO0K;IACT,CAAA;AAEA,SAAKF,gBAAgBxtB,KAAAA;AACrB,WAAO,KAAKitB,eAAevnB,OAAO1F,KAAAA;EACpC;;;;EAKAwtB,gBAAgBxtB,OAAY;AAC1B,UAAM,EAAEkB,QAAO,IAAKlB;AAEpB,QAAIA,MAAKyD,WAAW2mB,YAAYE,KAAK;AACnC,WAAKrO,gBAAgBvH,IACnB,QACA,qDAAaxT,OAAAA,6BACb;QACEA;MACF,CAAA;AAGF,YAAMomB,UAAUpmB,QAAQ0mB;IAC1B;AACA,QAAI5nB,MAAKyD,WAAW2mB,YAAYC,QAAQ;AACtC,YAAMwD,WAAW,IAAInpB,KAAK1E,MAAKqjB,QAAQ;AACvC,UAAIwK,SAASxa,QAAO,IAAK3O,KAAKD,IAAG,GAAI;AACnC,aAAKwX,gBAAgBvH,IACnB,QACA,qDAAaxT,OAAAA,qDAAoB+N,WAC/B4e,QAAAA,CAAAA,IAEF;UACE3sB;UACA2sB;QACF,CAAA;AAEF,cAAM;UACJ7uB,MAAMsoB,UAAUpmB,QAAQymB,OAAO3oB;UAC/BC,KAAKqoB,UAAUpmB,QAAQymB,OAAO1oB;UAC9BoK,MAAM;YACJga,UAAUrjB,MAAKqjB;UACjB;QACF;MACF;AACArjB,MAAAA,MAAKyD,SAAS2mB,YAAYH;AAC1BjqB,MAAAA,MAAKqjB,WAAW;IAClB;AAGArjB,IAAAA,MAAKojB,cAAc;AACnBpjB,IAAAA,MAAKmjB,YAAY,oBAAIze,KAAAA;EACvB;AACF,GA/Re,OAAA2Q,MAAA,gBAAAA;;MACZyH,6BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAFNwY,YAAAA,WAAAA,mBAAAA,MAAAA;;MAIlBlQ,6BAAO4P,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GALLM,YAAAA,WAAAA,kBAAAA,MAAAA;;MAOlBlQ,6BAAO8N,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GARHoC,YAAAA,WAAAA,gBAAAA,MAAAA;AAAAA,cAAAA,eAAAA;MADpBlY,8BAAAA;GACoBkY,WAAAA;;;AGZrB,IAAApmB,wBAA2C;;;ACA3C,IAAAA,wBAA2C;AAC3C,IAAAmC,kBAAmC;AAEnC,IAAAwX,kBAAmB;AACnB,IAAAuN,gBAAkB;;;ACJlB,IAAAlnB,wBAAwB;;;;;;;;;;;;AAgBjB,SAASmnB,eAAevM,SAAeC,UAAoB,CAAA,GAAE;AAClE,QAAM,EAAEZ,KAAK/O,OAAM,IAAKwP,mBAAmB,SAAS;IAClDjY,MAAMmY;IACNC;;IAEAC,OAAO;EACT,CAAA;AACA,SAAO3W,OAAc8V,KAAAA,GAAQ/O,MAAAA;AAC/B;AARgBic;AAUT,SAASC,YAAYxM,SAAeC,UAAoB,CAAA,GAAE;AAC/D,QAAM,EAAEZ,KAAK/O,OAAM,IAAKwP,mBAAmB,SAAS;IAClDjY,MAAM;MACJkb,KAAK;MACL,GAAG/C;IACL;IACAC;;IAEAC,OAAO;EACT,CAAA;AACA,SAAO3W,OAAc8V,KAAAA,GAAQ/O,MAAAA;AAC/B;AAXgBkc;AAuBT,SAASC,eAAeC,QAAcjR,MAAU;AACrD,QAAM,EAAE4D,KAAK/O,OAAM,IAAK0Q,mBAAmB,SAASvF,MAAMiR,MAAAA;AAC1D,SAAOnjB,OAAgB8V,KAAAA,GAAQ/O,MAAAA;AACjC;AAHgBmc;;AAoEhB,IAAaE,kBAAN9Y,OAAA,cAA6B4Q,eAAAA;EAA7B;;AACKC,sCAAaT,cAAcwB,cAAchD,MAAAA;AAEzCkC,sCAAalC,OAAM/S;;AAG/B,GANoC+U,OAAAA,MAAAA,mBAA7B5Q;AAAM8Y,iBAAAA,eAAAA;MADZrZ,+BAAAA;GACYqZ,cAAAA;;;AC3GN,SAASC,UAAUC,QAAuB;AAC/CrjB,SAAOmN,OAA6BkW,QAAQ;IAC1Cjd,IAAItC,aAAAA;IACJsV,MAAM,oBAAI1f,KAAAA;EACZ,CAAA;AACA,SAAOkJ,iBAAsB,UAAUygB,MAAAA;AACzC;AANgBD;AAOT,SAASE,kBAAkBD,QAA+B;AAC/D,SAAOD,UAAUC,MAAAA;AACnB;AAFgBC;AAIT,SAASC,gBAAgBxjB,QAA0B;AACxD,SAAOqD,oBAA4B,UAAUrD,MAAAA;AAC/C;AAFgBwjB;AAIT,SAASC,yBACdza,UACAC,UACAjJ,QAA0B;AAE1B,SAAOuC,aAAuB,CAACd,IAAIW,YAAAA;AACjCX,OAAGgB,WAAmB,QAAA,EACnBU,KAAKnD,MAAAA,EACLkJ,KAAK;MAAEN,KAAK;IAAG,CAAA,EACfO,KAAKH,QAAAA,EACLI,MAAMH,QAAAA,EACN7F,QAAO,EACP5B,KAAKY,OAAAA;EACV,CAAA;AACF;AAdgBqhB;AAgBT,SAASC,WAAoBJ,QAA8B;AAChE,SAAOpgB,eAA0B,UAAUogB,MAAAA;AAC7C;AAFgBI;AAIT,SAASC,aACd3jB,QACAsjB,QAA8B;AAE9B,SAAO9gB,iBAA4B,UAAUxC,QAAOsjB,MAAAA;AACtD;AALgBK;;;IC9CT;UAAKC,aAAU;AAAVA,EAAAA,YAAAA;;;;IAIVC;EAAAA,IAAAA,CAAAA,IAAAA;AAJUD,EAAAA,YAAAA;;;;IASVE;EAAAA,IAAAA,CAAAA,IAAAA;AATUF,EAAAA,YAAAA;;;;IAcVG;EAAAA,IAAAA,CAAAA,IAAAA;AAdUH,EAAAA,YAAAA;;;;IAmBVI;EAAAA,IAAAA,CAAAA,IAAAA;AAnBUJ,EAAAA,YAAAA;;;;IAwBVK;EAAAA,IAAAA,CAAAA,IAAAA;GAxBUL,eAAAA,aAAAA,CAAAA,EAAAA;IA0CL;UAAKM,iBAAc;AAAdA,EAAAA,gBAAAA;;;;IAIVC;EAAAA,IAAAA,CAAAA,IAAAA;AAJUD,EAAAA,gBAAAA;;;;IAQVE;EAAAA,IAAAA,CAAAA,IAAAA;AARUF,EAAAA,gBAAAA;;;;IAYVG;EAAAA,IAAAA,CAAAA,IAAAA;AAZUH,EAAAA,gBAAAA;;;;IAgBVI;EAAAA,IAAAA,CAAAA,IAAAA;GAhBUJ,mBAAAA,iBAAAA,CAAAA,EAAAA;;;AC1CZ,mBAAkB;AAEX,SAASK,UAAU5b,KAAUD,OAAU;AAC5C,aAAO8b,aAAAA,SAAM,IAAI7qB,KAAKgP,GAAAA,CAAAA,EAAM8b,SAAKD,aAAAA,SAAM,IAAI7qB,KAAK+O,KAAAA,CAAAA,GAAS,SAAS,IAAA;AACpE;AAFgB6b;;;ACDhB,IAAA1oB,wBAAwB;;;;;;;;;;;;AAYjB,SAAS6oB,aACdjO,SACAC,UAAoB;EAAC;GAAO;AAE5B,QAAM,EAAEZ,KAAK/O,OAAM,IAAKwP,mBAAmB,UAAU;IACnDjY,MAAMmY;IACNC;EACF,CAAA;AAEA,SAAO1W,OAAgB8V,KAAAA,GAAQ/O,MAAAA;AACjC;AAVgB2d;AAYT,SAASC,aAAarL,QAAkBsL,cAAsB,CAAC,GAAC;AACrEtL,SAAOxa,QAAQ,CAACqD,MAAAA;AACdlC,WAAOmN,OAAOjL,GAAGyiB,aAAaziB,CAAAA;EAChC,CAAA;AACA,QAAM,EAAE2T,KAAK/O,OAAM,IAAKwQ,uBAAuB,UAAU+B,MAAAA;AACzD,SAAOtZ,OAAgB8V,KAAAA,GAAQ/O,MAAAA;AACjC;AANgB4d;AAQT,SAASE,aAAavL,QAAuB;AAClD,QAAM,EAAExD,KAAK/O,OAAM,IAAKqQ,mBAAmB,UAAUkC,MAAAA;AACrD,SAAOtZ,OAAgB8V,KAAAA,GAAQ/O,MAAAA;AACjC;AAHgB8d;AAKT,SAASC,aAAaxL,QAAgB9Q,GAAS;AACpD,QAAM,EAAEsN,KAAK/O,OAAM,IAAK0Q,mBAAmB,UAAU6B,QAAQ9Q,CAAAA;AAC7D,SAAOxI,OAAgB8V,KAAAA,GAAQ/O,MAAAA;AACjC;AAHgB+d;;AAMhB,IAAaC,oBAANza,OAAA,cAA+B4Q,eAAAA;EAA/B;;AACKC,sCAAaT,cAAcwB,cAAc8I,MAAAA;AAEzC5J,sCAAa4J,OAAa7e;;AACtC,GAJsC+U,OAAAA,MAAAA,qBAA/B5Q;AAAMya,mBAAAA,eAAAA;MADZhb,+BAAAA;GACYgb,gBAAAA;;;;;;;;;;;;;;;;;;;;ILZQE,eAAN3a,OAAA,MAAA;EAAA;AAEL2G;AAGAiU;AAGAlH;AAGA9M;AAGA6M;AAGAmE;AAGAC;AAGAgD;AAGAC;;EAER,MAAMC,sBAAsB5O,SAAyB9D,OAAe;AAClE,WAAO,KAAKuS,eAAevJ,mBAAmBlF,SAAS9D,OAAO;MAC5DtM,IAAI;IACN,CAAA;EACF;EAEA4L,UAAUC,MAAY;AACpB,WAAO,eAAeA,KAAKC,YAAYD,KAAKE,OAAO,IAAIF,KAAKja,IAAI,IAC9Dia,KAAK/L,IAAI;EAEb;;;;EAKA,MAAMmf,aAAa9d,QAAgB;AAEjC,UAAM4J,QAAQ,MAAM,KAAK8T,eAAe5J,SAAS;MAC/C9T;IACF,CAAA;AAGA,UAAM+d,cAAc,MAAM,KAAKvH,iBAAiB1M,YAAYF,KAAAA;AAE5D,WAAOA,MAAM9Q,OAAO,CAACsD,KAAKsO,SAAAA;AACxB,YAAMsT,SAAS,KAAKvT,UAAUC,IAAAA;AAC9B,YAAM,EAAEkH,YAAW,IAAKlH;AAExB,aACEtO,QACI2hB,YAAY9rB,IAAI+rB,MAAAA,KAAWD,YAAY9rB,IAAI2f,WAAAA,IAAelhB,SAAS;IAE3E,GAAG,CAAA;EACL;EAEA,MAAMutB,YAAYC,QAAgB;AAChC,UAAM,EAAErf,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AAEzD,UAAMsM,OAAO,MAAM,KAAKgT,eAAe7J,QAAQ;MAC7C7T;MACAnB,IAAIqf;IACN,CAAA;AAEA,QAAI,CAACxT,MAAM;AACT,WAAKhB,gBAAgBvH,IAAI,QAAQ,qDAAakV,UAAAA,+CAAsB;QAClE1oB,SAAS0oB;MACX,CAAA;AACA,YAAM3B,YAAYhL,KAAKyK;IACzB;AACA,QAAI3X,IAAI,KAAKiN,UAAUC,IAAAA;AACvB,QAAItT,UAAU;AAEd,QAAIsT,KAAKkH,aAAa;AACpBxa,gBAAU,MAAM,KAAKof,iBAAiBlL,iBAAiBZ,KAAKkH,WAAW;IACzE;AAEA,QAAI,CAACxa,SAAS;AACZA,gBAAU,MAAM,KAAKof,iBAAiBlL,iBAAiB9N,CAAAA;IACzD,OACK;AACHA,UAAIkN,KAAKkH;IACX;AAEA,QAAI,CAACxa,SAAS;AACZ,WAAKsS,gBAAgBvH,IAAI,QAAQ,qDAAakV,UAAAA,iBAAiB3M,KAAK/L,IAAI,yCAAW;QACjFhQ,SAAS0oB;QACT1Y,MAAM+L,KAAK/L;MACb,CAAA;AAEA,YAAM+W,YAAYhL,KAAKyK;IACzB;AAEA,UAAMjkB,SAAS,MAAM,KAAKslB,iBAAiBvO,gBAAgB;MAACzK;KAAE;AAC9D,UAAMjN,WAAWW,OAAO,CAAA,GAAI4F,MAAMvG;AAIlC,UAAMiB,cAAc2sB,2BAA2BznB,YAAYuC,cAAa,GAAImlB,sBAAsB,CAAA;AAClG,UAAMC,YAAY,KAAK7H,iBAAiBzI,eAAevQ,GAAGhM,aAAa,KAAKiY,IAAIhX,GAAG;AAEnF,UAAM8b,SAAS,MAAMwN,kBAAkB;MACrC/b;MACAhP,MAAMorB,WAAWE;MACjBgC,SAAS5T,KAAK7L;IAChB,CAAA;AAEA,UAAM0f,OAAOtf,UAAUsP,OAAOiQ,YAAY,KAAK/U,IAAIhX,GAAG;AACtD,UAAMqE,OAA2B;MAC/B9D,KAAKurB;MACLF;MACAntB,QAAQwrB,eAAeG;MACvB4B,KAAK;QAAC/T,KAAK7L;;MACXmU,KAAKtI,KAAK/L;MACVA,MAAM+L,KAAK/L;MACXhO,MAAM+Z,KAAK/Z;MACXhC,SAAS0oB;MACT9mB;MACAiB,aAAaA,cAAc;IAC7B;AAEA,UAAM2qB,aACJ;MAAE/a,SAAKsd,0BAASnQ,OAAOiQ,UAAU;IAAE,GACnC;MACEG,MAAM;QACJ7nB;MACF;IACF,CAAA;AAEF,WAAO;MACLynB;MACAhuB;IACF;EACF;EAEA,MAAMquB,cAAcH,KAAehrB,SAAiB;AAClD,UAAM,EAAEoL,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AACzD,UAAMwL,QAAQ,MAAM,KAAK8T,eAAe5J,SAAS;MAC/CjV,QAAI+X,oBAAG6H,GAAAA;MACPze;IACF,CAAA;AACA,QAAI4J,MAAMrM,WAAW,GAAG;AACtB,WAAKmM,gBAAgBvH,IAAI,QAAQ,iEAAekV,UAAAA,IAAc;QAC5D1oB,SAAS0oB;MACX,CAAA;AACA,YAAM3B,YAAYhL,KAAKyK;IACzB;AACA,QAAIzc,OAAO,CAAA;AACX,eAAWgS,QAAQd,OAAO;AACxB,YAAM,EAAEgI,YAAW,IAAKlH;AACxB,YAAMzb,MAAM,KAAKwb,UAAUC,IAAAA;AAC3B,UAAI,CAACkH,aAAa;AAChBlZ,aAAKT,KAAKhJ,GAAAA;MACZ;AAEA,UAAI2iB,aAAa;AACf,cAAMiN,aAAa,MAAM,KAAKrI,iBAAiBlL,iBAAiBsG,WAAAA;AAChE,YAAIiN,YAAY;AACdnmB,eAAKT,KAAK2Z,WAAAA;QACZ,OACK;AACHlZ,eAAKT,KAAKhJ,GAAAA;QACZ;MACF;IACF;AAEA,UAAM6vB,cAAc,MAAM,KAAKtI,iBAAiBvO,gBAAgBvP,IAAAA;AAChE,QAAI/H,OAAO;AACX+H,WAAOA,KAAKd,OAAO,CAACihB,GAAGC,QAAAA;AACrB,YAAM,EAAErsB,KAAI,IAAKqyB,YAAYhG,GAAAA;AAC7B,UAAIrsB,SAAS,KAAK;AAChBkE,gBAAQmuB,YAAYhG,GAAAA,EAAKhiB,MAAMpG,SAAS;MAC1C;AACA,aAAOjE,SAAS;IAClB,CAAA;AACA,QAAIiM,KAAK6E,WAAW,GAAG;AACrB,WAAKmM,gBAAgBvH,IAAI,QAAQ,iEAAekV,UAAAA,2DAAwB;QACtE1oB,SAAS0oB;MACX,CAAA;AACA,YAAM3B,YAAYhL,KAAKyK;IACzB;AAEA,UAAMphB,WAAW2K,kBAAkBjL,OAAAA,KAAY,GAAG8I,aAAAA,CAAAA;AAClD,UAAM/E,QAAQ,MAAM,KAAKgf,iBAAiBvJ,gBAAgBvU,MAAM3E,QAAAA;AAChE,SAAK2V,gBAAgBvH,IAAI,QAAQ,qDAAakV,UAAAA,6BAAmB3e,KAAK6E,MAAM,kCAAS/F,KAAAA,IAAS;MAC5F7I,SAAS0oB;MACT9Z,QAAQ7E,KAAK6E;MACb5M;IACF,CAAA;AAEA,UAAMorB,kBAAkB;MACtB/b;MACAhP,MAAMorB,WAAWG;MACjBzlB,MAAM;QACJ5F,QAAQwrB,eAAeC;QACvB8B;QACAzL,KAAK,GAAGjf,QAAAA,SAAiB2E,KAAK6E,MAAM;QACpC5J,YAAY6D;MACd;IACF,CAAA;AACA,WAAO;MACLgG,GAAGhG;IACL;EACF;EAEA,MAAMunB,iBAAiBhrB,UAAkB6W,SAAiB;AACxD,UAAMpN,IAAI,eAAeoN,OAAAA,aAAoB7W,QAAAA;AAC7C,UAAMqD,UAAU,MAAM,KAAKof,iBAAiBlL,iBAAiB9N,CAAAA;AAC7D,QAAI,CAACpG,SAAS;AACZ,WAAKsS,gBAAgBvH,IAAI,QAAQ,iEAAe;QAC9CrL,MAAM,KAAK2S,IAAIhX,IAAI+F;MACrB,CAAA;AACA,YAAMkd,YAAYhL,KAAKyK;IACzB;AAEA,UAAM6B,OAAO,MAAM,KAAKT,eAAe1C,QAAQ;MAC7CrW,GAAGoN;MACHoH,KAAK3B,QAAQC;IACf,CAAA;AAEA,QAAI,CAAC0G,MAAM;AACT,WAAKtN,gBAAgBvH,IAAI,QAAQ,iEAAe;QAC9CrL,MAAM,KAAK2S,IAAIhX,IAAI+F;MACrB,CAAA;AACA,YAAMkd,YAAYhL,KAAKyK;IACzB;AAEA,UAAM1nB,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAC7ChV,IAAImY,KAAKhX;IACX,CAAA;AAEA,UAAM,CAACgf,QAAAA,IAAY,MAAM,KAAKxI,iBAAiBvO,gBAAgB;MAACzK;KAAE;AAClE,UAAM,EAAEjN,UAAUG,MAAK,IAAKsuB,UAAUloB,QAAQ,CAAC;AAG/C,UAAMtF,cAAc2sB,2BAA2BznB,YAAYuC,cAAa,GAAImlB,sBAAsB,CAAA;AAClG,UAAMC,YAAY,KAAK7H,iBAAiBzI,eAAevQ,GAAGhM,aAAa,KAAKiY,IAAIhX,GAAG;AAEnF,UAAM8b,SAAS,MAAMwN,kBAAkB;MACrC/b,QAAQgX,KAAKhX;MACbhP,MAAMorB,WAAWK;MACjB6B,SAAS1T;IACX,CAAA;AAEA,UAAM2T,OAAOtf,UAAUsP,OAAOiQ,YAAY,KAAK/U,IAAIhX,GAAG;AACtD,UAAMqE,OAA2B;MAC/B9D,KAAKurB;MACLF;MACAntB,QAAQwrB,eAAeG;MACvB4B,KAAK,CAAA;MACLzL,KAAKjf;MACL4K,MAAM5K;MACNpD,MAAMD;MACN/B,SAASlB,MAAKkB;MACd4B;MACAiB,aAAaA,cAAc;IAC7B;AAEA,UAAM2qB,aACJ;MAAE/a,SAAKsd,0BAASnQ,OAAOiQ,UAAU;IAAE,GACnC;MACEG,MAAM;QACJ7nB;MACF;IACF,CAAA;AAGF,WAAO;MACLynB;MACAhuB;IACF;EACF;EAEA,MAAM0uB,cAAcC,QAAkB;AAGpC,QAAI,CAAC,KAAKzV,IAAIhX,IAAI2L,UAAU;AAC1B,YAAM,IAAIgS,MAAM,gCAAA;IAClB;AAEA,UAAM+O,UAAU,MAAMjD,WAAW;MAC/B,UAAU,KAAKzS,IAAIhX,IAAI2L,SAASS;MAChC,eAAe;QACbugB,KAAK;UAAC1C,eAAeC;UAASD,eAAeG;UAASH,eAAeE;;MACvE;MACA,YAAY;QACVwC,KAAKF;MACP;IACF,CAAA;AAKA,UAAMG,aAAaF,QAAQlc,IAAIa,CAAAA,MAAKA,EAAE1C,IAAI3E,YAAW,CAAA;AACrD,UAAM6iB,OAAO,MAAMzd,QAAQ;MACzB,QAAQ;MACR,mCAAmC;QAAEud,KAAKC;MAAW;IACvD,CAAA;AAEA,UAAM9P,SAAS2P,OAAOjc,IAAI,CAACib,WAAAA;AACzB,YAAMqB,YAAYJ,QACfvnB,OAAOkM,CAAAA,MAAKA,EAAEhN,KAAK2nB,KAAKtU,SAAS+T,MAAAA,CAAAA,EACjCplB,OAAO,CAACsD,KAAK0f,WAAAA;AAEZ,cAAM0D,WAAWF,KAAK1nB,OAAOkM,CAAAA,MAAKA,EAAEhN,MAAMxE,MAAMwE,MAAM2oB,qBAAqB3D,OAAO1a,IAAI3E,YAAW,CAAA,EAAIc;AACrG,eAAOnB,OAAOojB,YAAY;MAC5B,GAAG,CAAA;AACL,aAAOD;IACT,CAAA;AACA,WAAOhQ;EACT;EAEA,MAAMmQ,YAAY/wB,UAAU,IAAIgZ,KAG7B;AACD,UAAM,EAAE1H,WAAWC,QAAO,IAAKyH,OAAO,CAAC;AACvC,WAAO9F,QAAQ;MACb,IAAI5B,aAAaC,YAAY;QAC3BkB,KAAK;UACH,GAAGnB,aAAa;YAAE0f,MAAM,IAAInjB,yBAASoE,YAAYX,SAAAA,CAAAA;UAAY;UAC7D,GAAGC,WAAW;YAAE0f,MAAM,IAAIpjB,yBAASoE,YAAYV,OAAAA,CAAAA;UAAU;QAC3D;MACF;MACA,QAAQ;MACR,iBAAiB;QAAE2f,QAAQ,IAAInoB,OAAO,uDAAe/I,OAAAA,kEAAuBA,OAAAA,sDAAqBA,OAAAA,GAAU;MAAE;IAC/G,CAAA;EACF;EAEAmxB,uBACEC,UACAhW,UACApC,KAGA;AACA,UAAM,EAAE1H,UAAS,IAAK0H,OAAO,CAAC;AAC9B,UAAMqY,MAAMD,SAASjnB,OAAO,CAACsD,KAAKsO,SAAAA;AAChC,YAAMsT,SAAS,KAAKvT,UAAUC,IAAAA;AAC9B,YAAM,EAAEkH,YAAW,IAAKlH;AACxB,YAAMuV,WAAW,CAACvV,KAAK/Z;AACvB,YAAMuvB,WAAWnW,SAAS9X,IAAI+rB,MAAAA,KAAWjU,SAAS9X,IAAI2f,WAAAA,IAAelhB,SAAS;AAE9E,UAAI,CAACwvB,SAAS;AACZ,cAAM,EAAEjO,WAAU,IAAKvH;AAEvB,YAAI,CAACuH,YAAY;AACf,iBAAO7V;QACT;AAEA,YAAI6V,aAAahS,WAAW;AAC1B,iBAAO7D;QACT;AAEA,eAAOA,MAAM2gB,UAAU9K,YAAYhS,SAAAA,IAAaggB;MAClD;AAEA,aAAO7jB,MAAM2gB,UAAU5qB,KAAKD,IAAG,GAAIrB,KAAKsvB,IAAI,CAAC,IAAIhuB,KAAKuY,KAAKmH,IAAI,GAAG,CAAC5R,SAAAA,CAAAA,IAAcggB;IACnF,GAAG,CAAA;AACH,WAAOpvB,KAAKuvB,MAAMJ,GAAAA;EACpB;EAEAK,mBAAmBf,MAAa;AAC9B,UAAMgB,UAAU;MACdnV,OAAO;MACPxa,MAAM;IACR;AACA,UAAM4vB,eAAe;MACnBpV,OAAO;MACPxa,MAAM;IACR;AAEA,UAAM6vB,eAAe;MACnBrV,OAAO;MACPxa,MAAM;IACR;AAEA2uB,SAAKhoB,QAAQ,CAACwM,MAAAA;AACZ,YAAM,EAAExR,KAAI,IAAKwR,EAAEhN;AACnB,YAAM,EAAEpK,IAAG,IAAK4F;AAChB,YAAM3B,OAAO,CAAC2B,KAAKwE,KAAKnG,QAAQ;AAChC,UAAIjE,IAAI4b,WAAW,oDAAA,GAAe;AAChCgY,gBAAQnV,SAAS;AACjBmV,gBAAQ3vB,QAAQA;MAClB,WACSjE,IAAI4b,WAAW,gEAAA,GAAiB;AACvCiY,qBAAapV,SAAS;AACtBoV,qBAAa5vB,QAAQA;MACvB,WACSjE,IAAI4b,WAAW,oDAAA,GAAe;AACrCkY,qBAAarV,SAAS;AACtBqV,qBAAa7vB,QAAQA;MACvB;IACF,CAAA;AACA,WAAO;MACL2vB;MACAC;MACAC;IACF;EACF;;;;;;EAOAC,mBAAmBC,WAAmBT,UAAkB;AACtD,UAAM,EAAEU,WAAU,IAAKjqB,YAAYuC,cAAa;AAChD,WAAO0nB,eAAeD,cAAc,KAAKA,YAAYT;EACvD;EAEAW,oBAAoBC,SAAiB;AACnC,UAAM,EAAEC,YAAW,IAAKpqB,YAAYuC,cAAa;AACjD,WAAO6nB,eAAeD,WAAW;EACnC;EAEAE,oBAAoBC,UAIjBd,SAAiB;AAClB,UAAM,EAAEe,gCAAgCC,oBAAoBC,2BAA2BC,eAAeC,cAAa,IAAK3qB,YAAYuC,cAAa;AAEjJ,UAAMqoB,WAAWvjB,KAAKmiB,OAAAA,IAAWkB;AAEjC,UAAMG,gBAAgBxjB,KAAKijB,SAASQ,SAAS7wB,IAAI,IAAIuwB;AACrD,UAAMO,eAAe1jB,KACnBijB,SAASU,IAAI/wB,OACXqwB,SAASQ,SAAS7wB,OAClBqwB,SAASjyB,SAAS4B,IAAI;AAG1B,UAAMgxB,uBAAuBF,eAAeR,iCAAiCE;AAE7E,UAAMS,WAAWH,eAAeJ;AAEhC,WAAO;MACLQ,UAAU7jB,YAAYsjB,QAAAA;MACtBC,eAAevjB,YAAYujB,aAAAA;MAC3BI,sBAAsB3jB,YAAY2jB,oBAAAA;MAClCC,UAAU5jB,YAAY4jB,QAAAA;MACtBE,OAAO9jB,YACL,CAACA,YAAYsjB,QAAAA,IACX,CAACtjB,YAAYujB,aAAAA,IACb,CAACvjB,YAAY2jB,oBAAAA,IACb,CAAC3jB,YAAY4jB,QAAAA,CAAAA;IAEnB;EACF;EAEAG,QAAQrX,MAAa;AACnBA,SAAK/L,OAAOD,kBAAkBgM,KAAK/L,IAAI;AACvC+L,SAAKmH,OAAO,oBAAI1f,KAAAA;AAChB,WAAO,KAAKurB,eAAerJ,OAAO3J,IAAAA;EACpC;EAEA,MAAMsX,eAAe;AACnB,UAAM,EAAEnjB,GAAE,IAAK,KAAK4K,IAAIhX,IAAI2L;AAC5B,UAAMwL,QAAQ,MAAM,KAAK8T,eAAe5J,SAAS;MAC/C9T,QAAQnB;MACRmT,KAAK3B,QAAQC;IACf,GAAG;MAAEnB,OAAO;QAAEtQ,IAAI;MAAO;IAAE,CAAA;AAC3B,WAAO+K;EACT;EAEA,MAAMqY,YAAYta,KAA8B;AAC9C,WAAO,KAAK+V,eAAe7J,QAAQ;MACjC7B,KAAK3B,QAAQC;MACb,GAAG3I;IACL,CAAA;EACF;EAEA,MAAMua,cAAcxX,MAAa;AAC/B,UAAM,EAAE/b,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AAC7C,QAAI,CAACsM,MAAM;AACT,WAAKhB,gBAAgBvH,IAAI,QAAQ,qDAAakV,UAAAA,+CAAsB;QAClE1oB,SAAS0oB;QACT6G,QAAQxT,KAAK7L;MACf,CAAA;AACA,YAAM6W,YAAYhL,KAAKyK;IACzB;AACA,QAAI3X,IAAI,eAAekN,KAAKE,OAAO,IAAIF,KAAKja,IAAI,IAAIia,KAAK/L,IAAI;AAE7D,QAAI+L,KAAKkH,aAAa;AACpBpU,UAAIkN,KAAKkH;IACX;AACA,UAAMuQ,aAAa,MAAM,KAAKzE,eAAe5J,SAAS;MACpDlJ,SAASF,KAAKE;MACdna,MAAMia,KAAKja;MACXkO,MAAM+L,KAAK/L;MACXqT,KAAK3B,QAAQC;IACf,CAAA;AAEA,UAAM8R,WAAWD,WAAW5kB,SAAS;AAGrC,QAAI,CAAC6kB,UAAU;AAEb,WAAK5L,iBAAiBtP,eAAe1J,CAAAA;IACvC;AACA,QAAI,CAACkN,KAAKuH,YAAY;AACpBvH,WAAKuH,aAAa,oBAAI9f,KAAAA;IACxB;AACAuY,SAAKsH,MAAM3B,QAAQE;AACnB7F,SAAKwH,UAAU,oBAAI/f,KAAAA;AACnB,UAAM,KAAKurB,eAAevqB,OAAOuX,IAAAA;AACjC,SAAKhB,gBAAgBvH,IAAI,QAAQ,6EAAiBkV,UAAAA,iBAAiB3M,KAAK/L,IAAI,IACxEyjB,WAAW,qBAAMD,WAAW5kB,SAAS,CAAA,mCAAW,6BAAA,IAC9C;MACJ5O,SAAS0oB;MACT1Y,MAAM+L,KAAK/L;MACXiM,SAASF,KAAKE;MACdna,MAAMia,KAAKja;IACb,CAAA;EACF;EAEA,MAAM4xB,gBAAgB50B,OAAYwhB,SAI9B;AACF,QAAI,EAAErF,OAAOG,UAAU2V,YAAW,IAAKzQ,WAAW,CAAC;AACnD,UAAM,EAAEqT,cAAa,IAAK5rB,YAAYuC,cAAa;AACnD,QAAI,CAAC2Q,OAAO;AACVA,cAAQ,MAAM,KAAK8T,eAAe5J,SAAS;QACzC9T,QAAQvS,MAAKoR;MACf,CAAA;IACF;AACA,QAAI,CAACkL,UAAU;AACbA,iBAAW,MAAM,KAAKyM,iBAAiB1M,YAAYF,KAAAA;IACrD;AACA,QAAI,CAAC8V,aAAa;AAChBA,oBAAc,MAAM,KAAKA,YAAYjyB,MAAKkB,SAAS;QACjDsR,WAAW,IAAI9N,KAAKmwB,aAAAA;MACtB,CAAA;IACF;AACA,UAAMtD,WAAWpV;AACjB,QAAI2Y,WAAW;AACf,QAAIC,iBAAiB;AACrB,QAAIC,gBAAgB;AACpB,QAAIC,kBAAkB;AACtB,QAAIC,mBAAmB;AACvB,UAAM1C,WAAWjB,SAASlmB,OAAO,CAACsD,KAAK0H,MAAAA;AACrC,YAAM,EAAE+N,KAAI,IAAK/N;AACjB0e,wBAAmB,CAAC1e,EAAEnT,QAAQ;AAC9B,YAAMqtB,SAAS,KAAKvT,UAAU3G,CAAAA;AAC9B,YAAM,EAAEpT,QAAQ,EAAC,IACXqZ,SAAS9X,IAAI+rB,MAAAA,KAAWjU,SAAS9X,IAAI6R,EAAE8N,WAAW,KAAK,CAAC;AAE9D,UAAIlhB,OAAO;AACT6xB,oBAAY;MACd;AACA,cAAIvF,cAAAA,SAAMnL,IAAAA,EAAM+Q,aAAS5F,cAAAA,SAAAA,EAAQ6F,SAAS,GAAG,OAAA,CAAA,GAAW;AACtDJ,yBAAiB/xB;MACnB;AACA,cAAIssB,cAAAA,SAAMnL,IAAAA,EAAM+Q,aAAS5F,cAAAA,SAAAA,EAAQ6F,SAAS,GAAG,OAAA,CAAA,GAAW;AACtDH,2BAAmBhyB;MACrB;AACA,cAAIssB,cAAAA,SAAMnL,IAAAA,EAAM+Q,aAAS5F,cAAAA,SAAAA,EAAQ6F,SAAS,GAAG,OAAA,CAAA,GAAW;AACtDF,4BAAoBjyB;MACtB;AAEA,aAAO0L,MAAM1L;IACf,GAAG,CAAA;AAEH,UAAMoyB,aAAa,MAAM,KAAKnI,aAAahC,aAAalrB,MAAKkB,OAAO;AACpE,QAAI,CAACm0B,WAAWvlB,QAAQ;AACtB,WAAKod,aAAajB,cAAcoJ,YAAYr1B,MAAKkB,OAAO;IAC1D;AAEA,UAAM+xB,YAAYqC,eAAet1B,MAAKijB,UAAU+G,WAAWE,QACvD9mB,KAAKsvB,IAAI,MAAM1yB,OAAMkD,IAAAA,IACrBlD,OAAMkD,SAAS,CAAA;AAGnB,UAAMqyB,cAAc,KAAKvC,mBAAmBC,WAAWT,QAAAA;AACvD,UAAMgD,aACA/jB,gBAAgB+gB,UAAUS,SAAAA;AAEhC,UAAM,EAAEJ,SAASC,cAAcC,aAAY,IAAK,KAAKH,mBACnDX,WAAAA;AAKF,UAAMwD,QAAQ,KAAKnC,oBAAoB;MACrCW,KAAKpB;MACLkB,UAAUjB;MACVxxB,UAAUyxB;IACZ,GAAG,KAAKV,uBAAuBd,UAAUjV,UAAU;MACjD9J,WAAW,IAAI9N,KAAKmwB,aAAAA;IACtB,CAAA,CAAA;AAEA,UAAMzB,UAAU,CAACpzB,MAAKsjB,SAAS,CAACmS,MAAMpB;AACtC,UAAMqB,UAAU11B,MAAKijB,UAAU+G,WAAWE;AAC1C,UAAMmJ,cAAc,KAAKF,oBAAoBC,OAAAA;AAC7C,WAAO;MACLuC,WAAWpE,SAASzhB;MACpBilB;MACAD;MACA7B,WACIjzB,MAAKijB,UAAU+G,WAAWE,QAAQ,uBAAQla,WAAWijB,SAAAA;MACzD2C,SAAS3C;MACTsC,aAAaG,UAAU,QAASrC,eAAekC;MAC/CrC,YAAYqC;MACZlC;MACAmC;MACAK,WAAW7lB,WAAWwiB,QAAAA;MACtBsD,cAAc9lB,WAAWglB,aAAAA;MACzBe,gBAAgB/lB,WAAWilB,eAAAA;MAC3Be,cAAchmB,WAAWklB,gBAAAA;MACzBe,aAAaZ,WAAWvlB;;MAExBomB,OAAO1D;MACP2D,eAAe,CAAC,IAAIzxB,KAAK1E,MAAKmjB,SAAS,KAAK;MAC5C0P;MACAC;MACAC;MACAvB,eAAeqB,QAAQnV,QAAQoV,aAAapV,QAAQqV,aAAarV;MACjEsW,cAAcnB,QAAQ3vB,OAAO4vB,aAAa5vB,OAAO6vB,aAAa7vB;MAC9DuyB;MACAW,MAAM,CAACX,MAAMpB;MACb/Q,QAAQtjB,MAAKsjB,UAAU;;MAEvB8P,SAASA,QAAQ/iB,QAAQ,CAAA;IAC3B;EACF;EAEA,MAAMgmB,aAAahtB,MAAM;AACvB,UAAM,EAAE8T,SAAS+G,UAAU5d,UAAUtD,MAAMszB,YAAYzxB,KAAI,IAAKwE;AAChE,UAAM6f,WAAW,MAAM,KAAKgH,gBAAgBzG,YAAYtM,OAAAA;AACxD,UAAMkI,cAAc6D,SAAS7E,WAAWzB,QAAQE;AAGhD,QAAI3G,QAAQ,MAAM,KAAK8T,eAAe5J,SAAS;MAC7C9B,KAAK3B,QAAQC;MACb1F;MACA+G;MACAhT,MAAM5K;MACNtD;IACF,CAAA;AAEAmZ,YAAQA,MAAMhS,OAAO8S,CAAAA,SAAQvM,WAAWuM,KAAKpY,MAAMA,IAAAA,CAAAA;AAEnD,UAAM0xB,YAAYpa,MAAMhS,OAAO8S,CAAAA,SAAQA,KAAKoH,WAAWiS,UAAAA;AAEvD,QAAI,CAACC,UAAUzmB,QAAQ;AACrB,WAAKmM,gBAAgBvH,IAAI,QAAQ,wCAAU4hB,UAAAA,iBAAiBhwB,QAAAA,mCAAkB;QAC5EA;QACAgwB;QACAjtB;MACF,CAAA;AACA,YAAM4e,YAAYhL,KAAKyK;IACzB;AACA,UAAM8O,WAAWD,UAAUzmB,WAAWqM,MAAMrM;AAG5C,QAAI0mB,UAAU;AACZ,YAAMh1B,MAAM,eAAe2b,OAAAA,IAAWna,IAAAA,IAAQsD,QAAAA;AAC9C,WAAKyiB,iBAAiBtP,eAAejY,GAAAA;IACvC;AACA,UAAM,KAAKyuB,eAAenJ,oBAAoB;MAC5C1V,QAAI+X,oBAAGoN,UAAU/gB,IAAIyH,CAAAA,SAAQA,KAAK7L,EAAE,CAAA;IACtC,GAAG;MACDmT,KAAK3B,QAAQE;MACb0B,YAAY,oBAAI9f,KAAAA;MAChB+f,SAAS,oBAAI/f,KAAAA;IACf,CAAA;AACA,SAAKuX,gBAAgBvH,IAAI,QAAQ,qDAAapO,QAAAA,6BAC5CiwB,UAAUzmB,MAAM,gCACN0mB,WAAW,WAAM,QAAA,IAAO;MAClCnR;MACAmR;MACAC,YAAYta,MAAMrM;MAClB4mB,gBAAgBH,UAAUzmB;MAC1BxJ;MACAgwB;MACAjtB;IACF,CAAA;AAGA,QAAIitB,YAAY;AACd,YAAMjS,SAAS,MAAM,KAAK8L,iBAAiB/J,QAAQ;QACjDlV,MAAMolB;QACN7yB,QAAQ;QACR0Z;MACF,CAAA;AAEA,UAAI,CAACkH,QAAQ;AACX,aAAKpI,gBAAgBvH,IAAI,QAAQ,gBAAM4hB,UAAAA,uBAAkB;UACvDhwB;UACAgwB;UACAjtB;QACF,CAAA;AACA,cAAM4e,YAAYhL,KAAKyK;MACzB;AACArD,aAAO5gB,UAAU,MAAM,KAAKwsB,eAAe5J,SAAS;QAClD9B,KAAK3B,QAAQC;QACbwB,QAAQiS;QACRnZ;MACF,CAAA,GAAIrN,SACA,IACA;AACJuU,aAAOQ,aAAa,oBAAIngB,KAAAA;AACxB,YAAM,KAAKyrB,iBAAiBzqB,OAAO2e,MAAAA;IACrC;EACF;EAEA,MAAMsS,YAAY3F,KAAe;AAC/B,UAAM,EAAE5f,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AACzD,UAAMwL,QAAQ,MAAM,KAAK8T,eAAe5J,SAAS;MAC/C9B,KAAK3B,QAAQC;MACbtQ;MACAnB,QAAI+X,oBAAG6H,GAAAA;IACT,CAAA;AAEA,QAAI7U,MAAMrM,WAAW,GAAG;AACtB;IACF;AACA,UAAM7E,OAAO,oBAAIuR,IAAAA;AAIjB,eAAWS,QAAQd,OAAO;AACxB,YAAM,EAAEjL,MAAMiM,SAASna,MAAMmhB,YAAW,IAAKlH;AAE7C,UAAIkH,aAAa;AACflZ,aAAKyJ,IAAIyP,WAAAA;MACX,OACK;AAEH,cAAMyS,UAAU,MAAM,KAAK3G,eAAevS,MAAM;UAC9C6G,KAAK3B,QAAQC;UACb1F;UACAna;UACAkO;QACF,CAAA;AAEA,cAAM2lB,WAAW1a,MAAMhS,OACrBkM,CAAAA,MAAKA,EAAE8G,YAAYA,WAAW9G,EAAErT,SAASA,QAAQqT,EAAEnF,SAASA,IAAAA,EAC5DpB;AACF,YAAI8mB,WAAWC,UAAU;AACvB5rB,eAAKyJ,IAAI,KAAKsI,UAAUC,IAAAA,CAAAA;QAC1B;MACF;IACF;AAIA,SAAK8L,iBAAiBpQ,iBAAiB;SAAI1N;KAAK;AAChD,UAAM,KAAKglB,eAAenJ,oBAAoB;MAC5C1V,QAAI+X,oBAAGhN,MAAM3G,IAAIyH,CAAAA,SAAQA,KAAK7L,EAAE,CAAA;IAClC,GAAG;MACDmT,KAAK3B,QAAQE;MACb0B,YAAY,oBAAI9f,KAAAA;MAChB+f,SAAS,oBAAI/f,KAAAA;IACf,CAAA;AAEA,SAAKuX,gBAAgBvH,IAAI,QAAQ,iEAAekV,UAAAA,yCAAqBzN,MAAMrM,MAAM,gCAAY7E,KAAK/H,IAAI,IAAI;MACxGhC,SAAS0oB;MACT9Z,QAAQqM,MAAMrM;MACdglB,UAAU7pB,KAAK/H;IACjB,CAAA;EACF;;EAGA,MAAM4zB,gBAAgBztB,MAAM;AAC1B,UAAM,EAAE8T,SAAStY,MAAMqM,OAAO,GAAE,IAAK7H;AAErC,QAAI8S,QAAQ,MAAM,KAAK8T,eAAe5J,SAAS;MAC7C9B,KAAK3B,QAAQC;MACb1F;MACAkH,QAAQnT;IACV,CAAA;AACAiL,YAAQA,MAAMhS,OAAOkM,CAAAA,MAAK3F,WAAW2F,EAAExR,MAAMyE,KAAKgB,UAAUzF,IAAAA,CAAAA,CAAAA;AAC1D,KAAA,YAAA;AACA,YAAM0kB,OAAO,MAAM,KAAKT,eAAe1C,QAAQ;QAC7CrW,GAAGoN;MACL,CAAA;AACA,UAAIoM,MAAM;AACR,aAAKtN,gBAAgBvH,IAAI,QAAQ,2DAAcyH,MAAMrM,SAAS,IAAI,WAAM,QAAA,iBACtEyZ,KAAKrY,IAAI,iBACJiL,MAAMrM,MAAM,IAAI;UACrBqN;UACA+G,UAAUqF,KAAKrY;UACfrM;UACA6Y,OAAOvB,MAAMrM;QACf,CAAA;MACF,OACK;AACH,aAAKmM,gBAAgBvH,IAAI,QAAQ,wEAAiByI,OAAAA,uBAAe;UAC/DA;UACA+G,UAAUqF,KAAKrY;UACfrM;QACF,CAAA;MACF;IACF,GAAA;AAEA,WAAO;MACLkyB,UAAU5a,MAAMrM,SAAS;MACzBknB,KAAK;IACP;EACF;AACF,GA1yBe,OAAA3hB,MAAA,gBAAAA;;MACZR,iCAAAA;uCACY,YAAA,cAAA,SAAA,OAAA;GAFMmb,YAAAA,WAAAA,OAAAA,MAAAA;;MAIlBlT,8BAAOqR,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GALL6B,YAAAA,WAAAA,kBAAAA,MAAAA;;MAOlBlT,8BAAOC,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GARPiT,YAAAA,WAAAA,oBAAAA,MAAAA;;MAUlBlT,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAXNwb,YAAAA,WAAAA,mBAAAA,MAAAA;;MAalBlT,8BAAOsK,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GAdL4I,YAAAA,WAAAA,kBAAAA,MAAAA;;MAgBlBlT,8BAAO4P,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GAjBLsD,YAAAA,WAAAA,kBAAAA,MAAAA;;MAmBlBlT,8BAAO8N,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GApBHoF,YAAAA,WAAAA,gBAAAA,MAAAA;;MAsBlBlT,8BAAO8L,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAvBNoH,YAAAA,WAAAA,mBAAAA,MAAAA;;MAyBlBlT,8BAAOgT,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GA1BPE,YAAAA,WAAAA,oBAAAA,MAAAA;AAAAA,cAAAA,eAAAA;MADpBlb,+BAAAA;GACoBkb,WAAAA;;;;;;;;;;;;;;;;;;;;IDpBAiH,eAAN5hB,OAAA,MAAA;EAAA;AAELZ;AAGAqU;AAGAoH;AAGAjU;AAGAib;;EAER,MAAMC,WAAW5N,MAAY;AAC3BA,SAAKxZ,IAAIjB,aAAAA;AAET,UAAMoa,WAAW,IAAIlE,SAAAA;AACrBkE,aAAS/L,UAAUoM,KAAKxZ;AACxBmZ,aAAS3W,SAASgX,KAAKhX;AACvB,UAAM,KAAK2d,gBAAgBnG,eAAeb,QAAAA;AAC1C,UAAM,KAAKJ,eAAelC,OAAO2C,IAAAA;EACnC;EAEA,MAAM6N,SAAS7kB,QAAgBrR,SAAiB;AAC9C,UAAMmI,OAAO,MAAM,KAAKyf,eAAexC,sBACrC;MACE/T;MACAgS,KAAK3B,QAAQC;IACf,GACA;MAAC;MAAQ;MAAe;KAAI;AAG9B,UAAMwU,QAAQhuB,KAAKmM,IAAI,CAAC8hB,MAAAA;AACtB,YAAM,EAAEpmB,MAAMiT,aAAaoT,UAAUxnB,GAAGvO,IAAG,IAAK81B;AAChD,aAAO;QACLpmB;QACAqmB;QACA/1B;QACAg2B,WAAW,CAAA;MACb;IACF,CAAA;AACA,UAAMC,uBAAuB;AAC7B,eAAWH,KAAKD,OAAO;AACrB,YAAMlb,QAAQ,MAAM,KAAK+a,YAAY9G,sBACnC;QACEjT,SAASma,EAAE91B;MACb,GACAi2B,oBAAAA;AAGFH,QAAEE,YAAYrb,MAAM3G,IAAIa,CAAAA,OAAM;QAAE/P,UAAU+P,EAAEnF;QAAMkT,MAAM/N,EAAE+N;MAAK,EAAA;IACjE;AAEA,SAAKnI,gBAAgBvH,IAAI,QAAQ,qDAAaxT,OAAAA,IAAW;MACvDA;IACF,CAAA;AAEA,WAAO;MAAEm2B;IAAM;EACjB;EAEA,MAAMK,aAAal2B,KAAa;AAC9B,UAAM+nB,OAAO,MAAM,KAAKT,eAAe1C,QAAQ;MAC7CrW,GAAGvO;MACH+iB,KAAK3B,QAAQC;IACf,CAAA;AAEA,QAAI,CAAC0G,MAAM;AACT,WAAKtN,gBAAgBvH,IAAI,QAAQ,oFAAmB;QAClDlT;MACF,CAAA;AACA,YAAM8mB,UAAUb;IAClB;AACA,SAAKxL,gBAAgBvH,IAAI,QAAQ,qDAAa6U,KAAKrY,IAAI,IAAI;MACzDA,MAAMqY,KAAKrY;IACb,CAAA;AAEA,WAAO;MACLA,MAAMqY,KAAKrY;MACXqmB,UAAUhO,KAAKpF;MACf5R,QAAQgX,KAAKhX;IACf;EACF;EAEA,MAAMolB,QAAQn2B,KAAa;AACzB,UAAM,EAAE4P,IAAIlQ,SAAS0oB,WAAU,IAAK,KAAKnV,IAAIzP,IAAI2L;AACjD,UAAM4Y,OAAO,MAAM,KAAKT,eAAe1C,QAAQ;MAC7C7T,QAAQnB;MACRrB,GAAGvO;MACH+iB,KAAK3B,QAAQC;IACf,CAAA;AAEA,QAAI0G,MAAM;AAER,UAAIA,KAAKpF,gBAAgB,SAAS;AAChCoF,aAAKpF,cAAc;MACrB,OACK;AAEHoF,aAAKhF,MAAM3B,QAAQE;MACrB;AACA,YAAM,KAAKgG,eAAepjB,OAAO6jB,IAAAA;IACnC;AAGA,UAAMqO,cAAcrO,MAAMrY;AAC1B,SAAK+K,gBAAgBvH,IACnB,QACA,qDAAakV,UAAAA,uBAAkBgO,WAAAA,IAC/B;MACE12B,SAAS0oB;MACT1Y,MAAM0mB;IACR,CAAA;EAEJ;EAEA,MAAMC,WAAWr2B,KAAa8nB,SAA+C;AAC3E,UAAM,EAAEpY,MAAMqmB,SAAQ,IAAKjO;AAC3B,UAAM,EAAElY,IAAIlQ,SAAS0oB,WAAU,IAAK,KAAKnV,IAAIzP,IAAI2L;AAEjD,UAAM4Y,OAAO,MAAM,KAAKT,eAAe1C,QAAQ;MAC7C7T,QAAQnB;MACRrB,GAAGvO;IACL,CAAA;AACA,QAAI+nB,MAAM;AACR,UAAIrY,MAAM;AACRqY,aAAKrY,OAAOA;MACd;AACA,UAAIqmB,aAAa5rB,QAAW;AAC1B4d,aAAKpF,cAAcoT;MACrB;AACA,UAAIrmB,QAAQqmB,aAAa5rB,QAAW;AAClC,cAAM,KAAKmd,eAAepjB,OAAO6jB,IAAAA;MACnC;IACF;AACA,SAAKtN,gBAAgBvH,IACnB,QACA,kEAAgBkV,UAAAA,WAAgBL,KAAKrY,IAAI,WAAMqY,KAAKrY,IAAI,IACxD;MACEhQ,SAAS0oB;MACTkO,SAASvO,KAAKrY;MACd6mB,SAASxO,KAAKrY;IAChB,CAAA;EAEJ;AACF,GAnJe,OAAAmE,MAAA,gBAAAA;;MACZR,iCAAAA;uCACY,YAAA,cAAA,SAAA,OAAA;GAFMoiB,YAAAA,WAAAA,OAAAA,MAAAA;;MAIlBna,8BAAOsK,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GALL6P,YAAAA,WAAAA,kBAAAA,MAAAA;;MAOlBna,8BAAO8L,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GARNqO,YAAAA,WAAAA,mBAAAA,MAAAA;;MAUlBna,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAXNyiB,YAAAA,WAAAA,mBAAAA,MAAAA;;MAalBna,8BAAOkT,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GAdFiH,YAAAA,WAAAA,eAAAA,MAAAA;AAAAA,cAAAA,eAAAA;MADpBniB,+BAAAA;GACoBmiB,WAAAA;;;AOVrB,IAAArwB,wBAAqD;;;ACFrD,IAAM,EAAEwU,QAAQuX,MAAK,IAAKvvB;AAMnB,SAAS40B,aAAaloB,QAAc;AACzC,MAAIvB,MAAM;AACV,MAAI0pB,IAAI;AACR,SAAOA,IAAInoB,QAAQ;AACjBmoB,SAAK;AACL1pB,WAAOokB,MAAMvX,OAAAA,IAAW,GAAA,IAAO;EACjC;AACA,SAAO7M;AACT;AARgBypB;;;ACNhB,wBAAwC;AAsBxC,IAAIE,cAAkC;AACtC,IAAIC,iBAAiB;AAErB,SAASC,YAAAA;AACP,QAAMtsB,MAAM7C,YAAYmC,oBAAoB,MAAA;AAC5C,MAAI,CAACU,OAAO,CAACA,IAAI/K,UAAU;AACzB,UAAM,IAAI4hB,MAAM,4FAAA;EAClB;AACA,SAAO;IACL5hB,UAAU+K,IAAI/K;IACdC,UAAU8K,IAAI9K;IACdC,QAAQmJ,QAAQ0B,IAAI7K,MAAM;IAC1BC,SAAS4K,IAAI5K;IACbjB,UAAU6L,IAAI7L;IACdkB,MAAM2K,IAAI3K;IACVC,YAAY0K,IAAI1K;IAChBC,SAASyK,IAAIzK;IACbC,UAAUwK,IAAIxK;EAChB;AACF;AAhBS82B;AAkBT,SAASC,oBAAoBvsB,KAAe;AAC1C,SAAO;IAACA,IAAI/K;IAAU+K,IAAI9K;IAAU8K,IAAI5K;IAAS4K,IAAI7K;IAAQS,KAAK,GAAA;AACpE;AAFS22B;AAIT,SAASC,kBAAkBxsB,KAAe;AACxC,SAAOysB,kBAAAA,QAAWC,gBAAgB;IAChC34B,MAAMiM,IAAI/K;IACVjB,MAAMuZ,OAAOvN,IAAI9K,QAAQ;IACzBy3B,QAAQ3sB,IAAI7K;IACZN,MAAM;MACJX,MAAM8L,IAAI5K;MACVw3B,MAAM5sB,IAAI7L;IACZ;EACF,CAAA;AACF;AAVSq4B;AAYT,eAAeK,kBAAkB7sB,KAAe;AAC9C,QAAMtK,MAAM62B,oBAAoBvsB,GAAAA;AAChC,MAAIosB,eAAeC,mBAAmB32B,KAAK;AACzC,WAAO02B;EACT;AACAA,gBAAcI,kBAAkBxsB,GAAAA;AAChCqsB,mBAAiB32B;AACjB,SAAO02B;AACT;AAReS;AAUf,eAAsBC,SAASpX,SAA0BqX,gBAA2B;AAClF,QAAM/sB,MAAM+sB,kBAAkBT,UAAAA;AAC9B,MAAIU;AACJ,MAAID,gBAAgB;AAClBC,SAAKR,kBAAkBxsB,GAAAA;EACzB,OACK;AACHgtB,SAAK,MAAMH,kBAAkB7sB,GAAAA;EAC/B;AACA,QAAMzK,UAAUmgB,QAAQngB,WAAWyK,IAAIzK,WAAW;AAClD,QAAM03B,OAAOvX,QAAQuX,QAAQjtB,IAAIxK;AACjC,QAAM03B,cAAcltB,IAAI3K,QAAQ2K,IAAI5K;AACpC,QAAM+3B,SAASntB,IAAI1K,aAAa,IAAI0K,IAAI1K,UAAU,MAAM43B,WAAAA,MAAiBA;AACzE,QAAMF,GAAGF,SAAS;IAChBz3B,MAAM83B;IACNC,IAAI1X,QAAQ0X;IACZ73B;IACA2P,MAAMwQ,QAAQxQ;IACd+nB;EACF,CAAA;AACF;AApBsBH;AAsBf,SAASO,gBAAAA;AACd,SAAOf,UAAAA;AACT;AAFgBe;AAIT,SAASC,uBAAAA;AACdlB,gBAAc;AACdC,mBAAiB;AACnB;AAHgBiB;;;;;;;;;;;;;;;;;;;;IFjFKC,iBAANhkB,OAAA,MAAA;EAAA;AAEL2G;AAGAC;AAGAiR;AAGAD;AAGAlE;;;;;;;;;;EAUR,MAAM+C,cACJ9I,OACAsW,QAAoD,WACpD;AAEA,QAAI,CAAC1M,OAAO/d,KAAKmU,KAAAA,GAAQ;AACvB,WAAK/G,gBAAgBvH,IACnB,UACA,+CAAYsO,KAAAA,mCACZ;QACEA;MACF,CAAA;AAEF,YAAMsE,UAAUtE,MAAMuE;IACxB;AAGA,QAAI+R,UAAU,WAAWA,UAAU,SAAS;AAC1C,UAAIt5B,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;QAAEpD;MAAM,CAAA;AACrD,UAAI,CAAChjB,OAAM;AACTA,QAAAA,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;UAAEllB,SAAS8hB;QAAM,CAAA;MAC5D;AACA,UAAI,CAAChjB,OAAM;AACT,aAAKic,gBAAgBvH,IACnB,UACA,+CAAYsO,KAAAA,uBACZ;UAAEA;QAAM,CAAA;AAEV,cAAMsE,UAAUtE,MAAMyE;MACxB;IACF;AACA,UAAMzoB,OAAOg5B,aAAa,CAAA;AAC1B,UAAMlsB,MAAMqtB,cAAAA;AACZ,UAAMI,eACFztB,IAAIxK,YACH,2JAAkDtC,IAAAA;AACvD,UAAM+5B,OAAOQ,aAAax3B,QAAQ,oBAAoB/C,IAAAA;AACtD,UAAM0uB,cAAc1K,MAAMjhB,QACxB,iBACA,CAACqpB,GAAGpR,QAAQ2T,WAAW,GAAG3T,MAAAA,MAAY2T,MAAAA,EAAQ;AAEhD,SAAK1R,gBAAgBvH,IACnB,UACA,+CAAYgZ,WAAAA,uBAAmB1uB,IAAAA,iBAC/B;MACEgkB,OAAO0K;MACP1uB;IACF,CAAA;AAEF,UAAM45B,SAAS;MACbM,IAAIlW;MACJ3hB,SAASyK,IAAIzK,WAAW;MACxB03B;IACF,CAAA;AACA,SAAK7L,aAAatB,cAAc5I,OAAOhkB,IAAAA;EACzC;EAEAw6B,WAAW;AACT,UAAM,EAAEx0B,IAAG,IAAK,KAAKgX;AACrB,UAAMyd,UAAU,wBAACh4B,UAAAA;AACf,UAAI,CAACA,OAAM;AACT;MACF;AACA,UAAI;AACF,aAAKwa,gBAAgBrH,MAAMnT,KAAAA;MAC7B,SACOkC,OAAO;AACZC,gBAAQ4S,KAAK,mCAAmC7S,OAAOqJ,WAAWrJ,KAAAA;MACpE;IACF,GAVgB;AAWhB,QAAIqB,IAAI+M,WAAW,OAAO;AACxB0nB,cAAQz0B,IAAI+F,OAAOtJ,IAAAA;AACnB,aAAOi4B,+BAASC,MAAM,eAAe,yBAAA;IACvC;AACAF,YAAQz0B,IAAIgN,MAAMvQ,IAAAA;EACpB;EAEA,MAAMm4B,kBAAkB5W,OAAe;AACrC,QAAI,CAAC4J,OAAO/d,KAAKmU,KAAAA,GAAQ;AACvB,WAAK/G,gBAAgBvH,IACnB,UACA,iEAAesO,KAAAA,mCACf;QACEA;MACF,CAAA;AAGF,aAAO0W,+BAASG,cAAcvS,UAAUtE,MAAMuE,KAAK;IACrD;AACA,QAAIvnB,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAAEpD;IAAM,CAAA;AAErD,QAAI,CAAChjB,OAAM;AACTA,MAAAA,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;QAAEllB,SAAS8hB;MAAM,CAAA;IAC5D;AACA,QAAIhjB,OAAM;AACR,WAAKic,gBAAgBvH,IACnB,UACA,iEAAesO,KAAAA,uBACf;QACEA;MACF,CAAA;AAEF,YAAMsE,UAAUtE,MAAMwE;IACxB;AACA,SAAKvL,gBAAgBvH,IACnB,UACA,iEAAesO,KAAAA,uBACf;MACEA;IACF,CAAA;EAEJ;EAEA,MAAM8W,YACJt4B,KACA6H,MAIA;AACA,UAAMtF,cAAc2sB,2BAA2BznB,YAAYuC,cAAa,GAAImlB,sBAAsB,CAAA;AAClG,WAAO3kB,QAAQ+R,IACb1U,KAAKmM,IAAI,OAAOa,MAAAA;AACd,YAAM0jB,SAAS,mBAAmBv4B,GAAAA,IAAO6U,EAAE9E,GAAG,IAAI8E,EAAEnF,IAAI;AACxD,YAAM8oB,QAAQ,MAAM,KAAKjR,iBAAiB1J,mBACxC0a,QACA,SACAh2B,aACA,KAAKiY,IAAIhX,GAAG;AAEd,YAAMi1B,UAAU,MAAM,KAAKlR,iBAAiB1J,mBAC1C0a,QACA,WACAh2B,aACA,KAAKiY,IAAIhX,GAAG;AAEd,aAAO;QACLg1B;QACAC;MACF;IACF,CAAA,CAAA;EAEJ;AACF,GAvKe,OAAA5kB,MAAA,kBAAAA;;MACZR,iCAAAA;uCACY,YAAA,cAAA,SAAA,OAAA;GAFMwkB,cAAAA,WAAAA,OAAAA,MAAAA;;MAIlBvc,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GALN6kB,cAAAA,WAAAA,mBAAAA,MAAAA;;MAOlBvc,8BAAO8N,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GARHyO,cAAAA,WAAAA,gBAAAA,MAAAA;;MAUlBvc,8BAAO4P,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GAXL2M,cAAAA,WAAAA,kBAAAA,MAAAA;;MAalBvc,8BAAOC,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GAdPsc,cAAAA,WAAAA,oBAAAA,MAAAA;AAAAA,gBAAAA,eAAAA;MADpBvkB,+BAAAA;GACoBukB,aAAAA;;;AGdrB,IAAAzyB,wBAAoD;;;ACCpD,IAAAA,wBAAwB;;;;;;;;;;;;;AAiCxB,IAAaszB,sBAAN7kB,OAAA,cAAiC4Q,eAAAA;EAAjC;;AACKC,sCAAaT,cAAcwB,cAAckT,QAAAA;AAEzChU,sCAAagU,SAAejpB;;AACxC,GAJwC+U,OAAAA,MAAAA,uBAAjC5Q;AAAM6kB,qBAAAA,eAAAA;MADZplB,+BAAAA;GACYolB,kBAAAA;;;;;;;;;;;;;;;;;;;;IDzBQE,mBAAN/kB,OAAA,MAAA;EAAA;AAEL2G;AAGAqe;AAGAvR;AAGA7M;;EAER,MAAMqe,eAAeppB,MAAc;AACjC,UAAM,EAAEE,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AACzD,UAAM4pB,aAAa,MAAM,KAAKF,mBAAmBhU,SAAS;MACxD9T;MACArB;IACF,CAAA;AAGA,QAAIqpB,WAAWzqB,WAAW,GAAG;AAC3B,WAAKmM,gBAAgBvH,IACnB,YACA,yEAAkBkV,UAAAA,iBAAiB1Y,IAAAA,IACnC;QACEA;QACAhQ,SAAS0oB;MACX,CAAA;AAEF,YAAM5B,cAAcR;IACtB;AACA,SAAKvL,gBAAgBvH,IACnB,YACA,qDAAakV,UAAAA,iBAAiB1Y,IAAAA,IAC9B;MACEA;MACAhQ,SAAS0oB;IACX,CAAA;AAEF,UAAM2N,WAAW,IAAIxT,SAAAA;AACrBwT,aAAShlB,SAASA;AAClBglB,aAASrmB,OAAOA;AAChBqmB,aAASxnB,IAAIjB,aAAAA;AACb,UAAM,KAAKurB,mBAAmBzT,OAAO2Q,QAAAA;EACvC;EAEA,MAAMiD,UAAU;AACd,UAAM,EAAEppB,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AACzD,SAAKsL,gBAAgBvH,IAAI,YAAY,qDAAakV,UAAAA,IAAc;MAC9D1oB,SAAS0oB;IACX,CAAA;AAEA,UAAM2Q,aAAa,MAAM,KAAKF,mBAAmBhU,SAAS;MACxD9T;IACF,CAAA;AACAgoB,eAAW1wB,QAAQ,CAACwM,MAAAA;AAClB,aAAOA,EAAE9D;IACX,CAAA;AACA,WAAO;MACLgoB;IACF;EACF;EAEA,MAAME,eAAej5B,KAAa;AAChC,UAAM,EAAE4P,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AACzD,UAAMyE,IAAI,MAAM,KAAKilB,mBAAmBjU,QAAQ;MAC9C7T;MACAxC,GAAGvO;IACL,CAAA;AACA,QAAI4T,GAAG;AACL,YAAM,KAAKilB,mBAAmB11B,OAAO;QACnCyM,IAAIgE,EAAEhE;MACR,CAAA;AAEA,YAAM,KAAK0X,eAAehC,oBACxB;QACE3C,aAAa3iB;MACf,GACA;QACE2iB,aAAa;MACf,CAAA;AAGF,WAAKlI,gBAAgBvH,IACnB,YACA,qDAAakV,UAAAA,iBAAiBxU,EAAElE,IAAI,IACpC;QACEhQ,SAAS0oB;QACT1Y,MAAMkE,EAAElE;MACV,CAAA;IAEJ;EACF;AACF,GA9Fe,OAAAmE,MAAA,oBAAAA;;MACZR,iCAAAA;uCACY,kCAAA,cAAA,SAAA,6BAAA;GAFMulB,gBAAAA,WAAAA,OAAAA,MAAAA;;MAIlBtd,8BAAOod,kBAAAA;uCACoB,uBAAA,cAAA,SAAA,kBAAA;GALTE,gBAAAA,WAAAA,sBAAAA,MAAAA;;MAOlBtd,8BAAOsK,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GARLgT,gBAAAA,WAAAA,kBAAAA,MAAAA;;MAUlBtd,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAXN4lB,gBAAAA,WAAAA,mBAAAA,MAAAA;AAAAA,kBAAAA,eAAAA;MADpBtlB,+BAAAA;GACoBslB,eAAAA;;;AETrB,IAAAxzB,wBAAgC;;;;;;;;;;;;;;;;;;IAIX8zB,oBAANrlB,OAAA,MAAA;EAAA;AAEL6X;;EAER,MAAMyN,OAAOz5B,SAAiB;AAC5B,UAAM05B,SAAS,MAAM,KAAK1N,aAAahC,aAAahqB,OAAAA;AACpD,eAAW8C,SAAS42B,QAAQ;AAC1B,WAAK1N,aAAanW,gBAAgB/S,KAAAA;IACpC;AACA,SAAKkpB,aAAanW,gBAAgB,KAAKmW,aAAa5B,eAAepqB,OAAAA,CAAAA;AACnE,WAAOA;EACT;AACF,GAZe,OAAAmU,MAAA,qBAAAA;;MACZyH,8BAAO8N,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GAFH8P,iBAAAA,WAAAA,gBAAAA,MAAAA;AAAAA,mBAAAA,eAAAA;MADpB5lB,+BAAAA;GACoB4lB,gBAAAA;;;ACJrB,IAAA9zB,wBAAoD;AACpD,IAAA2Z,mBAAmB;;;;;;;;;;;;;;;;;;IASEsa,iBAANxlB,OAAA,MAAA;EAAA;AAEL2G;AAGAmU;AAGArH;AAGA7M;AAGA4M;;EAER,MAAMiS,UAAUt5B,KAAa0P,MAAc;AACzC,UAAMlR,QAAO,KAAKgc,IAAIhX,IAAI2L;AAC1B,UAAM6W,QAAQ,CAAC,CAAE,MAAM,KAAK2I,iBAAiB/J,QAAQ;MACnDjJ,SAAS3b;MACT+Q,QAAQvS,MAAKoR;MACbF;IACF,CAAA;AAEA,SAAK+K,gBAAgBvH,IACnB,UACA,uCAAS8S,QAAQ,iBAAO,cAAA,KAAStW,IAAAA,IACjC;MACEA;MACAsW;IACF,CAAA;AAEF,QAAIA,OAAO;AACT,YAAMmB,YAAYnB;IACpB;AAEA,UAAMnD,SAAS,IAAIO,OAAAA;AACnBP,WAAOnT,OAAOA;AACdmT,WAAOlH,UAAU3b;AACjB6iB,WAAO9R,SAASvS,MAAKoR;AACrB,UAAM,KAAK+e,iBAAiBvJ,OAAOvC,MAAAA;EACrC;EAEA,MAAM0W,mBAAmBv5B,KAAa0P,MAAc;AAClD,UAAMqY,OAAO,MAAM,KAAKT,eAAe1C,QAAQ;MAC7CrW,GAAGvO;IACL,CAAA;AACA,QAAI,CAAC+nB,MAAM;AACT,aAAO;IACT;AACA,UAAMlF,SAAS,MAAM,KAAK8L,iBAAiB/J,QAAQ;MACjDjJ,SAAS3b;MACT0P;IACF,CAAA;AAEA,UAAMsW,QAAQ,CAAC,CAACnD;AAChB,SAAKpI,gBAAgBvH,IACnB,UACA,6EAAiB6U,KAAKrY,IAAI,6BAASA,IAAAA,iBACjCsW,QAAQ,WAAM,QAAA,IAEhB;MACEtD,UAAUqF,KAAKrY;MACfA;MACAsW;IACF,CAAA;AAEF,WAAOA;EACT;EAEA,MAAMwT,kBAAkBx5B,KAAa;AACnC,SAAKya,gBAAgBvH,IAAI,UAAU,sEAAe;MAChDyI,SAAS3b;IACX,CAAA;AAEA,UAAMxB,QAAO,KAAKgc,IAAIhX,IAAI2L;AAE1B,UAAMsqB,eACJ,MAAM,KAAKpS,mBAAmBvC,sBAC5B;MACE/T,QAAQvS,MAAKoR;MACbiU,aAAa;IACf,GACA;MAAC;KAAU,GAGZlb,OAAO,CAACkM,MAAMA,EAAE8G,YAAY3b,GAAAA,EAC5BgU,IAAI,CAACa,MAAMA,EAAE8G,OAAO;AAEvB,QAAI,CAAC8d,YAAYnrB,QAAQ;AACvB,aAAO,CAAA;IACT;AAEA,UAAMoZ,WAAW,MAAM,KAAKJ,eAAexC,sBACzC;MACEvW,OAAGoZ,qBAAG8R,WAAAA;IACR,GACA;MAAC;MAAK;KAAO;AAIf,UAAM5W,SAAS,MAAM,KAAK8L,iBAAiB7J,sBACzC;MACEnJ,aAASgM,qBAAG8R,WAAAA;IACd,GACA;MAAC;MAAW;KAAO;AAGrB,UAAM5xB,OAAO6f,SAAS1T,IAAI,CAACa,MAAAA;AACzB,YAAMqH,QAAQ2G,OAAOla,OAAO,CAAC+C,MAAMA,EAAEiQ,YAAY9G,EAAEtG,CAAC,EAAED;AACtD,aAAO;QACLqN,SAAS9G,EAAEtG;QACXmB,MAAMmF,EAAEnF;QACRwM;MACF;IACF,CAAA;AACA,WAAOrU;EACT;EAEA,MAAM6xB,oBACJ/d,SACAge,QACA53B,MACA;AACA,UAAM63B,OAAiB,CAAA;AACvB,UAAMC,UAAoB,CAAA;AAE1B,QAAIle,YAAYge,QAAQ;AACtB,WAAKlf,gBAAgBtY,MACnB,oDACA,IAAIgf,MAAM,kDAAA,EAAY7P,KAAK;AAE7B,aAAO;QACLuoB,SAASA,QAAQvrB;QACjBsrB;MACF;IACF;AAEA,UAAMp7B,QAAO,KAAKgc,IAAIhX,IAAI2L;AAG1B,UAAM0T,SAAS,MAAM,KAAK8L,iBAAiB7J,sBACzC;MACEnJ,SAASge;MACT5oB,QAAQvS,MAAKoR;IACf,GACA;MAAC;KAAO;AAGV,QAAI7N,SAAS,YAAY;AAEvB,YAAM,KAAK4sB,iBAAiBxrB,OAAO;QACjCwY;QACA5K,QAAQvS,MAAKoR;MACf,CAAA;AACAiqB,cAAQ7wB,KAAI,GAAI6Z,OAAO7O,IAAI,CAACa,MAAMA,EAAEnF,IAAI,CAAA;IAC1C;AACA,QAAI3N,SAAS,OAAO;AAElB,YAAM+3B,aACJ,MAAM,KAAKnL,iBAAiB7J,sBAC1B;QAAE/T,QAAQvS,MAAKoR;QAAI+L;MAAQ,GAC3B;QAAC;OAAO,GAEV3H,IAAI,CAACa,MAAMA,EAAEnF,IAAI;AACnB,iBAAWhE,KAAKmX,QAAQ;AACtB,YAAIiX,UAAU5e,SAASxP,EAAEgE,IAAI,GAAG;AAC9BkqB,eAAK5wB,KAAK0C,EAAEgE,IAAI;QAClB,OAAO;AACLmqB,kBAAQ7wB,KAAK0C,EAAEgE,IAAI;QACrB;MACF;IACF;AACA,QAAImqB,QAAQvrB,QAAQ;AAClB,YAAM,KAAKqgB,iBAAiBpiB,WAC1BstB,QAAQ7lB,IAAI,CAACtE,SAAAA;AACX,cAAMhE,IAAI,IAAI0X,OAAAA;AACd1X,UAAEgE,OAAOA;AACThE,UAAEiQ,UAAUA;AACZjQ,UAAEqF,SAASvS,MAAKoR;AAChB,eAAOlE;MACT,CAAA,CAAA;IAEJ;AACA,SAAK+O,gBAAgBvH,IACnB,UACA,iEAAe1U,MAAKkB,OAAO,iBAAOm6B,QAAQvrB,MAAM,iBAAOsrB,KAAKtrB,MAAM,IAClE;MACE5O,SAASlB,MAAKkB;MACdm6B,SAASA,QAAQvrB;MACjBsrB,MAAMA,KAAKtrB;IACb,CAAA;AAGF,WAAO;MACLurB,SAASA,QAAQvrB;MACjBsrB;IACF;EACF;AACF,GAvMe,OAAA/lB,MAAA,kBAAAA;;MACZR,iCAAAA;uCACY,kCAAA,cAAA,SAAA,6BAAA;GAFMgmB,cAAAA,WAAAA,OAAAA,MAAAA;;MAIlB/d,8BAAOgT,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GALP+K,cAAAA,WAAAA,oBAAAA,MAAAA;;MAOlB/d,8BAAOsK,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GARLyT,cAAAA,WAAAA,kBAAAA,MAAAA;;MAUlB/d,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAXNqmB,cAAAA,WAAAA,mBAAAA,MAAAA;;MAalB/d,8BAAOkK,kBAAAA;uCACoB,uBAAA,cAAA,SAAA,kBAAA;GAdT6T,cAAAA,WAAAA,sBAAAA,MAAAA;AAAAA,gBAAAA,eAAAA;MADpB/lB,+BAAAA;GACoB+lB,aAAAA;;;ACVrB,IAAAxlB;AAIA,IAAMkmB,aAANlmB,OAAA,cAAwBuV,aAAAA;EAGtB,OAAO1U,cAAc;AACnB,QAAI,CAAC,KAAKC,UAAU;AAClB,WAAKA,WAAW,IAAIolB,KAAAA;IACtB;AACA,WAAO,KAAKplB;EACd;AACF,GATwByU,OAAAA,MAAAA,cACtB,cADFvV,MACSc,YAAsB,OAD/Bd;AAWA,IAAA,oBAAekmB,UAAUrlB,YAAW;;;ACZpC,eAAsB5D,YAAYtN,KAAc;AAC9C,MAAI,CAACA,IAAIG,QAAQnB,OAAO;AACtB,WAAO;EACT;AACA,SAAOw3B,kBAAUlpB,YAAYtN,IAAIG,QAAQnB,KAAK;AAChD;AALsBsO;AAUf,SAASgjB,cAAcpyB,MAAY;AAExC,SAAOA,OAAO,OAAO,OAAO;AAC9B;AAHgBoyB;AAUT,SAAS5E,2BAA2Bhe,UAAgB;AACzD,SAAOtP,KAAKC,MAAMqB,KAAKD,IAAG,IAAK,GAAA,IAAQ,KAAKiO;AAC9C;AAFgBge;;;AjDHhB,IAAM+K,SAAS,IAAIC,6BAAO,QAAA;AAC1B,IAAMC,UAAU,GAAGj8B,qBAAAA,QAAQC,IAAG,CAAA;AAG9B,IAAMi8B,cAAc;EAAC;;AAKrBH,OAAOI,KACL,SACA,OAAO72B,KAAKiH,QAAAA;AACV,QAAM,EAAE3F,UAAU/C,KAAI,IAAKyB,IAAIgN;AAC/B,QAAM,EAAEZ,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,MAAMtX,YAAYtN,GAAAA;AAC9D,QAAM,EAAExD,IAAG,IAAKwD,IAAI8M;AACpB,QAAMgqB,WAAWr6B,kBAAAA,QAAKC,KAAKi6B,SAASr1B,QAAAA;AAEpC,MAAI,CAACs1B,YAAYlf,SAASnZ,IAAAA,GAAO;AAC/B0I,QAAI4tB,cAAc5R,YAAYhL,KAAKiL,UAAU;AAC7C;EACF;AACA,UAAQ3kB,MAAAA;IACN,KAAK;AACH,YAAMw4B,cAAc75B,gBAAAA,QAAG85B,aAAaF,UAAU;QAAEG,UAAU;MAAQ,CAAA;AAClE,UAAI/5B,gBAAAA,QAAGg6B,QAAQ;AACbh6B,wBAAAA,QAAGg6B,OAAOJ,UAAU,CAACnvB,QAAAA;AACnB,cAAIA,KAAK;AACPkG,wBAAY7N,KAAK2H,IAAIK,SAASL,IAAImG,KAAK;UACzC;QACF,CAAA;MACF;AACA,YAAM6c,cAAsB;QAAExS,SAAS3b;QAAK+Q;MAAO;AAEnD,YAAM4pB,aAAuBJ,YAC1B7xB,MAAM,IAAA,EACNsL,IAAIa,CAAAA,MAAKA,EAAE6L,KAAI,EAAGngB,QAAQ,WAAW,EAAA,CAAA,EACrCoI,OAAOkM,CAAAA,MAAKA,CAAAA;AAEf,YAAM+lB,iBAAiB,MAAM3M,aAAaE,WAAAA,GAAcna,IACtDa,CAAAA,MAAKA,EAAEnF,IAAI;AAGb,YAAMkqB,OAAiB,CAAA;AACvB,YAAMC,UAAoB,CAAA;AAE1Bc,iBAAWtyB,QAAQ,CAACqD,MAAAA;AAClB,YAAIkvB,cAAc1f,SAASxP,CAAAA,GAAI;AAC7BkuB,eAAK5wB,KAAK0C,CAAAA;QACZ,WACS,CAAC,CAACA,KAAK,CAACmuB,QAAQ3e,SAASxP,CAAAA,GAAI;AACpCmuB,kBAAQ7wB,KAAK0C,CAAAA;QACf;MACF,CAAA;AACA,UAAImuB,QAAQvrB,SAAS,GAAG;AACtB,cAAM4f,aACJ2L,QAAQ7lB,IAAItE,CAAAA,UAAS;UAAEA;QAAK,EAAA,GAC5Bye,WAAAA;MAEJ;AAEA/c,kBAAY5N,KAAK;QACf2P,QAAQ;QACR1V,KAAK,qDAAa2qB,UAAAA,iBAAiByR,QAAQvrB,MAAM,iBAAOsrB,KAAKtrB,MAAM;QACnEzG,MAAM;UACJnI,SAAS0oB;UACTyR,SAASA,QAAQvrB;UACjBsrB,MAAMA,KAAKtrB;QACb;MACF,CAAA;AACA7D,UAAIovB,QAAQ;QACVA,SAASA,QAAQvrB;QACjBsrB;MACF,CAAA;AACA;IACF;AACE;EACJ;AACAnvB,MAAIovB,QAAO;AACb,GACA;EACEgB,WAAW;AACb,CAAA;AAMFZ,OAAOj3B,IACL,SACA,OAAOQ,KAAKiH,QAAAA;AACV,QAAM,EAAEmF,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,MAAMtX,YAAYtN,GAAAA;AAC9D,QAAM,EAAExD,IAAG,IAAKwD,IAAI8M;AACpB,QAAM,EAAEwqB,OAAM,IAAKt3B,IAAI+F;AACvB,QAAMwxB,aAAaD,WAAW;AAC9B,QAAMjY,UACJ,MAAMoL,aACJ;IACEld;IACA4K,SAAS3b;EACX,GACA,CAAA,CAAE,GAEJgU,IAAIa,CAAAA,OAAM;IACVjF,IAAIiF,EAAEjF;IACNF,MAAMmF,EAAEnF;IACRzN,QAAQ4S,EAAE5S;IACV+4B,UAAUnmB,EAAEomB;IACZ/e,OAAOrH,EAAEqmB;EACX,EAAA;AACA,aAAWxvB,KAAKmX,QAAQ;AAEtB,UAAMsY,yBAAyB,MAAM3O,YAAY;MAC/Czb;MACA4K,SAAS3b;MACT6iB,QAAQnX,EAAEgE;IACZ,CAAA;AAEA,UAAM0rB,YACF1vB,EAAEzJ,UAAUk5B,uBAAuB7sB,UAAUysB,aAC3C,MAAM/hB,gBACNmiB,uBAAuBnnB,IACrBa,CAAAA,MAAK,eAAeA,EAAE6G,QAAQ,IAAI7G,EAAErT,IAAI,IAAIqT,EAAEnF,IAAI,EAAE,CAAA,IAGtD,CAAA;AAEN,UAAMykB,YAAYzoB,EAAEzJ,SAChBm5B,UAAUzyB,OAAOkM,CAAAA,MAAKA,EAAErX,SAAS,GAAA,EAAK8Q,SACtC;AACJ5C,MAAEyoB,YAAYA;AAMd,QAAI7Q,cAAc;AAClB,QAAIyX,YAAY;AACdzX,oBAAc5X,EAAEzJ,SACX,MAAM6P,aAAa;QAClB,QAAQ;QACR,+BAA+B9R;QAC/B,8BAA8B0L,EAAEgE;QAChC,+BAA+BqB;QAC/B,iBAAiB;QACjB,iBAAiB;UACf6f,QAAQ;QACV;MACF,CAAA,IACG,MAAM9e,aAAa;QACpB,QAAQ;QACR,+BAA+B9R;QAC/B,kCAAkC0L,EAAEgE;QACpC,oBAAoBqB;QACpB,iBAAiB;QACjB,iBAAiB;UACf6f,QAAQ;QACV;MACF,CAAA,IACA;IACN;AAEAllB,MAAE4X,cAAc1hB,KAAKsvB,IAAI5N,aAAa6Q,SAAAA;AAGtCzoB,MAAEwQ,QAAQta,KAAKsvB,IAAIxlB,EAAEwQ,OAAOxQ,EAAE4X,WAAW;EAC3C;AACAlS,cAAY5N,KAAK;IACf2P,QAAQ;IACR1V,KAAK,qDAAa2qB,UAAAA;IAClBvgB,MAAM;MACJnI,SAAS0oB;IACX;EACF,CAAA;AACA3d,MAAIovB,QAAQ;IACVhX;EACF,CAAA;AACF,GACA;EACEgY,WAAW;AACb,CAAA;AAMFZ,OAAOj3B,IAAI,eAAe,OAAOQ,KAAKiH,QAAAA;AACpC,QAAM,EAAEzK,IAAG,IAAKwD,IAAI8M;AACpB,QAAM,EAAEZ,KAAI,IAAKlM,IAAI+F;AACrB,QAAM,CAACwe,IAAAA,IAAQ,MAAMpC,YAAY;IAC/BpX,GAAGvO;EACL,CAAA;AACA,MAAI,CAAC+nB,MAAM;AACTtd,QAAIovB,QAAQ;MACV7T,OAAO;IACT,CAAA;AACA;EACF;AACA,QAAMnD,SAAS,MAAMoL,aAAa;IAChCtS,SAAS3b;IACT0P;EACF,CAAA;AACA,QAAMsW,QAAQnD,OAAOvU,WAAW;AAChC8C,cAAY5N,KAAK;IACf2P,QAAQ;IACR1V,KAAK,6EAAiBsqB,KAAKrY,IAAI,6BAASA,IAAAA,iBACtCsW,QAAQ,WAAM,QAAA;IAEhBne,MAAM;MACJ6a,UAAUqF,KAAKrY;MACfA;MACAsW;IACF;EACF,CAAA;AACAvb,MAAIovB,QAAQ;IACV7T;EACF,CAAA;AACF,CAAA;AAKAiU,OAAO92B,OACL,SACA,OAAOK,KAAKiH,QAAAA;AACV,QAAM,EAAEzK,IAAG,IAAKwD,IAAI8M;AACpB,QAAM,EAAEV,GAAE,IAAKpM,IAAIgN;AACnB,QAAM,EAAEZ,IAAImB,QAAQrR,SAAS0oB,WAAU,IAAK,MAAMtX,YAAYtN,GAAAA;AAC9D,MAAIxD,OAAO4P,MAAMmB,QAAQ;AACvB,UAAM,CAACrF,CAAAA,IAAK,MAAMuiB,aAAa;MAC7Bre;IACF,CAAA;AACA,QAAIlE,GAAG;AACL0iB,mBAAa;QACXxe;QACAmB;QACA4K,SAAS3b;MACX,CAAA;AAGE,OAAA,YAAA;AACA,cAAM,CAAC+nB,IAAAA,IAAQ,MAAMpC,YAAY;UAC/BpX,GAAGvO;QACL,CAAA;AACA,YAAI+nB,MAAM;AACR3W,sBAAY5N,KAAK;YACf2P,QAAQ;YACR1V,KAAK,qDAAa2qB,UAAAA,iBAAiBL,KAAKrY,IAAI,iBAAOhE,EAAEgE,IAAI;YACzD7H,MAAM;cACJnI,SAAS0oB;cACT1F,UAAUqF,KAAKrY;cACfA,MAAMhE,EAAEgE;YACV;UACF,CAAA;QACF;MACF,GAAA;IACF;EACF;AAEAjF,MAAIovB,QAAO;AACb,GACA;EACEgB,WAAW;AACb,CAAA;AAMFZ,OAAOpgB,IAAI,SAAS,OAAOrW,KAAKiH,QAAAA;AAC9B,QAAM,EAAEzK,IAAG,IAAKwD,IAAI8M;AACpB,QAAM,EAAEZ,MAAM5K,UAAUtD,KAAI,IAAKgC,IAAIgN;AACrC,MAAI,CAACd,QAAQ,CAAC5K,YAAY,CAAC9E,OAAO,CAACwB,MAAM;AACvC4P,gBAAY5N,KAAK;MACf2P,QAAQ;MACR1V,KAAK;MACLoK,MAAM;QACJ7H;QACA0P;QACA5K;QACAtD;MACF;IACF,CAAA;AACAiJ,QAAI4tB,cAAc5R,YAAYE,QAAQC,WAAW;AACjD;EACF;AACA,QAAMjM,QAAQ,MAAM6R,YAAY;IAC9B7Q,SAAS3b;IACT0P,MAAM5K;IACNtD;EACF,CAAA;AACA,MAAImZ,MAAMrM,WAAW,GAAG;AACtB8C,gBAAY5N,KAAK;MACf2P,QAAQ;MACR1V,KAAK;MACLoK,MAAM;QACJ7H;QACA0P;QACA5K;QACAtD;MACF;IACF,CAAA;AACAiJ,QAAI4tB,cAAc5R,YAAYE,QAAQC,WAAW;AACjD;EACF;AACA,QAAMyU,gBAEF,MAAMpN,aACJ;IACEtS,SAAS3b;IACT0P;EACF,GACA;IAAC;IAAQ;GAAe,GAE1B,CAAA,EAAGwrB,gBAAgB;AAEvB,QAAM7M,aACJ;IACEpsB,QAAQ;IACRohB,YAAY,oBAAIngB,KAAAA;IAChBogB,aAAa+X,eAAe;EAC9B,GACA;IACE3rB;IACAiM,SAAS3b;EACX,CAAA;AAEF2lB,cAAY;IACVpX,GAAGvO;EACL,CAAA,EAAG+K,KAAK,CAAC,CAACgd,IAAAA,MAAK;AACb,QAAIA,MAAM;AACR3W,kBAAY5N,KAAK;QACf2P,QAAQ;QACR1V,KAAK,8EAAkBsqB,KAAKrY,IAAI,iBAAOA,IAAAA;QACvC7H,MAAM;UACJ7H;UACA0iB,UAAUqF,KAAKrY;UACfA;UACA5K;UACAtD;QACF;MACF,CAAA;IACF;EACF,CAAA;AAEAiJ,MAAIovB,QAAO;AACb,CAAA;AACA,IAAA,iBAAeI;;;AkDtWf,IAAMqB,UAAU;EAACzY;;AAEjB,IAAA,iBAAeyY,QAAQzxB,OACrB,CAACsD,KAAc8sB,YAAW9sB,IAAI0L,OAAOohB,QAAOsB,UAAS,CAAA,GACrD,CAAA,CAAE;;;ACZJ,IAAAn2B,wBASO;;;ICTA;UAAKo2B,aAAU;AAAVA,EAAAA,YAAAA;;;;IAIVC;EAAAA,IAAAA,CAAAA,IAAAA;AAJUD,EAAAA,YAAAA;;;;IAQVE;EAAAA,IAAAA,CAAAA,IAAAA;AARUF,EAAAA,YAAAA;;;;IAYVG;EAAAA,IAAAA,CAAAA,IAAAA;AAZUH,EAAAA,YAAAA;;;;IAgBVI;EAAAA,IAAAA,CAAAA,IAAAA;AAhBUJ,EAAAA,YAAAA;;;;IAoBVK;EAAAA,IAAAA,CAAAA,IAAAA;GApBUL,eAAAA,aAAAA,CAAAA,EAAAA;;;ACQL,SAASM,YAAYC,MAAU;AACpC,SAAO3vB,iBAAuB,QAAQ2vB,IAAAA;AACxC;AAFgBD;AAIT,SAASE,SAASD,MAAuB;AAC9C,SAAOtvB,eAAqB,QAAQsvB,IAAAA;AACtC;AAFgBC;AAIT,SAASC,WAAW1yB,QAA0BwyB,MAAuB;AAC1E,SAAOhwB,iBAAuB,QAAQxC,QAAOwyB,IAAAA;AAC/C;AAFgBE;;;AChBhB,IAAA72B,wBAA6B;AAEtB,SAAS82B,QAAAA;AACd,aAAOC,oCAAa,KAAA;AACtB;AAFgBD;AAIT,SAASE,cAAAA;AACd,aAAOD,oCAAa,WAAA;AACtB;AAFgBC;;;;;;;;;;;;;;;;;;;;;;;;;AHchB,IAAMC,aAAa;EAAExB,WAAW;EAAMyB,WAAW9T,WAAWE;AAAM;;IAG7C6T,kBAAN1oB,OAAA,MAAA;;;;EAIb,MACM2oB,QAAmBhsB,MAAYhN,KAAgB;AACnD4N,gBAAY5N,KAAK;MACf2P,QAAQ;MACR1V,KAAK;MACLoK,MAAM2I;IACR,CAAA;AAEA,UAAMurB,OAAa;MACjB,GAAGvrB;MACHZ,IAAItC,aAAAA;MACJrL,QAAQu5B,WAAWC;IACrB;AACA,UAAMK,YAAYC,IAAAA;EACpB;EAEA,MACMU,aAAa;AACjB,UAAMC,SAAS,MAAMV,SAAS,CAAC,CAAA;AAE/BU,WAAOjqB,KAAK,CAACkqB,GAAGC,MAAAA;AACd,YAAMC,QAAQltB,gBAAgBgtB,EAAE/sB,EAAE;AAClC,YAAMktB,QAAQntB,gBAAgBitB,EAAEhtB,EAAE;AAClC,aAAOktB,QAAQD;IACjB,CAAA;AACA,WAAOH,OAAO1oB,IAAI,CAAC+nB,SAAAA;AACjB,YAAM,EAAEgB,OAAOC,KAAK/6B,QAAQ2N,IAAIqtB,QAAO,IAAKlB;AAC5C,YAAMmB,aAAavtB,gBAAgBC,EAAAA;AACnC,aAAO;QACLmtB;QACAC;QACA/6B;QACA2N;QACAqtB;QACAC;MACF;IACF,CAAA;EACF;EAEA,MACMC,iBACWvtB,IACI3N,QACnB;AACA,UAAMg6B,WAAW;MAAErsB;IAAG,GAAG;MAAE8f,MAAM;QAAEztB;MAAO;IAAE,CAAA;AAE5C,QAAIA,WAAWu5B,WAAWG,OAAO;AAC/B,YAAMM,WAAW;QAAErsB;MAAG,GAAG;QAAE8f,MAAM;UAAE0N,WAAW,oBAAIl6B,KAAAA;QAAO;MAAE,CAAA;IAC7D;AACA,QAAIjB,WAAWu5B,WAAWK,SAAS55B,WAAWu5B,WAAWI,KAAK;AAC5D,YAAMK,WAAW;QAAErsB;MAAG,GAAG;QAAE8f,MAAM;UAAE2N,SAAS,oBAAIn6B,KAAAA;QAAO;MAAE,CAAA;IAC3D;EACF;EAEA,MACMo6B,eAAgC1tB,IAAuBY,MAAY;AACvE,UAAM,EAAEusB,OAAOC,IAAG,IAAKxsB;AACvB,UAAMyrB,WAAW;MAAErsB;IAAG,GAAG;MAAE8f,MAAM;QAAEqN;QAAOC;MAAI;IAAE,CAAA;EAClD;EAEA,MACMO,YAAqB3sB,IAAY;AACrC,UAAM8rB,SAAS,MAAMV,SAAS;MAC5BwB,KAAK;QACH;UAAEv7B,QAAQu5B,WAAWG;QAAM;QAC3B;UAAE15B,QAAQu5B,WAAWE;QAAK;QAC1B;UAAEz5B,QAAQu5B,WAAWI;QAAI;;IAE7B,CAAA;AACA,UAAMtc,SAAS,CAAA;AACf,eAAWyc,QAAQW,QAAQ;AACzB,YAAM,EAAEK,OAAOC,KAAKptB,IAAIwtB,WAAWn7B,OAAM,IAAK85B;AAC9C,YAAM7f,QAAQ,MAAM6Q,gBAAgB;QAClCsC,SAAS0M,KAAKnsB;QACd7N,MAAMorB,WAAWC;MACnB,CAAA;AACA,YAAMqQ,gBACH,MAAM1Q,gBAAgB;QACrBsC,SAAS0M,KAAKnsB;QACd7N,MAAMorB,WAAWC;QACjBxc;MACF,CAAA,IAAM;AACR0O,aAAOtW,KAAK;QACV+zB,OAAO96B,WAAWu5B,WAAWI,MAAM,wBAASmB,KAAAA,KAAUA;QACtDC;QACAptB;QACAwtB;QACAlhB;QACAuhB;QACAx7B;MACF,CAAA;IACF;AAEAqd,WAAO7M,KAAK,CAACkqB,GAAGC,MAAMA,EAAE1gB,QAAQygB,EAAEzgB,KAAK;AACvC,WAAOoD;EACT;;;;EAKA,MACMoe,UAA2B9tB,IAAqBgB,IAAY;AAChE,UAAM8rB,SAAS,MAAMV,SAAS;MAAEpsB;IAAG,CAAA;AACnC,QAAI,CAAC8sB,OAAOpuB,QAAQ;AAClB,aAAO4pB,+BAAS0B,KAAK,IAAI,gCAAA;IAC3B;AACA,UAAM+D,aAAa,MAAM1Q,WAAW;MAClCrc;MACAye,SAASzf;MACT7N,MAAMorB,WAAWC;IACnB,CAAA;AACA,QAAIuQ,WAAWrvB,QAAQ;AACrB,aAAO4pB,+BAAS0B,KAAK,GAAG,sCAAA;IAC1B;AACA,UAAMhN,UAAU;MACd7qB,MAAMorB,WAAWC;MACjBiC,SAASzf;MACTgB;IACF,CAAA;EACF;AACF,GA5He,OAAAiD,MAAA,mBAAAA;;MAIZ+pB,4BAAK,OAAO;IAAEC,MAAM;EAAK,CAAA;EACXC,UAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,SAAA,cAAA,SAAA;WAAW,oCAAA,cAAA,SAAA;;GALvBvB,eAAAA,WAAAA,WAAAA,IAAAA;;MAoBlBwB,2BAAI,OAAO1B,UAAAA;;;GApBOE,eAAAA,WAAAA,cAAAA,IAAAA;;MA2ClByB,2BAAI,UAAU3B,UAAAA;EAEZyB,UAAAA,OAAAA,+BAAQ,IAAA,CAAA;EACRA,UAAAA,OAAAA,+BAAQ,QAAA,CAAA;;;;WAAkB,eAAA,cAAA,SAAA;;GA9CVvB,eAAAA,WAAAA,oBAAAA,IAAAA;;MA0DlByB,2BAAI,cAAc3B,UAAAA;EACG4B,UAAAA,OAAAA,iCAAU,IAAA,CAAA;EAAmBH,UAAAA,OAAAA,+BAAAA,CAAAA;;;;WAAgB,SAAA,cAAA,SAAA;;GA3DhDvB,eAAAA,WAAAA,kBAAAA,IAAAA;;MAgElBwB,2BAAI,YAAY;IAAEF,MAAM;EAAK,CAAA;EACX3B,UAAAA,GAAAA,MAAAA,CAAAA;;;;;GAjEAK,eAAAA,WAAAA,eAAAA,IAAAA;;MAwGlBqB,4BAAK,cAAc;IAAEC,MAAM;EAAK,CAAA;EAChBI,UAAAA,OAAAA,iCAAU,IAAA,CAAA;EAAmB/B,UAAAA,GAAAA,MAAAA,CAAAA;;;;;;GAzG3BK,eAAAA,WAAAA,aAAAA,IAAAA;AAAAA,iBAAAA,eAAAA;MADpB2B,wCAAiB,MAAA;GACG3B,cAAAA;;;AIpBrB,IAAAn3B,wBAQO;AAEP,IAAAmC,kBAAyB;;;;;;;;;;;;;;;;;;;;;;;AA4BzB,IAAMka,QAAQ;EACZ6a,WAAW9T,WAAWE;EACtBmS,WAAW;AACb;AAEA,IAAMsD,iBAAiB;;IAEFC,sBAANvqB,OAAA,MAAA;EAAA;AACLwqB,qCAAmB,CAAA;;EAEnBC,UAAUjO,MAAa;AAC7B,WAAOA,KAAKrc,IAAI,CAACvQ,QAAAA;AACf,YAAM,EAAE1B,MAAM8F,MAAM+H,GAAE,IAAKnM;AAC3B,YAAMmf,OAAO,IAAIrV,yBAASqC,EAAAA,EAAIC,aAAY;AAC1C,UAAI9N,SAAS,WAAW;AACtB,cAAM2L,KAAI7F;AAEV,eAAO;UACL+H;UACAgT;UACA7gB;UACA6O,IAAIlD,GAAEkD;UACNnT,KAAK,GAAGiQ,GAAE6C,MAAM,IAAI7C,GAAE3J,GAAG,IAAI,GAAG2J,GAAEwD,YAAY,CAAA,IAAK;QACrD;MACF;AACA,UAAInP,SAAS,YAAY;AACvB,cAAM2L,KAAI7F;AAEV,eAAO;UACL+H;UACAgT;UACA7gB;UACAtE,MACGiQ,IAAGrK,MAAM5F,OAAO,mBAEbiQ,GAAErK,MAAMwE,MAAMnG,QAAQ,IAAI8M,WAAWd,GAAErK,MAAMwE,MAAMnG,IAAAA,CAAAA,MACpD;UACLkP,IAAIlD,IAAGlK,KAAKoN,MAAM;QACpB;MACF;AAEA,UAAI7O,SAAS,MAAM;AACjB,cAAM2L,KAAI7F;AAEV,eAAO;UACL+H;UACAgT;UACA7gB;UACA6O,IAAIlD,GAAEkD;UACNnT,KAAK,GAAGiQ,GAAEzN,IAAI;QAChB;MACF;AACA,YAAMyN,IAAI7F;AAGV,aAAO;QACL+H;QACAgT;QACA7gB;QACA6O,IAAIlD,GAAGlK,KAAKoN,MAAM;QAClBnT,KAAKiQ,GAAGjQ,OAAO;MACjB;IACF,CAAA;EACF;EAEQ8gC,wBAAwB58B,SAAiB;AAC/C,UAAM,EAAE68B,wBAAuB,IAAK/2B,YAAYuC,cAAa;AAC7D,WAAO9G,KAAKD,IAAG,IAAKtB,UAAU,MAAO,MAAM68B,2BAA2B;EACxE;;;;;EAMA,MACMC,aAA8B7uB,IAAY;AAC9C,UAAM,CAACnM,GAAAA,IAAO,MAAMmP,QAAQ;MAAEhD;IAAG,CAAA;AACjC,WAAOnM,IAAIoE,KAAKkJ;AAChB,WAAOtN,IAAIoE;EACb;EAEA,MACM62B,kBAAkB;AACtB,UAAMz7B,MAAM,oBAAIC,KAAAA;AAChB,UAAMy7B,UAAU,oBAAIz7B,KAClB,GAAGD,IAAImL,YAAW,CAAA,IAAMnL,IAAI4K,SAAQ,IAAK,CAAA,IAAK5K,IAAI6K,QAAO,CAAA,QAAU;AAErE,UAAM8wB,QAAQ,MAAM3T,cAAc;MAAC;KAAY;AAC/C,UAAM4T,aAAaD,MAAMj2B,OACvBkjB,CAAAA,MAAK,IAAI3oB,KAAK2oB,EAAEiT,SAAS,IAAIH,OAAAA,EAC7BrwB;AAEF,UAAMqM,QAAQ,MAAM4R,eAAe,CAAC,GAAG;MAAC;MAAQ;KAAO;AACvD,UAAMwS,aAAapkB,MAAMhS,OAAOiS,CAAAA,MAAK,IAAI1X,KAAK0X,EAAEgI,IAAI,IAAI+b,OAAAA,EAASrwB;AAGjE,UAAM8L,WAAW,MAAML,cAAaC,YAAW;AAE/C,UAAMuW,WAAW,MAAMze,aAAa,CAAC,CAAA;AACrC,UAAMktB,YAAY,MAAMhtB,qBAAqB2sB,OAAAA;AAG7C,UAAMM,SAAS,MAAMpsB,eAAe;MAClC9Q,MAAM;IACR,CAAA;AACA,UAAMm9B,KAAK,IAAIlkB,IAAIikB,OAAOjrB,IAAImrB,CAAAA,OAAMA,GAAGt3B,KAAK+I,EAAE,CAAA,EAAGlP;AAEjD,UAAM09B,UAAU,MAAMrsB,mBAAmB4rB,OAAAA;AACzC,UAAMU,UAAU,IAAIrkB,IAAIokB,QAAQprB,IAAImrB,CAAAA,OAAMA,GAAGt3B,KAAK+I,EAAE,CAAA,EAAGlP;AAGvD,UAAM49B,eAAe,MAAMvmB,YAAY,0BAAA;AACvC,UAAMwmB,mBAAmB,MAAMxmB,YAAY,GAAA,EAAKhO,KAAK8J,CAAAA,MACnDA,EAAElM,OAAOkM,CAAAA,OAAKspB,eAAe9wB,KAAKwH,GAAE7U,GAAG,CAAA,CAAA;AAGzC,WAAO;MACLxB,MAAM;QACJuyB,KAAK6N,MAAMtwB;QACXkxB,QAAQX;MACV;MACApjB,MAAM;QACJgkB,QAAQ;UACN1O,KAAKpW,MAAMrM;UACXkxB,QAAQT;UACRr9B,MAAM8M,WAAWmM,MAAM9Q,OAAO,CAACknB,KAAKnW,MAAMmW,MAAMnW,EAAElZ,MAAM,CAAA,CAAA;QAC1D;QACAg+B,KAAK;UACH3O,KAAK3W,SAAS9L;UACd5M,MAAM8M,WAAW4L,SAASvQ,OAAO,CAACknB,KAAKnW,MAAMmW,MAAMnW,EAAEnZ,OAAO,CAAA,CAAA;QAC9D;MACF;MACAgC,KAAK;QACHstB,KAAKR;QACLiP,QAAQR,UAAU1wB;MACpB;MACA6wB,IAAI;QACFQ,OAAO;UACL5O,KAAKqO,QAAQ9wB;UACb4wB,IAAIG;QACN;QACA9iB,KAAK;UACHwU,KAAKkO,OAAO3wB;UACZ4wB;QACF;MACF;MACA3M,UAAU;QACRhW,KAAK;UACHwU,KAAKuO,aAAahxB,SAASixB,iBAAiBjxB;UAC5C5M,MAAM8M,WACJ8wB,aACGzmB,OAAO0mB,gBAAAA,EACP11B,OAAO,CAACknB,KAAKzoB,SAASyoB,MAAMzoB,KAAK7G,OAAO,CAAA,CAAA;QAE/C;QACAm+B,SAAS;UACP7O,KAAKuO,aACFzmB,OAAO0mB,gBAAAA,EACP52B,OAAOL,CAAAA,SACN,KAAKi2B,wBAAwBj2B,KAAK3G,UAAU,GAAA,CAAA,EAC5C2M;UACJ5M,MAAM8M,WACJ8wB,aACGzmB,OAAO0mB,gBAAAA,EACP52B,OAAOL,CAAAA,SACN,KAAKi2B,wBAAwBj2B,KAAK3G,UAAU,GAAA,CAAA,EAE7CkI,OAAO,CAACknB,KAAKzoB,SAASyoB,MAAMzoB,KAAK7G,OAAO,CAAA,CAAA;QAE/C;MACF;IACF;EACF;EAEA,MACMo+B,qBAAqBr8B,KAAgB;AAEzC,UAAM87B,eAAe,MAAMvmB,YAAY,0BAAA;AACvC,UAAM6mB,UAAUN,aACb32B,OAAOL,CAAAA,SAAQ,KAAKi2B,wBAAwBj2B,KAAK3G,UAAU,GAAA,CAAA,EAC3DqS,IAAIa,CAAAA,MAAKA,EAAE7U,GAAG;AACjB,UAAMmX,iBAAiByoB,SAASp8B,GAAAA;AAGhC,UAAMs8B,YAAY,MAAM/mB,YAAY,GAAA,GAAMpQ,OAAOkM,CAAAA,MAC/CspB,eAAe9wB,KAAKwH,EAAE7U,GAAG,CAAA;AAE3B,UAAM+/B,aAAaD,SAChBn3B,OAAOL,CAAAA,SAAQ,KAAKi2B,wBAAwBj2B,KAAK3G,UAAU,GAAA,CAAA,EAC3DqS,IAAIa,CAAAA,MAAKA,EAAE7U,GAAG;AACjB,UAAMmX,iBAAiB4oB,YAAYv8B,GAAAA;AACnC4N,gBAAY5N,KAAK;MACf2P,QAAQ;MACR1V,KAAK,wCAAUmiC,QAAQtxB,SAASyxB,WAAWzxB,MAAM;MACjDzG,MAAM;QACJ4B,MAAMm2B,QAAQ/mB,OAAOknB,UAAAA;MACvB;IACF,CAAA;EACF;;;;EAKA,MACMC,YAAY;AAChB,QAAI3P,OAAO,CAAA;AACX,QAAI,KAAKgO,WAAW;AAClBhO,aAAO,KAAKgO;AACZxrB,qBAAe,CAAC,CAAA,EAAG9H,KAAK,CAAClD,SAAAA;AACvB,aAAKw2B,YAAYx2B;MACnB,CAAA;IACF,OACK;AACHwoB,aAAO,MAAMxd,eAAe,CAAC,CAAA;AAC7B,WAAKwrB,YAAYhO;IACnB;AACA,UAAM/Q,SAAS,KAAKgf,UAAUjO,IAAAA;AAE9B,WAAO;MACLA,MAAM/Q;IACR;EACF;;;;EAKA,MACM2gB,WACal+B,MACIL,OAAO,GACNwH,QAAQ,GACXg3B,SAAS,IAC5B;AACA,QAAI32B,SAA0B;MAC5BxH;IACF;AACA,QAAIm+B,QAAQ;AACV,cAAQn+B,MAAAA;QACN,KAAK;AACHwH,UAAAA,SAAQ;YACN,GAAGA;YACHi0B,KAAK;cACH;gBACE,iBAAiB;kBACf5M,QAAQ,KAAKsP,MAAAA;gBACf;cACF;cACA;gBACE,eAAe;kBACbtP,QAAQ,KAAKsP,MAAAA;gBACf;cACF;;UAEJ;AACA;QACF,KAAK;AACH32B,UAAAA,SAAQ;YACN,GAAGA;YACHi0B,KAAK;cACH;gBACE,eAAe;kBACb5M,QAAQ,KAAKsP,MAAAA;gBACf;cACF;cACA;gBACE,YAAY;kBACVtP,QAAQ,KAAKsP,MAAAA;gBACf;cACF;cACA;gBACE,WAAW;kBACTtP,QAAQ,KAAKsP,MAAAA;gBACf;cACF;;UAEJ;AACA;QACF,KAAK;AACH32B,UAAAA,SAAQ;YACN,GAAGA;YACHi0B,KAAK;cACH;gBACE,aAAa;kBACX5M,QAAQ,KAAKsP,MAAAA;gBACf;cACF;cACA;gBACE,WAAW;kBACTtP,QAAQ,KAAKsP,MAAAA;gBACf;cACF;;UAEJ;AACA;QACF,KAAK;AACH32B,UAAAA,SAAQ;YACN,GAAGA;YACHi0B,KAAK;cACH;gBACE,eAAe;kBACb5M,QAAQ,KAAKsP,MAAAA;gBACf;cACF;cACA;gBACE,YAAY;kBACVtP,QAAQ,KAAKsP,MAAAA;gBACf;cACF;;UAEJ;AACA;QACF;AACE;MACJ;IACF;AACA,UAAM3P,WAAW,MAAMze,aAAavI,MAAAA;AACpC,UAAM8mB,OAAO,MAAM/d,uBAAuBpJ,QAAQ,KAAKxH,MAAMA,MAAM6H,MAAAA;AACnE,WAAO;MACL8mB,MAAM,KAAKiO,UAAUjO,IAAAA;MACrBU,KAAKR;IACP;EACF;EAEA,MACM4P,oBACcC,OACCn+B,QACnB;AACA,UAAMiuB,UAAU,MAAMjD,WAAW;MAC/BlrB,MAAMorB,WAAWI;IACnB,CAAA;AACA,UAAMV,SAASqD,QAAQxjB,KAAKmI,CAAAA,MAAKA,EAAEhN,KAAKu4B,UAAUA,KAAAA;AAClD,QAAI,CAACvT,QAAQ;AACX,YAAMD,UAAU;QACd7qB,MAAMorB,WAAWI;QACjB1lB,MAAM;UACJu4B;UACAn+B;QACF;MACF,CAAA;AACA;IACF;AACA,UAAMirB,aACJ;MACEtd,IAAIid,OAAOjd;IACb,GACA;MACE8f,MAAM;QACJ7nB,MAAM;UACJu4B;UACAn+B;QACF;MACF;IACF,CAAA;EAEJ;EAEA,MACMo+B,mBAAsCD,OAAe;AACzD,QAAIE,eAAe;AACnB,QAAI;AACF,YAAMpQ,UAAU,MAAMjD,WAGnB;QACDlrB,MAAMorB,WAAWI;MACnB,CAAA;AACA,YAAMV,SAASqD,QAAQxjB,KAAKmI,CAAAA,MAAKA,EAAEhN,KAAKu4B,UAAUA,KAAAA;AAClDE,qBAAe13B,QAAQikB,QAAQhlB,MAAM5F,MAAAA;IACvC,SACOE,OAAO;AACZC,cAAQ4S,KAAK,qDAAqD7S,OAAOqJ,WAAWrJ,KAAAA;IACtF;AACA,WAAO;MACLF,QAAQq+B;IACV;EACF;AACF,GAlXe,OAAAzsB,MAAA,uBAAAA;;MAmEZkqB,2BAAI,WAAWtc,KAAAA;EACIwc,WAAAA,OAAAA,iCAAU,IAAA,CAAA;;;;;GApEXG,mBAAAA,WAAAA,gBAAAA,IAAAA;;MA0ElBL,2BAAI,SAAStc,KAAAA;;;GA1EK2c,mBAAAA,WAAAA,mBAAAA,IAAAA;;MAuKlBmC,8BAAO,YAAY9e,KAAAA;;;WACY,cAAA,cAAA,SAAA;;GAxKb2c,mBAAAA,WAAAA,wBAAAA,IAAAA;;MAoMlBL,2BAAI,OAAOtc,KAAAA;;;GApMO2c,mBAAAA,WAAAA,aAAAA,IAAAA;;MA2NlBR,4BAAK,OAAOnc,KAAAA;EAEVqc,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,UAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,WAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,QAAA,CAAA;;;WAHc,YAAA,cAAA,SAAA;;;;;GA7NNM,mBAAAA,WAAAA,cAAAA,IAAAA;;MA4TlBR,4BAAK,kBAAkBnc,KAAAA;EAErBqc,WAAAA,OAAAA,+BAAQ,OAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,QAAA,CAAA;;;;;;GA/TQM,mBAAAA,WAAAA,uBAAAA,IAAAA;;MA8VlBL,2BAAI,gBAAA;EACqByC,WAAAA,OAAAA,gCAAS,OAAA,CAAA;;;;;GA/VhBpC,mBAAAA,WAAAA,sBAAAA,IAAAA;AAAAA,qBAAAA,eAAAA;MADpBF,wCAAiB,gBAAA;GACGE,kBAAAA;;;AChDrB,IAAAh5B,wBAWO;;;ACXP,IAAAA,wBAAyB;AAElB,SAASq7B,kBAAkBt1B,KAAQ;AACxC,QAAM,EAAE3N,MAAMC,KAAKoK,KAAI,IAAKsD,OAAO,CAAC;AACpC,MAAI3N,QAAQC,OAAOoK,MAAM;AACvB,WAAOqwB,+BAAS0B,KAAKp8B,MAAMC,KAAKoK,IAAAA;EAClC;AAEA,MAAIrK,QAAQC,KAAK;AACf,WAAOy6B,+BAASG,cAAcltB,GAAAA;EAChC;AACA,QAAMA;AACR;AAVgBs1B;;;;;;;;;;;;;;;;;;;;;;;;;ADoBhB,IAAMhf,SAAQ;EACZoZ,WAAW;AACb;;IAGqB6F,oBAAN7sB,OAAA,MAAA;EAAA;AAEb2G;AAGAC;AAGAkmB;;EAEA,MACMrH,UAEct5B,KACD0P,MACjB;AACA,QAAI;AACF,YAAM,KAAKixB,cAAcrH,UAAUt5B,KAAK0P,IAAAA;IAC1C,SAASvN,OAAO;AACd,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;;;;EAKA,MACMo3B,mBACa7pB,MACC1P,KAClB;AACA,UAAMgmB,QAAQ,MAAM,KAAK2a,cAAcpH,mBAAmBv5B,KAAK0P,IAAAA;AAC/D,WAAO;MACLsW;IACF;EACF;EAEA,MACMwT,kBAAoC7d,SAAiB;AACzD,WAAO,KAAKglB,cAAcnH,kBAAkB7d,OAAAA;EAC9C;EAEA,MACM+d,oBACc/d,SACFge,QACC53B,MACjB;AACA,WAAO,KAAK4+B,cAAcjH,oBAAoB/d,SAASge,QAAQ53B,IAAAA;EACjE;AACF,GAlDe,OAAA8R,MAAA,qBAAAA;;MACZR,iCAAAA;uCACI,kCAAA,cAAA,SAAA,6BAAA;GAFcqtB,iBAAAA,WAAAA,OAAAA,MAAAA;;MAIlBplB,8BAAOtI,eAAAA;uCACS,oBAAA,cAAA,SAAA,eAAA;GALE0tB,iBAAAA,WAAAA,mBAAAA,MAAAA;;MAOlBplB,8BAAO+d,aAAAA;uCACO,kBAAA,cAAA,SAAA,aAAA;GARIqH,iBAAAA,WAAAA,iBAAAA,MAAAA;;MAUlB9C,4BAAK,aAAanc,MAAAA;EAGhBwc,WAAAA,OAAAA,iCAAU,KAAA,CAAA;EACVH,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;;;;;;GAdQ4C,iBAAAA,WAAAA,aAAAA,IAAAA;;MA0BlB9C,4BAAK,aAAA;EAEHE,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EACRG,WAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;;GA7BMyC,iBAAAA,WAAAA,sBAAAA,IAAAA;;MAqClB3C,2BAAI,kBAAkBtc,MAAAA;EACEwc,WAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;GAtChByC,iBAAAA,WAAAA,qBAAAA,IAAAA;;MA0ClB1C,2BAAI,kBAAkBvc,MAAAA;EAEpBwc,WAAAA,OAAAA,iCAAU,KAAA,CAAA;EACVH,WAAAA,OAAAA,+BAAQ,KAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;;;;;;;GA9CQ4C,iBAAAA,WAAAA,uBAAAA,IAAAA;AAAAA,mBAAAA,eAAAA;MADpBxC,wCAAiB,QAAA;GACGwC,gBAAAA;;;AEvBrB,IAAAt7B,wBAYO;AACP,IAAAmC,kBAAyB;AAGzB;AAaA;AACA;AACA,wBAAuB;AACvB,IAAAvC,kBAAe;AACf,IAAAD,oBAAiB;;;;;;;;;;;;;;;;;;;;;;;AAGjB,IAAM0c,SAAQ;EACZoZ,WAAW;AACb;AAEA,IAAM+F,UAAU;EACd/F,WAAW;AACb;;IAGqBgG,kBAANhtB,OAAA,MAAA;EAAA;AAEL2G;AAGAkb;AAGAjb;AAGAqmB;AAGAvZ;;;;;EAKR,MACMwZ,cACY9Q,QACDzxB,OACfgF,KACA;AACA4N,gBAAY5N,KAAK;MACf2P,QAAQ;MACR1V,KAAK,iEAAee,MAAKkB,OAAO;MAChCmI,MAAM;QACJnI,SAASlB,MAAKkB;QACduwB;MACF;IACF,CAAA;AACA,UAAMtV,QAAQ,MAAM6R,YAClB;MACE5c,IAAIqgB;MACJlf,QAAQvS,MAAKoR;IACf,GACA;MAAC;MAAY;MAAQ;KAAO;AAE9B,UAAMnG,OAAOkR,MAAM3G,IACjByH,CAAAA,SAAQ,eAAeA,KAAKC,QAAQ,IAAID,KAAKja,IAAI,IAAIia,KAAK/L,IAAI,EAAE;AAElE,UAAMnN,cAAc2sB,2BAA2BznB,YAAYuC,cAAa,GAAImlB,sBAAsB,CAAA;AAElG,UAAMU,cAAc,MAAM,KAAKtI,iBAAiBvO,gBAAgBvP,IAAAA;AAChE,UAAM6V,SAAS,MAAM9U,QAAQ+R,IAC3BsT,YAAY7b,IAAI,OAAO/R,QAAQ4nB,QAAAA;AAC7B,UAAI5nB,OAAOzE,SAAS,OAAOyE,OAAO4F,MAAMvG,UAAU4Z,SAAS,OAAA,GAAU;AACnE,cAAMsd,QAAQ,MAAM,KAAKjR,iBAAiB1J,mBACxCpU,KAAKogB,GAAAA,GACL,SACAtnB,aACAiB,GAAAA;AAEF,cAAMi1B,UAAU,MAAM,KAAKlR,iBAAiB1J,mBAC1CpU,KAAKogB,GAAAA,GACL,WACAtnB,aACAiB,GAAAA;AAEF,eAAO;UACLg1B;UACAC;QACF;MACF;AACA,aAAO;QACLD,OAAO;QACPC,SACE;MACJ;IACF,CAAA,CAAA;AAEF,WAAOnZ;EACT;EAEA,MACM0Q,cACYC,QAChB;AACA,QAAI;AACF,aAAO,MAAM,KAAKyF,YAAY1F,cAAcC,MAAAA;IAC9C,SACO9tB,OAAO;AACZC,cAAQD,MAAM,qDAAaA,KAAAA;AAC3B,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACM6+B,gBACWpxB,IACE2mB,SACF/3B,OACfgF,KACA;AACA,UAAMiY,QAAQ,MAAM+Q,YAAY;MAAE5c;MAAImB,QAAQvS,MAAKoR;IAAG,CAAA,GAAI,CAAA;AAC1D,QAAI,CAAC6L,MAAM;AACTrK,kBAAY5N,KAAK;QACf2P,QAAQ;QACR1V,KAAK,2DAAce,MAAKkB,OAAO,mBAASkQ,EAAAA,6BAAW2mB,OAAAA;MACrD,CAAA;AACA,aAAO2B,+BAASG,cAActR,UAAUC,OAAO;IACjD;AAEA,UAAM+H,SAAS,eAAetT,KAAKC,QAAQ,IAAID,KAAKja,IAAI,IAAIia,KAAK/L,IAAI;AACrE,UAAMuxB,YAAY,eAAexlB,KAAKC,QAAQ,IAAID,KAAKja,IAAI,IAAI+0B,OAAAA;AAC/D,UAAM3G,aAAa,MAAM,KAAKrI,iBAAiBlL,iBAAiB0S,MAAAA;AAChE,UAAMmS,aAAa,MAAM,KAAK3Z,iBAAiBlL,iBAAiB4kB,SAAAA;AAChE,QAAI,CAACrR,YAAY;AACf,aAAOsI,+BAASG,cAActR,UAAUE,SAAS;IACnD;AACA,QAAIia,YAAY;AACd,aAAOhJ,+BAASG,cAActR,UAAUG,aAAa;IACvD;AAEA,UAAM,EAAEnnB,gBAAAA,gBAAc,IAAK,MAAM;AACjC,UAAMohC,UAAUphC,gBAAegvB,MAAAA;AAC/B,UAAMqS,UAAUrhC,gBAAekhC,SAAAA;AAC/B,UAAM,EAAEzgC,WAAAA,WAAS,IAAK,MAAM;AAC5BA,IAAAA,WAAUP,kBAAAA,QAAK4b,QAAQulB,OAAAA,CAAAA;AACvB1gC,oBAAAA,QAAG2gC,WAAWF,SAASC,OAAAA;AAEvB,UAAM3U,eAAe;MAAE7c;MAAImB,QAAQvS,MAAKoR;IAAG,GAAG;MAAEF,MAAM6mB;IAAQ,CAAA;AAC9DnlB,gBAAY5N,KAAK;MACf2P,QAAQ;MACR1V,KAAK,2DAAce,MAAKkB,OAAO,mBAASkQ,EAAAA,6BAAW2mB,OAAAA;IACrD,CAAA;EACF;;;;EAKA,MACM+K,cAAc;AAClB,UAAM,EAAE1xB,IAAImB,OAAM,IAAK,KAAKyJ,IAAIhX,IAAI2L;AACpC,UAAMwL,QAAQ,MAAM6R,YAAY;MAC9Bzb;IACF,CAAA;AACA,UAAMxO,cAAc2sB,2BAA2BznB,YAAYuC,cAAa,GAAImlB,sBAAsB,CAAA;AAClG,WAAO;MACLxU,OAAOA,MAAM3G,IAAIa,CAAAA,OAAM;QACrB,GAAGA;QACHkd,UAAU,KAAKxK,iBAAiBzI,eAC9B,KAAK4W,YAAYla,UAAU3G,CAAAA,GAC3BtS,aACA,KAAKiY,IAAIhX,GAAG;MAEhB,EAAA;IACF;EACF;EAEA,MACMwrB,YAA4Bpf,IAAY;AAC5C,QAAI;AACF,aAAO,MAAM,KAAK8lB,YAAY1G,YAAY,CAACpf,EAAAA;IAC7C,SACOzN,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;;;;EAKA,MACMo/B,aAA+BvhC,KAAa;AAChDoC,YAAQqB,IAAI,gEAAA;AACZrB,YAAQqB,IAAI,qBAAWzD,GAAAA;AAGvB,QAAIwhC,UAAyB;AAC7B,QAAIzP,WAAgB;AAEpB,QAAI;AACFtC,oCAASzvB,GAAAA;AACToC,cAAQqB,IAAI,+DAAA;AAEZ,YAAM,CAACg+B,cAAAA,IAAkB,MAAMxU,WAA+B;QAC5D9a,SAAKsd,0BAASzvB,GAAAA;MAChB,CAAA;AACA,UAAIyhC,gBAAgB;AAClB1P,mBAAW0P;AACXr/B,gBAAQqB,IAAI,yCAAWg+B,eAAe55B,IAAI;AAE1C,cAAMunB,YAAYqS,eAAe55B,KAAKunB;AACtC,YAAIA,UAAUlU,SAAS,gBAAA,GAAmB;AAExC9Y,kBAAQqB,IAAI,yFAAmB2rB,SAAAA;AAC/B,eAAK5U,IAAI/P,IAAIi3B,UAAU,KAAK;YAAEC,UAAUvS;UAAU,CAAA;AAClD,eAAK5U,IAAI/P,IAAIyH,IAAG;AAChB;QACF,WACSkd,UAAUlU,SAAS,iBAAA,GAAoB;AAC9C,gBAAM1Y,QAAQ4sB,UAAU1mB,MAAM,iBAAA,EAAmB,CAAA;AACjD84B,oBAAU1+B,oBAAoBN,KAAAA;AAC9BJ,kBAAQqB,IAAI,wCAAyBjB,OAAO,YAAYg/B,OAAAA;QAC1D,OACK;AAEHA,oBAAUC,eAAe55B,KAAKunB,UAAU7uB,QAAQ,qBAAqB,EAAA;AACrE6B,kBAAQqB,IAAI,4CAAwB+9B,OAAAA;QACtC;MACF;IACF,QACM;AAEJp/B,cAAQqB,IAAI,gEAAA;AACZ+9B,gBAAU1+B,oBAAoB9C,GAAAA;AAC9BoC,cAAQqB,IAAI,mCAAe+9B,OAAAA;AAC3B,UAAI,CAACA,SAAS;AACZp/B,gBAAQD,MAAM,4CAAmBnC,GAAAA;AACjCoC,gBAAQD,MAAM,sFAAA;MAChB;IACF;AAGA,QAAIq/B,SAAS;AACXp/B,cAAQqB,IAAI,uCAAc+9B,OAAAA;AAE1B,UAAIphC;AACJ,UAAIohC,QAAQnoB,WAAW,aAAA,GAAgB;AACrC,cAAM,EAAErV,kBAAAA,mBAAkBI,gBAAAA,gBAAc,IAAK,MAAM;AAGnDhE,oBAAYH,kBAAAA,QAAKC,KAAKhC,QAAQC,IAAG,GAAI,gBAAgBqjC,OAAAA;MACvD,WACSA,QAAQnoB,WAAW,aAAA,GAAgB;AAE1C,cAAM1U,WAAW68B,QAAQjhC,QAAQ,eAAe,EAAA;AAChDH,oBAAYH,kBAAAA,QAAKC,KAAKpC,oBAAoB6G,QAAAA;AAC1CvC,gBAAQqB,IAAI,yCAAWrD,SAAAA;MACzB,OACK;AACHA,oBAAYL,eAAeyhC,OAAAA;MAC7B;AAEAp/B,cAAQqB,IAAI,yCAAWrD,SAAAA;AACvBgC,cAAQqB,IAAI,yCAAW/C,gBAAAA,QAAGC,WAAWP,SAAAA,CAAAA;AAErC,UAAIM,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC5B,cAAMa,QAAQP,gBAAAA,QAAGQ,SAASd,SAAAA;AAC1B,cAAMuE,WAAW1E,kBAAAA,QAAKye,SAASte,SAAAA;AAC/BgC,gBAAQqB,IAAI,4CAAckB,UAAU,iBAAO1D,MAAMS,IAAI;AAGrD,YAAIqwB,UAAU;AACZ,gBAAM,EAAEryB,SAAS0oB,YAAYrE,KAAK6d,SAAStgC,UAAUI,MAAMsvB,SAAQ,IAAKe,SAASlqB;AACjF,gBAAMg6B,SAAS;YACb,CAAC1U,WAAWE,QAAQ,GAAG;YACvB,CAACF,WAAWG,QAAQ,GAAG;YACvB,CAACH,WAAWK,gBAAgB,GAAG;UACjC;AAEA,eAAK/S,gBAAgBvH,IAAI,QAAQ,GAAG2uB,OAAO9P,SAAShwB,IAAI,CAAC,iBAAOqmB,UAAAA,iBAAiBwZ,WAAWj9B,QAAAA,iBAAerD,QAAAA,IAAY;YACrH5B,SAAS0oB;YACT0Z,cAAc/P,SAAShwB;YACvB2N,MAAMkyB,WAAWj9B;YACjBjD,MAAMsvB,YAAY/vB,MAAMS;YACxBJ;YACAkvB,kBAAkBxwB;UACpB,CAAA;QACF;AAGAoC,gBAAQqB,IAAI,gFAAA;AAGZ,aAAK+W,IAAI/P,IAAIi3B,UAAU,KAAK;UAC1B,gBAAgB;UAChB,uBAAuB,yBAAyBK,mBAAmBp9B,QAAAA,CAAAA;UACnE,kBAAkB1D,MAAMS,KAAKiB,SAAQ;UACrC,iBAAiB;UACjB,+BAA+B;QACjC,CAAA;AAGA,cAAMq/B,aAAathC,gBAAAA,QAAGme,iBAAiBze,SAAAA;AAEvC4hC,mBAAW7wB,GAAG,QAAQ,MAAA;AACpB/O,kBAAQqB,IAAI,sCAAA;QACd,CAAA;AAEAu+B,mBAAW7wB,GAAG,QAAQ,CAAC8wB,UAAAA;AACrB7/B,kBAAQqB,IAAI,qDAAaw+B,MAAM3zB,MAAM;QACvC,CAAA;AAEA0zB,mBAAW7wB,GAAG,SAAS,CAAChG,QAAAA;AACtB/I,kBAAQD,MAAM,yCAAWgJ,GAAAA;AACzB,cAAI,CAAC,KAAKqP,IAAI/P,IAAIy3B,aAAa;AAC7B,iBAAK1nB,IAAI/P,IAAIi3B,UAAU,KAAK;cAAE,gBAAgB;YAAiC,CAAA;AAC/E,iBAAKlnB,IAAI/P,IAAIyH,IAAIpK,KAAKgB,UAAU;cAAEtL,MAAM;cAAKC,KAAK;YAAS,CAAA,CAAA;UAC7D,OAAO;AACL,iBAAK+c,IAAI/P,IAAI03B,QAAO;UACtB;QACF,CAAA;AAEAH,mBAAW7wB,GAAG,OAAO,MAAA;AACnB/O,kBAAQqB,IAAI,4CAAA;QACd,CAAA;AAGA,aAAK+W,IAAI/P,IAAI0G,GAAG,UAAU,MAAA;AACxB/O,kBAAQqB,IAAI,gCAAA;QACd,CAAA;AAEA,aAAK+W,IAAI/P,IAAI0G,GAAG,SAAS,MAAA;AACvB/O,kBAAQqB,IAAI,4CAAA;AAEZ,cAAI,CAACu+B,WAAWI,WAAW;AACzBJ,uBAAWG,QAAO;UACpB;QACF,CAAA;AAGAH,mBAAWvjB,KAAK,KAAKjE,IAAI/P,GAAG;AAI5B,eAAO,IAAID,QAAc,CAACmB,YAAAA;AACxBq2B,qBAAW7wB,GAAG,OAAO,MAAA;AACnB/O,oBAAQqB,IAAI,iEAAA;AACZkI,oBAAAA;UACF,CAAA;AACAq2B,qBAAW7wB,GAAG,SAAS,MAAA;AACrBxF,oBAAAA;UACF,CAAA;QACF,CAAA;MACF;IACF;AAGAvJ,YAAQD,MAAM,mDAAqBq/B,SAAS,QAAQxhC,GAAAA;AACpD,SAAKya,gBAAgBvH,IAAI,QAAQ,yCAAWlT,GAAAA,EAAK;AACjD,WAAOk4B,+BAASG,cAAc5R,YAAYE,QAAQC,WAAW;EAC/D;EAEA,MACM+I,cAAyBnf,MAAM;AACnC,UAAM,EAAEgf,KAAKhrB,QAAO,IAAKgM;AACzB,QAAI;AACF,YAAM8O,SAAS,MAAM,KAAKoW,YAAY/F,cAAcH,KAAKhrB,OAAAA;AAEzD,YAAME,aAAa4a,OAAO/Q;AAC1B,YAAMhM,cAAcX,KAAKC,MAAMqB,KAAKD,IAAG,IAAK,GAAA,IAAQ,OAAO;AAC3D,YAAMo/B,cAAc,KAAK9a,iBAAiBzI,eAAepa,YAAYnC,aAAa,KAAKiY,IAAIhX,GAAG;AAC9F,aAAO;QACL,GAAG8b;QACH+iB;MACF;IACF,SACOlgC,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;;;;;EAMA,MACMmgC,qBAAsCtiC,KAAa;AACvDoC,YAAQqB,IAAI,4EAAA;AACZrB,YAAQqB,IAAI,iCAAazD,GAAAA;AACzBoC,YAAQqB,IAAI,qBAAW,KAAK+W,IAAIhX,IAAIO,GAAG;AAEvC,QAAI,CAAC/D,KAAK;AACRoC,cAAQD,MAAM,+BAAA;AACd,aAAO+1B,+BAASG,cAAc5R,YAAYE,QAAQC,WAAW;IAC/D;AAGA,UAAM2b,aAAaC,mBAAmBxiC,GAAAA;AACtCoC,YAAQqB,IAAI,iCAAa8+B,UAAAA;AAGzB,QAAIniC;AACJ,QAAImiC,WAAWlpB,WAAW,aAAA,GAAgB;AACxC,YAAM1U,YAAW49B,WAAWhiC,QAAQ,eAAe,EAAA;AACnDH,kBAAYH,kBAAAA,QAAKC,KAAKpC,oBAAoB6G,SAAAA;IAC5C,OAAO;AAELvE,kBAAYH,kBAAAA,QAAKC,KAAKpC,oBAAoBykC,UAAAA;IAC5C;AAEAngC,YAAQqB,IAAI,qDAAarD,SAAAA;AACzBgC,YAAQqB,IAAI,yCAAW/C,gBAAAA,QAAGC,WAAWP,SAAAA,CAAAA;AAErC,QAAI,CAACM,gBAAAA,QAAGC,WAAWP,SAAAA,GAAY;AAC7BgC,cAAQD,MAAM,+CAAY/B,SAAAA;AAC1B,aAAO83B,+BAASG,cAAc5R,YAAYE,QAAQC,WAAW;IAC/D;AAEA,UAAM3lB,QAAQP,gBAAAA,QAAGQ,SAASd,SAAAA;AAC1B,UAAMuE,WAAW1E,kBAAAA,QAAKye,SAASte,SAAAA;AAC/BgC,YAAQqB,IAAI,4CAAckB,UAAU,iBAAO1D,MAAMS,IAAI;AAGrDU,YAAQqB,IAAI,gFAAA;AAEZ,SAAK+W,IAAI/P,IAAIi3B,UAAU,KAAK;MAC1B,gBAAgB;MAChB,uBAAuB,yBAAyBK,mBAAmBp9B,QAAAA,CAAAA;MACnE,kBAAkB1D,MAAMS,KAAKiB,SAAQ;MACrC,iBAAiB;MACjB,+BAA+B;IACjC,CAAA;AAEA,UAAMq/B,aAAathC,gBAAAA,QAAGme,iBAAiBze,SAAAA;AAEvC4hC,eAAW7wB,GAAG,SAAS,CAAChG,QAAAA;AACtB/I,cAAQD,MAAM,yCAAWgJ,GAAAA;AACzB,UAAI,CAAC,KAAKqP,IAAI/P,IAAIy3B,aAAa;AAC7B,aAAK1nB,IAAI/P,IAAIi3B,UAAU,KAAK;UAAE,gBAAgB;QAAiC,CAAA;AAC/E,aAAKlnB,IAAI/P,IAAIyH,IAAIpK,KAAKgB,UAAU;UAAEtL,MAAM;UAAKC,KAAK;QAAS,CAAA,CAAA;MAC7D,OAAO;AACL,aAAK+c,IAAI/P,IAAI03B,QAAO;MACtB;IACF,CAAA;AAEAH,eAAWvjB,KAAK,KAAKjE,IAAI/P,GAAG;AAE5B,WAAO,IAAID,QAAc,CAACmB,YAAAA;AACxBq2B,iBAAW7wB,GAAG,OAAO,MAAA;AACnB/O,gBAAQqB,IAAI,4CAAA;AACZkI,gBAAAA;MACF,CAAA;AACAq2B,iBAAW7wB,GAAG,SAAS,MAAA;AACrBxF,gBAAAA;MACF,CAAA;IACF,CAAA;EACF;;;;EAKA,MACMmkB,iBAA6BvmB,QAAO;AACxC,UAAM,EAAEzJ,UAAUE,IAAG,IAAKuJ;AAC1B,QAAI;AACF,aAAO,MAAM,KAAKmsB,YAAY5F,iBAAiBhwB,UAAUE,GAAAA;IAC3D,SACOmC,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;;;;EAMAyU,iBAAiB;AACf,SAAK6D,gBAAgBvH,IAAI,QAAQ,kDAAA;AACjC,WAAO;MACL1Q,OAAO;MACPigC,WAAW;IACb;EACF;;;;EAKA,MACMC,WAAWl/B,KAAgB;AAC/BpB,YAAQqB,IAAI,gEAAA;AACZrB,YAAQqB,IAAI,QAAQD,IAAIO,GAAG;AAC3B3B,YAAQqB,IAAI,WAAWD,IAAI+M,MAAM;AACjCnO,YAAQqB,IAAI,iBAAiBD,IAAIG,QAAQ,cAAA,CAAe;AAExD,WAAO,IAAI6G,QAAQ,CAACmB,SAASsN,WAAAA;AAC3B,YAAM0pB,WAAOC,kBAAAA,SAAW;QACtBC,WAAW;QACXC,gBAAgB;QAChBC,aAAa,OAAO,OAAO,OAAO;QAClCC,WAAWjlC;MACb,CAAA;AAEAqE,cAAQqB,IAAI,+DAAiC1F,YAAAA;AAE7C4kC,WAAK56B,MAAMvE,KAAK,OAAO2H,KAAK83B,QAAQtoB,UAAAA;AAClCvY,gBAAQqB,IAAI,iDAAA;AACZrB,gBAAQqB,IAAI,QAAQ0H,GAAAA;AACpB/I,gBAAQqB,IAAI,WAAWqE,KAAKgB,UAAUm6B,MAAAA,CAAAA;AACtC7gC,gBAAQqB,IAAI,UAAUkX,QAAQnR,OAAOC,KAAKkR,KAAAA,IAAS,MAAA;AAEnD,YAAIxP,KAAK;AACP/I,kBAAQD,MAAM,qDAAagJ,GAAAA;AAC3BQ,kBAAQusB,+BAAS0B,KAAK,KAAK,yCAAWzuB,IAAIK,OAAO,EAAE,CAAA;AACnD;QACF;AAEA,cAAMiQ,OAAOpP,MAAMC,QAAQqO,MAAMc,IAAI,IAAId,MAAMc,KAAK,CAAA,IAAKd,MAAMc;AAC/D,YAAI,CAACA,MAAM;AACTrZ,kBAAQD,MAAM,sDAAmBwY,KAAAA;AACjChP,kBAAQusB,+BAAS0B,KAAK,KAAK,4CAAA,CAAA;AAC3B;QACF;AAEA,YAAI;AAEF,gBAAM55B,MAAMqM,MAAMC,QAAQ22B,OAAOjjC,GAAG,IAAIijC,OAAOjjC,IAAI,CAAA,IAAKijC,OAAOjjC;AAC/D,cAAI,CAACA,OAAO,OAAOA,QAAQ,UAAU;AACnCoC,oBAAQD,MAAM,sDAAwB8gC,MAAAA;AACtCt3B,oBAAQusB,+BAAS0B,KAAK,KAAK,2CAAA,CAAA;AAC3B;UACF;AAEAx3B,kBAAQqB,IAAI,8CAAgBzD,KAAK,aAAayb,KAAK6e,UAAU,SAAS7e,KAAK/Z,IAAI;AAG/E,gBAAMwhC,QAAQ,MAAM,KAAK3b,iBAAiB3L,SAAS5b,KAAKyb,KAAK6e,QAAQ;AACrE,cAAI,CAAC4I,OAAO;AACV9gC,oBAAQD,MAAM,8CAAgBnC,GAAAA;AAC9B2L,oBAAQusB,+BAAS0B,KAAK,KAAK,sCAAA,CAAA;AAC3B;UACF;AAEAx3B,kBAAQqB,IAAI,8CAAgBzD,GAAAA;AAG5B,gBAAMqD,OAAO,MAAM,KAAKkkB,iBAAiBxmB,YAAYf,GAAAA;AACrD,cAAIqD,QAAQA,KAAK/B,SAAS4Z,SAAS,OAAA,GAAU;AAC3C,kBAAM,KAAKqM,iBAAiBxK,kBAAkB/c,GAAAA;AAC9C,kBAAM,KAAKunB,iBAAiB9J,gBAAgBzd,GAAAA;UAC9C;AAGA,cAAI;AACFU,4BAAAA,QAAGqb,WAAWN,KAAK6e,QAAQ;UAC7B,QACM;UAEN;AAEA,eAAK7f,gBAAgBvH,IAAI,QAAQ,yCAAWlT,GAAAA,IAAO;YACjDA;YACA0B,MAAM+Z,KAAK/Z;YACXJ,UAAUma,KAAK0nB;UACjB,CAAA;AAGA,gBAAM7jB,SAAS;YACb9hB,MAAM;YACNqK,MAAM;cACJ7H;cACAwB,MAAM;cACNC,OAAOga,KAAK/Z;YACd;YACAjE,KAAK;UACP;AACA2E,kBAAQqB,IAAI,6BAASqE,KAAKgB,UAAUwW,MAAAA,CAAAA;AACpC3T,kBAAQ2T,MAAAA;QACV,SACOnd,OAAO;AACZC,kBAAQD,MAAM,yCAAWA,KAAAA;AACzBwJ,kBAAQusB,+BAAS0B,KAAK,KAAK,yCAAWz3B,KAAAA,EAAO,CAAA;QAC/C;MACF,CAAA;AAEAwgC,WAAKxxB,GAAG,SAAS,CAAChG,QAAAA;AAChB/I,gBAAQD,MAAM,4BAAkBgJ,GAAAA;AAChC8N,eAAO9N,GAAAA;MACT,CAAA;IACF,CAAA;EACF;EAEA,MACMi4B,WAAsBv7B,MAAa;AACvC,QAAI;AACF,YAAMkgB,OAAO,MAAM,KAAK+Y,YAAY5K,aAAaruB,KAAK8T,OAAO;AAC7D,UAAI,CAACoM,MAAM;AACT,aAAKtN,gBAAgBvH,IAAI,QAAQ,sDAAcrL,IAAAA;AAC/C,cAAM4e,YAAYE,QAAQC;MAC5B;AAEA,YAAM,EAAE7V,OAAM,IAAKgX;AACnBve,aAAOmN,OAA8B9O,MAAM;QACzCkJ;QACA4R,aAAa;QACbE,QAAQhb,KAAKgb,UAAU;QACvBC,YAAYjb,KAAKib,cAAc;MACjC,CAAA;AACA,YAAM,KAAK4S,YAAY5C,QAAQjrB,IAAAA;AAC/B,WAAK4S,gBAAgBvH,IAAI,QAAQ,gDAAarL,KAAK6H,IAAI,iBAAO7H,IAAAA;IAChE,SACO1F,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACMkhC,kBAAkB;AACtB,UAAM,EAAE3jC,SAAS0oB,WAAU,IAAK,KAAK5N,IAAIhX,IAAI2L;AAC7C,UAAMwL,QAAQ,MAAM,KAAK+a,YAAY3C,aAAY;AACjD,SAAKtY,gBAAgBvH,IAAI,QAAQ,qDAAakV,UAAAA,iBAAiB;MAC7DA;IACF,CAAA;AACA,WAAO;MACLzN,OAAOA,MAAM3G,IAAIa,CAAAA,OAAM;QACrB,GAAGA;;QAEHoG,cAAcpG,EAAE8N;QAChB2gB,aAAazuB,EAAEiO;QACfygB,WAAW1uB,EAAE6N;QACbhH,UAAU7G,EAAE8G;QACZja,MAAM,CAACmT,EAAEnT;MACX,EAAA;IACF;EACF;EAEA,MACMuxB,cAA6BrjB,IAAI;AACrC,UAAM,EAAEA,IAAImB,OAAM,IAAK,KAAKyJ,IAAIhX,IAAI2L;AACpC,QAAI;AACF,YAAMsM,OAAO,MAAM,KAAKia,YAAY1C,YAAY;QAC9CpjB;QACAmB;MACF,CAAA;AACA,YAAM,KAAK2kB,YAAYzC,cAAcxX,IAAAA;IACvC,SACOtZ,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACM0yB,aAAwBrkB,MAAM;AAClC,QAAI;AACF,YAAM,KAAKklB,YAAYb,aAAarkB,IAAAA;IACtC,SACOrO,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACMgzB,YAA4B3F,KAAe;AAC/C,QAAI;AACF,YAAM,KAAKkG,YAAYP,YAAY3F,GAAAA;IACrC,SACOrtB,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;;;;EAKA,MACMqhC,eAA8B5zB,IAAYpM,KAAgB;AAC9D,UAAMqE,OAAOpD,yBAAyBmL,EAAAA;AACtC,QAAI/H,KAAKrK,SAAS,GAAG;AACnB6T,kBAAY7N,KAAKqE,KAAK47B,OAAO57B,KAAK1F,KAAK;AACvC,aAAO+1B,+BAAS0B,KAAK,KAAK/xB,KAAK47B,OAAO57B,KAAK1F,KAAK;IAClD;AACA,WAAO0F;EACT;EAEA,MACMytB,gBAA2B9kB,MAAM;AACrC,UAAM8O,SAAS,MAAM,KAAKoW,YAAYJ,gBAAgB9kB,IAAAA;AACtD,WAAO8O;EACT;AACF,GAvpBe,OAAAzL,MAAA,mBAAAA;;MACZR,iCAAAA;uCACY,YAAA,cAAA,SAAA,OAAA;GAFMwtB,eAAAA,WAAAA,OAAAA,MAAAA;;MAIlBvlB,8BAAOkT,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GALFqS,eAAAA,WAAAA,eAAAA,MAAAA;;MAOlBvlB,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GARN6tB,eAAAA,WAAAA,mBAAAA,MAAAA;;MAUlBvlB,8BAAOma,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GAXFoL,eAAAA,WAAAA,eAAAA,MAAAA;;MAalBvlB,8BAAOC,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GAdPslB,eAAAA,WAAAA,oBAAAA,MAAAA;;MAmBlBjD,4BAAK,gBAAA;EAEHE,WAAAA,OAAAA,+BAAQ,KAAA,CAAA;EACR1B,WAAAA,GAAAA,YAAAA,CAAAA;;;;WAAoB,SAAA,cAAA,SAAA;WAChB,cAAA,cAAA,SAAA;;GAvBYyE,eAAAA,WAAAA,iBAAAA,IAAAA;;MA4ElBjD,4BAAK,iBAAA;EAEHE,WAAAA,OAAAA,+BAAQ,KAAA,CAAA;;;;;GA9EQ+C,eAAAA,WAAAA,iBAAAA,IAAAA;;MAyFlB7C,2BAAI,eAAA;EAEFF,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EACR1B,WAAAA,GAAAA,YAAAA,CAAAA;;;;;WAAoB,SAAA,cAAA,SAAA;WAChB,cAAA,cAAA,SAAA;;GA9FYyE,eAAAA,WAAAA,mBAAAA,IAAAA;;MAqIlB9C,2BAAI,eAAA;;;GArIc8C,eAAAA,WAAAA,eAAAA,IAAAA;;MAwJlB9C,2BAAI,MAAA;EACcyC,WAAAA,OAAAA,gCAAS,IAAA,CAAA;;;;;GAzJTK,eAAAA,WAAAA,eAAAA,IAAAA;;MAqKlB9C,2BAAI,kBAAkB6C,OAAAA;EACH3C,WAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;GAtKX4C,eAAAA,WAAAA,gBAAAA,IAAAA;;MAiVlBjD,4BAAK,aAAA;EACeE,WAAAA,OAAAA,+BAAAA,CAAAA;;;;;GAlVF+C,eAAAA,WAAAA,iBAAAA,IAAAA;;MAwWlB9C,2BAAI,aAAa6C,OAAAA;EACUJ,WAAAA,OAAAA,gCAAS,KAAA,CAAA;;;;;GAzWlBK,eAAAA,WAAAA,wBAAAA,IAAAA;;MAoblB9C,2BAAI,aAAa6C,OAAAA;EACMJ,WAAAA,OAAAA,gCAAAA,CAAAA;;;;;GArbLK,eAAAA,WAAAA,oBAAAA,IAAAA;;MAkclB9C,2BAAI,UAAU6C,OAAAA;;;GAlcIC,eAAAA,WAAAA,kBAAAA,IAAAA;;MA8clBjD,4BAAK,WAAWgD,OAAAA;;;WACK,cAAA,cAAA,SAAA;;GA/cHC,eAAAA,WAAAA,cAAAA,IAAAA;;MAsjBlBjD,4BAAK,SAASgD,OAAAA;EACG9C,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,UAAA,cAAA,SAAA;;GAvjBf+C,eAAAA,WAAAA,cAAAA,IAAAA;;MA8kBlB9C,2BAAI,OAAA;;;GA9kBc8C,eAAAA,WAAAA,mBAAAA,IAAAA;;MAkmBlBN,8BAAO,MAAA;EACazC,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;;;;;GAnmBV+C,eAAAA,WAAAA,iBAAAA,IAAAA;;MAinBlBN,8BAAO,aAAaK,OAAAA;EACD9C,WAAAA,OAAAA,+BAAAA,CAAAA;;;;;GAlnBD+C,eAAAA,WAAAA,gBAAAA,IAAAA;;MA2nBlBN,8BAAO,YAAA;EACWzC,WAAAA,OAAAA,+BAAQ,KAAA,CAAA;;;;;GA5nBR+C,eAAAA,WAAAA,eAAAA,IAAAA;;MAwoBlBjD,4BAAK,kBAAA;EACgBE,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;;;;WAAuB,cAAA,cAAA,SAAA;;GAzoBlC+C,eAAAA,WAAAA,kBAAAA,IAAAA;;MAkpBlBjD,4BAAK,iBAAiBgD,OAAAA;EACA9C,WAAAA,OAAAA,+BAAAA,CAAAA;;;;;GAnpBJ+C,eAAAA,WAAAA,mBAAAA,IAAAA;AAAAA,iBAAAA,eAAAA;MADpB3C,wCAAiB,QAAQzc,MAAAA;GACLof,cAAAA;;;ACjDrB,IAAAz7B,wBAQO;;;;;;;;;;;;;;;;;;;;;;;AAKP,IAAMqc,SAAQ;EACZoZ,WAAW;AACb;AAEA,IAAMhU,WAAW;EACfgU,WAAW;AACb;;IAGqB6I,sBAAN7vB,OAAA,MAAA;EAAA;AAEL6a;;EAER,MACM8K,kBAAoC7d,SAAiB;AACzD,WAAO,KAAK+S,gBAAgBlH,mBAAmB7L,OAAAA;EACjD;;EAGA,MACMkM,YACY9X,KACCL,MACC1P,KAClB;AACA,QAAI;AACF,YAAM,KAAK0uB,gBAAgB7G,YAAY;QAAE9X;QAAKL;QAAM1P;MAAI,CAAA;IAC1D,SACOmC,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAGA8lB,YAA8BjoB,KAAa;AACzC,WAAO,KAAK0uB,gBAAgBzG,YAAYjoB,GAAAA;EAC1C;EAEA,MACMmoB,eAA0B3X,MAAwBxQ,KAAa;AACnE,WAAO,KAAK0uB,gBAAgBvG,eAAe3X,MAAMxQ,GAAAA;EACnD;AACF,GAjCe,OAAA6T,MAAA,uBAAAA;;MACZyH,8BAAO8L,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GAFNsc,mBAAAA,WAAAA,mBAAAA,MAAAA;;MAIlB3F,2BAAI,gBAAA;EACoBE,WAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;GALhByF,mBAAAA,WAAAA,qBAAAA,IAAAA;;MAUlBnD,8BAAO,iBAAA;EAELzC,WAAAA,OAAAA,+BAAQ,KAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EACRG,WAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;;;GAdMyF,mBAAAA,WAAAA,eAAAA,IAAAA;;MAwBlB3F,2BAAI,SAASlX,QAAAA;EACDoX,WAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;GAzBJyF,mBAAAA,WAAAA,eAAAA,IAAAA;;MA6BlB1F,2BAAI,OAAA;EACiBF,WAAAA,OAAAA,+BAAAA,CAAAA;EAAiBG,WAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;;GA9B9ByF,mBAAAA,WAAAA,kBAAAA,IAAAA;AAAAA,qBAAAA,eAAAA;MADpBxF,wCAAiB,aAAazc,MAAAA;GACViiB,kBAAAA;;;ACtBrB,IAAAt+B,wBAOO;;;;;;;;;;;;;;;;;;;;;;;;IAScu+B,oBAAN9vB,OAAA,MAAA;EAAA;AAEL+vB;;EAER,MACMC,WACeriB,OACAsW,OACJt5B,OACf;AACA,UAAMslC,cAActlC,OAAMgjB,SAASA;AACnC,QAAI;AACF,UAAI,CAACsiB,aAAa;AAChB,cAAMhe,UAAUtE,MAAMyE;MACxB;AACA,YAAM8d,WACDjM,SAAwD;AAC7D,YAAM,KAAK8L,cAActZ,cAAcwZ,aAAaC,QAAAA;IACtD,SACO5hC,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAMA6hC,WAAW;AACT,WAAO,KAAKJ,cAAc5L,SAAQ;EACpC;EAEA,MACMI,kBAAqC5W,OAAe;AACxD,QAAI;AACF,YAAM,KAAKoiB,cAAcxL,kBAAkB5W,KAAAA;IAC7C,SACOrf,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAGAm2B,YACkBt4B,KAEhB6H,MAIA;AACA,WAAO,KAAK+7B,cAActL,YAAYt4B,KAAK6H,IAAAA;EAC7C;AACF,GArDe,OAAAgM,MAAA,qBAAAA;;MACZyH,8BAAOuc,aAAAA;uCACe,kBAAA,cAAA,SAAA,aAAA;GAFJ8L,iBAAAA,WAAAA,iBAAAA,MAAAA;;MAIlB5F,2BAAI,MAAA;EAEFyC,WAAAA,OAAAA,gCAAS,OAAA,CAAA;EACTA,WAAAA,OAAAA,gCAAS,OAAA,CAAA;EACTpE,WAAAA,GAAAA,YAAAA,CAAAA;;;;;WAAqB7a,UAAA,cAAA,SAAAA;;GARLoiB,iBAAAA,WAAAA,cAAAA,IAAAA;;MAwBlB5F,2BAAI,aAAa;IAChBF,MAAM;EACR,CAAA;MACCD,4BAAK,WAAA;;;GA3Ba+F,iBAAAA,WAAAA,YAAAA,IAAAA;;MAgClB5F,2BAAI,aAAA;EACoByC,WAAAA,OAAAA,gCAAS,OAAA,CAAA;;;;;GAjCfmD,iBAAAA,WAAAA,qBAAAA,IAAAA;;MA0ClB/F,4BAAK,WAAA;EAEHE,WAAAA,OAAAA,+BAAQ,KAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;;;;;;GA7CQ6F,iBAAAA,WAAAA,eAAAA,IAAAA;AAAAA,mBAAAA,eAAAA;MADpBzF,wCAAiB,QAAA;GACGyF,gBAAAA;;;ACbrB,IAAAv+B,wBASO;AACP,IAAAknB,gBAAkB;AAClB,IAAAvN,mBAAmB;;;ACZnB,IAAAlL;AAAA,IAAM2a,gBAAN3a,OAAA,MAAM2a;EACJhT,UAAUC,MAAY;AACpB,WAAO,eAAeA,KAAKC,YAAYD,KAAKE,OAAO,IAAIF,KAAKja,IAAI,IAC9Dia,KAAK/L,IAAI;EAEb;AACF,GANM8e,OAAAA,MAAAA,gBAAN3a;AAQA,IAAA,eAAe,IAAI2a,aAAAA;;;ICVZ;UAAKyV,cAAW;AAAXA,EAAAA,aAAAA,aACVC,aAAAA,IAAAA,CAAAA,IAAAA;AADUD,EAAAA,aAAAA,aAEVE,WAAAA,IAAAA,CAAAA,IAAAA;GAFUF,gBAAAA,cAAAA,CAAAA,EAAAA;IAKL;UAAKG,eAAY;AAAZA,EAAAA,cAAAA,cACVC,QAAAA,IAAAA,CAAAA,IAAAA;AADUD,EAAAA,cAAAA,cAEVE,cAAAA,IAAAA,CAAAA,IAAAA;AAFUF,EAAAA,cAAAA,cAGVG,SAAAA,IAAAA,CAAAA,IAAAA;AAHUH,EAAAA,cAAAA,cAIVI,MAAAA,IAAAA,CAAAA,IAAAA;GAJUJ,iBAAAA,eAAAA,CAAAA,EAAAA;;;ACLZ,IAAAvwB;AASA,IAAM4wB,kBAAN5wB,OAAA,MAAM4wB;EACJC,YAAYC,QAAgBC,QAAgBp1B,MAAc;AACxD,WAAOpD,iBAA0B,WAAW;MAC1CwD,IAAItC,aAAAA;MACJq3B;MACAC;MACA7iC,MAAMkiC,YAAYE;MAClBU,OAAOT,aAAaC;MACpBzhB,MAAM,oBAAI1f,KAAAA;MACVsM;MACAs1B,MAAM;IACR,CAAA;EACF;EAEA,MAAMC,kBAAkBJ,QAAgBn1B,MAAc;AACpD,UAAMovB,QAAQ,MAAM3T,cAAc;MAAC;KAAK;AACxC,WAAO7e,iBACL,WACAwyB,MAAM5qB,IAAI,CAAC6X,MAAAA;AACT,aAAO;QACLjc,IAAItC,aAAAA;QACJq3B;QACAC,QAAQ/Y,EAAEjc;QACV7N,MAAMkiC,YAAYC;QAClBW,OAAOT,aAAaC;QACpBzhB,MAAM,oBAAI1f,KAAAA;QACVsM;QACAs1B,MAAM;MACR;IACF,CAAA,GACA,IAAA;EAEJ;EAEAE,eAAej0B,QAAgB;AAC7B,WAAOtE,eAAwB,WAAW;MAAEm4B,QAAQ7zB;IAAO,CAAA,EAAGhG,KAAK,CAAC8J,MAAAA;AAClEA,QAAEpC,KAAK,CAACkqB,GAAGC,MAAMA,EAAEha,KAAK/Q,QAAO,IAAK8qB,EAAE/Z,KAAK/Q,QAAO,CAAA;AAClD,aAAOgD;IACT,CAAA;EACF;EAEAowB,YAAYl0B,QAAgBm0B,OAAe;AACzC,WAAOn5B,iBACL,WACA;MAAE64B,QAAQ7zB;MAAQnB,IAAIs1B;IAAM,GAC5B;MACExV,MAAM;QACJoV,MAAM;MACR;IACF,CAAA;EAEJ;EAEAK,mBAAmBpI,OAAeqI,OAAiBC,SAAS,MAAM;AAChE,WAAO,gxBAAkvBtI,KAAAA;MACvvBqI,MACCpxB,IACC,CAACa,MACC,4NAA6MA,CAAAA,MAAO,EAEvN3U,KAAK,EAAA,CAAA;IAERmlC,SACI,qVACA,EAAA;;EAGN;AACF,GApEMZ,OAAAA,MAAAA,mBAAN5wB;AAsEA,IAAA,kBAAe,IAAI4wB,eAAAA;;;;;;;;;;;;;;;;;;;;;;;;;AHnCnB,IAAMhjB,SAAQ;EACZ6a,WAAW9T,WAAWE;EACtBmS,WAAW;AACb;;IAGqByK,uBAANzxB,OAAA,MAAA;EAAA;AAEL6X;AAGA6Z;AAGA9qB;AAGAgR;AAGA+Z;AAGA/W;AAGAiH;;EAER,MACMgP,YAEJ3iC,MAEAyN,MACehR,OAEfomC,QACA;AAEA,QAAK7iC,SAASkiC,YAAYE,aAAa,CAACS,UAAW,CAACp1B,KAAKkR,KAAI,GAAI;AAC/D;IACF;AACA,QAAI3e,SAASkiC,YAAYE,WAAW;AAClCM,sBAAeC,YAAYlmC,MAAKoR,IAAIg1B,QAAQp1B,IAAAA;IAC9C,WACSzN,SAASkiC,YAAYC,aAAa;AACzCO,sBAAeM,kBAAkBvmC,MAAKoR,IAAIJ,IAAAA;IAC5C;EACF;EAEA,MACM2pB,OAA2Bz5B,SAAiB;AAChD,WAAO,KAAK6lC,iBAAiBpM,OAAOz5B,OAAAA;EACtC;EAEA,MAGMslC,eAA8BxmC,OAAY;AAC9C,UAAMinC,cAAc,MAAMhB,gBAAeO,eAAexmC,MAAKoR,EAAE;AAC/D,WAAO61B,YAAYzxB,IAAI,CAACa,MAAAA;AACtB,aAAO;QACLjF,IAAIiF,EAAEjF;QACN7N,MAAM8S,EAAE9S;QACR8iC,OAAOhwB,EAAEgwB;QACTjiB,MAAM/N,EAAE+N;QACRpT,MAAMqF,EAAErF;QACRs1B,MAAMjwB,EAAEiwB;MACV;IACF,CAAA;EACF;EAKAG,YAA2BzmC,OAA2BoR,IAAY;AAChE60B,oBAAeQ,YAAYzmC,MAAKoR,IAAIA,EAAAA;EACtC;;;;EAKA,MACM81B,cAAc;AAElB,UAAM9G,QAAQ,MAAM,KAAKnT,eAAe5G,SAAS,CAAC,CAAA;AAElD,UAAMlK,QAAQ,MAAM,KAAK8T,eAAe5J,SAAS,CAAC,CAAA;AAClD,UAAM,EAAEwO,cAAa,IAAK5rB,YAAYuC,cAAa;AACnD,UAAM8Q,WAAW,MAAM,KAAK0qB,aAAa3qB,YAAYF,KAAAA;AACrD,UAAM8V,cAAc,MAAM,KAAKiF,YAAYjF,YAAY,IAAI;MACzDzf,WAAW,IAAI9N,KAAKmwB,aAAAA;IACtB,CAAA;AAEA,eAAW70B,SAAQogC,OAAO;AACxB,YAAM7O,WAAWpV,MAAMhS,OAAO8S,CAAAA,SAAQA,KAAK1K,WAAWvS,MAAKoR,EAAE;AAC7D,YAAM+1B,eAAe,MAAM,KAAKjQ,YAAYtC,gBAAgB50B,OAAM;QAChEmc,OAAOoV;QACPjV;QACA2V,aAAaA,YAAY9nB,OAAQkM,CAAAA,MAAKA,EAAEhN,MAAMxE,MAAMwE,MAAMnI,YAAYlB,MAAKkB,OAAO;MACpF,CAAA;AACA8J,aAAOmN,OAAOnY,OAAMmnC,YAAAA;IACtB;AACA,UAAMC,UAAUhH,MAAM/0B,OAAO,CAACg8B,KAAK52B,QAAa42B,MAAM52B,IAAI2lB,MAAM,CAAA;AAChE,WAAO;MACLkR,MAAMlH,MAAM5qB,IAAI,CAAC6X,MAAAA;AACf,cAAMrK,QAAQqK,GAAGrK;AACjB,cAAM0K,cAAc1K,QAChBA,MAAMjhB,QAAQ,iBAAiB,CAACqpB,GAAGpR,QAAQ2T,WAAW,GAAG3T,MAAAA,MAAY2T,MAAAA,EAAQ,IAC7E;AACJ,eAAO;UACL,GAAGN;UACHrK,OAAO0K;QACT;MACF,CAAA;MACA0Z,SAASA,QAAQ/2B,QAAQ,CAAA;IAC3B;EACF;EAEA,MACMk3B,cACWn2B,IAEf7N,MAEAoN,UACA;AACA,UAAM3Q,SAAQ,MAAMosB,eAAehb,EAAAA,GAAK,CAAA;AACxC,QAAI,CAACpR,OAAM;AACT;IACF;AACA,UAAMwnC,SAAS;MACbC,OAAO;MACPC,SAAS;MACTC,MAAM;IACR;AACA,QAAI,CAACH,OAAOjkC,IAAAA,GAAO;AACjB;IACF;AACA,UAAMqkC,iBAAarY,cAAAA,SAAAA,EAAQ6F,SAASoS,OAAOjkC,IAAAA,GAAO,OAAA;AAClD,UAAM4Y,SACJ,MAAM6R,YACJ;MACEzb,QAAQnB;IACV,GACA;MAAC;MAAY;MAAW;MAAQ;MAAQ;MAAQ;MAAM;KAAe,GAEvEjH,OAAO,CAACkM,MAAAA;AACR,iBAAOkZ,cAAAA,SAAMlZ,EAAE+N,IAAI,EAAE+Q,SAASyS,UAAAA,KAAe,CAACvxB,EAAEwxB;IAClD,CAAA;AACA,QAAI1rB,MAAMrM,WAAW,GAAG;AACtB;IACF;AACA,UAAMg4B,UAAU3rB,MAAM3G,IAAIwa,aAAYhT,SAAS;AAC/CipB,oBAAeC,YACbv1B,SAASS,IACTpR,MAAKoR,IACL60B,gBAAeU,mBAAmB,wCAAU;MAC1C,sMAA4Ga,OAAOjkC,IAAAA,CAAK;MACxH;KACD,CAAA;AAEHoV,qBAAiBmvB,OAAAA;AAGjB,UAAM,KAAK7X,eAAenJ,oBAAoB;MAC5C1V,QAAI+X,qBAAGhN,MAAM3G,IAAIa,CAAAA,MAAKA,EAAEjF,EAAE,CAAA;IAC5B,GAAG;MACDoT,YAAY,oBAAI9f,KAAAA;IAClB,CAAA;EACF;;;;EAKA,MACMqjC,aACW32B,IACI3N,QACE4f,UACrB;AACA,QAAI5f,WAAW2mB,YAAYC,QAAQ;AACjChH,iBAAW;IACb,OACK;AACHA,iBAAW,IAAI3e,KAAK,IAAIA,KAAK2e,QAAAA,EAAUhQ,QAAO,CAAA;IAChD;AACA,UAAMmZ,WACJ;MACE/oB;MACA4f;IACF,GACA;MACEjS;IACF,CAAA;EAEJ;EAEA,MACM42B,cACW52B,IACMnR,WACrB+E,KACA;AACA,UAAMhF,QAAO,MAAMosB,eAAehb,EAAAA;AAClC,QAAI,CAACpR,MAAK8P,UAAU,CAACgd,UAAUje,KAAK5O,SAAAA,GAAW;AAC7C2S,kBAAY5N,KAAK;QACf2P,QAAQ;QACRtL,MAAMrE,IAAIgN;QACV/S,KAAK;MACP,CAAA;AACA,aAAOy6B,+BAAS0B,KAAK,KAAK,gCAAA;IAC5B;AACA,WAAOp2B,IAAIgN,KAAK/R;AAChB2S,gBAAY5N,KAAK;MACf2P,QAAQ;MACRtL,MAAMrE,IAAIgN;MACV/S,KAAK,2DAAce,MAAK,CAAA,EAAGkB,OAAO;IACpC,CAAA;AACA,UAAMsrB,WACJ;MACEvsB,UAAUqO,WAAWrO,SAAAA;IACvB,GACA;MACEmR;IACF,CAAA;EAEJ;EAEA,MACM62B,WACW72B,IACG4R,OACDhkB,MACFkpC,UACfljC,KACA;AACA,UAAMhF,QAAO,MAAMosB,eAAehb,EAAAA;AAClC,QAAI,CAACpR,MAAK8P,UAAU,CAAC8c,OAAO/d,KAAKmU,KAAAA,KAAU,CAAC+J,SAASle,KAAK7P,IAAAA,GAAO;AAC/D4T,kBAAY5N,KAAK;QACf2P,QAAQ;QACRtL,MAAMrE,IAAIgN;QACV/S,KAAK;MACP,CAAA;AACA,aAAOy6B,+BAAS0B,KAAK,KAAK,gCAAA;IAC5B;AACA,QAAI,CAAC8M,UAAUllB,OAAO;AACpBpQ,kBAAY5N,KAAK;QACf2P,QAAQ;QACRtL,MAAMrE,IAAIgN;QACV/S,KAAK;MACP,CAAA;AACA,aAAOy6B,+BAAS0B,KAAK,KAAK,4FAAA;IAC5B;AACA,UAAM+M,WAAW,MAAM,KAAKjb,aAAapB,cAAcoc,SAASllB,KAAK;AACrE,QAAImlB,aAAanpC,MAAM;AACrB4T,kBAAY5N,KAAK;QACf2P,QAAQ;QACRtL,MAAMrE,IAAIgN;QACV/S,KAAK;MACP,CAAA;AACA,aAAOy6B,+BAASG,cAAcvS,UAAUtoB,KAAKuoB,KAAK;IACpD;AAEA,QAAI,CAAC6gB,SAAAA,IAAa,MAAMjc,kBAAkBnJ,KAAAA;AAC1C,QAAI,CAAColB,WAAW;AACb,OAACA,SAAAA,IAAa,MAAMlc,oBAAoBlJ,KAAAA;IAC3C;AACA,QAAIolB,WAAW;AACbx1B,kBAAY5N,KAAK;QACf2P,QAAQ;QACR1V,KAAK,4DAAe+jB,KAAAA;QACpB3Z,MAAMrE,IAAIgN;MACZ,CAAA;AACA,aAAO0nB,+BAASG,cAAcvS,UAAUtE,MAAMwE,KAAK;IACrD;AACA,SAAK0F,aAAanB,kBAAkBmc,SAASllB,KAAK;AAClDpQ,gBAAY5N,KAAK;MACf2P,QAAQ;MACRtL,MAAMrE,IAAIgN;MACV/S,KAAK,2DAAce,MAAK,CAAA,EAAGkB,OAAO;IACpC,CAAA;AACA,UAAMsrB,WACJ;MACExJ;IACF,GACA;MACE5R;IACF,CAAA;EAEJ;EAEA,MACMi3B,WAA0Bj3B,IAA6BlO,MAAc;AACzE,UAAMlD,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAC7ChV;IACF,CAAA;AACA,SAAK6K,gBAAgBvH,IACnB,SACA,oDAAY1U,MAAKkB,OAAO,IAAIlB,MAAKkD,IAAI,OAAOA,IAAAA,MAC5C;MACEolC,SAAStoC,MAAKkD;MACdqlC,SAASrlC;IACX,CAAA;AAEFlD,IAAAA,MAAKkD,OAAOA;AACZ,UAAM,KAAK+pB,eAAevnB,OAAO1F,KAAAA;EACnC;EAEA,MACMwoC,kBAAiCp3B,IAA8BrH,OAAe;AAClF,UAAM/J,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAC7ChV;IACF,CAAA;AACA,SAAK6K,gBAAgBvH,IACnB,SACA,wCAAU1U,MAAKkB,OAAO,IAAIlB,MAAKsjB,MAAM,OAAOvZ,KAAAA,WAC5C;MACE0+B,UAAUzoC,MAAKsjB;MACfolB,UAAU3+B;IACZ,CAAA;AAEF/J,IAAAA,MAAKsjB,SAASvZ,MAAMsG,QAAQ,CAAA;AAC5B,UAAM,KAAK4c,eAAevnB,OAAO1F,KAAAA;EACnC;AACF,GA/Te,OAAAqV,MAAA,wBAAAA;;MACZyH,8BAAO8N,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GAFHkc,oBAAAA,WAAAA,gBAAAA,MAAAA;;MAIlBhqB,8BAAO4d,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GALPoM,oBAAAA,WAAAA,oBAAAA,MAAAA;;MAOlBhqB,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GARNsyB,oBAAAA,WAAAA,mBAAAA,MAAAA;;MAUlBhqB,8BAAO4P,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GAXLoa,oBAAAA,WAAAA,kBAAAA,MAAAA;;MAalBhqB,8BAAOf,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GAdH+qB,oBAAAA,WAAAA,gBAAAA,MAAAA;;MAgBlBhqB,8BAAOqR,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GAjBL2Y,oBAAAA,WAAAA,kBAAAA,MAAAA;;MAmBlBhqB,8BAAO6rB,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GApBF7B,oBAAAA,WAAAA,eAAAA,MAAAA;;MAsBlB1H,4BAAK,SAAA;EAEHE,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EAERA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EAER1B,WAAAA,GAAAA,YAAAA,CAAAA;EACA0B,WAAAA,OAAAA,+BAAQ,QAAA,CAAA;;;WAJH,gBAAA,cAAA,SAAA;;WAGe,SAAA,cAAA,SAAA;;;GA5BJwH,oBAAAA,WAAAA,eAAAA,IAAAA;;MA4ClB/E,8BAAO,QAAA;EACMzC,WAAAA,OAAAA,+BAAQ,SAAA,CAAA;;;;;GA7CHwH,oBAAAA,WAAAA,UAAAA,IAAAA;;MAiDlBvH,2BAAI,WAAW;IACdzB,WAAW9T,WAAWC;EACxB,CAAA;EACsB2T,WAAAA,GAAAA,YAAAA,CAAAA;;;WAAoB,SAAA,cAAA,SAAA;;GApDvBkJ,oBAAAA,WAAAA,kBAAAA,IAAAA;;MAkElBtH,2BAAI,WAAW;IACd1B,WAAW9T,WAAWC;EACxB,CAAA;EACa2T,WAAAA,GAAAA,YAAAA,CAAAA;EAA2B0B,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;;;WAAf,SAAA,cAAA,SAAA;;;GArEdwH,oBAAAA,WAAAA,eAAAA,IAAAA;;MA4ElBvH,2BAAI,MAAA;;;GA5EcuH,oBAAAA,WAAAA,eAAAA,IAAAA;;MAiHlB/E,8BAAO,WAAA;EAELzC,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EAER1B,WAAAA,GAAAA,YAAAA,CAAAA;;;;;WACS,SAAA,cAAA,SAAA;;GAvHOkJ,oBAAAA,WAAAA,iBAAAA,IAAAA;;MAyKlBtH,2BAAI,QAAA;EAEFF,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,QAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,UAAA,CAAA;;;;WADkB,gBAAA,cAAA,SAAA;;;GA5KVwH,oBAAAA,WAAAA,gBAAAA,IAAAA;;MAgMlBtH,2BAAI,UAAA;EAEFF,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,UAAA,CAAA;;;;;WACJ,cAAA,cAAA,SAAA;;GApMYwH,oBAAAA,WAAAA,iBAAAA,IAAAA;;MA+NlBtH,2BAAI,OAAA;EAEFF,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,OAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;EACR1B,WAAAA,GAAAA,YAAAA,CAAAA;;;;;;WAAwB,SAAA,cAAA,SAAA;WACpB,cAAA,cAAA,SAAA;;GArOYkJ,oBAAAA,WAAAA,cAAAA,IAAAA;;MA8RlBtH,2BAAI,MAAA;EACaF,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;EAAmBA,WAAAA,OAAAA,+BAAQ,MAAA,CAAA;;;;;;GA/RlCwH,oBAAAA,WAAAA,cAAAA,IAAAA;;MA+SlBtH,2BAAI,QAAA;EACoBF,WAAAA,OAAAA,+BAAQ,IAAA,CAAA;EAAmBA,WAAAA,OAAAA,+BAAQ,OAAA,CAAA;;;;;;GAhTzCwH,oBAAAA,WAAAA,qBAAAA,IAAAA;AAAAA,sBAAAA,eAAAA;MADpBpH,wCAAiB,cAAczc,MAAAA;GACX6jB,mBAAAA;;;AI/CrB,IAAAlgC,wBASO;;;;;;;;;;;;;;;;;;;;;;;;IAoBcgiC,kBAANvzB,OAAA,MAAA;EAAA;AAELwzB;AAGA5sB;AAGAiR;AAGAD;AAGAiK;AAGAziB;;EAER,MACM0Y,SAAoBnb,MAAW;AACnC,QAAI;AAEF,YAAM,CAACqc,MAAAA,IAAU,MAAMI,WAEpB;QACD,QAAQE,WAAWI;QACnB,cAAc;MAChB,CAAA;AACA,UAAIV,QAAQhlB,MAAM5F,QAAQ;AACxB,aAAKwY,gBAAgBvH,IAAI,QAAQ,4BAAQ1C,MAAM9Q,OAAAA,IAAW;UACxDA,SAAS8Q,MAAM9Q;QACjB,CAAA;AACA,cAAMomB,UAAUS,OAAOH;MACzB;AACA,YAAM5nB,QAAO,MAAM,KAAK6oC,YAAY1b,SAASnb,IAAAA;AAC7C,YAAMhO,QAAQ,MAAM,KAAKkpB,aAAazB,kBAAkBzrB,KAAAA;AACxD,aAAO;QACLgE;MACF;IACF,SACOL,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACM2pB,MACgBpsB,SACJ4mB,KAChB;AACA,QAAI;AACF,UAAI,CAAC5mB,WAAW,CAAC4mB,KAAK;AACpB,eAAO4R,+BAASG,cAAcvS,UAAUpmB,QAAQqmB,KAAK;MACvD;AAGA,YAAMuhB,oBAAoB7/B,YAAY6B,eAAe;QACnDvH,MAAM;QACN/B,KAAK;MACP,CAAA,KAAM,CAAA;AAEN,YAAMunC,kBAAkBD,kBAAkBh5B,SAAS,KAAKg5B,kBAAkBE,KAAKv9B,CAAAA,WAAUA,QAAQ1B,UAAU7I,OAAAA;AAE3G0C,cAAQqB,IAAI,wDAAgB;QAC1B/D;QACA+nC,aAAaH,kBAAkBtzB,IAAIJ,CAAAA,MAAKA,GAAGrL,KAAAA,EAAOI,OAAOC,OAAAA;QACzD2+B;QACAG,aAAaJ,kBAAkBh5B;MACjC,CAAA;AAEA,UAAIi5B,iBAAiB;AACnB,cAAMI,mBAAmBlgC,YAAY6B,eAAe;UAClDvH,MAAM;UACN/B,KAAK;QACP,CAAA,KAAM,CAAA;AAEN,cAAM4nC,aAAaD,iBAAiBr5B,SAAS,KAAKq5B,iBAAiBH,KAAKv9B,CAAAA,WAAUA,QAAQ1B,UAAU+d,GAAAA;AAEpGlkB,gBAAQqB,IAAI,wDAAgB;UAC1BokC,WAAWvhB,KAAKhY;UAChBs5B;UACAE,gBAAgBH,iBAAiBr5B;QACnC,CAAA;AAEA,YAAIs5B,YAAY;AACd,cAAI;AACF,kBAAM/b,IAAI,IAAItK,MAAAA;AACdsK,cAAEnsB,UAAUA;AACZmsB,cAAEpK,QAAQ+G,WAAWG;AACrB,kBAAMnmB,SAAQ,MAAM,KAAKkpB,aAAazB,kBAAkB4B,CAAAA;AACxDzpB,oBAAQqB,IAAI,oEAAkB/D,OAAAA;AAC9B,mBAAO;cACL8C,OAAAA;cACA+jB,QAAQ;YACV;UACF,SACOwhB,YAAY;AACjB3lC,oBAAQD,MAAM,mDAAqB4lC,UAAAA;AACnC,mBAAO7P,+BAAS0B,KAAK,KAAK,kDAAA;UAC5B;QACF;AAEAx3B,gBAAQqB,IAAI,oEAAkB/D,OAAAA;AAC9B,eAAOw4B,+BAASG,cAAcvS,UAAUQ,IAAIP,KAAK;MACnD;AAGA,YAAMvnB,QAAO,MAAM,KAAK6oC,YAAYvb,MAAMpsB,SAAS4mB,GAAAA;AACnD,YAAM9jB,QAAQ,MAAM,KAAKkpB,aAAazB,kBAAkBzrB,KAAAA;AACxD,aAAO;QACLgE;MACF;IACF,SACOL,OAAY;AACjBC,cAAQD,MAAM,4CAAc;QAC1BA,OAAOA,OAAOqJ,WAAWrJ;QACzBmP,OAAOnP,OAAOmP;QACd5R;MACF,CAAA;AAGA,UAAIyC,OAAO3E,QAAQ2E,OAAO1E,KAAK;AAC7B,eAAOy6B,+BAASG,cAAcl2B,KAAAA;MAChC;AAEA,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACMg3B,SAAS;AACb,UAAM,EAAEz5B,QAAO,IAAK,KAAKuT,IAAIzP,IAAI2L;AACjC,SAAKsL,gBAAgBvH,IAAI,QAAQ,4BAAQxT,OAAAA,IAAW;MAClDA;IACF,CAAA;AACA,SAAKgsB,aAAalC,aAAa,KAAKvW,IAAIzP,IAAIG,QAAQnB,KAAK;EAC3D;EAEA,MACMypB,YAAuBzb,MAAM;AACjC,QAAI;AACF,YAAM,EAAEhT,MAAMgkB,MAAK,IAAKhR;AACxB,YAAMhS,QAAO,MAAM,KAAK6oC,YAAYpb,YAAYzK,OAAOhkB,IAAAA;AACvD,YAAMgF,QAAQ,MAAM,KAAKkpB,aAAazB,kBAAkBzrB,KAAAA;AACxD,aAAO;QACLgE;MACF;IACF,SACOL,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACMiqB,eAA0B5b,MAAM;AACpC,QAAI;AACF,YAAMhS,QAAO,MAAM,KAAK6oC,YAAYjb,eAAe5b,IAAAA;AACnD,YAAMhO,QAAQ,MAAM,KAAKkpB,aAAazB,kBAAkBzrB,KAAAA;AACxD,aAAO;QACLgE;MACF;IACF,SACOL,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAEA,MACM6lC,eAAe;AACnB,UAAM,EAAEvmB,OAAAA,QAAO/hB,QAAO,IAAK,KAAKuT,IAAIzP,IAAI2L;AACxC,SAAKuc,aAAavB,aAAa,KAAKlX,IAAIzP,IAAIG,QAAQnB,KAAK;AACzD,WAAO;MACLif,OAAOA,WAAU+G,WAAWE;MAC5BhZ,MAAMhQ;MACN6mB,QAAQ9E,WAAU+G,WAAWG;IAC/B;EACF;EAEA,MACMsf,UAAU;AACd,WAAO,CAAC,CAAC,KAAKh1B,IAAIzP,IAAI2L;EACxB;EAEA,MACM+4B,WAAW;AACf,UAAM1pC,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;MAC7ChV,IAAI,KAAKqD,IAAIzP,IAAI2L,SAASS;IAC5B,CAAA;AACA,UAAMu4B,eAAe,MAAM,KAAKzS,YAAYtC,gBAAgB50B,KAAAA;AAC5D,UAAM,EAAE41B,SAASM,OAAOX,aAAajS,QAAQ8S,MAAMlD,YAAYG,aAAaoC,MAAK,IAAKkU;AACtF,QAAIzW,YAAY;AACd,WAAKjX,gBAAgBvH,IAAI,QAAQ,gBAAM1U,MAAKkB,OAAO,yCAAW;QAC5D0oC,OAAO55B,WAAW4lB,OAAAA;QAClBM,OAAOlmB,WAAWkmB,KAAAA;MACpB,CAAA;IACF;AACA,QAAI7C,aAAa;AACf,WAAKpX,gBAAgBvH,IAAI,QAAQ,gBAAM1U,MAAKkB,OAAO,6BAAS;QAC1DoiB;QACA8S;MACF,CAAA;IACF;AACA,WAAO;MACLlzB,MAAM0yB;MACNM;MACAX;MACAjS;MACA8S,MAAMA,KAAK/lB,QAAQ,CAAA;MACnB6iB;MACAG;MACAoC,OAAO;QACLnf,SAASmf,MAAMrB;QACfb,WAAW,CAACkC,MAAMvB,uBAAuB,CAACuB,MAAMtB,WAAW,CAACsB,MAAM3B,eAAezjB,QAAQ,CAAA;MAC3F;IACF;EACF;AACF,GAzNe,OAAAgF,MAAA,mBAAAA;;MACZyH,8BAAOkQ,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GAFF4b,eAAAA,WAAAA,eAAAA,MAAAA;;MAIlB9rB,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GALNo0B,eAAAA,WAAAA,mBAAAA,MAAAA;;MAOlB9rB,8BAAO8N,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GARHge,eAAAA,WAAAA,gBAAAA,MAAAA;;MAUlB9rB,8BAAO4P,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GAXLkc,eAAAA,WAAAA,kBAAAA,MAAAA;;MAalB9rB,8BAAOkT,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GAdF4Y,eAAAA,WAAAA,eAAAA,MAAAA;;MAgBlB/zB,iCAAAA;uCACY,YAAA,cAAA,SAAA,OAAA;GAjBM+zB,eAAAA,WAAAA,OAAAA,MAAAA;;MAmBlBxJ,4BAAK,UAAA;EACUE,WAAAA,OAAAA,+BAAAA,CAAAA;;;;;GApBGsJ,eAAAA,WAAAA,YAAAA,IAAAA;;MA8ClBxJ,4BAAK,OAAA;EAEHE,WAAAA,OAAAA,+BAAQ,SAAA,CAAA;EACRA,WAAAA,OAAAA,+BAAQ,KAAA,CAAA;;;;;;GAjDQsJ,eAAAA,WAAAA,SAAAA,IAAAA;;MAkIlBrJ,2BAAI,UAAU;IAAElD,WAAW;EAAK,CAAA;;;GAlIduM,eAAAA,WAAAA,UAAAA,IAAAA;;MA2IlBxJ,4BAAK,YAAA;EACaE,WAAAA,OAAAA,+BAAAA,CAAAA;;;;;GA5IAsJ,eAAAA,WAAAA,eAAAA,IAAAA;;MA0JlBpJ,2BAAI,UAAA;EACiBF,WAAAA,OAAAA,+BAAAA,CAAAA;;;;;GA3JHsJ,eAAAA,WAAAA,kBAAAA,IAAAA;;MAwKlBrJ,2BAAI,eAAe;IAAElD,WAAW;EAAK,CAAA;;;GAxKnBuM,eAAAA,WAAAA,gBAAAA,IAAAA;;MAmLlBrJ,2BAAI,SAAS;IAAElD,WAAW;EAAK,CAAA;;;GAnLbuM,eAAAA,WAAAA,WAAAA,IAAAA;;MAwLlBrJ,2BAAI,SAAS;IAAElD,WAAW;EAAK,CAAA;;;GAxLbuM,eAAAA,WAAAA,YAAAA,IAAAA;AAAAA,iBAAAA,eAAAA;MADpBlJ,wCAAiB,MAAA;GACGkJ,cAAAA;;;AChCrB,IAAAiB,mBAAe;AACf,IAAAtjC,oBAAiB;AACjB,IAAAujC,gBAAkB;AAClB,IAAAC,gBAAkB;AAClB,IAAAhhC,mBAA4B;AAC5B,IAAAnC,wBAQO;AAOP;;;ACpBA,sBAA2B;AAC3B,IAAAiC,uBAAoB;AAsDpB,eAAemhC,cACbC,WACAC,OAAoB;AAEpB,QAAMp+B,MAAM7C,YAAYmC,oBAAoB,OAAA;AAC5C,QAAM++B,SAASr+B,IAAI/L;AAEnB,QAAM,EAAEqqC,WAAWtzB,cAAc0M,SAAS6mB,WAAW3lB,iBAAiB,MAAK,IAAKwlB;AAEhF,QAAMI,qBACF;AACJ,QAAM,EAAE5sB,MAAK,KACX,MAAM3S,OAAMu/B,oBAAoBL,WAAW,GAAGniC,OAAOsiC,SAAAA,CAAAA,IAAcD,MAAAA,GACnE,CAAA;AACF,MAAIzsB,UAAU,GAAG;AACf9Z,YAAQqB,IAAI,4BAAQglC,SAAAA,IAAaniC,OAAOsiC,SAAAA,CAAAA,EAAY;AACpD,UAAMvpB,MAAM,eAAeopB,SAAAA,eAAwBniC,OAC7CsiC,SAAAA,CAAAA,IACGC,SAAAA,YAAqBvzB,YAAAA,IAAgB4N,iBAAiB,gCAAgC,EAAA,aAAelB,OAAAA;AAC9G5f,YAAQqB,IAAI4b,GAAAA;AACZjd,YAAQqB,IAAI,MAAM8F,OAAM8V,GAAAA,CAAAA;EAC1B;AACF;AAtBempB;AAwBf,eAAeO,iBACbN,WACAC,OAA6B;AAE7B,QAAMp+B,MAAM7C,YAAYmC,oBAAoB,OAAA;AAC5C,QAAM++B,SAASr+B,IAAI/L;AACnB,QAAM,EAAEqqC,WAAWC,UAAS,IAAKH;AACjC,QAAMI,qBACF;AACJ,QAAM,EAAE5sB,MAAK,KACX,MAAM3S,OAAMu/B,oBAAoBL,WAAW,GAAGniC,OAAOsiC,SAAAA,CAAAA,IAAcD,MAAAA,GACnE,CAAA;AACF,MAAIzsB,UAAU,GAAG;AACf9Z,YAAQqB,IAAI,UAAKglC,WAAW,kCAASG,WAAWC,SAAAA;AAChD;EACF;AAEA,QAAMG,mBACF;AACJ,QAAM,EAAEC,aAAaC,WAAU,KAC7B,MAAM3/B,OAAMy/B,kBAAkBP,WAAW,GAAGniC,OAAOsiC,SAAAA,CAAAA,IAAcD,MAAAA,GACjE,CAAA;AAEF,MAAIO,eAAeL,WAAW;AAE5B,QAAIA,cAAc,YAAYK,WAAWhuB,SAAS2tB,SAAAA,GAAY;AAC5D;IACF;AACAzmC,YAAQqB,IAAI,4BAAQglC,SAAAA,IAAaniC,OAAOsiC,SAAAA,CAAAA,EAAY;AACpDxmC,YAAQqB,IACN,eAAeglC,SAAAA,WAAoBniC,OAAOsiC,SAAAA,CAAAA,IAAcC,SAAAA,EAAW;AAErEzmC,YAAQqB,IACN,MAAM8F,OACJ,eAAek/B,SAAAA,WAAoBniC,OAAOsiC,SAAAA,CAAAA,IAAcC,SAAAA,EAAW,CAAA;EAGzE;AACF;AAtCeE;AAwCf,eAAsBI,aAAAA;AACpB,QAAMC,OAAOxnC,KAAKuvB,MAAM,OAAO,EAAA;AAC/B,QAAMqX,cAAc,aAAa;IAC/BI,WAAW;IACXC,WAAW;IACX7mB,SAAS;IACT1M,cAAc;EAChB,CAAA;AAEA,QAAMkzB,cAAc,SAAS;IAC3BI,WAAW;IACXC,WAAW;IACX7mB,SAAS;IACT1M,cAAc;EAChB,CAAA;AAEA,QAAMkzB,cAAc,QAAQ;IAC1BI,WAAW;IACXC,WAAW;IACX7mB,SAAS;IACT1M,cAAc;EAChB,CAAA;AAEA,QAAMkzB,cAAc,SAAS;IAC3BI,WAAW;IACXC,WAAW;IACX7mB,SAAS;IACT1M,cAAc;EAChB,CAAA;AAEA,QAAMyzB,iBAAiB,aAAa;IAClCH,WAAW;IACXC,WAAW,WAAWO,IAAAA;EACxB,CAAA;AAEA,QAAML,iBAAiB,SAAS;IAC9BH,WAAW;IACXC,WAAW,WAAWO,IAAAA;EACxB,CAAA;AAEA,QAAML,iBAAiB,aAAa;IAClCH,WAAW;IACXC,WAAW;EACb,CAAA;AAEA,QAAME,iBAAiB,SAAS;IAC9BH,WAAW;IACXC,WAAW;EACb,CAAA;AAEA,QAAML,cAAc,aAAa;IAC/BI,WAAW;IACXC,WAAW;IACXvzB,cAAc;IACd0M,SAAS;EACX,CAAA;AAEA,QAAMwmB,cAAc,QAAQ;IAC1BI,WAAW;IACXC,WAAW;IACXvzB,cAAc;IACd0M,SAAS;EACX,CAAA;AACA,QAAMwmB,cAAc,QAAQ;IAC1BI,WAAW;IACXC,WAAW;IACXvzB,cAAc;IACd0M,SAAS;EACX,CAAA;AAEA,QAAMwmB,cAAc,SAAS;IAC3BI,WAAW;IACXC,WAAW;IACXvzB,cAAc;IACd0M,SAAS;EACX,CAAA;AACA,QAAMwmB,cAAc,SAAS;IAC3BI,WAAW;IACXC,WAAW;IACXvzB,cAAc;IACd0M,SAAS;EACX,CAAA;AACA,QAAMwmB,cAAc,SAAS;IAC3BI,WAAW;IACXC,WAAW;IACXvzB,cAAc;IACd0M,SAAS;IACTkB,gBAAgB;EAClB,CAAA;AACF;AAzFsBimB;AA2FtB,SAASE,gBAAAA;AACP,QAAMrpC,MAAMsN,aAAAA;AACZ,SAAO,KAAKtN,IAAIspC,MAAM,IAAItpC,IAAIsO,MAAM,CAAA;AACtC;AAHS+6B;AAKT,SAASE,oBAAAA;AACP,QAAMvpC,MAAMsN,aAAAA;AACZ,SAAOtN,IAAIspC,MAAM,IAAI,EAAA;AACvB;AAHSC;AAKT,eAAsB7hC,iBAAAA;AAEpB,MAAI8hC,cAAc/hC,YAAY6B,eAAe;IAC3CvH,MAAM;IACN/B,KAAK;EACP,CAAA,IAAK,CAAA,GAAIuI;AACT,MAAIkhC,UAAUhiC,YAAY6B,eAAe;IAAEvH,MAAM;IAAU/B,KAAK;EAAM,CAAA,IAAK,CAAA,GACvEuI;AACJ,MAAI,CAACihC,eAAe,CAACC,SAAS;AAC5BD,kBAAcH,cAAAA;AACdI,cAAUF,kBAAAA;AACV9hC,gBAAYsB,kBAAkB;MAC5BhH,MAAM;MACN/B,KAAK;MACLuI,OAAOihC;MACPE,UAAU;IACZ,CAAA;AACAjiC,gBAAYsB,kBAAkB;MAC5BhH,MAAM;MACN/B,KAAK;MACLuI,OAAOkhC;MACPC,UAAU;IACZ,CAAA;EACF;AAEAtnC,UAAQqB,IAAI,gDAAkB,iBAAO+lC,aAAa,iBAAOC,OAAAA;AACzDrnC,UAAQqB,IAAI,gDAAkB,iBAAO+lC,aAAa,iBAAOC,OAAAA;AACzDrnC,UAAQqB,IAAI,gDAAkB,iBAAO+lC,aAAa,iBAAOC,OAAAA;AAEzD,QAAME,cAAc,wBAAC5nC,MAAsBkI,WAAAA;AACzC,UAAM2/B,aAAaniC,YAAY6B,eAAe;MAAEvH;IAAK,CAAA,KAAM,CAAA;AAC3DyH,WAAOC,KAAKQ,MAAAA,EAAQ5B,QAAQ,CAACrI,QAAAA;AAC3B,UAAI,CAAC4pC,WAAWpC,KAAKl/B,CAAAA,SAAQA,KAAKtI,QAAQA,GAAAA,GAAM;AAE9CoC,gBAAQqB,IAAI,sDAAwB1B,IAAAA,IAAQ/B,GAAAA,IAAOiK,OAAOjK,GAAAA,CAAI,EAAE;AAChEyH,oBAAYsB,kBAAkB;UAC5BhH;UACA/B;UACAuI,OAAO0B,OAAOjK,GAAAA;UACd0pC,UAAU;YAAC;YAAY;YAAaxuB,SAASlb,GAAAA;QAC/C,CAAA;MACF;AAEA,UAAIiK,OAAOjK,GAAAA,aAAgBwJ,QAAQ;AACjC,cAAMqgC,YAAiBD,WAAWl9B,KAChCpE,CAAAA,SAAQA,KAAKtI,QAAQA,GAAAA,GACpBuI;AAEH,YAAIiB,OAAOC,KAAKQ,OAAOjK,GAAAA,CAAI,EAAEwnC,KAAKj5B,CAAAA,MAAKs7B,YAAYt7B,CAAAA,MAAOpE,MAAAA,GAAY;AACpE,gBAAM+8B,WAAW;YACf,GAAGj9B,OAAOjK,GAAAA;YACV,GAAG6pC;UACL;AACAznC,kBAAQqB,IACN,0CAAsB1B,IAAAA,IAAQ/B,GAAAA,IAAO8H,KAAKgB,UAAUo+B,QAAAA,CAAAA,EAAW;AAEjEz/B,sBAAYkC,iBACV;YACE5H;YACA/B;UACF,GACA;YACEuI,OAAO2+B;UACT,CAAA;QAEJ;MACF;IACF,CAAA;EACF,GAvCoB;AAwCpByC,cAAY,SAASjkC,WAAAA;AACrBikC,cAAY,SAAS3jC,aAAAA;AACrB2jC,cAAY,SAASnjC,WAAAA;AACrBmjC,cAAY,SAAS9iC,WAAAA;AACrB8iC,cAAY,UAAU;IACpBG,MAAM;MACJC,gBAAgB;MAChBC,YAAY;MACZC,YAAY;MACZ9a,oBAAoB;MACpBqP,yBAAyB;MACzB0L,mBAAmB;MACnBhgC,eAAe;MACfwnB,YAAY;MACZG,aAAa;MACbM,eAAe;MACfC,eAAe;MACfF,2BAA2B;MAC3BF,gCAAgC;MAChCC,oBAAoB;MACpBoB,eAAe,CAAC,oBAAInwB,KAAK,YAAA;MACzBinC,SAAS;IACX;EACF,CAAA;AAEA,QAAM1iC,YAAYoB,UAAS;AAE3B,QAAMpB,YAAYQ,eAAc;AAClC;AAjGsBP;AAsGf,SAAS0iC,wBAAAA;AAEd,SAAO5/B,QAAQ+R,IAAI;IACjB8tB,cAAAA;;IAEAnmB,YAAAA;IACAjF,YAAAA;;IAEAvI,oBAAAA;;IAEArM,eAAAA;GACD;AAIH;AAfgB+/B;AAiBT,SAASC,gBAAAA;AACd,MAAI,CAACnsC,qBAAAA,QAAQoH,IAAI0kB,cAAc;AAE7B,UAAMxR,SAAS5W,KAAKgY,OAAM,EAAGjX,SAAS,EAAA,EAAI2mC,MAAM,GAAG,CAAA;AACnDprC,yBAAAA,QAAQoH,IAAI0kB,eAAe,YAAYxR,MAAAA;AACvC8xB,oCAAW,cAAc;eAAkBpsC,qBAAAA,QAAQoH,IAAI0kB,YAAY,EAAE;EACvE;AACF;AAPgBqgB;;;;;;;;;;;;;;;;;;;;;;;;;AD7ShB,IAAME,gBAAgBtqC,kBAAAA,QAAKC,KACzBhC,QAAQC,IAAG,GACX,0BAAA;AAGF,IAAIqsC,sBAAsB;AA8D1B,eAAeC,oBAAAA;AACb,MAAI,CAACD,qBAAqB;AACxBA,0BAAsB,MAAM9pC,iBAAAA,QAAGsH,SAASuiC,eAAe,OAAA;EACzD;AACA,SAAOC;AACT;AALeC;AAOf,SAASC,sBAAsB5iB,SAAyB;AACtD,SAAO;IACL,GAAGA;IACHxpB,MAAMuZ,OAAOiQ,QAAQxpB,IAAI,KAAK;EAChC;AACF;AALSosC;AAOT,SAASC,sBAAsB7iB,SAA2B;AACxD,SAAO;IACLzpB,MAAMypB,QAAQzpB;IACdC,MAAMuZ,OAAOiQ,QAAQxpB,IAAI,KAAK;IAC9BG,UAAUqpB,QAAQrpB,YAAY;EAChC;AACF;AANSksC;AAQT,SAASC,cAAcxrC,KAAW;AAChC,QAAMyrC,SAAS,IAAI/mC,IAAI1E,GAAAA;AACvB,QAAMD,QAAOyJ,QAAQiiC,OAAOzmB,QAAQ;AACpC,SAAO;IACLhlB;IACAf,MAAMwsC,OAAOrlC;IACblH,MAAMuZ,OAAOgzB,OAAOvsC,IAAI,KAAK;IAC7BE,MAAMqsC,OAAOzmB,WAAWoe,mBAAmBqI,OAAOzmB,QAAQ,IAAI;IAC9D3lB,UAAUosC,OAAOpsC,WAAW+jC,mBAAmBqI,OAAOpsC,QAAQ,IAAI;IAClEF,UAAUssC,OAAOC,UAAUvqC,QAAQ,KAAK,EAAA,KAAO;IAC/CpB,MAAAA;EACF;AACF;AAZSyrC;AAcT,SAASG,sBAAsBjjB,SAA2BkjB,QAAQ,OAAK;AACrE,QAAM1gC,MAAMogC,sBAAsB5iB,OAAAA;AAClC,QAAMmjB,mBAA2C;IAC/C5sC,MAAMiM,IAAIjM;IACVC,MAAMgM,IAAIhM;IACVE,MAAM8L,IAAI8Z;IACV3lB,UAAU6L,IAAI7L;IACdysC,SAAS;IACTC,oBAAoB;EACtB;AACA,MAAIH,OAAO;AACTC,qBAAiB1sC,WAAW+L,IAAI/L;EAClC;AACA,SAAO,IAAIiM,QAA0B,CAACmB,SAASsN,WAAAA;AAC7C,UAAMzH,aAAapT,cAAAA,QAAMgtC,iBAAiBH,gBAAAA;AAC1Cz5B,eAAW5G,QAAQ,CAACO,QAAAA;AAClB,UAAIA,KAAK;AACP8N,eAAO9N,GAAAA;AACP;MACF;AACAQ,cAAQ6F,UAAAA;IACV,CAAA;EACF,CAAA;AACF;AAvBSu5B;AAyBT,SAASM,KAAK75B,YAA8B6N,KAAW;AACrD,SAAO,IAAI7U,QAAc,CAACmB,SAASsN,WAAAA;AACjCzH,eAAWjI,MAAM8V,KAAK,CAAClU,QAAAA;AACrB,UAAIA,KAAK;AACP8N,eAAO9N,GAAAA;AACP;MACF;AACAQ,cAAAA;IACF,CAAA;EACF,CAAA;AACF;AAVS0/B;AAYT,eAAeC,kBAAkBxjB,SAAyB;AACxD,QAAMyjB,YAAYb,sBAAsB5iB,OAAAA;AACxC,QAAMtW,aAAa,MAAMu5B,sBAAsBQ,SAAAA;AAC/C,MAAI;AACF,UAAMF,KACJ75B,YACA,6BAA6B+5B,UAAUhtC,QAAQ,IAAI;AAErD,UAAM8sC,KACJ75B,YACA,mCAAmC+5B,UAAUhtC,QAAQ,6DAA6D;EAEtH,UAAA;AAEEiT,eAAWU,IAAG;EAChB;AAEA,QAAMs5B,eAAe,MAAMT,sBAAsBQ,WAAW,IAAA;AAC5D,MAAI;AACF,UAAMlsB,MAAM,MAAMorB,kBAAAA;AAClB,UAAMY,KAAKG,cAAcnsB,GAAAA;EAC3B,UAAA;AAEEmsB,iBAAat5B,IAAG;EAClB;AACF;AAzBeo5B;AAkCf,eAAeG,kBAAkBnoC,SAAsB;AACrD,aAAWooC,SAASpoC,SAAS;AAC3B,UAAMmE,YAAYwB,cAAc;MAC9BlH,MAAM2pC,MAAM3pC;MACZ/B,KAAK0rC,MAAM1rC;MACXuI,OAAOmjC,MAAMnjC;MACbmhC,UAAU9gC,QAAQ8iC,MAAMhC,QAAQ;IAClC,CAAA;EACF;AACA,QAAMjiC,YAAYQ,eAAc;AAClC;AAVewjC;AAYf,eAAeE,mBAAmB7jB,SAAyB;AACzD,QAAMxd,MAAMogC,sBAAsB5iB,OAAAA;AAClC,QAAM2jB,kBAAkB;IACtB;MAAE1pC,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAIjM;IAAK;IAC9C;MAAE0D,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAIhM;IAAK;IAC9C;MAAEyD,MAAM;MAAS/B,KAAK;MAAYuI,OAAO+B,IAAI/L;IAAS;IACtD;MAAEwD,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAI8Z;IAAS;IAClD;MAAEriB,MAAM;MAAS/B,KAAK;MAAYuI,OAAO+B,IAAI7L;MAAUirC,UAAU;IAAK;GACvE;AACD,QAAMzqB,YAAAA;AACN,MAAI;AACF,UAAMiF,YAAAA;AACN,UAAMilB,WAAAA;EACR,SACOhnC,OAAO;AACZC,YAAQqB,IAAI,6FAA4BtB,OAAOqJ,OAAAA;EACjD;AACF;AAjBemgC;AAmBf,eAAeC,oBAAoB9jB,SAAyB;AAC1D,QAAMtW,aAAa,MAAMu5B,sBAAsBjjB,OAAAA;AAC/C,MAAI;AACF,UAAMujB,KAAK75B,YAAY,UAAA;EACzB,UAAA;AAEEA,eAAWU,IAAG;EAChB;AACF;AARe05B;AAUf,SAASC,kBAAkB/jB,SAA2B;AACpD,QAAMxd,MAAMqgC,sBAAsB7iB,OAAAA;AAClC,QAAM9H,UAAU1V,IAAI7L,WAChB;IACEA,UAAU6L,IAAI7L;EAChB,IACA0L;AACJ,QAAMqJ,SAASnU,cAAAA,QAAMoU,aAAanJ,IAAIhM,MAAMgM,IAAIjM,MAAM2hB,OAAAA;AACtD,SAAO;IAAExM;IAAQlJ;EAAI;AACvB;AATSuhC;AAWT,eAAeC,oBAAoBhkB,SAA2B;AAC5D,QAAM,EAAEtU,OAAM,IAAKq4B,kBAAkB/jB,OAAAA;AACrC,SAAO,IAAItd,QAAc,CAACmB,SAASsN,WAAAA;AACjCzF,WAAOrC,GAAG,SAAS,MAAA;AACjBqC,aAAOE,KAAI;AACX/H,cAAAA;IACF,CAAA;AACA6H,WAAOrC,GAAG,SAAS,CAAChG,QAAAA;AAClBqI,aAAOE,KAAI;AACXuF,aAAO9N,GAAAA;IACT,CAAA;EACF,CAAA;AACF;AAZe2gC;AAcf,eAAeC,mBAAmBjkB,SAA2B;AAC3D,QAAMxd,MAAMqgC,sBAAsB7iB,OAAAA;AAClC,QAAM2jB,kBAAkB;IACtB;MAAE1pC,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAIjM;IAAK;IAC9C;MAAE0D,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAIhM;IAAK;IAC9C;MAAEyD,MAAM;MAAS/B,KAAK;MAAYuI,OAAO+B,IAAI7L;MAAUirC,UAAU;IAAK;IACtE;MAAE3nC,MAAM;MAAS/B,KAAK;MAAQuI,OAAOK,QAAQ0B,IAAI7L,QAAQ;IAAE;GAC5D;AACDP,UAAQoH,IAAImB,gBAAgB6D,IAAIjM;AAChCH,UAAQoH,IAAIoB,gBAAgBJ,OAAOgE,IAAIhM,IAAI;AAC3CJ,UAAQoH,IAAIqB,oBAAoB2D,IAAI7L;AACpCP,UAAQoH,IAAIsB,qBAAqBN,OAAOsC,QAAQ0B,IAAI7L,QAAQ,CAAA;AAC9D;AAZestC;AAcf,eAAeC,oBAAoBlkB,SAA2B;AAC5D,QAAMtU,SAAS,MAAM7I,6BAAYC,QAAQkd,QAAQ1oB,KAAK;IACpDyL,oBAAoB;IACpBC,iBAAiB;EACnB,CAAA;AACA,QAAM0I,OAAOxI,GAAE,EAAGihC,QAAQ;IAAEC,MAAM;EAAE,CAAA;AACpC,QAAM14B,OAAOlI,MAAK;AACpB;AAPe0gC;AASf,eAAeG,mBAAmBrkB,SAA2B;AAC3D,QAAMxd,MAAMsgC,cAAc9iB,QAAQ1oB,GAAG;AACrC,QAAMqsC,kBAAkB;IACtB;MAAE1pC,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAIjM;IAAK;IAC9C;MAAE0D,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAIhM;IAAK;IAC9C;MAAEyD,MAAM;MAAS/B,KAAK;MAAYuI,OAAO+B,IAAI/L;IAAS;IACtD;MAAEwD,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAI9L;IAAK;IAC9C;MAAEuD,MAAM;MAAS/B,KAAK;MAAYuI,OAAO+B,IAAI7L;MAAUirC,UAAU9gC,QAAQ0B,IAAI7L,QAAQ;IAAE;IACvF;MAAEsD,MAAM;MAAS/B,KAAK;MAAQuI,OAAO+B,IAAInL;IAAK;IAC9C;MACE4C,MAAM;MACN/B,KAAK;MACLuI,OAAO+B,IAAIlL;MACXsqC,UAAU9gC,QAAQ0B,IAAI7L,QAAQ;IAChC;GACD;AACDP,UAAQoH,IAAIW,gBAAgBqE,IAAIjM;AAChCH,UAAQoH,IAAIY,gBAAgBI,OAAOgE,IAAIhM,IAAI;AAC3CJ,UAAQoH,IAAIa,gBAAgBmE,IAAI/L;AAChCL,UAAQoH,IAAIc,gBAAgBkE,IAAI9L;AAChCN,UAAQoH,IAAIe,eAAeiE,IAAI7L;AAC/BP,UAAQoH,IAAIiB,qBAAqBD,OAAOgE,IAAInL,IAAI;AAChD,QAAMkL,eAAAA;AACR;AAvBe8hC;;IA0BM/E,mBAANvzB,OAAA,MAAA;EAAA;AAEL6X;;EAER,MACM0gB,mBAAmB;AACvB,UAAMvkC,OAAO,MAAM2C,QAAQ+R,IAAI;MAC7BnD,eAAAA;MACAzF,eAAAA;MACA6L,eAAAA;MACApU,iBAAAA;KACD;AAED,UAAMkU,SAASzX,KAAKgC,OAAO,CAACsD,KAAK8B,QAAAA;AAC/B,YAAM,EAAElN,MAAM,GAAGsqC,KAAAA,IAASp9B;AAC1B9B,UAAIpL,IAAAA,IAAQsqC;AACZ,aAAOl/B;IACT,GAAG,CAAC,CAAA;AACJ,WAAOmS;EACT;EAEA,MACMgtB,UAAqBxkB,SAA2B;AACpD,UAAM8jB,oBAAoB9jB,OAAAA;EAC5B;EAEA,MACMykB,gBAA2BzkB,SAA2B;AAC1D,UAAM8jB,oBAAoB9jB,OAAAA;AAC1B,UAAMwjB,kBAAkBxjB,OAAAA;AACxB,UAAM6jB,mBAAmB7jB,OAAAA;EAC3B;EAEA,MACM0kB,UAAqB1kB,SAA6B;AACtD,UAAMgkB,oBAAoBhkB,OAAAA;EAC5B;EAEA,MACM2kB,gBAA2B3kB,SAA6B;AAC5D,UAAMgkB,oBAAoBhkB,OAAAA;AAC1B,UAAMikB,mBAAmBjkB,OAAAA;EAC3B;EAEA,MACM4kB,UAAqB5kB,SAA6B;AACtD,UAAMkkB,oBAAoBlkB,OAAAA;EAC5B;EAEA,MACM6kB,gBAA2B7kB,SAA6B;AAC5D,UAAMkkB,oBAAoBlkB,OAAAA;AAC1B,UAAMqkB,mBAAmBrkB,OAAAA;EAC3B;EAEA8kB,gBAAgBtiC,KAAmB;AACjC,WAAOA,IAAI0J,IAAI,CAACa,MAAAA;AACd,YAAM,EAAE7U,KAAK0pC,UAAUnhC,OAAOxG,KAAI,IAAK8S;AACvC,aAAO;QACL7U;QACAuI,OAAOmhC,WAAW,WAAWnhC;QAC7BxG;QACA8qC,OAAO7uC,iBAAiB+D,IAAAA,EAAM/B,GAAAA;MAChC;IACF,CAAA;EACF;EAEA,MACM8sC,gBAAgB;AACpB,UAAM1uC,SAAQ,KAAKwuC,gBACjBnlC,YAAY6B,eAAe;MACzBvH,MAAM;IACR,CAAA,CAAA;AAGF,UAAMrD,SAAQ,KAAKkuC,gBACjBnlC,YAAY6B,eAAe;MACzBvH,MAAM;IACR,CAAA,CAAA;AAGF,UAAM7C,QAAQ,KAAK0tC,gBACjBnlC,YAAY6B,eAAe;MACzBvH,MAAM;IACR,CAAA,CAAA;AAGF,WAAO;MACL;QAAEg7B,OAAO;QAASl1B,MAAMzJ;MAAM;MAC9B;QAAE2+B,OAAO;QAAWl1B,MAAM3I;MAAM;MAChC;QAAE69B,OAAO;QAAOl1B,MAAMnJ;MAAM;;EAEhC;EAEA,MACMquC,eAA0Bv8B,MAAoB;AAClD,UAAM,EAAE4T,UAAU5C,OAAO/iB,UAAAA,UAAQ,IAAK+R;AACtC,QAAI,CAAC4T,UAAU;AACb,YAAM0B,UAAUpmB,QAAQqmB;IAC1B;AACA,QAAI,CAACqF,OAAO/d,KAAKmU,KAAAA,GAAQ;AACvB,YAAMsE,UAAUtE,MAAMuE;IACxB;AACA,QAAI,CAACtnB,WAAU;AACb,YAAMqnB,UAAUQ,IAAIP;IACtB;AACA,QAAIinB,SAAS,MAAMtiB,oBAAoBtG,QAAAA,GAAW,CAAA;AAClD,QAAI,CAAC4oB,OAAO;AACVA,eAAS,MAAMriB,kBAAkBnJ,KAAAA,GAAQ,CAAA;IAC3C;AACA,UAAMyrB,eAAengC,WAAWrO,SAAAA;AAChC,QAAIuuC,OAAO;AACT,YAAMhiB,WACJ;QACEtrB,SAAS0kB;QACT5C;QACA/iB,UAAUwuC;QACVxrB,OAAO+G,WAAWE;QAClBzmB,QAAQ2mB,YAAYH;MACtB,GACA;QACE7Y,IAAIo9B,MAAMp9B;MACZ,CAAA;AAEF;IACF;AACA,UAAMmb,WAAW;MACfrrB,SAAS0kB;MACT5C;MACA/iB,UAAUwuC;MACVxrB,OAAO+G,WAAWE;MAClBzmB,QAAQ2mB,YAAYH;MACpB7G,YAAY;IACd,CAAA;EACF;EAEA,MACMsrB,sBAAwC1rB,OAAe;AAC3D,QAAI,CAAC4J,OAAO/d,KAAKmU,KAAAA,GAAQ;AACvB,YAAMsE,UAAUtE,MAAMuE;IACxB;AACA,UAAMvoB,OAAOg5B,aAAa,CAAA;AAC1B,UAAMY,SAAS;MACbM,IAAIlW;MACJ3hB,SAAS;MACT03B,MAAM,4FAAqC/5B,IAAAA;IAC7C,CAAA;AACA,SAAKkuB,aAAatB,cAAc5I,OAAOhkB,MAAM,KAAK,CAAA;AAClD,WAAO;MACLgO,SAAS,8CAAWgW,KAAAA;IACtB;EACF;EAEA,MACM2rB,qBAAgC38B,MAAyB;AAC7D,UAAM,EAAEgR,OAAOpjB,OAAAA,QAAO4uC,MAAK,IAAKx8B;AAChC,QAAI,CAAC4a,OAAO/d,KAAKmU,KAAAA,GAAQ;AACvB,YAAMsE,UAAUtE,MAAMuE;IACxB;AACA,UAAMzb,MAAMqtB,cAAAA;AACZ,UAAMJ,OAAO;;;;;6BAKHyV,MAAM5oB,QAAQ;6BACd4oB,MAAMvuC,QAAQ;6BACduuC,MAAMxrB,KAAK;;;;;+CAKRpjB,OAAMC,IAAI,IAAID,OAAME,IAAI;+CACxBF,OAAMG,QAAQ;mCAChBH,OAAMgmB,QAAQ;;AAEzB,UAAMgT,SAAS;MACbM,IAAIlW;MACJ3hB,SAASyK,IAAIzK,WAAW;MACxB03B;IACF,CAAA;AACA,WAAO;MACLt1B,QAAQ;IACV;EACF;EAEA,MACMmrC,cAAyB58B,MAAyB;AACtD,QAAI,CAACA,KAAKjR,YAAY,CAACiR,KAAK9Q,WAAW,CAAC8Q,KAAK/R,UAAU;AACrD,YAAMqnB,UAAUpmB,QAAQqmB;IAC1B;AACA,UAAM0lB,kBAAkB;MACtB;QAAE1pC,MAAM;QAAQ/B,KAAK;QAAYuI,OAAOiI,KAAKjR;MAAS;MACtD;QAAEwC,MAAM;QAAQ/B,KAAK;QAAYuI,OAAOiI,KAAKhR;MAAS;MACtD;QAAEuC,MAAM;QAAQ/B,KAAK;QAAUuI,OAAOiI,KAAK/Q;MAAO;MAClD;QAAEsC,MAAM;QAAQ/B,KAAK;QAAWuI,OAAOiI,KAAK9Q;MAAQ;MACpD;QAAEqC,MAAM;QAAQ/B,KAAK;QAAYuI,OAAOiI,KAAK/R;QAAUirC,UAAU;MAAK;MACtE;QAAE3nC,MAAM;QAAQ/B,KAAK;QAAQuI,OAAOiI,KAAK7Q,QAAQ6Q,KAAK9Q;MAAQ;MAC9D;QAAEqC,MAAM;QAAQ/B,KAAK;QAAcuI,OAAOiI,KAAK5Q,cAAc;MAAG;MAChE;QAAEmC,MAAM;QAAQ/B,KAAK;QAAWuI,OAAOiI,KAAK3Q,WAAW;MAAgB;MACvE;QAAEkC,MAAM;QAAQ/B,KAAK;QAAYuI,OAAOiI,KAAK1Q,YAAY;MAAG;KAC7D;AACD83B,yBAAAA;EACF;EAEA,MACMyV,aAAwB78B,MAAuB;AACnD,QAAI,CAAC4a,OAAO/d,KAAKmD,KAAKo0B,MAAM,GAAG;AAC7B,YAAM9e,UAAUtE,MAAMuE;IACxB;AACA,UAAMzb,MAAMqtB,cAAAA;AACZ,UAAMP,SAAS;MACbM,IAAIlnB,KAAKo0B;MACT/kC,SAASyK,IAAIzK,WAAW;MACxB03B,MAAMjtB,IAAIxK,YACL;IACP,CAAA;EACF;EAEA,MACMwtC,iBAA4B98B,MAA2B;AAC3D,UAAM,EACJjR,UACAC,UACAC,QACAC,SACAjB,UAAAA,WACAkB,MACAC,YACAC,SACAC,UACA8kC,OAAM,IACJp0B;AACJ,QAAI,CAACjR,YAAY,CAACG,WAAW,CAACjB,WAAU;AACtC,YAAMqnB,UAAUpmB,QAAQqmB;IAC1B;AACA,QAAI,CAACqF,OAAO/d,KAAKu3B,MAAAA,GAAS;AACxB,YAAM9e,UAAUtE,MAAMuE;IACxB;AACA,UAAMwnB,aAAyB;MAC7BhuC;MACAC;MACAC;MACAC;MACAjB,UAAAA;MACAkB,MAAMA,QAAQD;MACdE;MACAC;MACAC;IACF;AACA,UAAMs3B,SAAS;MACbM,IAAIkN;MACJ/kC,SAASA,WAAW;MACpB03B,MAAMz3B,YACD;IACP,GAAGytC,UAAAA;EACL;EAEA,MACM5jC,iBAA4B9B,MAA2B;AAC3D,UAAM2lC,eAAe,wBAACxtC,KAAa6U,MAAAA;AACjC,YAAM44B,MAAM;QAAC;;AACb,YAAMC,OAAO;QAAC;;AACd,YAAMC,aAAa;QAAC;QAAmB;;AACvC,UAAIF,IAAIvyB,SAASlb,GAAAA,GAAM;AACrB,eAAO,CAAC6U;MACV;AACA,UAAI64B,KAAKxyB,SAASlb,GAAAA,GAAM;AACtB,eAAOsG,OAAO,IAAA,MAAUuO;MAC1B;AACA,UAAI84B,WAAWzyB,SAASlb,GAAAA,GAAM;AAC5B,eAAOsG,OAAO,KAAA,MAAWuO,IAAI,KAAKA;MACpC;AACA,aAAOA;IACT,GAdqB;AAerB,UAAMpN,YAAYkC,iBAChB;MACE5H,MAAM8F,KAAK9F;MACX/B,KAAK6H,KAAK7H;IACZ,GACA;MACEuI,OAAOilC,aAAa3lC,KAAK7H,KAAK6H,KAAKU,KAAK;IAC1C,CAAA;AAEF,QAAIV,KAAK9F,SAAS,SAAS;AACzB,YAAMkd,YAAAA;AACN,UAAI;AACF,cAAMiF,YAAAA;AACN,cAAMilB,WAAAA;MACR,SACOhnC,OAAO;MAEd;IACF;AACA,QAAI0F,KAAK9F,SAAS,SAAS;AACzB,YAAM2U,oBAAAA;IACR;AACA,QAAI7O,KAAK9F,SAAS,SAAS;AACzB,YAAMsI,eAAAA;IACR;AACA,UAAM5C,YAAYQ,eAAc;EAClC;EAEA,MACM2lC,gBAAkC5tC,MAAM,QAAQ;AACpD,UAAM6tC,eAAepmC,YAAY6B,eAAe;MAC9CvH,MAAM;MACN/B;IACF,CAAA;AACA,UAAM8tC,aACFD,aAAa,CAAA,GAAItlC,UACfvI,QAAQ,SAASyH,YAAYuC,cAAa,IAAK,CAAC,MACjD,CAAC;AACN,UAAM+jC,YAAwC;MAAC;MAAkB;MAAc;MAAc;MAAqB;MAAiB;MAAc;MAAe;MAAiB;;AACjL,WAAOA,UAAUlkC,OAAO,CAACsD,KAAK8B,QAAAA;AAC5B9B,UAAI8B,GAAAA,IAAO6+B,WAAW7+B,GAAAA;AACtB,aAAO9B;IACT,GAAG,CAAC,CAAA;EACN;EAEA,MACM6gC,mBAAqChuC,MAAM,QAAQ;AACvD,UAAM6tC,eAAepmC,YAAY6B,eAAe;MAC9CvH,MAAM;MACN/B;IACF,CAAA;AACA,WAAO6tC,aAAa,CAAA,GAAItlC,UAAUvI,QAAQ,SAASyH,YAAYuC,cAAa,IAAK,CAAC;EACpF;EAEA,MACMikC,mBAA8BpmC,MAAM;AACxC,UAAM,EAAE7H,KAAKuI,MAAK,IAAKV;AACvB,UAAMJ,YAAYkC,iBAChB;MACE5H,MAAM;MACN/B;IACF,GACA;MACEuI;IACF,CAAA;EAEJ;AACF,GAtVe,OAAAsL,MAAA,mBAAAA;;MACZyH,8BAAO8N,YAAAA;uCACc,iBAAA,cAAA,SAAA,YAAA;GAFHge,gBAAAA,WAAAA,gBAAAA,MAAAA;;MAIlBrJ,2BAAI,kBAAA;;;GAJcqJ,gBAAAA,WAAAA,oBAAAA,IAAAA;;MAqBlBxJ,4BAAK,iBAAA;EACWE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAmB,qBAAA,cAAA,SAAA;;GAtBjBsJ,gBAAAA,WAAAA,aAAAA,IAAAA;;MA0BlBxJ,4BAAK,YAAA;EACiBE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAmB,qBAAA,cAAA,SAAA;;GA3BvBsJ,gBAAAA,WAAAA,mBAAAA,IAAAA;;MAiClBxJ,4BAAK,iBAAA;EACWE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAmB,uBAAA,cAAA,SAAA;;GAlCjBsJ,gBAAAA,WAAAA,aAAAA,IAAAA;;MAsClBxJ,4BAAK,YAAA;EACiBE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAmB,uBAAA,cAAA,SAAA;;GAvCvBsJ,gBAAAA,WAAAA,mBAAAA,IAAAA;;MA4ClBxJ,4BAAK,iBAAA;EACWE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAmB,uBAAA,cAAA,SAAA;;GA7CjBsJ,gBAAAA,WAAAA,aAAAA,IAAAA;;MAiDlBxJ,4BAAK,YAAA;EACiBE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAmB,uBAAA,cAAA,SAAA;;GAlDvBsJ,gBAAAA,WAAAA,mBAAAA,IAAAA;;MAmElBrJ,2BAAI,gBAAA;;;GAnEcqJ,gBAAAA,WAAAA,iBAAAA,IAAAA;;MA8FlBxJ,4BAAK,YAAA;EACgBE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,iBAAA,cAAA,SAAA;;GA/FnBsJ,gBAAAA,WAAAA,kBAAAA,IAAAA;;MAwIlBxJ,4BAAK,yBAAA;EACuBE,WAAAA,OAAAA,+BAAQ,OAAA,CAAA;;;;;GAzIlBsJ,gBAAAA,WAAAA,yBAAAA,IAAAA;;MAyJlBxJ,4BAAK,aAAA;EACsBE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,sBAAA,cAAA,SAAA;;GA1JzBsJ,gBAAAA,WAAAA,wBAAAA,IAAAA;;MA0LlBxJ,4BAAK,WAAA;EACeE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,sBAAA,cAAA,SAAA;;GA3LlBsJ,gBAAAA,WAAAA,iBAAAA,IAAAA;;MA6MlBxJ,4BAAK,gBAAA;EACcE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,oBAAA,cAAA,SAAA;;GA9MjBsJ,gBAAAA,WAAAA,gBAAAA,IAAAA;;MA2NlBxJ,4BAAK,qBAAA;EACkBE,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,wBAAA,cAAA,SAAA;;GA5NrBsJ,gBAAAA,WAAAA,oBAAAA,IAAAA;;MAkQlBpJ,2BAAI,gBAAA;EACmBF,WAAAA,OAAAA,+BAAAA,CAAAA;;;WAAgB,YAAA,cAAA,SAAA;;GAnQrBsJ,gBAAAA,WAAAA,oBAAAA,IAAAA;;MA+SlBrJ,2BAAI,UAAU;IAAElD,WAAW;IAAOyB,WAAW;EAAK,CAAA;EAC5BkE,WAAAA,OAAAA,gCAAS,MAAA,CAAA;;;;;GAhTb4G,gBAAAA,WAAAA,mBAAAA,IAAAA;;MAgUlBrJ,2BAAI,cAAc;IAAEzB,WAAW9T,WAAWE;EAAM,CAAA;EACvB8X,WAAAA,OAAAA,gCAAS,MAAA,CAAA;;;;;GAjUhB4G,gBAAAA,WAAAA,sBAAAA,IAAAA;;MAyUlBpJ,2BAAI,UAAU;IAAE1B,WAAW9T,WAAWE;EAAM,CAAA;EACnBoV,WAAAA,OAAAA,+BAAAA,CAAAA;;;;;GA1UPsJ,gBAAAA,WAAAA,sBAAAA,IAAAA;AAAAA,kBAAAA,eAAAA;MADpBlJ,wCAAiB,UAAU;IAAE5B,WAAW9T,WAAWG;IAAQkS,WAAW;EAAK,CAAA;GACvDuM,eAAAA;;;AEvUrB,IAAAriC,oBAAiB;AAEjB,IAAAK,wBAA2D;AAgB3D;AAMA,IAAAA,wBAAuB;;;;;;;;;;;;;;;;;;;;;;;;IAKF8oC,oBAANr6B,OAAA,MAAA;EAAA;AAEb2G;AAGQ+M;;EAER,MACM4mB,sBACiBzsC,MACCwH,OACDsmB,KACrB;AACA,UAAM4e,YAAY,EAAEllC,SAAS;AAC7B,UAAMmlC,WAAW7e,OAAO,CAAA;AACxB,UAAMhd,WAAW5Q,KAAKsvB,IAAI,EAAExvB,QAAQ,IAAI2sC,SAAS//B,MAAM;AACvD,UAAM9P,QAAO,KAAKgc,IAAIhX,IAAI2L;AAC1B,UAAM5F,SAA6B;MACjCi0B,KAAK;WACA6Q,SAASr6B,IAAIpI,CAAAA,OAAM;UAAEgE,IAAIhE;QAAE,EAAA;QAC9B;UAAE7J,MAAMorB,WAAWE;QAAS;QAC5B;UAAEtrB,MAAMorB,WAAWG;QAAS;;MAE9Bvc,QAAQvS,MAAKoR;IACf;AACA,UAAMsM,QAAQ,MAAM6Q,gBAAgBxjB,MAAAA;AACpC,UAAM2mB,UAA4B,MAAMlD,0BACrCohB,YAAY,KAAK57B,UAClBA,UACAjJ,MAAAA;AAGF,UAAMtG,MAAMC,KAAKD,IAAG;AACpB,UAAMqrC,eAAe;AACrB,UAAMC,UAAU,MAAO,KAAK;AAC5B,eAAW1hB,UAAUqD,SAAS;AAC5B,UAAIse,aAAa;AAEjB,UAAI3hB,OAAOhlB,KAAK5F,WAAWwrB,eAAeG,SAAS;AACjD,cAAMsJ,OAAOt1B,KAAKC,OAAOoB,MAAM,CAAC4pB,OAAOjK,QAAQ2rB,OAAAA;AAC/C,YAAI1hB,OAAOhlB,KAAKtF,eAAeU,MAAM4pB,OAAOhlB,KAAKtF,aAAa;AAC5DsqB,iBAAOhlB,KAAK5F,SAASwrB,eAAeE;AACpC6gB,uBAAa;QACf,WACStX,QAAQoX,cAAc;AAC7BzhB,iBAAOhlB,KAAK5F,SAASwrB,eAAeE;AACpC6gB,uBAAa;QACf;MACF;AAGA,UAAI3hB,OAAOhlB,KAAK5F,WAAWwrB,eAAeC,SAAS;AACjDtrB,gBAAQqB,IAAI,qDAAuBopB,OAAOhlB,KAAKnD,UAAU;AACzD,cAAMmD,OAAOpD,yBAAyBooB,OAAOhlB,KAAKnD,cAAc,EAAA;AAChEtC,gBAAQqB,IAAI,qDAAaoE,IAAAA;AACzB,YAAIA,KAAK1F,OAAO;AACdC,kBAAQD,MAAM,qDAAa0F,KAAK1F,KAAK;AACrC0qB,iBAAOhlB,KAAK5F,SAASwrB,eAAeI;AACpChB,iBAAOhlB,KAAK1F,QAAQ0F,KAAK1F;AACzBqsC,uBAAa;QACf;AACA,YAAI3mC,KAAKrK,SAAS,KAAKqK,KAAK7H,KAAK;AAC/BoC,kBAAQqB,IAAI,8FAAA;AAEZ,gBAAMssB,WAAWnrB,sBAAsBiD,KAAK7H,GAAG;AAC/CoC,kBAAQqB,IAAI,yCAAWssB,QAAAA;AACvB,cAAIA,UAAU;AACZlD,mBAAOhlB,KAAK5F,SAASwrB,eAAeG;AAEpC,kBAAMrrB,cAAcX,KAAKC,MAAMqB,KAAKD,IAAG,IAAK,GAAA,IAAQ,OAAO;AAI3D,kBAAMS,SAAS,KAAK8W,IAAIhX,IAAIG,QAAQD,UAAU,KAAK8W,IAAIhX,IAAIG,QAAQC,WAAW;AAC9E,kBAAMC,UAAU,IAAIC,IAAIJ,MAAAA,EAAQA;AAChC,kBAAM+qC,aAAa1M,mBAAmBl6B,KAAK7H,GAAG;AAE9C6sB,mBAAOhlB,KAAKunB,YAAY,GAAGvrB,OAAAA,sBAA6B4qC,UAAAA;AACxDrsC,oBAAQqB,IAAI,+CAAYopB,OAAOhlB,KAAKunB,SAAS;AAE7CvC,mBAAOhlB,KAAK9D,MAAMiM,UAAU6c,OAAO1a,KAAK,KAAKqI,IAAIhX,GAAG;AACpDqpB,mBAAOhlB,KAAKnG,OAAOquB,SAAStuB;AAC5BorB,mBAAOhlB,KAAKtF,cAAcA,cAAc;AACxC,kBAAMuC,WAAW7E,kBAAAA,QAAK8H,MAAMgoB,SAAS/vB,GAAG,EAAE0P;AAC1Cmd,mBAAOhlB,KAAK6H,OAAO5K;AACnB+nB,mBAAOhlB,KAAKnI,UAAUlB,MAAKkB;AAC3BmtB,mBAAOhlB,KAAKvG,WAAWyuB,SAASzuB;AAGhCktC,yBAAa;AACbpsC,oBAAQqB,IAAI,sEAAA;UACd,OACK;AACHrB,oBAAQD,MAAM,sEAAoB0F,KAAK7H,GAAG;AAC1C6sB,mBAAOhlB,KAAK5F,SAASwrB,eAAeI;AACpChB,mBAAOhlB,KAAK1F,QAAQ;AACpBqsC,yBAAa;UACf;QACF;MACF;AAEA,UAAIA,YAAY;AACdthB,qBACE;UAAEtd,IAAIid,OAAOjd;QAAG,GAChB;UACE8f,MAAM;YACJ7nB,MAAM;cACJ,GAAGglB,OAAOhlB;YACZ;UACF;QACF,CAAA;MAEJ;IACF;AAGA,WAAO;MACLkpB,KAAK7U;MACLkyB,WAAWllC;MACXsJ,UAAU9Q;MACVwuB,SAASA,QAAQlc,IAAIa,CAAAA,OAAM;QACzBjF,IAAIiF,EAAEjF;QACN7N,MAAM8S,EAAE9S;QACRE,QAAQ4S,EAAEhN,KAAK5F;QACf8B,KAAK8Q,EAAEhN,KAAK9D;QACZggB,KAAKlP,EAAEhN,KAAKkc;QACZnB,MAAM,CAAC/N,EAAE+N;QACTlhB,MAAMmT,EAAEhN,KAAKnG;QACbS,OAAO0S,EAAEhN,KAAK1F;MAChB,EAAA;IACF;EACF;AACF,GApIe,OAAA0R,MAAA,qBAAAA;;MACZR,iCAAAA;uCACK,YAAA,cAAA,SAAA,OAAA;GAFa66B,iBAAAA,WAAAA,OAAAA,MAAAA;;MAIlB5yB,8BAAOC,gBAAAA;uCACkB,qBAAA,cAAA,SAAA,gBAAA;GALP2yB,iBAAAA,WAAAA,oBAAAA,MAAAA;;MAOlBtQ,4BAAK,eAAA;EAEHE,YAAAA,OAAAA,+BAAQ,UAAA,CAAA;EACRA,YAAAA,OAAAA,+BAAQ,WAAA,CAAA;EACRA,YAAAA,OAAAA,+BAAQ,UAAA,CAAA;;;;;;;GAXQoQ,iBAAAA,WAAAA,yBAAAA,IAAAA;AAAAA,mBAAAA,eAAAA;MAHpBhQ,wCAAiB,UAAU;IAC1BrD,WAAW;EACb,CAAA;GACqBqT,gBAAAA;;;AC1BrB,IAAA9oC,wBAUO;;;;;;;;;;;;;;;;;;;;;;;AAUP,IAAMy1B,YAAY;EAChBA,WAAW;AACb;;IAEqB6T,kBAAN76B,OAAA,MAAA;EAAA;AAELZ;AAGA6tB;AAGArmB;AAGAgR;AAGAiK;;;;;EAKR,MACMC,WAAsB7N,SAAS;AACnC,UAAM,EAAEpY,MAAMqmB,SAAQ,IAAKjO;AAC3B,UAAM,EAAElY,IAAIlQ,SAAS0oB,WAAU,IAAK,KAAKnV,IAAIzP,IAAI2L;AACjD,UAAM4Y,OAAO,IAAIxE,KAAAA;AACjBwE,SAAKrY,OAAOA;AACZqY,SAAKpF,cAAcoT,YAAY;AAC/BhO,SAAKhX,SAASnB;AAEd,UAAM,KAAKkxB,YAAYnL,WAAW5N,IAAAA;AAClC,SAAKtN,gBAAgBvH,IACnB,QACA,yCAAWkV,UAAAA,iBAAiB1Y,IAAAA,iBAC5B;MACEhQ,SAAS0oB;MACT1Y;IACF,CAAA;EAEJ;EAEA,MACMkmB,WAAW;AACf,UAAM,EAAEhmB,IAAIlQ,QAAO,IAAK,KAAKuT,IAAIzP,IAAI2L;AACrC,WAAO,KAAK2xB,YAAYlL,SAAShmB,IAAIlQ,OAAAA;EACvC;EAEA,MACMw2B,aAA+Bl2B,KAAa;AAChD,QAAI;AACF,YAAM6H,OAAO,MAAM,KAAKi5B,YAAY5K,aAAal2B,GAAAA;AACjD,YAAMxB,QAAO,MAAM,KAAKitB,eAAe7G,QAAQ;QAC7ChV,IAAI/H,KAAKkJ;MACX,CAAA;AAIA,YAAMo3B,eAAe,MAAM,KAAKzS,YAAYtC,gBAAgB50B,KAAAA;AAC5D,YAAM,EAAE41B,SAASM,OAAOX,aAAajS,QAAQ8S,MAAMlD,YAAYG,YAAW,IAAKsW;AAC/E,UAAIzW,YAAY;AACd,aAAKjX,gBAAgBvH,IAAI,QAAQ,gBAAM1U,MAAKkB,OAAO,yCAAW;UAC5D0oC,OAAO55B,WAAW4lB,OAAAA;UAClBM,OAAOlmB,WAAWkmB,KAAAA;QACpB,CAAA;MACF;AACA,UAAI7C,aAAa;AACf,aAAKpX,gBAAgBvH,IAAI,QAAQ,gBAAM1U,MAAKkB,OAAO,6BAAS;UAC1DoiB;UACA8S;QACF,CAAA;MACF;AACA,aAAO;QACL,GAAG/sB;QACHksB;MACF;IACF,SACO5xB,OAAO;AACZ,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAGAg0B,QAA0Bn2B,KAAa;AACrC,WAAO,KAAK8gC,YAAY3K,QAAQn2B,GAAAA;EAClC;EAGAq2B,WAA6Br2B,KAAwB8nB,SAAS;AAC5D,WAAO,KAAKgZ,YAAYzK,WAAWr2B,KAAK8nB,OAAAA;EAC1C;AACF,GAxFe,OAAAjU,MAAA,mBAAAA;;MACZR,iCAAAA;uCACY,YAAA,cAAA,SAAA,OAAA;GAFMq7B,eAAAA,WAAAA,OAAAA,MAAAA;;MAIlBpzB,8BAAOma,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GALFiZ,eAAAA,WAAAA,eAAAA,MAAAA;;MAOlBpzB,8BAAOtI,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GARN07B,eAAAA,WAAAA,mBAAAA,MAAAA;;MAUlBpzB,8BAAO4P,cAAAA;uCACgB,mBAAA,cAAA,SAAA,cAAA;GAXLwjB,eAAAA,WAAAA,kBAAAA,MAAAA;;MAalBpzB,8BAAOkT,WAAAA;uCACa,gBAAA,cAAA,SAAA,WAAA;GAdFkgB,eAAAA,WAAAA,eAAAA,MAAAA;;MAmBlB9Q,4BAAK,QAAA;EACYE,YAAAA,OAAAA,+BAAAA,CAAAA;;;;;GApBC4Q,eAAAA,WAAAA,cAAAA,IAAAA;;MAuClB3Q,2BAAI,EAAA;;;GAvCc2Q,eAAAA,WAAAA,YAAAA,IAAAA;;MA6ClB3Q,2BAAI,SAAS;IAAElD,WAAW;EAAM,CAAA;EACboD,YAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;GA9CXyQ,eAAAA,WAAAA,gBAAAA,IAAAA;;MA+ElBnO,8BAAO,OAAA;EACCtC,YAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;GAhFAyQ,eAAAA,WAAAA,WAAAA,IAAAA;;MAoFlB1Q,2BAAI,OAAA;EACOC,YAAAA,OAAAA,iCAAU,KAAA,CAAA;EAAqBH,YAAAA,OAAAA,+BAAAA,CAAAA;;;;;;GArFxB4Q,eAAAA,WAAAA,cAAAA,IAAAA;AAAAA,iBAAAA,eAAAA;MADpBxQ,wCAAiB,QAAQrD,SAAAA;GACL6T,cAAAA;;;AC3BrB,IAAAtpC,wBAUO;;;;;;;;;;;;;;;;;;;;;;;;IAKcupC,sBAAN96B,OAAA,MAAA;EAAA;AAEL2G;AAGAo0B;;EAER,MACM9V,eAAgCppB,MAAc;AAClD,QAAI;AACF,YAAM,KAAKk/B,gBAAgB9V,eAAeppB,IAAAA;IAC5C,SAASvN,OAAO;AACd,aAAOs+B,kBAAkBt+B,KAAAA;IAC3B;EACF;EAGA62B,UAAU;AACR,WAAO,KAAK4V,gBAAgB5V,QAAO;EACrC;EAGAC,eAAiCj5B,KAAa;AAC5C,WAAO,KAAK4uC,gBAAgB3V,eAAej5B,GAAAA;EAC7C;AACF,GAzBe,OAAA6T,MAAA,uBAAAA;;MACZR,iCAAAA;uCACY,kCAAA,cAAA,SAAA,6BAAA;GAFMs7B,mBAAAA,WAAAA,OAAAA,MAAAA;;MAIlBrzB,8BAAOsd,eAAAA;uCACiB,oBAAA,cAAA,SAAA,eAAA;GALN+V,mBAAAA,WAAAA,mBAAAA,MAAAA;;MAOlB/Q,4BAAK,SAAA;EACgBE,YAAAA,OAAAA,+BAAQ,MAAA,CAAA;;;;;GARX6Q,mBAAAA,WAAAA,kBAAAA,IAAAA;;MAgBlB5Q,2BAAI,EAAA;;;GAhBc4Q,mBAAAA,WAAAA,WAAAA,IAAAA;;MAqBlBpO,8BAAO,OAAA;EACQtC,YAAAA,OAAAA,iCAAU,KAAA,CAAA;;;;;GAtBP0Q,mBAAAA,WAAAA,kBAAAA,IAAAA;AAAAA,qBAAAA,eAAAA;MADpBzQ,wCAAiB,YAAY;IAAErD,WAAW;EAAK,CAAA;GAC3B8T,kBAAAA;;;ACFrB,IAAA,sBAAe;EACbE;EACAC;EACA1rB;EACA3H;EACA+H;EACAurB;EACAC;EACAztB;EACA0tB;EACAC;EACA3rB;EACAhB;;;;AClBF,IAAM4sB,kBAAkB;EAAC;EAAgB;;AAEzC,IAAMC,cAA0B,8BAAO5rC,KAAKiH,QAAAA;AAE1C,MAAKjH,IAAY6rC,UAAU;AACzB;EACF;AAGA,MAAI,CAAC7rC,IAAI48B,OAAO;AACd;EACF;AAEA,QAAM,EAAEkP,KAAI,IAAK9rC,IAAI48B;AACrB,MAAI,CAACkP,QAAQ9lC,OAAOC,KAAK6lC,IAAAA,EAAMhhC,WAAW;AAAG;AAC7C,QAAM,EAAEusB,WAAAA,YAAWyB,WAAWuB,KAAI,IAAKyR;AACvC,MAAIzR,MAAM;AACRpzB,QAAI8kC,UAAU,+BAA+B,GAAA;AAC7C9kC,QAAI8kC,UAAU,gCAAgC,6BAAA;AAC9C9kC,QAAI8kC,UAAU,gCAAgC,GAAA;AAC9C9kC,QAAI8kC,UAAU,oCAAoC,MAAA;EACpD;AAEA,QAAMC,gBAAgB,MAAM1+B,YAAYtN,GAAAA;AACxC,MACEq3B,eACC,CAACr3B,IAAIG,QAAQnB,SACZ,CAAC;IAACgmB,WAAWE;IAAOF,WAAWG;IAAQH,WAAWC;IAAQvN,SACxDs0B,eAAe/tB,KAAAA,IAEnB;AACArQ,gBAAY5N,KAAK;MACf2P,QAAQ;MACR1V,KAAK,oDAAiB+F,IAAIO,GAAG;MAC7B8D,MAAM;QACJ9D,KAAKP,IAAIO;MACX;IACF,CAAA;AACA0G,QAAI4tB,cAAc5R,YAAYE,QAAQE,QAAQ;AAC9C;EACF;AAGA,MAAI;IAAC2B,WAAWE;IAAOF,WAAWG;IAAQzN,SAASohB,SAAAA,GAAY;AAC7D,QAAIkT,eAAe/tB,UAAU6a,WAAW;AACtClrB,kBAAY5N,KAAK;QACf2P,QAAQ;QACR1V,KAAK,0DAAkB+F,IAAIO,GAAG;QAC9B8D,MAAM;UACJ9D,KAAKP,IAAIO;QACX;MACF,CAAA;AACA0G,UAAI4tB,cAAc5R,YAAYE,QAAQE,QAAQ;AAC9C;IACF;EACF;AAEA,MAAIgU,YAAW;AAEb,QACE2U,eAAe/tB,UAAU+G,WAAWG,UACpC2T,cAAc9T,WAAWG;IAEzB,CAACwmB,gBAAgBj0B,SAAS1X,IAAIO,GAAG,GACjC;AACAqN,kBAAY5N,KAAK;QACf2P,QAAQ;QACR1V,KAAK,0DAAkB+F,IAAIO,GAAG;QAC9B8D,MAAM;UACJ9D,KAAKP,IAAIO;QACX;MACF,CAAA;AACA0G,UAAI4tB,cAAc5R,YAAYE,QAAQE,QAAQ;AAC9C;IACF;AAGA,QAAI,CAAC2oB,eAAe;AAClB/kC,UAAI4tB,cAAc5R,YAAYE,QAAQE,QAAQ;AAC9C;IACF;AAEArjB,QAAI2L,WAAWqgC;AAEf,QAAIA,eAAe/tB,UAAU+G,WAAWG,QAAQ;AAE9CqR,wBAAU3Q,gBACRmmB,cAAc9vC,SACd8vC,eACAhsC,IAAIG,QAAQnB,KAAK;IAErB;EACF;AACF,GA3FgC;AA4FhC,IAAA,2BAAe4sC;;;ACpGf,IAAAK,qBAAuB;AACvB,gBAAsC;AACtC;AAWA,IAAMC,eAAe;EACnB;EACA;EACA;;AAGF,IAAI,KAAC/uC,sBAAWjD,aAAAA,GAAgB;AAC9BkD,2BAAUlD,aAAAA;AACZ;AAEA,IAAM0xC,eAA0B,8BAAO5rC,KAAKiH,QAAAA;AAE1C,QAAM,EAAE8F,OAAM,IAAK/M;AACnBA,MAAIwN,YAAY9N,KAAKD,IAAG;AAGxB,MAAIO,IAAIO,KAAKmX,SAAS,iBAAA,GAAoB;AACxC9Y,YAAQqB,IAAI,gEAAA;AACZrB,YAAQqB,IAAI,QAAQD,IAAIO,GAAG;AAC3B3B,YAAQqB,IAAI,WAAW8M,MAAAA;EACzB;AAEA,MAAIm/B,aAAax0B,SAAS1X,IAAIG,QAAQD,MAAM,GAAG;EAE/C;AAGA,MAAIF,IAAIO,KAAKmX,SAAS,cAAA,KAAmB1X,IAAIO,KAAKmX,SAAS,iBAAA,GAAoB;EAE/E,OAAO;AAELzQ,QAAI8kC,UAAU,gBAAgB,gCAAA;EAChC;AAEA,MAAIh/B,WAAW,WAAW;AACxB9F,QAAIsN,aAAa;AACjBtN,QAAI8kC,UAAU,+BAA+B,GAAA;AAC7C9kC,QAAI8kC,UAAU,gCAAgC,6BAAA;AAC9C9kC,QAAI8kC,UAAU,gCAAgC,GAAA;AAC9C9kC,QAAI8kC,UAAU,oCAAoC,MAAA;AAClD9kC,QAAIyH,IAAG;AACP;EACF;AAKA,MAAI1O,IAAIO,QAAQ,kBAAkBwM,WAAW,QAAQ;AACnDnO,YAAQqB,IAAI,4EAAA;AACZ,UAAM,EAAE1F,cAAAA,cAAY,IAAK,MAAM;AAC/B,UAAM4kC,WAAOC,mBAAAA,SAAW;MACtBC,WAAW;MACXC,gBAAgB;MAChBC,aAAa,OAAO,OAAO,OAAO;MAClCC,WAAWjlC;IACb,CAAA;AAEA,UAAM2N,IAAI,IAAIlB,QAAQ,CAACmB,SAASsN,WAAAA;AAC9B0pB,WAAK56B,MAAMvE,KAAK,OAAO2H,KAAK83B,QAAQtoB,UAAAA;AAClC,YAAIxP,KAAK;AACP/I,kBAAQD,MAAM,qDAAagJ,GAAAA;AAC3BV,cAAIi3B,UAAU,KAAK;YAAE,gBAAgB;UAAmB,CAAA;AACxDj3B,cAAIyH,IAAIpK,KAAKgB,UAAU;YAAEtL,MAAM;YAAKC,KAAK,yCAAW0N,IAAIK,OAAO;UAAG,CAAA,CAAA;AAClEyN,iBAAO9N,GAAAA;AACP;QACF;AAEA,cAAMsQ,OAAOpP,MAAMC,QAAQqO,MAAMc,IAAI,IAAId,MAAMc,KAAK,CAAA,IAAKd,MAAMc;AAC/D,YAAI,CAACA,MAAM;AACTrZ,kBAAQD,MAAM,sDAAmBwY,KAAAA;AACjClQ,cAAIi3B,UAAU,KAAK;YAAE,gBAAgB;UAAmB,CAAA;AACxDj3B,cAAIyH,IAAIpK,KAAKgB,UAAU;YAAEtL,MAAM;YAAKC,KAAK;UAAU,CAAA,CAAA;AACnDwb,iBAAO,IAAIkI,MAAM,4CAAA,CAAA;AACjB;QACF;AAEA,YAAI;AACF,gBAAMnhB,MAAMqM,MAAMC,QAAQ22B,OAAOjjC,GAAG,IAAIijC,OAAOjjC,IAAI,CAAA,IAAKijC,OAAOjjC;AAC/D,cAAI,CAACA,OAAO,OAAOA,QAAQ,UAAU;AACnCoC,oBAAQD,MAAM,sDAAwB8gC,MAAAA;AACtCx4B,gBAAIi3B,UAAU,KAAK;cAAE,gBAAgB;YAAmB,CAAA;AACxDj3B,gBAAIyH,IAAIpK,KAAKgB,UAAU;cAAEtL,MAAM;cAAKC,KAAK;YAAc,CAAA,CAAA;AACvDwb,mBAAO,IAAIkI,MAAM,2CAAA,CAAA;AACjB;UACF;AAEA/e,kBAAQqB,IAAI,8CAAgBzD,KAAK,aAAayb,KAAK6e,UAAU,SAAS7e,KAAK/Z,IAAI;AAG/E,gBAAM,EAAE3B,gBAAAA,iBAAgBS,WAAAA,YAAWO,aAAAA,cAAaiD,kBAAAA,mBAAkBI,gBAAAA,gBAAc,IAAK,MAAM;AAC3F,gBAAM1D,MAAK,MAAM,OAAO,IAAA;AACxB,gBAAMT,QAAO,MAAM,OAAO,MAAA;AAC1B,gBAAMid,SAAQ,MAAM,OAAO,OAAA;AAE3B,gBAAM9c,YAAYL,gBAAeC,GAAAA;AACjCQ,UAAAA,WAAUP,MAAK4b,QAAQzb,SAAAA,CAAAA;AAGvB,cAAI,CAACM,IAAGC,WAAW8a,KAAK6e,QAAQ,GAAG;AACjCl4B,oBAAQD,MAAM,yCAAWsZ,KAAK6e,QAAQ;AACtC7vB,gBAAIi3B,UAAU,KAAK;cAAE,gBAAgB;YAAmB,CAAA;AACxDj3B,gBAAIyH,IAAIpK,KAAKgB,UAAU;cAAEtL,MAAM;cAAKC,KAAK;YAAS,CAAA,CAAA;AAClDwb,mBAAO,IAAIkI,MAAM,sCAAA,CAAA;AACjB;UACF;AAGAzgB,UAAAA,IAAGob,aAAaL,KAAK6e,UAAUl6B,SAAAA;AAG/B,cAAI,CAACM,IAAGC,WAAWP,SAAAA,GAAY;AAC7BgC,oBAAQD,MAAM,2DAAc/B,SAAAA;AAC5BqK,gBAAIi3B,UAAU,KAAK;cAAE,gBAAgB;YAAmB,CAAA;AACxDj3B,gBAAIyH,IAAIpK,KAAKgB,UAAU;cAAEtL,MAAM;cAAKC,KAAK;YAAS,CAAA,CAAA;AAClDwb,mBAAO,IAAIkI,MAAM,sCAAA,CAAA;AACjB;UACF;AAEA/e,kBAAQqB,IAAI,8CAAgBzD,KAAK,SAASU,IAAGQ,SAASd,SAAAA,EAAWsB,IAAI;AAGrE,gBAAM2B,OAAOtC,aAAYX,SAAAA;AACzB,cAAIiD,QAAQA,KAAK/B,SAAS4Z,SAAS,OAAA,GAAU;AAC3C,gBAAI;AACF,oBAAMc,gBAAgBhY,kBAAiBhE,GAAAA;AACvCQ,cAAAA,WAAUP,MAAK4b,QAAQG,aAAAA,CAAAA;AACvB,oBAAMkB,OAAMiF,QAAQ/hB,SAAAA,EACjB+c,OAAO,KAAK,KAAK;gBAChBC,KAAK;gBACLC,UAAU;cACZ,CAAA,EACCC,KAAK;gBAAEC,SAAS;cAAG,CAAA,EACnBC,OAAOxB,aAAAA;AAEV,oBAAMC,cAAc7X,gBAAepE,GAAAA;AACnCQ,cAAAA,WAAUP,MAAK4b,QAAQI,WAAAA,CAAAA;AACvB,oBAAMiB,OAAMiF,QAAQ/hB,SAAAA,EACjB+c,OAAO,MAAM,MAAM;gBAClBC,KAAK;gBACLQ,oBAAoB;cACtB,CAAA,EACCN,KAAK;gBAAEC,SAAS;cAAG,CAAA,EACnBC,OAAOvB,WAAAA;YACZ,SACO9Z,OAAO;AACZC,sBAAQD,MAAM,2DAAcA,KAAAA;YAC9B;UACF;AAGA,cAAI;AACF,kBAAMzB,MAAK,MAAM,OAAO,IAAA;AACxBA,YAAAA,IAAGqb,WAAWN,KAAK6e,QAAQ;UAC7B,QACM;UAEN;AAEA,gBAAMhb,SAAS;YACb9hB,MAAM;YACNqK,MAAM;cACJ7H;cACAwB,MAAM;cACNC,OAAOga,KAAK/Z;YACd;YACAjE,KAAK;UACP;AACA2E,kBAAQqB,IAAI,6BAASqE,KAAKgB,UAAUwW,MAAAA,CAAAA;AACpC7U,cAAIi3B,UAAU,KAAK;YAAE,gBAAgB;UAAmB,CAAA;AACxDj3B,cAAIyH,IAAIpK,KAAKgB,UAAUwW,MAAAA,CAAAA;AACvB3T,kBAAQ2T,MAAAA;QACV,SACOnd,OAAO;AACZC,kBAAQD,MAAM,yCAAWA,KAAAA;AACzBsI,cAAIi3B,UAAU,KAAK;YAAE,gBAAgB;UAAmB,CAAA;AACxDj3B,cAAIyH,IAAIpK,KAAKgB,UAAU;YAAEtL,MAAM;YAAKC,KAAK,yCAAW0E,KAAAA;UAAQ,CAAA,CAAA;AAC5D8W,iBAAO9W,KAAAA;QACT;MACF,CAAA;AAEAwgC,WAAKxxB,GAAG,SAAS,CAAChG,QAAAA;AAChB/I,gBAAQD,MAAM,4BAAkBgJ,GAAAA;AAChCV,YAAIi3B,UAAU,KAAK;UAAE,gBAAgB;QAAmB,CAAA;AACxDj3B,YAAIyH,IAAIpK,KAAKgB,UAAU;UAAEtL,MAAM;UAAKC,KAAK,yCAAW0N,IAAIK,OAAO;QAAG,CAAA,CAAA;AAClEyN,eAAO9N,GAAAA;MACT,CAAA;IACF,CAAA;AAEA,QAAI;AACF,YAAMO;IACR,SACOvJ,OAAO;IAEd;AACA;EACF;AAIA,MAAIqB,IAAIO,QAAQ,kBAAkB;AAChC,UAAM4+B,WAAOC,mBAAAA,SAAW;MACtBC,WAAW;MACXG,WAAWtlC;MACXolC,gBAAgB;IAClB,CAAA;AACA,UAAMp3B,IAAI,IAAIlB,QAAQ,CAACmB,SAASsN,WAAAA;AAC9B0pB,WAAK56B,MAAMvE,KAAK,CAAC2H,KAAK83B,QAAQtoB,UAAAA;AAC5B,YAAIxP,KAAK;AACP8N,iBAAO9N,GAAAA;QACT;AACAV,YAAIi3B,UAAU,KAAK;UAAE,gBAAgB;QAAmB,CAAA;AACxD,cAAM75B,OAAO;UACX6H,MAAMiL,MAAMc,KAAKk0B;UACjBjuC,MAAMiZ,MAAMc,KAAK/Z;UACjBK,MAAM4Y,MAAMc,KAAK0nB;QACnB;AACA14B,YAAIyH,IAAIpK,KAAKgB,UAAU;UAAEtL,MAAM;UAAGqK;UAAMpK,KAAK;QAAK,GAAG,MAAM,CAAA,CAAA;AAC3DkO,gBAAQ,IAAA;MACV,CAAA;IACF,CAAA;AACA,QAAI;AACF,YAAMD;IACR,SAASvJ,OAAO;AACdsI,UAAIyH,IAAIpK,KAAKgB,UAAU;QAAEtL,MAAM;QAAKC,KAAK0E;MAAM,CAAA,CAAA;IACjD;EACF;AAGAqH,SAAOomC,eAAepsC,KAAK,OAAO;IAChC+E,OAAOsI,YAAYrN,GAAAA;EACrB,CAAA;AAGAgG,SAAOomC,eAAepsC,KAAK,aAAa;IACtC+E,OAAO,MAAMuI,YAAYtN,GAAAA;EAC3B,CAAA;AACF,GAlOgC;AAmOhC,IAAA,4BAAe4rC;;;ACxPf,IAAMA,eAA0B,8BAAO5rC,KAAKiH,QAAAA;AAE1C,MAAKjH,IAAY6rC,UAAU;AAEvB7rC,QAAY48B,QAAQ;AACtB;EACF;AAEA/vB,gBAAc7M,KAAKiH,GAAAA;AACrB,GATgC;AAUhC,IAAA,kCAAe2kC;;;ACVf,IAAMA,eAAuC,8BAAO5rC,KAAKiH,KAAKU,QAAAA;AAE5D,MAAIV,IAAIy3B,aAAa;AACnB9/B,YAAQqB,IAAI,gFAAA;AACZ;EACF;AAGA,MAAKD,IAAY6rC,UAAU;AACzB;EACF;AAEAh+B,cAAY7N,KAAK2H,IAAIxI,SAAQ,GAAIwI,IAAImG,KAAK;AAC5C,GAb6C;AAc7C,IAAA,wCAAe89B;;;A7EOfhtC,QAAQiZ,KAAK,cAAA;AAEb,IAAMw0B,MAAM,IAAIC,0BAAIC,2BAAmB;EACrCC,iBAAiBC;EACjBC,gBAAgBC;EAChBC,0BAA0BC;AAC5B,CAAA;AAGAR,IAAIS,UAAUC,cAAAA;AACdV,IAAIW,cAAcC,mBAAAA;AAElBZ,IAAIa,OAAOrrC,aAAa/G,MAAM+G,aAAaG,UAAU,YAAA;AACnDpD,UAAQqB,IAAI,UAAS,oBAAIP,KAAAA,GAAOytC,eAAc,GAAI,OAAA;AAClDvuC,UAAQwuC,QAAQ,cAAA;AAEhB,QAAMnpC,YAAYC,eAAc;AAChC,QAAMA,eAAAA;AACN,MAAI;AACF,UAAM0iC,sBAAAA;EACR,SACOj/B,KAAK;AACV/I,YAAQqB,IAAI,gCAA2B0H,KAAKK,OAAAA;EAC9C;AACA,MAAI;AACF,UAAM29B,WAAAA;AACN/mC,YAAQqB,IAAI,wCAAA;EACd,SACO0H,KAAK;AACV/I,YAAQqB,IAAI,iLAAA;EACd;AACF,CAAA","sourcesContent":["export interface CodeMsg {\n  code: number\n  msg: string\n}\nexport function codeMsg(code: number, msg: string): CodeMsg {\n  return {\n    code,\n    msg\n  }\n}\n\nexport const uploadFileDir = `${process.cwd()}/upload`\n\n// \nexport const filesManageDir = `${process.cwd()}/files-manage`\nexport const filesUploadDir = `${filesManageDir}/uploads`\nexport const filesThumbnailsDir = `${filesManageDir}/thumbnails`\nexport const filesCompressedDir = `${filesManageDir}/compressed`\nexport const filesTempDir = `${filesManageDir}/temp`\n\nexport const UserConfigLabels = {\n  mysql: {\n    host: '',\n    port: '',\n    database: '',\n    user: '',\n    password: ''\n  },\n  qiniu: {\n    accessKey: 'AccessKey',\n    secretKey: 'SecretKey',\n    bucketName: '',\n    bucketDomain: '',\n    imageCoverStyle: '',\n    imagePreviewStyle: '',\n    bucketZone: ''\n  },\n  mongo: {\n    host: '',\n    port: '',\n    database: '',\n    user: '',\n    password: '',\n    auth: '',\n    uri: '',\n  },\n  redis: {\n    host: '',\n    port: '',\n    password: '',\n    auth: '',\n  },\n  mail: {\n    smtpHost: 'SMTP ',\n    smtpPort: '',\n    useSSL: ' SSL',\n    account: '',\n    password: '/',\n    from: '',\n     senderName: '',\n    subject: '',\n    template: ''\n  }\n}\n\nexport const LocalEnvMap = {\n  mysql: {\n    host: 'MYSQL_DB_HOST',\n    port: 'MYSQL_DB_PORT',\n    database: 'MYSQL_DB_NAME',\n    user: 'MYSQL_DB_USER',\n    password: 'MYSQL_DB_PWD'\n  },\n  mongo: {\n    host: 'MONGO_DB_HOST',\n    port: 'MONGO_DB_PORT',\n    database: 'MONGO_DB_NAME',\n    user: 'MONGO_DB_USER',\n    password: 'MONGO_DB_PWD',\n    auth: 'MONGO_DB_NEED_AUTH'\n  },\n  redis: {\n    host: 'REDIS_DB_HOST',\n    port: 'REDIS_DB_PORT',\n    password: 'REDIS_DB_PASSWORD',\n    auth: 'REDIS_DB_NEED_AUTH'\n  },\n  qiniu: {\n    accessKey: 'QINIU_ACCESS_KEY',\n    secretKey: 'QINIU_SECRET_KEY',\n    bucketName: 'QINIU_BUCKET_NAME',\n    bucketDomain: 'QINIU_BUCKET_DOMAIN',\n    imageCoverStyle: 'QINIU_BUCKET_IMAGE_COVER_STYLE',\n    imagePreviewStyle: 'QINIU_BUCKET_IMAGE_PREVIEW_STYLE',\n    bucketZone: 'QINIU_BUCKET_ZONE'\n  }\n}\n","import path from 'node:path'\nimport fs from 'node:fs'\nimport crypto from 'node:crypto'\nimport type { FWRequest } from 'flash-wolves'\nimport {\n  filesUploadDir,\n  filesThumbnailsDir,\n  filesCompressedDir,\n  filesTempDir,\n} from '@/constants'\n\n//  Qiniu.ItemInfo\nexport interface LocalFileInfo {\n  key: string\n  hash: string\n  fsize: number\n  mimeType: string\n  putTime: number\n  type: number\n  status: 0\n  md5: string\n}\n\n//  Redis\nconst downloadTokens = new Map<string, {\n  key: string\n  expiredTime: number\n}>()\n\n/**\n *  OSS key \n * @param key OSS key easypicker2/task_key/hash/filename\n * @returns \n */\nexport function keyToLocalPath(key: string): string {\n  return path.join(filesUploadDir, key)\n}\n\n/**\n *  OSS key\n * @param localPath \n * @returns OSS key\n */\nexport function localPathToKey(localPath: string): string {\n  const relativePath = path.relative(filesUploadDir, localPath)\n  return relativePath.replace(/\\\\/g, '/')\n}\n\n/**\n * \n */\nexport function ensureDir(dirPath: string): void {\n  if (!fs.existsSync(dirPath)) {\n    fs.mkdirSync(dirPath, { recursive: true })\n  }\n}\n\n/**\n * \n */\nexport function initDirectories(): void {\n  ensureDir(filesUploadDir)\n  ensureDir(filesThumbnailsDir)\n  ensureDir(filesCompressedDir)\n  ensureDir(filesTempDir)\n}\n\n/**\n * \n * @param filePath \n * @returns \n */\nexport function getFileInfo(filePath: string): LocalFileInfo | null {\n  try {\n    if (!fs.existsSync(filePath)) {\n      return null\n    }\n\n    const stats = fs.statSync(filePath)\n    const key = localPathToKey(filePath)\n    const ext = path.extname(filePath).toLowerCase()\n    const mimeType = getMimeType(ext)\n\n    return {\n      key,\n      hash: '',\n      fsize: stats.size,\n      mimeType,\n      putTime: Math.floor(stats.mtimeMs / 1000),\n      type: stats.isDirectory() ? 1 : 0,\n      status: 0,\n      md5: '',\n    }\n  }\n  catch (error) {\n    console.error(':', error)\n    return null\n  }\n}\n\n/**\n *  MIME \n */\nfunction getMimeType(ext: string): string {\n  const mimeTypes: Record<string, string> = {\n    '.jpg': 'image/jpeg',\n    '.jpeg': 'image/jpeg',\n    '.png': 'image/png',\n    '.gif': 'image/gif',\n    '.webp': 'image/webp',\n    '.pdf': 'application/pdf',\n    '.doc': 'application/msword',\n    '.docx': 'application/vnd.openxmlformats-officedocument.wordprocessingml.document',\n    '.xls': 'application/vnd.ms-excel',\n    '.xlsx': 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',\n    '.zip': 'application/zip',\n    '.txt': 'text/plain',\n    '.mp4': 'video/mp4',\n    '.mp3': 'audio/mpeg',\n  }\n  return mimeTypes[ext] || 'application/octet-stream'\n}\n\n/**\n *  token\n * @param key  key\n * @param expiredTime \n * @returns token\n */\nexport function generateDownloadToken(key: string, expiredTime: number): string {\n  const token = crypto.randomBytes(32).toString('hex')\n  downloadTokens.set(token, {\n    key,\n    expiredTime,\n  })\n  return token\n}\n\n/**\n *  token  key\n * @param token token\n * @returns  key token  null\n */\nexport function verifyDownloadToken(token: string): string | null {\n  const tokenInfo = downloadTokens.get(token)\n  if (!tokenInfo) {\n    return null\n  }\n\n  const now = Math.floor(Date.now() / 1000)\n  if (now > tokenInfo.expiredTime) {\n    downloadTokens.delete(token)\n    return null\n  }\n\n  return tokenInfo.key\n}\n\n/**\n *  token\n */\nexport function cleanExpiredTokens(): void {\n  const now = Math.floor(Date.now() / 1000)\n  for (const [token, info] of downloadTokens.entries()) {\n    if (now > info.expiredTime) {\n      downloadTokens.delete(token)\n    }\n  }\n}\n\n/**\n *  URL\n * @param key  key\n * @param expiredTime \n * @param req \n * @returns  URL\n */\nexport function createDownloadUrl(key: string, expiredTime: number, req?: FWRequest): string {\n  const token = generateDownloadToken(key, expiredTime)\n  console.log(' token, key:', key, 'token:', token, 'expiredTime:', expiredTime)\n  if (req) {\n    const origin = req.headers.origin || req.headers.referer || 'http://localhost'\n    const baseUrl = new URL(origin).origin\n    const url = `${baseUrl}/api/file/download/${token}`\n    console.log(' URL:', url)\n    return url\n  }\n  const url = `/api/file/download/${token}`\n  console.log(' URL ( req):', url)\n  return url\n}\n\n/**\n * \n * @param key  key\n * @returns \n */\nexport function getThumbnailPath(key: string): string {\n  const hash = crypto.createHash('md5').update(key).digest('hex')\n  return path.join(filesThumbnailsDir, `${hash}.jpg`)\n}\n\n/**\n * \n * @param key  key\n * @returns \n */\nexport function getPreviewPath(key: string): string {\n  const hash = crypto.createHash('md5').update(key).digest('hex')\n  return path.join(filesThumbnailsDir, `${hash}_preview.jpg`)\n}\n\n/**\n *  key\n * @param key  key\n * @returns  key\n */\nexport function getThumbnailKey(key: string): string {\n  const hash = crypto.createHash('md5').update(key).digest('hex')\n  return `thumbnails/${hash}.jpg`\n}\n\n/**\n *  key\n * @param key  key\n * @returns  key\n */\nexport function getPreviewKey(key: string): string {\n  const hash = crypto.createHash('md5').update(key).digest('hex')\n  return `thumbnails/${hash}_preview.jpg`\n}\n\n/**\n * \n * @param zipName \n * @returns \n */\nexport function getCompressedPath(zipName: string): string {\n  return path.join(filesCompressedDir, zipName)\n}\n\n/**\n * \n * @param archiveKey  key compressed/filename.zip\n * @returns code: 0 key  key\n */\nexport function checkLocalCompressStatus(archiveKey: string): { code: number, key?: string, desc?: string, error?: string } {\n  try {\n    console.log(', archiveKey:', archiveKey)\n    // archiveKey  compressed/filename.zip\n    // \n    const fileName = archiveKey.replace('compressed/', '')\n    const localPath = path.join(filesCompressedDir, fileName)\n    console.log(':', localPath)\n    console.log(':', fs.existsSync(localPath))\n    \n    if (fs.existsSync(localPath)) {\n      const stats = fs.statSync(localPath)\n      console.log(':', stats.size)\n      return {\n        code: 0,\n        key: archiveKey,\n      }\n    }\n    else {\n      console.error(':', localPath)\n      return {\n        code: 1,\n        error: '',\n      }\n    }\n  }\n  catch (error) {\n    console.error(':', error)\n    return {\n      code: 3,\n      error: `: ${error}`,\n    }\n  }\n}\n\n/**\n * \n * @param archiveKey  key compressed/filename.zip\n * @returns \n */\nexport function getCompressedFileInfo(archiveKey: string): LocalFileInfo | null {\n  try {\n    const fileName = archiveKey.replace('compressed/', '')\n    const localPath = path.join(filesCompressedDir, fileName)\n    \n    if (!fs.existsSync(localPath)) {\n      return null\n    }\n\n    const stats = fs.statSync(localPath)\n    const ext = path.extname(localPath).toLowerCase()\n    const mimeType = getMimeType(ext)\n\n    return {\n      key: archiveKey,\n      hash: '',\n      fsize: stats.size,\n      mimeType,\n      putTime: Math.floor(stats.mtimeMs / 1000),\n      type: 0,\n      status: 0,\n      md5: '',\n    }\n  }\n  catch (error) {\n    console.error(':', error)\n    return null\n  }\n}\n\n/**\n * \n * @param filename \n * @returns \n */\nexport function getTempPath(filename: string): string {\n  return path.join(filesTempDir, filename)\n}\n\n//  token\nsetInterval(() => {\n  cleanExpiredTokens()\n}, 3600000)\n\n","import 'reflect-metadata'\nimport { App } from 'flash-wolves'\n\n// \nimport { serverConfig } from './config'\n\n// routes\nimport routes from './routes'\nimport controllers from './controllers'\n\n// interceptor\nimport {\n  beforeRouteMatchInterceptor,\n  beforeRuntimeErrorInterceptor,\n  routeInterceptor,\n  serverInterceptor,\n} from './middleware'\nimport {\n  initUserConfig,\n  patchTable,\n  readyServerDepService,\n} from './utils/patch'\nimport LocalUserDB from './utils/user-local-db'\n\nconsole.time('server-start')\n\nconst app = new App(serverInterceptor, {\n  beforeMathRoute: beforeRouteMatchInterceptor,\n  beforeRunRoute: routeInterceptor,\n  beforeReturnRuntimeError: beforeRuntimeErrorInterceptor,\n})\n\n// \napp.addRoutes(routes)\napp.addController(controllers)\n\napp.listen(serverConfig.port, serverConfig.hostname, async () => {\n  console.log('-----', new Date().toLocaleString(), '-----')\n  console.timeEnd('server-start')\n  // \n  await LocalUserDB.initUserConfig()\n  await initUserConfig()\n  try {\n    await readyServerDepService()\n  }\n  catch (err) {\n    console.log(' readyServerDepService', err?.message)\n  }\n  try {\n    await patchTable()\n    console.log(' mysql patch success')\n  }\n  catch (err) {\n    console.log(' mysql ')\n  }\n})\n","export const serverConfig = {\n  port: +process.env.SERVER_PORT,\n  hostname: process.env.SERVER_HOST\n}\n\n// \nexport const mysqlConfig = {\n  host: process.env.MYSQL_DB_HOST,\n  port: +process.env.MYSQL_DB_PORT,\n  database: process.env.MYSQL_DB_NAME,\n  user: process.env.MYSQL_DB_USER,\n  password: process.env.MYSQL_DB_PWD\n}\n\nexport const mongodbConfig = {\n  host: process.env.MONGO_DB_HOST,\n  port: +process.env.MONGO_DB_PORT,\n  database: process.env.MONGO_DB_NAME,\n  user: process.env.MONGO_DB_USER,\n  password: process.env.MONGO_DB_PWD,\n  auth: String(true) === process.env.MONGO_DB_NEED_AUTH\n}\n\nexport const redisConfig = {\n  host: process.env.REDIS_DB_HOST,\n  port: +process.env.REDIS_DB_PORT,\n  password: process.env.REDIS_DB_PASSWORD,\n  auth: String(true) === process.env.REDIS_DB_NEED_AUTH\n}\n\n// \n\nexport const qiniuConfig = {\n  accessKey: process.env.QINIU_ACCESS_KEY,\n  secretKey: process.env.QINIU_SECRET_KEY,\n  bucketName: process.env.QINIU_BUCKET_NAME,\n  bucketDomain: process.env.QINIU_BUCKET_DOMAIN,\n  imageCoverStyle:\n    process.env.QINIU_BUCKET_IMAGE_COVER_STYLE === 'false'\n      ? ''\n      : process.env.QINIU_BUCKET_IMAGE_COVER_STYLE,\n  imagePreviewStyle:\n    process.env.QINIU_BUCKET_IMAGE_PREVIEW_STYLE === 'false'\n      ? ''\n      : process.env.QINIU_BUCKET_IMAGE_PREVIEW_STYLE,\n  bucketZone: process.env.QINIU_BUCKET_ZONE\n}\n\n","/* eslint-disable no-case-declarations */\n\nimport path from 'node:path'\nimport fs from 'node:fs'\nimport process from 'node:process'\nimport { Router } from 'flash-wolves'\nimport { getUserInfo } from '@/utils/userUtil'\nimport { publicError } from '@/constants/errorMsg'\nimport type { People } from '@/db/model/people'\nimport {\n  deletePeople,\n  insertPeople,\n  selectPeople,\n  updatePeople,\n} from '@/db/peopleDb'\nimport { selectFiles } from '@/db/fileDb'\nimport { addBehavior, addErrorLog, findLog, findLogCount, getClientIp } from '@/db/logDb'\nimport { selectTasks } from '@/db/taskDb'\nimport { batchFileStatus } from '@/utils/qiniuUtil'\n\nconst router = new Router('people')\nconst fileDir = `${process.cwd()}/upload`\n\n// TODO: excel\nconst supportType = ['text/plain']\n\n/**\n * \n */\nrouter.post(\n  '/:key',\n  async (req, res) => {\n    const { filename, type } = req.body\n    const { id: userId, account: logAccount } = await getUserInfo(req)\n    const { key } = req.params\n    const filepath = path.join(fileDir, filename)\n\n    if (!supportType.includes(type)) {\n      res.failWithError(publicError.file.notSupport)\n      return\n    }\n    switch (type) {\n      case 'text/plain':\n        const fileContent = fs.readFileSync(filepath, { encoding: 'utf-8' })\n        if (fs.unlink) {\n          fs.unlink(filepath, (err) => {\n            if (err) {\n              addErrorLog(req, err.message, err.stack)\n            }\n          })\n        }\n        const defaultData: People = { taskKey: key, userId }\n        // \n        const peopleData: string[] = fileContent\n          .split('\\n')\n          .map(v => v.trim().replace(/[\\r\\n]/g, ''))\n          .filter(v => v)\n        // \n        const alreadyPeople = (await selectPeople(defaultData)).map(\n          v => v.name,\n        )\n\n        const fail: string[] = []\n        const success: string[] = []\n\n        peopleData.forEach((p) => {\n          if (alreadyPeople.includes(p)) {\n            fail.push(p)\n          }\n          else if (!!p && !success.includes(p)) {\n            success.push(p)\n          }\n        })\n        if (success.length > 0) {\n          await insertPeople(\n            success.map(name => ({ name })),\n            defaultData,\n          )\n        }\n\n        addBehavior(req, {\n          module: 'people',\n          msg: ` :${logAccount} :${success.length} :${fail.length}`,\n          data: {\n            account: logAccount,\n            success: success.length,\n            fail: fail.length,\n          },\n        })\n        res.success({\n          success: success.length,\n          fail,\n        })\n        return\n      default:\n        break\n    }\n    res.success()\n  },\n  {\n    needLogin: true,\n  },\n)\n\n/**\n * \n */\nrouter.get(\n  '/:key',\n  async (req, res) => {\n    const { id: userId, account: logAccount } = await getUserInfo(req)\n    const { key } = req.params\n    const { detail } = req.query\n    const showDetail = detail === '1'\n    const people: any = (\n      await selectPeople(\n        {\n          userId,\n          taskKey: key,\n        },\n        [],\n      )\n    ).map(v => ({\n      id: v.id,\n      name: v.name,\n      status: v.status,\n      lastDate: v.submit_date,\n      count: v.submit_count,\n    }))\n    for (const p of people) {\n      // ()\n      const existPeopleSubmitFiles = await selectFiles({\n        userId,\n        taskKey: key,\n        people: p.name,\n      })\n      // \n      const ossStatus\n        = p.status && existPeopleSubmitFiles.length && showDetail\n          ? await batchFileStatus(\n            existPeopleSubmitFiles.map(\n              v => `easypicker2/${v.task_key}/${v.hash}/${v.name}`,\n            ),\n          )\n          : []\n\n      const fileCount = p.status\n        ? ossStatus.filter(v => v.code === 200).length\n        : 0\n      p.fileCount = fileCount\n\n      // TODO: \n      // \n      // \n      //  =  - \n      let submitCount = 0\n      if (showDetail) {\n        submitCount = p.status\n          ? (await findLogCount({\n              'type': 'behavior',\n              'data.info.data.data.taskKey': key,\n              'data.info.data.data.people': p.name,\n              'data.info.data.data.user_id': userId,\n              'data.req.path': '/file/info',\n              'data.info.msg': {\n                $regex: '$',\n              },\n            }))\n            - (await findLogCount({\n              'type': 'behavior',\n              'data.info.data.data.taskKey': key,\n              'data.info.data.data.peopleName': p.name,\n              'data.user.userId': userId,\n              'data.req.path': '/file/withdraw',\n              'data.info.msg': {\n                $regex: '^',\n              },\n            }))\n          : 0\n      }\n      // \n      p.submitCount = Math.max(submitCount, fileCount)\n\n      // \n      p.count = Math.max(p.count, p.submitCount)\n    }\n    addBehavior(req, {\n      module: 'people',\n      msg: ` :${logAccount}`,\n      data: {\n        account: logAccount,\n      },\n    })\n    res.success({\n      people,\n    })\n  },\n  {\n    needLogin: true,\n  },\n)\n\n/**\n * \n */\nrouter.get('/check/:key', async (req, res) => {\n  const { key } = req.params\n  const { name } = req.query\n  const [task] = await selectTasks({\n    k: key,\n  })\n  if (!task) {\n    res.success({\n      exist: false,\n    })\n    return\n  }\n  const people = await selectPeople({\n    taskKey: key,\n    name,\n  })\n  const exist = people.length !== 0\n  addBehavior(req, {\n    module: 'people',\n    msg: ` :${task.name} :${name} :${\n      exist ? '' : ''\n    }`,\n    data: {\n      taskName: task.name,\n      name,\n      exist,\n    },\n  })\n  res.success({\n    exist,\n  })\n})\n\n/**\n * \n */\nrouter.delete(\n  '/:key',\n  async (req, res) => {\n    const { key } = req.params\n    const { id } = req.body\n    const { id: userId, account: logAccount } = await getUserInfo(req)\n    if (key && id && userId) {\n      const [p] = await selectPeople({\n        id,\n      })\n      if (p) {\n        deletePeople({\n          id,\n          userId,\n          taskKey: key,\n        })\n\n        // \n        ;(async () => {\n          const [task] = await selectTasks({\n            k: key,\n          })\n          if (task) {\n            addBehavior(req, {\n              module: 'people',\n              msg: ` :${logAccount} :${task.name} :${p.name}`,\n              data: {\n                account: logAccount,\n                taskName: task.name,\n                name: p.name,\n              },\n            })\n          }\n        })()\n      }\n    }\n\n    res.success()\n  },\n  {\n    needLogin: true,\n  },\n)\n\n/**\n * \n */\nrouter.put('/:key', async (req, res) => {\n  const { key } = req.params\n  const { name, filename, hash } = req.body\n  if (!name || !filename || !key || !hash) {\n    addBehavior(req, {\n      module: 'people',\n      msg: ' ',\n      data: {\n        key,\n        name,\n        filename,\n        hash,\n      },\n    })\n    res.failWithError(publicError.request.errorParams)\n    return\n  }\n  const files = await selectFiles({\n    taskKey: key,\n    name: filename,\n    hash,\n  })\n  if (files.length === 0) {\n    addBehavior(req, {\n      module: 'people',\n      msg: ' ',\n      data: {\n        key,\n        name,\n        filename,\n        hash,\n      },\n    })\n    res.failWithError(publicError.request.errorParams)\n    return\n  }\n  const alreadyCount\n    = (\n      await selectPeople(\n        {\n          taskKey: key,\n          name,\n        },\n        ['name', 'submit_count'],\n      )\n    )[0].submit_count || 0\n\n  await updatePeople(\n    {\n      status: 1,\n      submitDate: new Date(),\n      submitCount: alreadyCount + 1,\n    },\n    {\n      name,\n      taskKey: key,\n    },\n  )\n  selectTasks({\n    k: key,\n  }).then(([task]) => {\n    if (task) {\n      addBehavior(req, {\n        module: 'people',\n        msg: `  :${task.name} :${name}`,\n        data: {\n          key,\n          taskName: task.name,\n          name,\n          filename,\n          hash,\n        },\n      })\n    }\n  })\n\n  res.success()\n})\nexport default router\n","/* eslint-disable node/handle-callback-err */\nimport type { Context } from 'flash-wolves'\nimport { Inject, InjectCtx, Provide } from 'flash-wolves'\nimport qiniu from 'qiniu'\nimport BehaviorService from './behaviorService'\nimport { getTipImageKey } from '@/utils/stringUtil'\nimport { qiniuConfig } from '@/config'\nimport type { File } from '@/db/model/file'\nimport SuperService from '@/service/super'\n\n@Provide()\nexport default class QiniuService {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  private config = qiniuConfig\n\n  get bucket() {\n    return this.config.bucketName\n  }\n\n  get mac() {\n    return new qiniu.auth.digest.Mac(\n      this.config.accessKey,\n      this.config.secretKey,\n    )\n  }\n\n  deleteObjByKey(key: string) {\n    const config = new qiniu.conf.Config()\n    const bucketManager = new qiniu.rs.BucketManager(this.mac, config)\n\n    bucketManager.delete(this.bucket, key, (err) => {\n      if (err) {\n        console.log('------ start-------')\n        console.log(key)\n        console.log(err)\n        console.log('------ end-------')\n        if (this.ctx) {\n          this.behaviorService.error(\n            `:${key}${err?.message}`,\n            err?.stack,\n          )\n        }\n      }\n    })\n  }\n\n  getTipImageKey(key: string, name: string, uid: number) {\n    return getTipImageKey(key, name, uid)\n  }\n\n  deleteFiles(prefix: string): void {\n    const config = new qiniu.conf.Config()\n    const bucketManager = new qiniu.rs.BucketManager(this.mac, config)\n    bucketManager.listPrefix(\n      this.bucket,\n      {\n        limit: 1000,\n        prefix,\n      },\n      (err, respBody) => {\n        const files: any[] = respBody.items\n        // \n        this.batchDeleteFiles(files.map(f => f.key))\n      },\n    )\n  }\n\n  batchDeleteFiles(keys: string[]) {\n    if (!keys.length)\n      return\n    const { bucket, mac } = this\n    const config = new qiniu.conf.Config()\n    const delOptions = keys.map(k => qiniu.rs.deleteOp(bucket, k))\n    const bucketManager = new qiniu.rs.BucketManager(mac, config)\n    bucketManager.batch(delOptions, (err, respBody, respInfo) => {\n      if (err) {\n        console.log(err)\n        this.behaviorService.error(`: ${err.message}`, err.stack)\n        // throw err;\n      }\n      else {\n        // 200 is success, 298 is part success\n\n        if (Number.parseInt(`${respInfo.statusCode / 100}`, 10) === 2) {\n          respBody.forEach((item) => {\n            if (+item.code !== 200) {\n              this.behaviorService.error(\n                `${item.code}\\t${item.data.error}`,\n                item,\n              )\n            }\n          })\n        }\n        else {\n          console.log(respInfo.deleteusCode)\n          console.log(respBody)\n          this.behaviorService.error(\n            `: ${respInfo.deleteusCode}`,\n            respBody,\n          )\n        }\n      }\n    })\n  }\n\n  async getFilesMap(files: File[]) {\n    const filesMap = new Map<string, Qiniu.ItemInfo>()\n    const startTime = Date.now()\n    const ossFiles = await SuperService.getOssFiles()\n\n    ossFiles.forEach((v) => {\n      filesMap.set(v.key, v)\n    })\n\n    // ep1\n    const oldPrefixList = new Set(\n      files\n        .filter(v => v.category_key)\n        .map((v) => {\n          return v.category_key.split('/')[0]\n        })\n        .filter(v => !v.includes('\"'))\n        .filter(v => !v.startsWith('easypicker2')),\n    )\n\n    for (const prefix of oldPrefixList) {\n      const ossSources = await SuperService.getOssFilesByPrefix(`${prefix}/`)\n      ossSources.forEach((v) => {\n        filesMap.set(v.key, v)\n      })\n    }\n    const expireTime = Date.now() - startTime\n    this.behaviorService.add('file', `OSS - ${expireTime}ms`, {\n      time: expireTime,\n    })\n\n    return filesMap\n  }\n}\n","import { Context, InjectCtx, Provide } from 'flash-wolves'\nimport { LogBehaviorData } from '@/db/model/log'\nimport { addBehavior, addErrorLog, addPvLog } from '@/db/logDb'\n\n@Provide()\nexport default class BehaviorService {\n  @InjectCtx()\n  private Ctx: Context\n\n  add(module: LogBehaviorData.BehaviorInfoModule, msg: string, data?: any) {\n    return addBehavior(this.Ctx.req, {\n      module,\n      msg,\n      data\n    })\n  }\n\n  addPV(path: string) {\n    return addPvLog(this.Ctx.req, path)\n  }\n\n  error(msg: string, stack?: any) {\n    return addErrorLog(this.Ctx.req, msg, stack ?? {})\n  }\n}\n","import type { FWRequest, FWResponse } from 'flash-wolves'\nimport type { FilterQuery } from 'mongodb'\nimport { ObjectId } from 'mongodb'\nimport type {\n  Log,\n  LogBehaviorData,\n  LogData,\n  LogErrorData,\n  LogRequestData,\n  LogType,\n  PvData,\n} from './model/log'\nimport { insertCollection, mongoDbQuery } from '@/lib/dbConnect/mongodb'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport { getUserInfo } from '@/utils/userUtil'\n\nfunction getLogData(type: LogType, data: LogData): Log {\n  return {\n    id: getUniqueKey(),\n    type,\n    data,\n  }\n}\n\n/**\n * \n */\nexport async function addRequestLog(req: FWRequest, res: FWResponse) {\n  const { query = {}, params = {}, method, url } = req\n  let { body = {} } = req\n  if ((method !== 'GET' && !body) || body instanceof Buffer) {\n    body = {}\n  }\n  const { headers } = req\n  const userAgent = headers['user-agent']\n  const refer = headers.referer\n  const ip = getClientIp(req)\n  const user = await getUserInfo(req)\n  let userId = 0\n  if (user?.id) {\n    userId = user.id\n  }\n  const data: LogRequestData = {\n    method,\n    url,\n    query,\n    params,\n    body,\n    userAgent,\n    refer,\n    ip,\n    userId,\n    startTime: req.startTime,\n    endTime: Date.now(),\n    duration: Date.now() - req.startTime,\n  }\n  res.on('close', () => {\n    insertCollection('log', getLogData('request', data))\n  })\n}\n\n/**\n * \n */\nexport async function addBehavior(req: FWRequest, info: LogBehaviorData.Info) {\n  const { url } = req\n\n  const { headers, method } = req\n  const userAgent = headers['user-agent']\n  const refer = headers.referer\n  const ip = getClientIp(req)\n  const user = await getUserInfo(req)\n  let userId = 0\n  if (user?.id) {\n    userId = user.id\n  }\n  const data: LogBehaviorData = {\n    req: {\n      method,\n      path: url,\n      userAgent,\n      refer,\n      ip,\n    },\n    user: {\n      userId,\n    },\n    info,\n  }\n  insertCollection('log', getLogData('behavior', data))\n}\n\n/**\n * \n */\nexport async function addErrorLog(\n  req: FWRequest,\n  msg: string,\n  stack: any = {},\n) {\n  const { query = {}, params = {}, method, url } = req\n  let { body = {} } = req\n  if ((method !== 'GET' && !body) || body instanceof Buffer) {\n    body = {}\n  }\n  const { headers } = req\n  const userAgent = headers['user-agent']\n  const refer = headers.referer\n  const ip = getClientIp(req)\n  const user = await getUserInfo(req)\n  let userId = 0\n  if (user?.id) {\n    userId = user.id\n  }\n  const data: LogErrorData = {\n    req: {\n      method,\n      url,\n      query,\n      params,\n      body,\n      userAgent,\n      refer,\n      ip,\n      userId,\n    },\n    msg,\n    stack,\n  }\n  insertCollection('log', getLogData('error', data))\n}\n\n/**\n * \n */\nexport function addPvLog(req: FWRequest, path: string) {\n  const { headers } = req\n  const userAgent = headers['user-agent']\n  const refer = headers.referer\n  const ip = getClientIp(req)\n  const data: PvData = {\n    userAgent,\n    refer,\n    ip,\n    path,\n  }\n  insertCollection('log', getLogData('pv', data))\n}\n\nexport function getClientIp(req: FWRequest): string {\n  return (req.headers['x-forwarded-for']\n    || req.connection.remoteAddress\n    || req.socket.remoteAddress) as string\n}\n\nexport function timeToObjId(d: Date) {\n  const s = d.getTime() / 1000 // \n  return `${s.toString(16)}0000000000000000` // 16160\n}\n\nexport function findLogCount(q: FilterQuery<Log>) {\n  return mongoDbQuery<number>((db, resolve) => {\n    db.collection<Log>('log').countDocuments(q).then(resolve)\n  })\n}\nexport function findLogWithTimeRange(start: Date, end?: Date) {\n  if (end) {\n    return mongoDbQuery<Log[]>((db, resolve) => {\n      db.collection<Log>('log')\n        .find({\n          _id: {\n            $gt: new ObjectId(timeToObjId(start)),\n            $lt: new ObjectId(timeToObjId(end)),\n          },\n        })\n        .toArray()\n        .then(resolve)\n    })\n  }\n  return mongoDbQuery<Log[]>((db, resolve) => {\n    db.collection<Log>('log')\n      .find({\n        _id: {\n          $gt: new ObjectId(timeToObjId(start)),\n        },\n      })\n      .toArray()\n      .then(resolve)\n  })\n}\n\nexport function findLogWithPageOffset(\n  startIdx: number,\n  pageSize: number,\n  query: FilterQuery<Log>,\n) {\n  return mongoDbQuery<Log[]>((db, resolve) => {\n    db.collection<Log>('log')\n      .find(query)\n      .sort({ _id: -1 })\n      .skip(startIdx)\n      .limit(pageSize)\n      .toArray()\n      .then(resolve)\n  })\n}\nexport function findLog(query: FilterQuery<Log>) {\n  return mongoDbQuery<Log[]>((db, resolve) => {\n    db.collection<Log>('log').find(query).toArray().then(resolve)\n  })\n}\n\nexport function findLogReserve(q: Log) {\n  return mongoDbQuery<Log[]>((db, resolve) => {\n    db.collection<Log>('log')\n      .find(q)\n      .sort({ $natural: -1 })\n      .toArray()\n      .then(resolve)\n  })\n}\n\nexport function findPvLogWithRange(start: Date, end?: Date) {\n  if (end) {\n    return mongoDbQuery<Log[]>((db, resolve) => {\n      db.collection<Log>('log')\n        .find({\n          type: 'pv',\n          _id: {\n            $gt: new ObjectId(timeToObjId(start)),\n            $lt: new ObjectId(timeToObjId(end)),\n          },\n        })\n        .toArray()\n        .then(resolve)\n    })\n  }\n  return mongoDbQuery<Log[]>((db, resolve) => {\n    db.collection<Log>('log')\n      .find({\n        type: 'pv',\n        _id: {\n          $gt: new ObjectId(timeToObjId(start)),\n        },\n      })\n      .toArray()\n      .then(resolve)\n  })\n}\n","import {\n  Db,\n  FilterQuery,\n  InsertOneWriteOpResult,\n  MongoClient,\n  UpdateQuery,\n  UpdateWriteOpResult,\n  WithId\n} from 'mongodb'\nimport { mongodbConfig } from '@/config'\nimport LocalUserDB from '@/utils/user-local-db'\n\nconst { host, port, user, password, database, auth } = mongodbConfig\n\nlet url = auth\n  ? `mongodb://${user}:${password}@${host}:${port}/${database}`\n  : `mongodb://${host}:${port}/${database}?wtimeoutMS=2000`\n\ninterface Res {\n  db: MongoClient\n  Db: Db\n}\nexport function refreshMongoDb() {\n  const cfg = LocalUserDB.getUserConfigByType('mongo')\n  const { host, port, user, password, database, auth } = cfg\n  url = auth\n    ? `mongodb://${user}:${password}@${host}:${port}/${database}`\n    : `mongodb://${host}:${port}/${database}?wtimeoutMS=2000`\n}\n\nexport function getDBConnection(): Promise<Res> {\n  return new Promise((res, rej) => {\n    MongoClient.connect(url, {\n      useUnifiedTopology: true,\n      useNewUrlParser: true\n    })\n      .then((db) => {\n        res({\n          db,\n          Db: db.db(database)\n        })\n      })\n      .catch((err) => {\n        rej(err)\n      })\n  })\n}\n\nexport function getMongoDBStatus() {\n  return new Promise<ServiceStatus>((res) => {\n    getDBConnection()\n      .then((r) => {\n        r.db.close()\n        res({\n          type: 'mongodb',\n          status: true\n        })\n      })\n      .catch((err) => {\n        res({\n          errMsg: err.message,\n          type: 'mongodb',\n          status: false\n        })\n      })\n  })\n}\n\ntype Callback<T> = (\n  db: Db,\n  resolve: (value: T | PromiseLike<T>) => void\n) => void\n\nexport function query<T>(callback: Callback<T>): Promise<T> {\n  const p = new Promise<T>((resolve, rej) => {\n    getDBConnection().then(({ db, Db }) => {\n      // \n      callback(Db, resolve)\n      // resolve\n      p.catch((e) => rej(e)).finally(() => {\n        db.close()\n      })\n    })\n  })\n  return p\n}\n\nexport const mongoDbQuery = query\nexport function updateCollection<T>(\n  collection: string,\n  query: FilterQuery<T>,\n  data: UpdateQuery<T>,\n  many = false\n) {\n  return mongoDbQuery<UpdateWriteOpResult>((db, resolve) => {\n    if (many) {\n      db.collection<T>(collection).updateMany(query, data).then(resolve)\n      return\n    }\n    db.collection<T>(collection).updateOne(query, data).then(resolve)\n  })\n}\n\nexport function insertCollection<T>(\n  collection: string,\n  data: T[] | T,\n  many = false\n) {\n  return mongoDbQuery<InsertOneWriteOpResult<WithId<T>>>((db, resolve) => {\n    if (many && Array.isArray(data)) {\n      db.collection<T>(collection)\n        .insertMany(data as any)\n        .then(resolve as any)\n      return\n    }\n    db.collection<T>(collection)\n      .insertOne(data as any)\n      .then(resolve)\n  })\n}\nexport function findCollection<T>(\n  collection: string,\n  query: FilterQuery<T>\n): Promise<T[]> {\n  return mongoDbQuery<T[]>((db, resolve) => {\n    db.collection<T>(collection).find(query).toArray().then(resolve)\n  })\n}\n\nexport function findCollectionCount<T>(\n  collection: string,\n  query: FilterQuery<T>\n): Promise<number> {\n  return mongoDbQuery<number>((db, resolve) => {\n    db.collection<T>(collection).countDocuments(query).then(resolve)\n  })\n}\n","import fs, { existsSync } from 'node:fs'\nimport path from 'node:path'\nimport process from 'node:process'\nimport type { UserConfig, UserConfigType } from '@/db/model/config'\nimport { LocalEnvMap } from '@/constants'\nimport type { GlobalSiteConfig } from '@/types'\n\nconst JSONDbFile = path.join(process.cwd(), 'user-config.json')\n\nexport default class LocalUserDB {\n  private static data: UserConfig[] = []\n\n  static async initUserConfig() {\n    if (!existsSync(JSONDbFile)) {\n      await fs.promises.writeFile(JSONDbFile, '[]', 'utf-8')\n      this.data = []\n      return\n    }\n    try {\n      this.data = JSON.parse(await fs.promises.readFile(JSONDbFile, 'utf-8'))\n    }\n    catch (error) {\n      this.data = []\n      console.log(' user-config.json , ')\n      await fs.promises.writeFile(JSONDbFile, '[]', 'utf-8')\n    }\n  }\n\n  static async updateLocalEnv() {\n    const localEnvFile = `${process.cwd()}/.env.local`\n    const isExist = fs.existsSync(localEnvFile)\n    let content = ''\n    if (isExist) {\n      content = await fs.promises.readFile(localEnvFile, 'utf-8')\n    }\n    this.data.forEach((item) => {\n      const { type, key, value } = item\n      const originEnvKey = LocalEnvMap?.[type]?.[key]\n      if (!originEnvKey) {\n        return\n      }\n      if (process.env[originEnvKey] !== `${value}`) {\n        content = content.replace(new RegExp(`${originEnvKey}=.*`), '')\n        content += `\\n${originEnvKey}=${value}`\n      }\n    })\n    content = content.split('\\n').filter(Boolean).join('\\n')\n    await fs.promises.writeFile(localEnvFile, content, 'utf-8')\n  }\n\n  static updateCfg() {\n    return fs.promises.writeFile(\n      JSONDbFile,\n      JSON.stringify(this.data, null, 2),\n      'utf-8',\n    )\n  }\n\n  static addUserConfigData(data: UserConfig) {\n    this.data.push(data)\n  }\n\n  static async setUserConfig(data: UserConfig) {\n    const index = this.data.findIndex(\n      item => item.type === data.type && item.key === data.key,\n    )\n    const next = { ...data, lastUpdate: new Date() }\n    if (index > -1) {\n      this.data[index] = { ...this.data[index], ...next }\n    }\n    else {\n      this.data.push(next)\n    }\n    await this.updateCfg()\n  }\n\n  static findUserConfig(query: Partial<UserConfig>) {\n    return this.data.filter(item =>\n      Object.keys(query).every(key => item[key] === query[key]),\n    )\n  }\n\n  static updateUserConfig(\n    query: Partial<UserConfig>,\n    data: Partial<UserConfig>,\n  ) {\n    const index = this.data.findIndex(item =>\n      Object.keys(query).every(key => item[key] === query[key]),\n    )\n    if (index > -1) {\n      this.data[index] = { ...this.data[index], ...data }\n      return this.updateCfg()\n    }\n  }\n\n  static getUserConfigByType(type: UserConfigType): Record<string, any> {\n    return this.findUserConfig({ type }).reduce((prev, curr) => {\n      prev[curr.key] = curr.value\n      return prev\n    }, {})\n  }\n\n  static getSiteConfig() {\n    const config = this.findUserConfig({ type: 'global', key: 'site' })[0]\n      ?.value as GlobalSiteConfig & { needBindPhone?: boolean }\n    if (config && config.needBindEmail === undefined) {\n      config.needBindEmail = config.needBindPhone ?? false\n    }\n    return config\n  }\n}\n","/* eslint-disable regexp/no-unused-capturing-group */\n/* eslint-disable regexp/no-legacy-features */\nimport crypto from 'node:crypto'\nimport path from 'node:path'\nimport { ObjectId } from 'mongodb'\nimport type { FWRequest } from 'flash-wolves'\n/**\n * (md5+base64)\n * @param str \n */\nexport function encryption(str: string): string {\n  return crypto.createHash('md5').update(str).digest('base64')\n}\n\nexport function lowCamel2Underscore(word: string): string {\n  const letters = word.split('')\n  return letters.reduce(\n    (pre, letter) =>\n      pre + (/[A-Z]/.test(letter) ? `_${letter.toLowerCase()}` : letter),\n    '',\n  )\n}\n\nexport function getUniqueKey() {\n  return new ObjectId().toHexString()\n}\n\nexport function getKeyInfo(key: string) {\n  const { name, base, ext } = path.parse(key)\n  return {\n    name,\n    base,\n    ext,\n  }\n}\nexport function formatDate(d: Date, fmt = 'yyyy-MM-dd hh:mm:ss') {\n  const o: any = {\n    'M+': d.getMonth() + 1, // \n    'd+': d.getDate(), // \n    'h+': d.getHours(), // \n    'm+': d.getMinutes(), // \n    's+': d.getSeconds(), // \n    'q+': Math.floor((d.getMonth() + 3) / 3), // \n    'S': d.getMilliseconds(), // \n  }\n  if (/(y+)/.test(fmt)) {\n    fmt = fmt.replace(\n      RegExp.$1,\n      `${d.getFullYear()}`.substr(4 - RegExp.$1.length),\n    )\n  }\n\n  for (const k in o) {\n    if (new RegExp(`(${k})`).test(fmt)) {\n      fmt = fmt.replace(\n        RegExp.$1,\n        RegExp.$1.length === 1 ? o[k] : `00${o[k]}`.substr(`${o[k]}`.length),\n      )\n    }\n  }\n  return fmt\n}\n\nexport function formatSize(\n  size: number,\n  pointLength?: number,\n  units?: string[],\n) {\n  let unit\n  units = units || ['B', 'K', 'M', 'G', 'TB', 'PB']\n  // eslint-disable-next-line no-cond-assign\n  while ((unit = units.shift()) && size > 1024) {\n    size /= 1024\n  }\n  return (\n    (unit === 'B'\n      ? size\n      : size.toFixed(pointLength === undefined ? 2 : pointLength)) + unit\n  )\n}\n\nexport function B2GB(size: number) {\n  return size / 1024 / 1024 / 1024\n}\n\nexport function formatPrice(...prices: number[]) {\n  return prices.reduce((pre, cur) => pre + cur, 0).toFixed(2)\n}\n\ntype InfoItemType = 'input' | 'radio' | 'text' | 'select'\ninterface InfoItem {\n  type?: InfoItemType\n  // \n  text?: string\n  // \n  value?: string\n  children?: InfoItem[]\n}\n\nexport function isSameInfo(userInfo: string, dbInfo: string) {\n  try {\n    const userItems: InfoItem[] = JSON.parse(userInfo)\n    const dbItems: InfoItem[] = JSON.parse(dbInfo)\n    if (userItems.length === 0) {\n      return false\n    }\n    if (userItems.length !== dbItems.length) {\n      return false\n    }\n    if (\n      !dbItems.every(item =>\n        userItems.find(\n          userItem =>\n            userItem.text === item.text && userItem.value === item.value,\n        ),\n      )\n    ) {\n      return false\n    }\n  }\n  catch (error) {\n    console.log(error)\n    return false\n  }\n  return true\n}\n\n/**\n * \n */\nexport function normalizeFileName(name: string) {\n  return name.replace(/[\\\\/:*?\"<>|]/g, '-')\n}\n\nexport function getObjectIdDate(id: string) {\n  return +new ObjectId(id).getTimestamp()\n}\n\nexport function getTipImageKey(\n  key: string,\n  name: string,\n  uid?: number | string,\n) {\n  return `easypicker2/tip/${key}/${uid || Date.now()}/${name}`\n}\n\nexport function shortLink(key: string, req: FWRequest) {\n  return `${new URL(req.headers.referer).origin}/api/file/download/${key}`\n}\n\n/**\n * A/B\n * @param A\n * @param B\n */\nexport function percentageValue(A: number, B: number) {\n  return ((A / B) * 100).toFixed(2)\n}\n","import redis, { RedisClient } from 'redis'\nimport { redisConfig } from '@/config'\n\nconst { port, host, password, auth } = redisConfig\n\nexport function getClient(): Promise<RedisClient> {\n  return new Promise<RedisClient>((res, rej) => {\n    const client = redis.createClient(\n      port,\n      host,\n      auth\n        ? {\n            password\n          }\n        : {}\n    )\n    // redis \n    client.on('ready', () => {\n      res(client)\n    })\n    client.on('error', (err) => {\n      client.quit()\n      rej(err)\n    })\n  })\n}\n\nexport function getRedisStatus() {\n  return new Promise<ServiceStatus>((res, rej) => {\n    getClient()\n      .then((c) => {\n        c.quit()\n        res({\n          type: 'redis',\n          status: true\n        })\n      })\n      .catch((err) => {\n        res({\n          errMsg: err.message,\n          type: 'redis',\n          status: false\n        })\n      })\n  })\n}\n","interface Value {\n  value: any\n  duration: number\n}\n\n/**\n * \n */\nclass LocalStorage {\n  private map: Map<string, Value>\n\n  private loop() {\n    setTimeout(() => {\n      this.expiredCheck()\n      if (this.map.size > 0) {\n        this.loop()\n      }\n    }, 1000)\n  }\n\n  constructor() {\n    this.map = new Map()\n  }\n\n  /**\n   * \n   * @param key \n   * @param value \n   * @param duration(s) (-1)\n   */\n  public setItem(key: string, value: unknown, duration = -1) {\n    if (this.map.size === 0) {\n      this.loop()\n    }\n    // console.log('LocalStorage: set', key, value)\n    this.map.set(key, { value, duration })\n  }\n\n  /**\n   * \n   */\n  removeItem(key: string) {\n    this.map.delete(key)\n  }\n\n  /**\n   * \n   */\n  expireItem(key: string) {\n    this.setItem(key, null, 0)\n  }\n\n  /**\n   * \n   */\n  getItem(key: string) {\n    // console.log('LocalStorage: get', key)\n    return this.map.get(key)\n  }\n\n  /**\n   * \n   */\n  clearItem() {\n    this.map.clear()\n  }\n\n  /**\n   * \n   */\n  expiredCheck() {\n    const keys = this.map.keys()\n    for (const key of keys) {\n      const value = this.map.get(key)\n      if (value.duration === 0) {\n        // \n        console.log(`-------${key}`)\n        this.removeItem(key)\n      } else {\n        value.duration -= 1\n      }\n    }\n  }\n\n  static instance: LocalStorage = null\n\n  /**\n   * \n   */\n  static getInstance() {\n    if (!LocalStorage.instance) {\n      LocalStorage.instance = new LocalStorage()\n    }\n    return LocalStorage.instance\n  }\n}\n\nexport default LocalStorage.getInstance()\n","import { getClient } from '@/lib/dbConnect/redis'\n\n// \nimport storage from '@/utils/storageUtil'\n\nexport function setRedisValue(k: string, v: string, expiredTime = -1) {\n  storage.setItem(k, v, expiredTime)\n  getClient().then((client) => {\n    client.set(k, v, () => {\n      if (expiredTime !== -1) {\n        client.expire(k, expiredTime, () => {\n          client.quit()\n        })\n        return\n      }\n      client.quit()\n    })\n  }).catch((err) => {\n    // Redis \n    console.warn('[Redis] :', err?.message || err)\n  })\n}\n\nexport function getRedisVal(k: string, originCallback?: any): Promise<string> {\n  return new Promise((resolve) => {\n    const v = storage.getItem(k)\n    if (v?.value) {\n      resolve(v.value)\n      // \n      if (typeof originCallback === 'function') {\n        originCallback().then((v) => {\n          setRedisValue(k, JSON.stringify(v), 60 * 60 * 24 * 7)\n        })\n      }\n      return\n    }\n    getClient().then((client) => {\n      client.get(k, (err, reply) => {\n        storage.setItem(k, reply, 60 * 60 * 24 * 7)\n        client.quit()\n        if (reply === null && typeof originCallback === 'function') {\n          originCallback()\n            .then((v) => {\n              const str = JSON.stringify(v)\n              setRedisValue(k, str, 60 * 60 * 24 * 7)\n              resolve(str)\n            })\n            .catch(() => {\n              resolve(reply)\n            })\n        } else {\n          resolve(reply)\n        }\n      })\n    }).catch((err) => {\n      // Redis  null\n      console.warn('[Redis] :', err?.message || err)\n      const localValue = storage.getItem(k)\n      if (localValue?.value) {\n        resolve(localValue.value)\n      } else if (typeof originCallback === 'function') {\n        // \n        originCallback()\n          .then((v) => {\n            const str = JSON.stringify(v)\n            setRedisValue(k, str, 60 * 60 * 24 * 7)\n            resolve(str)\n          })\n          .catch(() => {\n            resolve(null)\n          })\n      } else {\n        resolve(null)\n      }\n    })\n  })\n}\n\nexport function getRedisValueJSON<T>(\n  k: string,\n  defaultValue: T,\n  originCallback?: any\n): Promise<T> {\n  return getRedisVal(k, originCallback).then((v) => {\n    if (v) {\n      return JSON.parse(v)\n    }\n    return defaultValue || null\n  })\n}\n\nexport function expiredRedisKey(k: string) {\n  setRedisValue(k, '', 0)\n  storage.expireItem(k)\n}\n","/* eslint-disable unused-imports/no-unused-vars */\n/* eslint-disable eqeqeq */\n/* eslint-disable node/handle-callback-err */\nimport type { FWRequest } from 'flash-wolves'\nimport qiniu from 'qiniu'\nimport { getKeyInfo } from './stringUtil'\nimport LocalUserDB from './user-local-db'\nimport { addBehavior, addErrorLog } from '@/db/logDb'\nimport { qiniuConfig } from '@/config'\n// [node-sdk](https://developer.qiniu.com/kodo/1289/nodejs#server-upload)\nlet privateBucketDomain = qiniuConfig.bucketDomain\n\nconst bucketZoneMap = {\n  huadong: qiniu.zone.Zone_z0,\n  huabei: qiniu.zone.Zone_z1,\n  huanan: qiniu.zone.Zone_z2,\n  beimei: qiniu.zone.Zone_na0,\n  SoutheastAsia: qiniu.zone.Zone_as0,\n}\nlet bucketZone = bucketZoneMap[qiniuConfig.bucketZone] || qiniu.zone.Zone_z2\n\n// 12\nconst getDeadline = () => Math.floor(Date.now() / 1000) + 3600 * 12\n\nlet bucket = qiniuConfig.bucketName\nlet mac = new qiniu.auth.digest.Mac(qiniuConfig.accessKey, qiniuConfig.secretKey)\nconst { urlsafeBase64Encode } = qiniu.util\n\nexport async function refreshQinNiuConfig() {\n  const cfg = LocalUserDB.getUserConfigByType('qiniu')\n  Object.assign(qiniuConfig, cfg)\n  privateBucketDomain = qiniuConfig.bucketDomain\n  bucketZone = bucketZoneMap[qiniuConfig.bucketZone] || qiniu.zone.Zone_z2\n  bucket = qiniuConfig.bucketName\n  mac = new qiniu.auth.digest.Mac(qiniuConfig.accessKey, qiniuConfig.secretKey)\n}\n/**\n * OSS12h\n * @param key key\n * @param expiredTime\n */\nexport function createDownloadUrl(key: string, expiredTime = getDeadline()): string {\n  // \n  const config = new qiniu.conf.Config()\n  // \n  const bucketManager = new qiniu.rs.BucketManager(mac, config)\n\n  const paths = key.split('/')\n  const url = bucketManager.privateDownloadUrl(privateBucketDomain,\n    // encode\n    paths.map((v, idx) => idx === paths.length - 1 ? encodeURIComponent(v) : v).join('/'), expiredTime)\n  return url\n}\n\nexport function getUploadToken(): string {\n  const putPolicy = new qiniu.rs.PutPolicy({\n    scope: bucket,\n    // returnBody: '{\"key\":\"$(key)\",\"hash\":\"$(etag)\",\"fsize\":$(fsize),\"bucket\":\"$(bucket)\",\"name\":\"$(x:name)\"}'\n    returnBody: '{\"key\":\"$(key)\",\"hash\":\"$(etag)\",\"fsize\":$(fsize)}',\n  })\n  return putPolicy.uploadToken(mac)\n}\n\nexport function deleteFiles(prefix: string): void {\n  const config = new qiniu.conf.Config()\n  const bucketManager = new qiniu.rs.BucketManager(mac, config)\n  bucketManager.listPrefix(bucket, {\n    limit: 1000,\n    prefix,\n  }, (err, respBody) => {\n    const files: any[] = respBody.items\n    // \n    batchDeleteFiles(files.map(f => f.key))\n  })\n}\n\nexport function batchDeleteFiles(keys: string[], req?: FWRequest) {\n  if (!keys.length)\n    return\n  const config = new qiniu.conf.Config()\n  const delOptions = keys.map(k => qiniu.rs.deleteOp(bucket, k))\n  const bucketManager = new qiniu.rs.BucketManager(mac, config)\n  bucketManager.batch(delOptions, (err, respBody, respInfo) => {\n    if (err) {\n      console.log(err)\n      addErrorLog(req, `: ${err.message}`, err.stack)\n      // throw err;\n    }\n    else {\n      // 200 is success, 298 is part success\n      if (Number.parseInt(`${respInfo.statusCode / 100}`, 10) === 2) {\n        respBody.forEach((item) => {\n          if ((+item.code) !== 200) {\n            if (req) {\n              addErrorLog(req, `${item.code}\\t${item.data.error}`, item)\n            }\n          }\n        })\n      }\n      else {\n        console.log(respInfo.deleteusCode)\n        console.log(respBody)\n        addErrorLog(req, `: ${respInfo.deleteusCode}`, respBody)\n      }\n    }\n  })\n}\n\nexport function deleteObjByKey(key: string, req?: FWRequest): void {\n  const config = new qiniu.conf.Config()\n  const bucketManager = new qiniu.rs.BucketManager(mac, config)\n  bucketManager.delete(bucket, key, (err) => {\n    if (err) {\n      console.log('------ start-------')\n      console.log(key)\n      console.log(err)\n      console.log('------ end-------')\n      if (req) {\n        addErrorLog(req, `:${key}${err?.message}`, err?.stack)\n      }\n    }\n  })\n}\n\nexport function judgeFileIsExist(key: string): Promise<boolean> {\n  return new Promise((res) => {\n    const config = new qiniu.conf.Config()\n    const bucketManager = new qiniu.rs.BucketManager(mac, config)\n    bucketManager.stat(bucket, key, (err, respBody, respInfo) => {\n      if (respInfo?.statusCode) {\n        res(respInfo.statusCode !== 612)\n      }\n      else {\n        res(false)\n      }\n    })\n  })\n}\n\nfunction mergeRequest<T extends Function>(callback: T, delay = 1000) {\n  const pMap = new Map<string, Promise<any>>()\n  const cb: any = (...args) => {\n    const key = JSON.stringify(args)\n    let p = pMap.get(key)\n    if (!p) {\n      p = callback(...args)\n      pMap.set(key, p)\n      setTimeout(() => {\n        pMap.delete(key)\n      }, delay)\n    }\n    return p\n  }\n  return cb as T\n}\n\n//  prefix \nexport const getOSSFiles = mergeRequest((prefix: string): Promise<Qiniu.ItemInfo[]> => {\n  let data = []\n  let marker = ''\n  const ops: any = {\n    limit: 1000,\n    prefix,\n  }\n  return new Promise((res) => {\n    const analyze = () => {\n      const config = new qiniu.conf.Config()\n      const bucketManager = new qiniu.rs.BucketManager(mac, config)\n      if (ops) {\n        ops.marker = marker\n      }\n      bucketManager.listPrefix(bucket, ops, (err, respBody) => {\n        data = data.concat(respBody?.items || [])\n        if (respBody?.marker) {\n          marker = respBody.marker\n          analyze()\n        }\n        else {\n          res(data)\n        }\n      })\n    }\n    analyze()\n  })\n})\n\nexport function getFileKeys(prefix: string): Promise<Qiniu.ItemInfo[]> {\n  return new Promise((res) => {\n    const config = new qiniu.conf.Config()\n    const bucketManager = new qiniu.rs.BucketManager(mac, config)\n    bucketManager.listPrefix(bucket, {\n      prefix,\n    }, (err, respBody) => {\n      res(respBody?.items || [])\n    })\n  })\n}\n\nexport function makeZipByPrefixWithKeys(prefix: string, zipName: string, keys: string[] = []): Promise<string> {\n  return new Promise((res) => {\n    const config = new qiniu.conf.Config()\n    const bucketManager = new qiniu.rs.BucketManager(mac, config)\n\n    bucketManager.listPrefix(bucket, {\n      // TODO:\n      limit: 1000,\n      prefix,\n    }, (err, respBody) => {\n      const files: any[] = respBody.items\n      // \n      deleteFiles(`${prefix.slice(0, -1)}_package/`)\n      const names = []\n      // ,\n      const content = files.filter(file => keys.includes(file.key)).map((file) => {\n        // url\n        // Base64\n        const keyInfo = getKeyInfo(file.key)\n        const { name, ext } = keyInfo\n        let { base } = keyInfo\n\n        // ,+\n        let i = 1\n        while (names.includes(base)) {\n          base = `${name}_${i}${ext}`\n          i += 1\n        }\n        names.push(base)\n        // ,+\n        const safeUrl = `/url/${urlsafeBase64Encode(createDownloadUrl(file.key))}/alias/${urlsafeBase64Encode(base)}`\n        return safeUrl\n      }).join('\\n')\n      const config = new qiniu.conf.Config({ zone: bucketZone })\n      const formUploader = new qiniu.form_up.FormUploader(config)\n      const putExtra = new qiniu.form_up.PutExtra()\n      const key = `${Date.now()}-${~~(Math.random() * 1000)}.txt`\n\n      formUploader.put(getUploadToken(), key, content, putExtra, (respErr, respBody, respInfo) => {\n        if (respErr) {\n          throw respErr\n        }\n        if (respInfo.statusCode == 200) {\n          const { key } = respBody\n          // \n          const zipKey = urlsafeBase64Encode(`${bucket}:${prefix.substring(0, prefix.length - 1)}_package/${zipName}.zip`)\n\n          const fops = `mkzip/4/encoding/${urlsafeBase64Encode('gbk')}|saveas/${zipKey}`\n          const operManager = new qiniu.fop.OperationManager(mac, config)\n          const pipeline = '' // \n          // \n          const options = { force: false }\n          operManager.pfop(bucket, key, [fops], pipeline, options, (err, respBody, respInfo) => {\n            if (err) {\n              throw err\n            }\n            if (respInfo.statusCode == 200) {\n              // statusUrl\n              const statusUrl = `http://api.qiniu.com/status/get/prefop?id=${respBody.persistentId}`\n              console.log(statusUrl)\n              // id\n              res(respBody.persistentId)\n            }\n            else {\n              console.log(respInfo.statusCode)\n              console.log(respBody)\n            }\n          })\n        }\n        else {\n          console.log(respInfo.statusCode)\n          console.log(respBody)\n        }\n      })\n    })\n  })\n}\n\nexport function makeZipWithKeys(keys: string[], zipName: string): Promise<string> {\n  return new Promise((res) => {\n    const names = []\n    const content = keys.map((key) => {\n      // url\n      // Base64\n      const keyInfo = getKeyInfo(key)\n      const { name, ext } = keyInfo\n      let { base } = keyInfo\n\n      // ,+\n      let i = 1\n      while (names.includes(base)) {\n        base = `${name}_${i}${ext}`\n        i += 1\n      }\n      // \n      const specialCharsReplaceMap = [['', '']]\n      specialCharsReplaceMap.forEach(([pre, post]) => {\n        base = base.replace(new RegExp(pre, 'g'), post)\n      })\n      names.push(base)\n      const safeUrl = `/url/${urlsafeBase64Encode(createDownloadUrl(key))}/alias/${urlsafeBase64Encode(base)}`\n      return safeUrl\n    }).join('\\n')\n    const config = new qiniu.conf.Config({ zone: bucketZone })\n    const formUploader = new qiniu.form_up.FormUploader(config)\n    const putExtra = new qiniu.form_up.PutExtra()\n    const inputKey = `${Date.now()}-${~~(Math.random() * 1000)}.txt`\n    // \n    // \n    formUploader.put(getUploadToken(), inputKey, content, putExtra, (respErr, respBody, respInfo) => {\n      if (respErr) {\n        throw respErr\n      }\n      if (respInfo.statusCode == 200) {\n        const { key } = respBody\n        // \n        const zipKey = urlsafeBase64Encode(`${bucket}:` + 'easypicker2/' + `temp_package/${Date.now()}/${zipName}.zip`)\n\n        const fops = `mkzip/4/encoding/${urlsafeBase64Encode('gbk')}|saveas/${zipKey}`\n        const operManager = new qiniu.fop.OperationManager(mac, config)\n        const pipeline = '' // \n        // \n        const options = { force: false }\n        operManager.pfop(bucket, key, [fops], pipeline, options, (err, respBody, respInfo) => {\n          if (err) {\n            throw err\n          }\n          if (respInfo.statusCode == 200) {\n            // statusUrl\n            const statusUrl = `http://api.qiniu.com/status/get/prefop?id=${respBody.persistentId}`\n            console.log(statusUrl)\n            // id\n            res(respBody.persistentId)\n          }\n          else {\n            console.log(respInfo.statusCode)\n            console.log(respBody)\n          }\n        })\n      }\n      else {\n        console.log(respInfo.statusCode)\n        console.log(respBody)\n      }\n    })\n  })\n}\n\nexport function checkFopTaskStatus(persistentId: string): Promise<{ code: number, key?: string, desc?: string, error?: string }> {\n  const config = new qiniu.conf.Config()\n  const operManager = new qiniu.fop.OperationManager(null, config)\n  return new Promise((res) => {\n    operManager.prefop(persistentId, (err, respBody, respInfo) => {\n      if (err) {\n        console.log(err)\n        throw err\n      }\n      if (respInfo.statusCode == 200) {\n        //  ![](http://img.cdn.sugarat.top/mdImg/MTYxMjg0MTQyODQ1Mg==612841428452)\n        const item = respBody.items[0]\n        const { code, key, desc, error } = item\n        res({ code, key, desc, error })\n      }\n      else {\n        console.log(respInfo.statusCode)\n        console.log(respBody)\n      }\n    })\n  })\n}\ninterface FileStat {\n  code: number\n  data: {\n    md5?: string\n    error?: string\n    hash?: string\n    mimeType?: string\n    putTime?: number\n    type?: number\n    fsize?: number\n  }\n}\n/**\n * \n */\nexport function batchFileStatus(keys: string[]): Promise<FileStat[]> {\n  return new Promise((resolve, reject) => {\n    if (keys.length === 0) {\n      return []\n    }\n    const statOperations = keys.map(k => qiniu.rs.statOp(bucket, k))\n    const config = new qiniu.conf.Config()\n    const bucketManager = new qiniu.rs.BucketManager(mac, config)\n    bucketManager.batch(statOperations, (err, respBody, respInfo) => {\n      if (err) {\n        reject(err)\n      }\n      else {\n        // 200 is success, 298 is part success\n        if (Number.parseInt(`${respInfo.statusCode / 100}`) == 2) {\n          resolve(respBody)\n        }\n        else {\n          console.log(respInfo.statusCode)\n          console.log(respBody)\n        }\n      }\n    })\n  })\n}\n\nexport function getQiniuStatus() {\n  return new Promise<ServiceStatus>((res) => {\n    if (!qiniuConfig.bucketDomain.startsWith('http')) {\n      res({\n        type: 'qiniu',\n        status: false,\n        errMsg: ' http:///  https://',\n      })\n      return\n    }\n    const config = new qiniu.conf.Config({ zone: bucketZone })\n\n    const checkRegion = new Promise((res, rej) => {\n      const formUploader = new qiniu.form_up.FormUploader(config)\n      const putExtra = new qiniu.form_up.PutExtra()\n      const key = `${Date.now()}-${~~(Math.random() * 1000)}.txt`\n      formUploader.put(getUploadToken(), key, 'status test', putExtra, (respErr, respBody, respInfo) => {\n        const err = respErr || respBody?.error\n        if (err) {\n          rej(err)\n          return\n        }\n        deleteObjByKey(key)\n        res(key)\n      })\n    })\n\n    const bucketManager = new qiniu.rs.BucketManager(mac, config)\n    bucketManager.listPrefix(bucket, {\n      prefix: 'easypicker2/',\n      limit: 1,\n    }, (err, respBody) => {\n      const errMsg = err?.message || respBody?.error\n      if (errMsg) {\n        res({\n          type: 'qiniu',\n          status: false,\n          errMsg,\n        })\n        return\n      }\n      checkRegion\n        .then(() => {\n          res({\n            type: 'qiniu',\n            status: true,\n          })\n        })\n        .catch((err) => {\n          res({\n            type: 'qiniu',\n            status: false,\n            errMsg: `${err}`,\n          })\n        })\n    })\n  })\n}\n\nexport function mvOssFile(oldKey: string, newKey: string, req?: FWRequest) {\n  const config = new qiniu.conf.Config()\n  const bucketManager = new qiniu.rs.BucketManager(mac, config)\n  const srcBucket = qiniuConfig.bucketName\n  const destBucket = qiniuConfig.bucketName\n  // \n  const options = {\n    force: false,\n  }\n  return new Promise((resolve, reject) => {\n    bucketManager.move(srcBucket, oldKey, destBucket, newKey, options, (\n      err,\n      respBody,\n      respInfo,\n    ) => {\n      if (err) {\n        console.log(err)\n        if (req) {\n          // \n          addBehavior(req, {\n            module: 'file',\n            msg: `${srcBucket}:${oldKey} -> ${destBucket}:${newKey}`,\n            data: {\n              oldKey,\n              newKey,\n              err,\n            },\n          })\n        }\n        reject(err)\n      }\n      else {\n        resolve(true)\n        // 200 is success\n        if (req) {\n          // \n          // TODO:\n          addBehavior(req, {\n            module: 'file',\n            msg: `OSS${srcBucket}:${oldKey} -> ${destBucket}:${newKey}`,\n            data: {\n              oldKey,\n              newKey,\n              respBody,\n              respInfo,\n            },\n          })\n        }\n      }\n    })\n  })\n}\n","import { getRedisValueJSON } from '@/db/redisDb'\nimport { getOSSFiles } from '@/utils/qiniuUtil'\nimport LocalUserDB from '@/utils/user-local-db'\n\nclass SuperService {\n  async getOssFiles() {\n    const systemUser = LocalUserDB.getUserConfigByType('server').USER || 'local'\n    const cacheKey = `${systemUser}-oss-files-easypicker2/`\n\n    // redis\n    const ossFiles = await getRedisValueJSON<Qiniu.ItemInfo[]>(\n      cacheKey,\n      [],\n      () => getOSSFiles('easypicker2/')\n    )\n    return ossFiles\n  }\n\n  async getOssFilesByPrefix(prefix: string) {\n    if (!prefix) {\n      return\n    }\n    const systemUser = LocalUserDB.getUserConfigByType('server').USER || 'local'\n    const cacheKey = `${systemUser}-oss-files-${prefix}`\n\n    // redis\n    const ossFiles = await getRedisValueJSON<Qiniu.ItemInfo[]>(\n      cacheKey,\n      [],\n      () => getOSSFiles(prefix)\n    )\n    return ossFiles\n  }\n}\n\nexport default new SuperService()\n","import type { Context } from 'flash-wolves'\nimport { Inject, InjectCtx, Provide } from 'flash-wolves'\nimport fs from 'node:fs'\nimport path from 'node:path'\nimport crypto from 'node:crypto'\nimport sharp from 'sharp'\nimport archiver from 'archiver'\nimport BehaviorService from './behaviorService'\nimport { getTipImageKey } from '@/utils/stringUtil'\nimport type { File } from '@/db/model/file'\nimport {\n  keyToLocalPath,\n  localPathToKey,\n  ensureDir,\n  initDirectories,\n  getFileInfo,\n  createDownloadUrl,\n  getThumbnailPath,\n  getPreviewPath,\n  getThumbnailKey,\n  getPreviewKey,\n  getCompressedPath,\n  getTempPath,\n  type LocalFileInfo,\n} from '@/utils/localFileUtil'\nimport type { FWRequest } from 'flash-wolves'\n\n@Provide()\nexport default class LocalFileService {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  constructor() {\n    // \n    initDirectories()\n  }\n\n  /**\n   *  OSS key\n   */\n  getOssKey(file: File): string {\n    return `easypicker2/${file.task_key || file.taskKey}/${file.hash}/${file.name}`\n  }\n\n  /**\n   *  key\n   */\n  getTipImageKey(key: string, name: string, uid: number): string {\n    return getTipImageKey(key, name, uid)\n  }\n\n  /**\n   * \n   * @param key  key\n   * @param filePath \n   * @returns \n   */\n  async saveFile(key: string, filePath: string): Promise<boolean> {\n    try {\n      const localPath = keyToLocalPath(key)\n      console.log(', key:', key, 'localPath:', localPath, 'sourcePath:', filePath)\n      \n      // \n      if (!fs.existsSync(filePath)) {\n        console.error(':', filePath)\n        return false\n      }\n\n      // \n      ensureDir(path.dirname(localPath))\n      \n      // \n      fs.copyFileSync(filePath, localPath)\n      \n      // \n      if (!fs.existsSync(localPath)) {\n        console.error(':', localPath)\n        return false\n      }\n\n      console.log(', size:', fs.statSync(localPath).size)\n      return true\n    }\n    catch (error) {\n      console.error(':', error, 'key:', key, 'filePath:', filePath)\n      if (this.ctx) {\n        this.behaviorService.error(`:${key}`, String(error))\n      }\n      return false\n    }\n  }\n\n  /**\n   * \n   * @param key  key\n   */\n  deleteObjByKey(key: string): void {\n    try {\n      const localPath = keyToLocalPath(key)\n      if (fs.existsSync(localPath)) {\n        fs.unlinkSync(localPath)\n      }\n      // \n      const thumbnailPath = getThumbnailPath(key)\n      const previewPath = getPreviewPath(key)\n      if (fs.existsSync(thumbnailPath)) {\n        fs.unlinkSync(thumbnailPath)\n      }\n      if (fs.existsSync(previewPath)) {\n        fs.unlinkSync(previewPath)\n      }\n    }\n    catch (error) {\n      console.error(':', error)\n      if (this.ctx) {\n        this.behaviorService.error(`:${key}${error?.message}`, String(error))\n      }\n    }\n  }\n\n  /**\n   * \n   * @param keys  key \n   */\n  batchDeleteFiles(keys: string[]): void {\n    if (!keys.length) {\n      return\n    }\n\n    for (const key of keys) {\n      this.deleteObjByKey(key)\n    }\n\n    if (this.ctx) {\n      this.behaviorService.add('file', ` ${keys.length} `, {\n        count: keys.length,\n        keys,\n      })\n    }\n  }\n\n  /**\n   * \n   * @param prefix \n   */\n  deleteFiles(prefix: string): void {\n    try {\n      const prefixPath = keyToLocalPath(prefix)\n      if (!fs.existsSync(prefixPath)) {\n        return\n      }\n\n      const files = this.listFilesByPrefix(prefix)\n      this.batchDeleteFiles(files.map(f => f.key))\n    }\n    catch (error) {\n      console.error(':', error)\n      if (this.ctx) {\n        this.behaviorService.error(`:${prefix}`, String(error))\n      }\n    }\n  }\n\n  /**\n   * \n   * @param key  key\n   * @returns \n   */\n  async judgeFileIsExist(key: string): Promise<boolean> {\n    const localPath = keyToLocalPath(key)\n    return fs.existsSync(localPath)\n  }\n\n  /**\n   * \n   * @param key  key\n   * @returns \n   */\n  async getFileInfo(key: string): Promise<LocalFileInfo | null> {\n    const localPath = keyToLocalPath(key)\n    return getFileInfo(localPath)\n  }\n\n  /**\n   * \n   * @param keys  key \n   * @returns \n   */\n  async batchFileStatus(keys: string[]): Promise<Array<{ code: number, data?: LocalFileInfo, error?: string }>> {\n    const results = await Promise.all(\n      keys.map(async (key) => {\n        const info = await this.getFileInfo(key)\n        if (info) {\n          return { code: 200, data: info }\n        }\n        return { code: 612, error: '' }\n      }),\n    )\n    return results\n  }\n\n  /**\n   * \n   * @param prefix \n   * @returns \n   */\n  listFilesByPrefix(prefix: string): LocalFileInfo[] {\n    const prefixPath = keyToLocalPath(prefix)\n    const files: LocalFileInfo[] = []\n\n    if (!fs.existsSync(prefixPath)) {\n      return files\n    }\n\n    const listFiles = (dir: string, baseKey: string) => {\n      const items = fs.readdirSync(dir)\n      for (const item of items) {\n        const itemPath = path.join(dir, item)\n        const stats = fs.statSync(itemPath)\n\n        if (stats.isDirectory()) {\n          listFiles(itemPath, `${baseKey}${item}/`)\n        }\n        else {\n          const key = `${baseKey}${item}`\n          const info = getFileInfo(itemPath)\n          if (info) {\n            files.push(info)\n          }\n        }\n      }\n    }\n\n    if (fs.statSync(prefixPath).isDirectory()) {\n      listFiles(prefixPath, prefix)\n    }\n    else {\n      const info = getFileInfo(prefixPath)\n      if (info) {\n        files.push(info)\n      }\n    }\n\n    return files\n  }\n\n  /**\n   *  QiniuService.getFilesMap\n   * @param files \n   * @returns \n   */\n  async getFilesMap(files: File[]): Promise<Map<string, LocalFileInfo>> {\n    const filesMap = new Map<string, LocalFileInfo>()\n    const startTime = Date.now()\n\n    //  easypicker2/ \n    const allFiles = this.listFilesByPrefix('easypicker2/')\n    allFiles.forEach((v) => {\n      filesMap.set(v.key, v)\n    })\n\n    //  ep1 \n    const oldPrefixList = new Set(\n      files\n        .filter(v => v.category_key)\n        .map((v) => {\n          return v.category_key!.split('/')[0]\n        })\n        .filter(v => !v.includes('\"'))\n        .filter(v => !v.startsWith('easypicker2')),\n    )\n\n    for (const prefix of oldPrefixList) {\n      const oldFiles = this.listFilesByPrefix(`${prefix}/`)\n      oldFiles.forEach((v) => {\n        filesMap.set(v.key, v)\n      })\n    }\n\n    const expireTime = Date.now() - startTime\n    this.behaviorService.add('file', ` - ${expireTime}ms`, {\n      time: expireTime,\n    })\n\n    return filesMap\n  }\n\n  /**\n   * \n   * @param key  key\n   * @param width  200\n   * @param height  200\n   * @returns \n   */\n  async generateThumbnail(key: string, width = 200, height = 200): Promise<boolean> {\n    try {\n      const localPath = keyToLocalPath(key)\n      if (!fs.existsSync(localPath)) {\n        return false\n      }\n\n      const thumbnailPath = getThumbnailPath(key)\n      ensureDir(path.dirname(thumbnailPath))\n\n      await sharp(localPath)\n        .resize(width, height, {\n          fit: 'cover',\n          position: 'center',\n        })\n        .jpeg({ quality: 80 })\n        .toFile(thumbnailPath)\n\n      return true\n    }\n    catch (error) {\n      console.error(':', error)\n      return false\n    }\n  }\n\n  /**\n   * \n   * @param key  key\n   * @param maxWidth  1200\n   * @param maxHeight  1200\n   * @returns \n   */\n  async generatePreview(key: string, maxWidth = 1200, maxHeight = 1200): Promise<boolean> {\n    try {\n      const localPath = keyToLocalPath(key)\n      if (!fs.existsSync(localPath)) {\n        return false\n      }\n\n      const previewPath = getPreviewPath(key)\n      ensureDir(path.dirname(previewPath))\n\n      await sharp(localPath)\n        .resize(maxWidth, maxHeight, {\n          fit: 'inside',\n          withoutEnlargement: true,\n        })\n        .jpeg({ quality: 85 })\n        .toFile(previewPath)\n\n      return true\n    }\n    catch (error) {\n      console.error(':', error)\n      return false\n    }\n  }\n\n  /**\n   *  URL\n   * @param key  key\n   * @param type cover  preview\n   * @param expiredTime \n   * @param req \n   * @returns  URL\n   */\n  async getImagePreviewUrl(\n    key: string,\n    type: 'cover' | 'preview',\n    expiredTime: number,\n    req?: FWRequest,\n  ): Promise<string> {\n    const localPath = keyToLocalPath(key)\n    if (!fs.existsSync(localPath)) {\n      return ''\n    }\n\n    // \n    const info = await this.getFileInfo(key)\n    if (!info || !info.mimeType.includes('image')) {\n      return ''\n    }\n\n    // \n    if (type === 'cover') {\n      const thumbnailPath = getThumbnailPath(key)\n      if (!fs.existsSync(thumbnailPath)) {\n        await this.generateThumbnail(key)\n      }\n      const thumbnailKey = getThumbnailKey(key)\n      if (fs.existsSync(thumbnailPath)) {\n        return createDownloadUrl(thumbnailKey, expiredTime, req)\n      }\n    }\n    else {\n      const previewPath = getPreviewPath(key)\n      if (!fs.existsSync(previewPath)) {\n        await this.generatePreview(key)\n      }\n      const previewKey = getPreviewKey(key)\n      if (fs.existsSync(previewPath)) {\n        return createDownloadUrl(previewKey, expiredTime, req)\n      }\n    }\n    return ''\n  }\n\n  /**\n   *  ZIP \n   * @param keys  key \n   * @param zipName \n   * @returns  key\n   */\n  async makeZipWithKeys(keys: string[], zipName: string): Promise<string> {\n    return new Promise((resolve, reject) => {\n      const zipPath = getCompressedPath(`${zipName}.zip`)\n      ensureDir(path.dirname(zipPath))\n\n      const output = fs.createWriteStream(zipPath)\n      const archive = archiver('zip', {\n        zlib: { level: 9 }, // \n      })\n\n      output.on('close', () => {\n        const zipKey = `compressed/${zipName}.zip`\n        resolve(zipKey)\n      })\n\n      archive.on('error', (err) => {\n        reject(err)\n      })\n\n      archive.pipe(output)\n\n      // \n      for (const key of keys) {\n        const localPath = keyToLocalPath(key)\n        if (fs.existsSync(localPath)) {\n          const fileName = path.basename(key)\n          archive.file(localPath, { name: fileName })\n        }\n      }\n\n      archive.finalize()\n    })\n  }\n\n  /**\n   * \n   * @param key  key\n   * @returns \n   */\n  getFileStream(key: string): fs.ReadStream | null {\n    try {\n      const localPath = keyToLocalPath(key)\n      if (fs.existsSync(localPath)) {\n        return fs.createReadStream(localPath)\n      }\n      return null\n    }\n    catch (error) {\n      console.error(':', error)\n      return null\n    }\n  }\n\n  /**\n   *  URL\n   * @param key  key\n   * @param expiredTime \n   * @param req \n   * @returns  URL\n   */\n  getDownloadUrl(key: string, expiredTime: number, req?: FWRequest): string {\n    return createDownloadUrl(key, expiredTime, req)\n  }\n}\n\n","import type { Context } from 'flash-wolves'\nimport { Inject, InjectCtx, Provide } from 'flash-wolves'\nimport { In } from 'typeorm'\nimport { TaskInfoRepository } from '@/db/taskInfoDb'\nimport { TaskRepository } from '@/db/taskDb'\nimport { BehaviorService, LocalFileService } from '@/service'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport type { TaskInfo } from '@/db/entity'\nimport { BOOLEAN } from '@/db/model/public'\nimport { publicError } from '@/constants/errorMsg'\n\n@Provide()\nexport default class TaskInfoService {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(TaskInfoRepository)\n  private taskInfoRepository: TaskInfoRepository\n\n  @Inject(TaskRepository)\n  private taskRepository: TaskRepository\n\n  @Inject(LocalFileService)\n  private localFileService: LocalFileService\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  async getUseFullTemplate(taskKey: string) {\n    const user = this.ctx.req.userInfo\n    const infoList = (\n      await this.taskInfoRepository.findWithSpecifyColumn(\n        {\n          userId: user.id,\n        },\n        ['taskKey', 'info'],\n      )\n    ).filter(v => v.taskKey !== taskKey)\n    if (!infoList.length) {\n      return []\n    }\n\n    const taskInfo = await this.taskRepository.findWithSpecifyColumn(\n      {\n        k: In(infoList.map(v => v.taskKey)),\n      },\n      ['k', 'name'],\n    )\n\n    const data = taskInfo.map((v) => {\n      const { info } = infoList.find(v2 => v2.taskKey === v.k)\n      return {\n        taskKey: v.k,\n        name: v.name,\n        info,\n      }\n    })\n    return data\n  }\n\n  async delTipImage(payload: { uid: number, name: string, key: string }) {\n    const { uid, name, key } = payload\n    const task = await this.taskRepository.findOne({\n      k: key,\n      userId: this.ctx.req.userInfo.id,\n    })\n    if (!task) {\n      throw publicError.request.errorParams\n    }\n    const tipImageKey = this.localFileService.getTipImageKey(key, name, uid)\n    this.behaviorService.add(\n      'taskInfo',\n      `${this.ctx.req.userInfo.account} : ${tipImageKey}`,\n      {\n        tipImageKey,\n      },\n    )\n    this.localFileService.deleteObjByKey(tipImageKey)\n  }\n\n  async getTaskInfo(key: string) {\n    const taskInfo = await this.taskInfoRepository.findOne({\n      taskKey: key,\n    })\n    const {\n      template,\n      rewrite,\n      format,\n      info,\n      shareKey: share,\n      limitPeople: people,\n      tip,\n      bindField,\n    } = taskInfo || {}\n    let { ddl } = taskInfo || {}\n    if (ddl && ddl?.getTime) {\n      ddl = new Date(ddl.getTime() + 8 * 60 * 60 * 1000)\n    }\n    this.taskRepository\n      .findOne({\n        k: key,\n      })\n      .then((task) => {\n        if (task) {\n          this.behaviorService.add(\n            'taskInfo',\n            ` :${task.name} `,\n            {\n              key,\n              name: task.name,\n            },\n          )\n        }\n      })\n\n    return {\n      template,\n      rewrite,\n      format,\n      info,\n      share,\n      ddl,\n      people,\n      tip,\n      bindField,\n    }\n  }\n\n  async updateTaskInfo(payload, key: string) {\n    const { template, rewrite, format, info, ddl, people, tip, bindField }\n      = payload\n    let { share } = payload\n    const { id: userId, account: logAccount } = this.ctx.req.userInfo\n\n    if (share !== undefined) {\n      share = getUniqueKey()\n    }\n    if (!template && template !== undefined) {\n      // \n      this.localFileService.deleteFiles(`easypicker2/${key}_template/`)\n    }\n    const options = {\n      template,\n      rewrite,\n      format,\n      info,\n      ddl,\n      shareKey: share,\n      limitPeople: people,\n      tip,\n      bindField,\n    }\n    if (bindField === '') {\n      options.bindField = undefined\n    }\n    await this.taskInfoRepository.updateSpecifyFields(\n      {\n        taskKey: key,\n        userId,\n      },\n      options,\n    )\n\n    // \n    this.taskRepository.findOne({ k: key }).then((task) => {\n      const [ks] = Object.keys(options).filter(o => options[o] !== undefined)\n      const bType = {\n        template: '',\n        rewrite: '',\n        info: '',\n        ddl: '',\n        limitPeople: '',\n        tip: '',\n        bindField: '',\n      }\n\n      if (task) {\n        this.behaviorService.add(\n          'taskInfo',\n          ` ${bType[ks]} :${logAccount} :${task.name} `,\n          {\n            key,\n            name: task.name,\n            account: logAccount,\n            data: payload,\n          },\n        )\n      }\n    })\n  }\n\n  createTaskInfo(taskInfo: TaskInfo) {\n    const data: Partial<TaskInfo> = {\n      limitPeople: BOOLEAN.FALSE,\n      template: '',\n      rewrite: BOOLEAN.FALSE,\n      format: '',\n      info: JSON.stringify(['']),\n      shareKey: getUniqueKey(),\n      ddl: null,\n    }\n    Object.assign(taskInfo, data)\n\n    return this.taskInfoRepository.insert(taskInfo)\n  }\n}\n","import { OkPacket } from 'mysql'\nimport { Provide } from 'flash-wolves'\nimport { query } from '@/lib/dbConnect/mysql'\nimport {\n  insertTableByModel,\n  selectTableByModel,\n  updateTableByModel\n} from '@/utils/sqlUtil'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport { BOOLEAN } from './model/public'\nimport { TaskInfo } from './model/taskInfo'\nimport { TaskInfo as TaskInfoEntity } from './entity'\nimport { AppDataSource, BaseRepository } from '.'\n\nexport function selectTaskInfo(\n  options: V2Array<TaskInfo>,\n  columns: string[] = []\n) {\n  const { sql, params } = selectTableByModel('task_info', {\n    data: options,\n    columns\n  })\n  return query<TaskInfo[]>(sql, ...params)\n}\n\nexport function insertTaskInfo(taskInfo: TaskInfo) {\n  const data: TaskInfo = {\n    limitPeople: BOOLEAN.FALSE,\n    template: '',\n    rewrite: BOOLEAN.FALSE,\n    format: '',\n    info: JSON.stringify(['']),\n    shareKey: getUniqueKey(),\n    ddl: null,\n    ...taskInfo\n  }\n  const { sql, params } = insertTableByModel('task_info', data)\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function updateTaskInfo(taskInfo: TaskInfo, q: TaskInfo) {\n  const { sql, params } = updateTableByModel('task_info', taskInfo, q)\n  return query<OkPacket>(sql, ...params)\n}\n\n@Provide()\nexport class TaskInfoRepository extends BaseRepository<TaskInfoEntity> {\n  protected repository = AppDataSource.getRepository(TaskInfoEntity)\n\n  protected entityName = TaskInfoEntity.name\n\n  // \n}\n","import mysql from 'mysql'\nimport { mysqlConfig } from '@/config'\nimport LocalUserDB from '@/utils/user-local-db'\n// \nlet pool: mysql.Pool\n\nexport function refreshPool() {\n  const cfg = LocalUserDB.getUserConfigByType('mysql')\n  pool?.end()\n  mysqlConfig.host = cfg.host\n  mysqlConfig.port = cfg.port\n  mysqlConfig.user = cfg.user\n  mysqlConfig.password = cfg.password\n  mysqlConfig.database = cfg.database\n  // \n  pool = mysql.createPool(mysqlConfig)\n  pool.on('error', (err) => {\n    console.log('pool connect error')\n    console.error(err)\n  })\n}\n\nexport function getConnection(): Promise<mysql.PoolConnection> {\n  return new Promise((res, rej) => {\n    pool.getConnection((err, coon) => {\n      if (err) {\n        console.error('------ db connection error -------')\n        console.error(err.message)\n        rej(err)\n        return\n      }\n      res(coon)\n    })\n  })\n}\n\ntype param = string | number\n/**\n * sql\n * @param sql sql\n * @param params \n */\nexport function query<T>(sql: string, ...params: param[]): Promise<T> {\n  return new Promise<T>((resolve, reject) => {\n    getConnection()\n      .then((coon) => {\n        coon.query(sql, params, (err, result) => {\n          if (err) {\n            reject(err)\n            return\n          }\n          // \n          coon.release()\n          resolve(result)\n        })\n      })\n      .catch((err) => {\n        reject(err)\n      })\n  })\n}\n\nexport function getMysqlStatus() {\n  return new Promise<ServiceStatus>((res, rej) => {\n    pool.getConnection((err, coon) => {\n      if (err) {\n        res({\n          errMsg: err.message,\n          type: 'mysql',\n          status: false\n        })\n        return\n      }\n      res({\n        type: 'mysql',\n        status: true\n      })\n      coon.release()\n    })\n  })\n}\n","import { lowCamel2Underscore } from './stringUtil'\n\ninterface SqlData {\n  sql: string\n  params: string[]\n}\ninterface Options {\n  data?: any\n  columns?: string[]\n  limit?: number\n  order?: string\n}\n\nfunction removeUndefKey(obj) {\n  return Object.keys(obj).reduce((pre, k) => {\n    if (obj[k] !== undefined) {\n      pre[k] = obj[k]\n    }\n    return pre\n  }, {})\n}\n\nfunction isObject(data): boolean {\n  return data instanceof Object && typeof data !== 'function'\n}\n\nfunction isOkModel(model) {\n  return isObject(model) && Object.keys(removeUndefKey(model)).length !== 0\n}\n\nexport function selectTableByModel(\n  table: string,\n  options: Options = {}\n): SqlData {\n  const { columns = [], order = '' } = options\n  let { data = {}, limit } = options\n  limit = limit || 0\n  if (!isObject(data)) return { sql: '', params: [] }\n  data = removeUndefKey(data)\n\n  const column = columns.length > 0 ? `${columns.join(',')}` : '*'\n  const keys = Object.keys(data)\n  const where =\n    keys.length > 0\n      ? `where ${keys\n          .map((key) => createWhereSql(key, data[key]))\n          .join(' and ')}`\n      : ''\n  const values = keys.map((key) => data[key]).flat()\n  const limitStr =\n    typeof limit === 'number' && limit > 0 ? `limit ${Math.ceil(limit)}` : ''\n  const sql =\n    `select ${column} from ${table} ${where} ${order} ${limitStr}`.trim()\n  return {\n    sql,\n    params: values\n  }\n}\n\nexport function deleteTableByModel(table: string, model: unknown): SqlData {\n  if (!isOkModel(model)) return { sql: '', params: [] }\n  model = removeUndefKey(model)\n\n  const keys = Object.keys(model)\n  const where = `where ${keys\n    .map((key) => createWhereSql(key, model[key]))\n    .join(' and ')}`\n  const values = keys.map((key) => model[key]).flat()\n  const sql = `delete from ${table} ${where}`.trim()\n  return {\n    sql,\n    params: values\n  }\n}\n\nexport function insertTableByModel(table: string, model: unknown): SqlData {\n  if (!isOkModel(model)) return { sql: '', params: [] }\n  model = removeUndefKey(model)\n\n  const keys = Object.keys(model)\n  const values = keys.map((key) => model[key])\n\n  const sql = `insert into ${table} (${keys\n    .map(lowCamel2Underscore)\n    .join(',')}) values (${new Array(keys.length).fill('?').join(',')})`\n  return {\n    sql,\n    params: values\n  }\n}\n\nexport function insertTableByModelMany(\n  table: string,\n  model: unknown[]\n): SqlData {\n  if (model.length === 0 || !isOkModel(model[0])) return { sql: '', params: [] }\n  const keys = Object.keys(model[0])\n\n  const values = model.reduce<string[]>(\n    (pre, value) => pre.concat(keys.map((key) => value[key])),\n    []\n  )\n  const sqlValues = `values ${Array.from({ length: model.length })\n    .map(() => `(${new Array(keys.length).fill('?').join(',')})`)\n    .join(',')}`\n  const sql = `insert into ${table} (${keys\n    .map(lowCamel2Underscore)\n    .join(',')}) ${sqlValues}`\n  return {\n    sql,\n    params: values\n  }\n}\n\nexport function updateTableByModel(\n  table: string,\n  model: unknown,\n  query: unknown\n): SqlData {\n  if (!isOkModel(model) || !isOkModel(query)) return { sql: '', params: [] }\n  model = removeUndefKey(model)\n  query = removeUndefKey(query)\n\n  const updateModelKeys = Object.keys(model)\n  let values = updateModelKeys.map((key) => model[key])\n  const queryModelKeys = Object.keys(query)\n  values = values.concat(queryModelKeys.map((key) => query[key]).flat())\n\n  const where = `where ${queryModelKeys\n    .map((key) => createWhereSql(key, query[key]))\n    .join(' and ')}`\n  const sql = `update ${table} set ${updateModelKeys\n    .map((key) => `${lowCamel2Underscore(key)} = ?`)\n    .join(',')} ${where}`\n  return {\n    sql,\n    params: values\n  }\n}\n\nexport function createWhereSql(k, v) {\n  if (!isObject(v)) {\n    return `${lowCamel2Underscore(k)} = ?`\n  }\n  if (Array.isArray(v)) {\n    return `${lowCamel2Underscore(k)} in (${Array.from({ length: v.length })\n      .fill('?')\n      .join(',')})`\n  }\n  throw new Error('not support Object')\n}\n","export enum BOOLEAN {\n  FALSE,\n  TRUE\n}\n","import { Column, Entity, PrimaryGeneratedColumn } from 'typeorm'\n\n@Entity('user')\nexport class User {\n  @PrimaryGeneratedColumn({ type: 'int', comment: '' })\n  id: number\n\n  @Column('varchar', { length: 64, nullable: true, comment: '' })\n  account: string\n\n  @Column('varchar', {\n    length: 128,\n    nullable: true,\n    comment: '',\n    name: 'email',\n  })\n  email: string\n\n  @Column('varchar', { length: 256, comment: '' })\n  password: string\n\n  @Column('tinyint', { default: 6, comment: '' })\n  power: number\n\n  @Column('tinyint', { default: 0, comment: '' })\n  status: number\n\n  @Column('timestamp', {\n    default: 'CURRENT_TIMESTAMP',\n    comment: '',\n    name: 'join_time',\n  })\n  joinTime: Date\n\n  @Column('timestamp', {\n    nullable: true,\n    comment: '',\n    name: 'login_time',\n  })\n  loginTime: Date\n\n  @Column('int', { default: 1, comment: '', name: 'login_count' })\n  loginCount: number\n\n  @Column('timestamp', {\n    nullable: true,\n    comment: '',\n    name: 'open_time',\n  })\n  openTime: Date\n\n  @Column('int', { default: 2, comment: 'GB' })\n  size: number\n\n  @Column({ type: 'decimal', precision: 10, scale: 2 })\n  wallet: string\n}\n","import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm'\n\n@Entity('category')\nexport class Category {\n  @PrimaryGeneratedColumn({ type: 'int', unsigned: true, comment: '' })\n  id: number\n\n  @Column('varchar', { length: 256, comment: '' })\n  name: string\n\n  @Column('int', { name: 'user_id', comment: '' })\n  userId: number\n\n  @Column('varchar', {\n    length: 128,\n    comment: ''\n  })\n  k: string\n\n  // @Column('tinyint', { default: 0 })\n  // del: number\n}\n","import { Column, Entity, PrimaryGeneratedColumn, UpdateDateColumn } from 'typeorm'\n\n@Entity('files')\nexport class Files {\n  @PrimaryGeneratedColumn({ type: 'int' })\n  id: number\n\n  @Column('varchar', { length: 256, name: 'task_key', comment: '' })\n  taskKey: string\n\n  @Column('varchar', {\n    length: 256,\n    name: 'task_name',\n    comment: '',\n  })\n  taskName: string\n\n  @Column('varchar', { length: 256, name: 'category_key', comment: '' })\n  categoryKey: string\n\n  @Column('int', { name: 'user_id', comment: '' })\n  userId: number\n\n  @Column('varchar', { length: 1024, name: 'name', comment: '' })\n  name: string\n\n  @Column('varchar', { length: 10240, nullable: true, comment: '' })\n  info: string | null\n\n  @Column('varchar', { length: 512, comment: 'hash' })\n  hash: string\n\n  @Column('timestamp', {\n    comment: '',\n    default: () => 'CURRENT_TIMESTAMP',\n  })\n  date: Date\n\n  @Column('bigint', { comment: '' })\n  size: number\n\n  @Column('varchar', { length: 256, nullable: true, comment: '' })\n  people: string | null\n\n  @Column('varchar', {\n    length: 1024,\n    default: '',\n    name: 'origin_name',\n    comment: '',\n  })\n  originName: string\n\n  @Column('tinyint', { default: 0, comment: '' })\n  del: number\n\n  @Column('timestamp', { name: 'oss_del_time', nullable: true, comment: 'OSS' })\n  ossDelTime: Date | null\n\n  @Column('timestamp', { name: 'del_time', nullable: true, comment: '' })\n  delTime: Date | null\n\n  @UpdateDateColumn({ name: 'last_update_time', comment: '' })\n  lastUpdateTime: Date\n}\n","import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm'\n\n@Entity('people')\nexport class People {\n  @PrimaryGeneratedColumn({ type: 'int' })\n  id: number\n\n  @Column('varchar', { length: 128, name: 'task_key', comment: 'id' })\n  taskKey: string\n\n  @Column('int', { name: 'user_id', comment: 'id' })\n  userId: number\n\n  @Column('varchar', { length: 128, nullable: true, comment: '' })\n  name: string | null\n\n  @Column('tinyint', { comment: '', default: 0 })\n  status: number\n\n  @Column('timestamp', {\n    comment: '',\n    name: 'submit_date',\n    default: () => 'CURRENT_TIMESTAMP'\n  })\n  submitDate: Date\n\n  @Column('int', {\n    name: 'submit_count',\n    default: 0,\n    comment: ''\n  })\n  submitCount: number\n}\n","import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm'\n\n@Entity('task')\nexport class Task {\n  @PrimaryGeneratedColumn({ type: 'int', comment: '' })\n  id: number\n\n  @Column('int', { name: 'user_id', comment: 'id' })\n  userId: number\n\n  @Column('varchar', {\n    length: 128,\n    name: 'category_key',\n    comment: 'key'\n  })\n  categoryKey: string\n\n  @Column('varchar', { length: 256, comment: '' })\n  name: string\n\n  @Column('varchar', { length: 128, comment: '' })\n  k: string\n\n  @Column('tinyint', { default: 0, comment: '' })\n  del: number\n}\n","import { Entity, PrimaryGeneratedColumn, Column } from 'typeorm'\n\n@Entity('task_info')\nexport class TaskInfo {\n  @PrimaryGeneratedColumn({ type: 'int' })\n  id: number\n\n  @Column('int', { name: 'user_id', comment: 'user_id' })\n  userId: number\n\n  @Column('varchar', {\n    length: 256,\n    name: 'task_key',\n    comment: 'key'\n  })\n  taskKey: string\n\n  @Column('varchar', { length: 1024, nullable: true, comment: '' })\n  template: string | null\n\n  @Column('tinyint', { comment: '', default: 0 })\n  rewrite: number\n\n  @Column('varchar', { length: 1024, nullable: true, comment: '' })\n  format: string | null\n\n  @Column('varchar', {\n    length: 10240,\n    nullable: true,\n    comment: '()'\n  })\n  info: string | null\n\n  @Column('timestamp', { nullable: true, comment: '' })\n  ddl: Date | null\n\n  @Column('varchar', {\n    name: 'share_key',\n    length: 128,\n    comment: ''\n  })\n  shareKey: string\n\n  @Column('tinyint', {\n    name: 'limit_people',\n    comment: '',\n    default: 0\n  })\n  limitPeople: number\n\n  @Column('varchar', {\n    name: 'bind_field',\n    length: 255,\n    comment: '',\n    default: ''\n  })\n  bindField: string\n\n  @Column('text', { nullable: true })\n  tip: string\n}\n","import { User } from './User'\nimport { Category } from './Category'\nimport { Files } from './Files'\nimport { People } from './People'\nimport { Task } from './Task'\nimport { TaskInfo } from './TaskInfo'\n\nexport { User, Category, Files, People, Task, TaskInfo }\n\nexport const entities = [User, Category, Files, People, Task, TaskInfo]\n","import process from 'node:process'\nimport type {\n  FindManyOptions,\n  FindOneOptions,\n  FindOptionsOrder,\n  FindOptionsWhere,\n  Repository,\n} from 'typeorm'\nimport {\n  DataSource,\n} from 'typeorm'\nimport type { QueryDeepPartialEntity } from 'typeorm/query-builder/QueryPartialEntity'\nimport { entities } from './entity'\nimport LocalUserDB from '@/utils/user-local-db'\n// eslint-disable-next-line import/no-mutable-exports\nexport let AppDataSource: DataSource\n\nexport async function initTypeORM() {\n  const cfg = LocalUserDB.getUserConfigByType('mysql')\n  AppDataSource = new DataSource({\n    type: 'mysql',\n    host: cfg.host,\n    port: cfg.port,\n    username: cfg.user,\n    password: cfg.password,\n    database: cfg.database,\n    entities,\n    synchronize: false,\n    logging: process.env.NODE_ENV === 'development',\n  })\n\n  await AppDataSource.initialize()\n}\n\n/**\n * Repository\n */\nexport class BaseRepository<T> {\n  protected repository: Repository<T>\n\n  protected entityName: string\n\n  findOne(where: FindOneOptions<T>['where']) {\n    return this.repository.findOne({\n      where,\n    })\n  }\n\n  findMany(where: FindManyOptions<T>['where'], ops?: FindManyOptions<T>) {\n    return this.repository.find({\n      where,\n      ...ops,\n    })\n  }\n\n  findWithSpecifyColumn(\n    where: FindOneOptions<T>['where'],\n    columns: (keyof T)[],\n  ) {\n    return this.repository\n      .createQueryBuilder(this.entityName)\n      .select(columns.map(v => `${this.entityName}.${String(v)}`))\n      .where(where)\n      .getMany()\n  }\n\n  findWithLimitCount(\n    where: FindOneOptions<T>['where'],\n    limit: number,\n    order?: FindOptionsOrder<T>,\n  ) {\n    return this.repository.find({\n      where,\n      take: limit,\n      order,\n    })\n  }\n\n  insert(options: T) {\n    return this.repository.save(options)\n  }\n\n  update(options: T) {\n    return this.repository.save(options)\n  }\n\n  insertMany(options: T[]) {\n    return this.repository.save(options)\n  }\n\n  updateSpecifyFields(\n    where: FindOneOptions<T>['where'],\n    value: QueryDeepPartialEntity<T>,\n  ) {\n    return this.repository\n      .createQueryBuilder(this.entityName)\n      .update()\n      .set(value)\n      .where(where)\n      .execute()\n  }\n\n  delete(options: FindOptionsWhere<T>) {\n    return this.repository.delete(options)\n  }\n\n  count(where: FindOptionsWhere<T>) {\n    return this.repository.count({\n      where,\n    })\n  }\n}\n","import { OkPacket } from 'mysql'\nimport { Provide } from 'flash-wolves'\nimport { query } from '@/lib/dbConnect/mysql'\nimport {\n  deleteTableByModel,\n  insertTableByModel,\n  selectTableByModel,\n  updateTableByModel\n} from '@/utils/sqlUtil'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport { Task } from './model/task'\nimport { insertTaskInfo } from './taskInfoDb'\nimport { AppDataSource, BaseRepository } from '.'\nimport { Task as TaskEntity } from './entity'\n\nexport function insertTask(task: Task) {\n  const data = { k: getUniqueKey(), ...task }\n  const { sql, params } = insertTableByModel('task', data)\n  // \n  insertTaskInfo({\n    taskKey: data.k,\n    userId: data.userId\n  })\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function selectTasks(options: V2Array<Task>, columns: string[] = []) {\n  const { sql, params } = selectTableByModel('task', {\n    data: options,\n    columns\n  })\n  return query<Task[]>(sql, ...params)\n}\n\nexport function deleteTask(task: Task) {\n  const { sql, params } = deleteTableByModel('task', task)\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function updateTask(task: Task, q: Task) {\n  const { sql, params } = updateTableByModel('task', task, q)\n  return query<OkPacket>(sql, ...params)\n}\n\n@Provide()\nexport class TaskRepository extends BaseRepository<TaskEntity> {\n  protected repository = AppDataSource.getRepository(TaskEntity)\n\n  protected entityName = TaskEntity.name\n}\n","import { codeMsg } from '.'\n\nexport const UserError = {\n  email: {\n    fault: codeMsg(1006, 'Email is not valid'),\n    exist: codeMsg(1002, 'Email already exist'),\n    noExist: codeMsg(1008, 'Email not exist'),\n  },\n  account: {\n    exist: codeMsg(1001, 'Account already exist'),\n    notExist: codeMsg(1005, 'Account not exist'),\n    fault: codeMsg(1007, 'Account is fault'),\n    freeze: codeMsg(1009, 'Account is freeze'),\n    ban: codeMsg(1010, 'Account is ban'),\n    bindEmail: codeMsg(1012, 'Please bind email'),\n  },\n  code: {\n    fault: codeMsg(1003, 'Error code'),\n  },\n  pwd: {\n    fault: codeMsg(1004, 'error pwd'),\n  },\n  system: {\n    ban: codeMsg(1011, 'The system prohibits new user registration'),\n  },\n}\n\nexport const CategoryError = {\n  exist: codeMsg(2001, 'category already exist'),\n}\n\nexport const publicError = {\n  file: {\n    notSupport: codeMsg(3001, 'file type is not support'),\n    notExist: codeMsg(3003, 'file not exist'),\n  },\n  request: {\n    errorParams: codeMsg(3002, 'error request params'),\n    notLogin: codeMsg(3004, 'user not login'),\n  },\n}\n\nexport const taskError = {\n  noExist: codeMsg(4001, 'task not exist'),\n}\n\nexport const fileError = {\n  noPower: codeMsg(5001, 'no power'),\n  noOssFile: codeMsg(5002, 'no oss file'),\n  ossFileRepeat: codeMsg(5003, 'oss file repeat'),\n}\n\nexport const peopleError = {\n  exist: codeMsg(6001, 'already exist'),\n}\n","import process from 'node:process'\nimport { Provide } from 'flash-wolves'\nimport { User } from '@/db/entity'\nimport { encryption } from '@/utils/stringUtil'\nimport { expiredRedisKey, getRedisVal, setRedisValue } from '@/db/redisDb'\nimport { AppDataSource } from '@/db'\nimport { USER_STATUS } from '@/db/model/user'\nimport { throttle } from '@/utils'\n\n@Provide()\nexport default class TokenService {\n  realToken(token) {\n    return process.env.TOKEN_PREFIX + token\n  }\n\n  onlineTokenKey(account) {\n    return `${process.env.TOKEN_PREFIX}-online-${account}`\n  }\n\n  async createTokenByUser(user: User, timeout = 60 * 60 * 24 * 7) {\n    const { account, power } = user\n    const token = encryption([account, power, Date.now()].join())\n    const realToken = this.realToken(token)\n    // \n    setRedisValue(realToken, JSON.stringify(user), timeout)\n    // \n    const onlineTokens = await this.getAllTokens(account)\n    onlineTokens.push(realToken)\n    setRedisValue(this.onlineTokenKey(account), JSON.stringify(onlineTokens))\n    return token\n  }\n\n  expiredToken(token: string) {\n    console.log('token', token)\n    expiredRedisKey(this.realToken(token))\n  }\n\n  expiredRedisKey(key: string) {\n    expiredRedisKey(key)\n  }\n\n  async getAllTokens(account: string): Promise<string[]> {\n    const onlineTokenKey = this.onlineTokenKey(account)\n    const str = await getRedisVal(onlineTokenKey)\n    try {\n      if (str) {\n        return JSON.parse(str)\n      }\n      return []\n    }\n    catch (e) {\n      return []\n    }\n  }\n\n  async getUserInfo(token: string): Promise<User> {\n    if (!token) {\n      return null\n    }\n    const v = await getRedisVal(this.realToken(token))\n    if (v) {\n      return JSON.parse(v)\n    }\n    return null\n  }\n\n  // TODO: token\n  async refreshToken(token: string, timeout = 60 * 60 * 24 * 7) {\n    const user = await this.getUserInfo(token)\n    setRedisValue(this.realToken(token), JSON.stringify(user), timeout)\n  }\n\n  setVerifyCode(identifier: string, code: string, timeout = 60 * 2) {\n    setRedisValue(\n      `${process.env.TOKEN_PREFIX}-code-${identifier}`,\n      code,\n      timeout,\n    )\n  }\n\n  getVerifyCode(identifier: string) {\n    return getRedisVal(`${process.env.TOKEN_PREFIX}-code-${identifier}`)\n  }\n\n  expiredVerifyCode(identifier: string) {\n    return expiredRedisKey(`${process.env.TOKEN_PREFIX}-code-${identifier}`)\n  }\n\n  /**\n   * token\n   */\n  createToken(user: User, timeout = 60 * 60 * 24 * 7) {\n    const { account, power } = user\n    const token = encryption([account, power, Date.now()].join())\n    setRedisValue(this.realToken(token), JSON.stringify(user), timeout)\n    return token\n  }\n\n  checkOnlineUser = throttle(async (cacheUser: User, token: string) => {\n    // \n    const userInfo = await AppDataSource.manager.findOne(User, {\n      where: {\n        id: cacheUser.id,\n      },\n    })\n    // \n    if (!userInfo) {\n      this.expiredToken(token)\n      return\n    }\n    const onlineTokens = await this.getAllTokens(userInfo.account)\n    // \n    if ([USER_STATUS.BAN, USER_STATUS.FREEZE].includes(userInfo.status)) {\n      this.expiredToken(token)\n      // token\n      console.log('', userInfo.account, 'token')\n      onlineTokens.forEach((token) => {\n        expiredRedisKey(token)\n      })\n      return\n    }\n\n    // token\n    const values = await Promise.all(\n      onlineTokens.map(token => getRedisVal(token)),\n    )\n    const newTokenList = onlineTokens.filter((_, idx) => {\n      return values[idx]\n    })\n    if (newTokenList.length !== onlineTokens.length) {\n      setRedisValue(\n        this.onlineTokenKey(userInfo.account),\n        JSON.stringify(newTokenList),\n      )\n    }\n  }, 500)\n\n  async checkAllToken(onlineTokens: string[], account: string) {\n    // token\n    const values = await Promise.all(\n      onlineTokens.map(token => getRedisVal(token)),\n    )\n    const newTokenList = onlineTokens.filter((_, idx) => {\n      return values[idx]\n    })\n    if (newTokenList.length !== onlineTokens.length) {\n      await setRedisValue(\n        this.onlineTokenKey(account),\n        JSON.stringify(newTokenList),\n      )\n    }\n  }\n}\n","/**\n * \n */\nexport enum USER_POWER {\n  /**\n   * \n   */\n  NORMAL = 6,\n  /**\n   * \n   */\n  SUPER = 0,\n  /**\n   * \n   */\n  SYSTEM\n}\n\n/**\n * \n */\nexport enum USER_STATUS {\n  /**\n   * \n   */\n  NORMAL,\n  /**\n   * \n   */\n  FREEZE,\n  /**\n   * \n   */\n  BAN\n}\n\nexport interface User {\n  id?: number\n  account?: string\n  email?: string\n  /**\n   * @deprecated  email \n   */\n  phone?: string\n  password?: string\n  power?: USER_POWER\n  status?: USER_STATUS\n  join_time?: Date\n  joinTime?: Date\n  login_time?: Date\n  /**\n   * \n   */\n  loginTime?: Date\n  open_time?: Date\n  /**\n   * \n   */\n  openTime?: Date\n  login_count?: number\n  loginCount?: number\n  /**\n   * GB\n   */\n  size?: number\n  wallet?: number\n}\n","export function throttle(func, delay: number) {\n  const timers = {}\n\n  return function (flag, ...args) {\n    if (!timers[flag]) {\n      func.apply(this, args)\n      timers[flag] = setTimeout(() => {\n        delete timers[flag]\n      }, delay)\n    }\n  }\n}\n","/* eslint-disable no-throw-literal */\nimport { Inject, Provide } from 'flash-wolves'\nimport { UserError } from '@/constants/errorMsg'\nimport { UserRepository } from '@/db/userDb'\nimport { rAccount, rEmail, rPassword } from '@/utils/regExp'\nimport { encryption, formatDate, getUniqueKey } from '@/utils/stringUtil'\nimport { User } from '@/db/entity'\nimport { BehaviorService, TokenService } from '@/service'\nimport { USER_STATUS } from '@/db/model/user'\nimport { randomNumStr } from '@/utils/randUtil'\nimport LocalUserDB from '@/utils/user-local-db'\n\n@Provide()\nexport default class UserService {\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(UserRepository)\n  private userRepository: UserRepository\n\n  @Inject(TokenService)\n  private tokenService: TokenService\n\n  async register(payload: any) {\n    const {\n      account,\n      pwd,\n      bindEmail,\n      email,\n      code,\n    } = payload\n    const { needBindEmail } = LocalUserDB.getSiteConfig()\n    // \n    if (needBindEmail && !bindEmail) {\n      throw UserError.account.bindEmail\n    }\n\n    // TODOzod\n    if (!rAccount.test(account)) {\n      this.behaviorService.add('user', ` :${account} `, {\n        account,\n      })\n      throw UserError.account.fault\n    }\n    if (!rPassword.test(pwd)) {\n      this.behaviorService.add(\n        'user',\n        ` :${account} `,\n        {\n          account,\n        },\n      )\n      throw UserError.pwd.fault\n    }\n    // \n    let user = await this.userRepository.findOne({ account })\n    // \n    if (rEmail.test(account) && !user) {\n      user = await this.userRepository.findOne({ email: account })\n    }\n    // \n    if (user) {\n      this.behaviorService.add('user', ` :${account} `, {\n        account,\n      })\n      throw UserError.account.exist\n    }\n\n    // \n    if (bindEmail) {\n      if (!rEmail.test(email)) {\n        this.behaviorService.add(\n          'user',\n          ` :${email} `,\n          {\n            email,\n          },\n        )\n        throw UserError.email.fault\n      }\n      const rightCode = await this.tokenService.getVerifyCode(email)\n      if (!code || code !== rightCode) {\n        this.behaviorService.add('user', ` :${code}`, {\n          code,\n          rightCode,\n        })\n        throw UserError.code.fault\n      }\n      // \n      user = await this.userRepository.findOne({ email })\n      // \n      if (!user) {\n        user = await this.userRepository.findOne({ account: email })\n      }\n      // \n      if (user) {\n        this.behaviorService.add('user', ` :${email} `)\n        throw UserError.email.exist\n      }\n      // \n      this.tokenService.expiredToken(email)\n    }\n\n    this.behaviorService.add(\n      'user',\n      ` :${account} :${bindEmail ? '' : ''} `,\n      {\n        account,\n        bindEmail,\n      },\n    )\n    // \n    const u = new User()\n    u.account = account\n    u.password = encryption(pwd)\n    if (bindEmail) {\n      u.email = email\n    }\n\n    return this.userRepository.insert(u)\n  }\n\n  async login(account: string, pwd: string) {\n    const isEmail = rEmail.test(account)\n    // \n    if (!rPassword.test(pwd)) {\n      this.behaviorService.add(\n        'user',\n        ` :${account} `,\n        {\n          account,\n        },\n      )\n\n      throw UserError.pwd.fault\n    }\n    // \n\n    // \n    let user = await this.userRepository.findOne({ account })\n    // &&\n    if (!user && !isEmail) {\n      this.behaviorService.add('user', ` :${account} `, {\n        account,\n      })\n      throw UserError.account.fault\n    }\n\n    // &&\n    if (!user && isEmail) {\n      user = await this.userRepository.findOne({ email: account })\n    }\n    if (!user) {\n      this.behaviorService.add('user', ` :${account} `, {\n        account,\n      })\n\n      throw isEmail ? UserError.email.fault : UserError.account.fault\n    }\n    if (user.password !== encryption(pwd)) {\n      this.behaviorService.add('user', ` :${account} `, {\n        account,\n      })\n\n      throw UserError.pwd.fault\n    }\n    this.checkUserStatus(user)\n    this.behaviorService.add('user', ` :${account} `, {\n      account,\n    })\n    return this.userRepository.update(user)\n  }\n\n  async loginByCode(email: string, code: string) {\n    if (!rEmail.test(email)) {\n      throw UserError.email.fault\n    }\n    const maskedEmail = email?.replace(\n      /(.{2}).+(@.+)/,\n      (_, prefix, suffix) => `${prefix}***${suffix}`,\n    )\n    const v = await this.tokenService.getVerifyCode(email)\n    if (code !== v) {\n      this.behaviorService.add('user', ` :${code}`, {\n        code,\n        rightCode: v,\n      })\n      throw UserError.code.fault\n    }\n    const user = await this.userRepository.findOne({ email })\n\n    if (!user) {\n      this.behaviorService.add('user', ` :${maskedEmail} `, {\n        email: maskedEmail,\n      })\n      throw UserError.email.noExist\n    }\n\n    this.checkUserStatus(user)\n    this.behaviorService.add('user', ` :${maskedEmail} `, {\n      email: maskedEmail,\n    })\n    this.tokenService.expiredVerifyCode(email)\n    return this.userRepository.update(user)\n  }\n\n  async updatePassword(payload) {\n    const { code, email, pwd } = payload\n\n    const maskedEmail = email?.replace(\n      /(.{2}).+(@.+)/,\n      (_, prefix, suffix) => `${prefix}***${suffix}`,\n    )\n    const v = await this.tokenService.getVerifyCode(email)\n    if (code !== v) {\n      this.behaviorService.add(\n        'user',\n        ` :${maskedEmail} : ${code}`,\n        {\n          email: maskedEmail,\n          code,\n          rightCode: v,\n        },\n      )\n      throw UserError.code.fault\n    }\n    const user = await this.userRepository.findOne({ email })\n\n    if (!user) {\n      this.behaviorService.add('user', ` :${maskedEmail} `, {\n        email: maskedEmail,\n      })\n      throw UserError.email.noExist\n    }\n    if (!rPassword.test(pwd)) {\n      this.behaviorService.add(\n        'user',\n        ` :${maskedEmail} `,\n        {\n          email: maskedEmail,\n        },\n      )\n      throw UserError.pwd.fault\n    }\n    user.password = encryption(pwd)\n    this.tokenService.expiredVerifyCode(email)\n    this.behaviorService.add('user', ` :${maskedEmail} `, {\n      email: maskedEmail,\n    })\n\n    this.checkUserStatus(user)\n    return this.userRepository.update(user)\n  }\n\n  /**\n   * \n   */\n  checkUserStatus(user: User) {\n    const { account } = user\n    // \n    if (user.status === USER_STATUS.BAN) {\n      this.behaviorService.add(\n        'user',\n        ` :${account} `,\n        {\n          account,\n        },\n      )\n\n      throw UserError.account.ban\n    }\n    if (user.status === USER_STATUS.FREEZE) {\n      const openDate = new Date(user.openTime)\n      if (openDate.getTime() > Date.now()) {\n        this.behaviorService.add(\n          'user',\n          ` :${account}  ${formatDate(\n            openDate,\n          )}`,\n          {\n            account,\n            openDate,\n          },\n        )\n        throw {\n          code: UserError.account.freeze.code,\n          msg: UserError.account.freeze.msg,\n          data: {\n            openTime: user.openTime,\n          },\n        }\n      }\n      user.status = USER_STATUS.NORMAL\n      user.openTime = null\n    }\n\n    // \n    user.loginCount += 1\n    user.loginTime = new Date()\n  }\n}\n","import type { OkPacket } from 'mysql'\nimport { Provide } from 'flash-wolves'\nimport type { User } from './model/user'\nimport { USER_STATUS } from './model/user'\nimport { User as UserEntity } from './entity'\nimport { AppDataSource, BaseRepository } from './index'\nimport { query } from '@/lib/dbConnect/mysql'\nimport {\n  insertTableByModel,\n  selectTableByModel,\n  updateTableByModel,\n} from '@/utils/sqlUtil'\n\nexport function selectUserByAccount(account: string): Promise<User[]> {\n  const { sql, params } = selectTableByModel('user', {\n    data: {\n      account,\n    },\n  })\n  return query<User[]>(sql, ...params)\n}\n\nexport function selectUserByEmail(email: string): Promise<User[]> {\n  const { sql, params } = selectTableByModel('user', {\n    data: {\n      email,\n    },\n  })\n  return query<User[]>(sql, ...params)\n}\n\nexport function selectUserById(id: number): Promise<User[]> {\n  const { sql, params } = selectTableByModel('user', {\n    data: {\n      id,\n    },\n  })\n  return query<User[]>(sql, ...params)\n}\n\nfunction mapUserToDbPayload(options: User) {\n  const payload = { ...options }\n  delete payload.phone\n  return payload\n}\n\nexport function insertUser(options: User): Promise<OkPacket> {\n  const { sql, params } = insertTableByModel('user', {\n    status: USER_STATUS.NORMAL,\n    ...mapUserToDbPayload(options),\n  })\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function updateUser(options: User, q: User): Promise<OkPacket> {\n  const { sql, params } = updateTableByModel(\n    'user',\n    mapUserToDbPayload(options),\n    mapUserToDbPayload(q),\n  )\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function selectAllUser(columns: string[]): Promise<User[]> {\n  const { sql, params } = selectTableByModel('user', {\n    data: {},\n    columns,\n    order: 'order by id desc',\n  })\n  return query<User[]>(sql, ...params)\n}\n\n@Provide()\nexport class UserRepository extends BaseRepository<UserEntity> {\n  protected repository = AppDataSource.getRepository(UserEntity)\n\n  protected entityName = UserEntity.name\n}\n","// \nexport const rEmail =\n  /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\\.[a-zA-Z]{2,}$/\n\n// \nexport const rAccount = /^(\\d|[a-zA-Z]){4,11}$/\n\n//  ///(6-16)\nexport const rPassword = /^[a-zA-Z0-9_-]{6,16}$/\n\n// \nexport const rVerCode = /^\\d{4}/\n\n// \nexport const rIdCard =\n  /^[1-9]\\d{5}(18|19|20)\\d{2}((0[1-9])|(1[0-2]))(([0-2][1-9])|10|20|30|31)\\d{3}[0-9Xx]$/\n","import type { Context } from 'flash-wolves'\nimport { Inject, InjectCtx, Provide } from 'flash-wolves'\nimport FileService from './fileService'\nimport { TaskRepository } from '@/db/taskDb'\nimport type { Task } from '@/db/entity'\nimport { TaskInfo } from '@/db/entity'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport { BehaviorService, TaskInfoService } from '@/service'\nimport { BOOLEAN } from '@/db/model/public'\nimport { taskError } from '@/constants/errorMsg'\n\n@Provide()\nexport default class TaskService {\n  @InjectCtx()\n  private Ctx: Context\n\n  @Inject(TaskRepository)\n  private taskRepository: TaskRepository\n\n  @Inject(TaskInfoService)\n  private taskInfoService: TaskInfoService\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(FileService)\n  private fileService: FileService\n\n  async createTask(task: Task) {\n    task.k = getUniqueKey()\n    // taskInfo\n    const taskInfo = new TaskInfo()\n    taskInfo.taskKey = task.k\n    taskInfo.userId = task.userId\n    await this.taskInfoService.createTaskInfo(taskInfo)\n    await this.taskRepository.insert(task)\n  }\n\n  async getTasks(userId: number, account: string) {\n    const data = await this.taskRepository.findWithSpecifyColumn(\n      {\n        userId,\n        del: BOOLEAN.FALSE,\n      },\n      ['name', 'categoryKey', 'k'],\n    )\n\n    const tasks = data.map((t) => {\n      const { name, categoryKey: category, k: key } = t\n      return {\n        name,\n        category,\n        key,\n        recentLog: [],\n      }\n    })\n    const recentSubmitLogCount = 4\n    for (const t of tasks) {\n      const files = await this.fileService.selectFilesLimitCount(\n        {\n          taskKey: t.key,\n        },\n        recentSubmitLogCount,\n      )\n\n      t.recentLog = files.map(v => ({ filename: v.name, date: v.date }))\n    }\n\n    this.behaviorService.add('task', ` :${account}`, {\n      account,\n    })\n\n    return { tasks }\n  }\n\n  async getTaskByKey(key: string) {\n    const task = await this.taskRepository.findOne({\n      k: key,\n      del: BOOLEAN.FALSE,\n    })\n\n    if (!task) {\n      this.behaviorService.add('task', ', ', {\n        key,\n      })\n      throw taskError.noExist\n    }\n    this.behaviorService.add('task', `, ${task.name}`, {\n      name: task.name,\n    })\n\n    return {\n      name: task.name,\n      category: task.categoryKey,\n      userId: task.userId,\n    }\n  }\n\n  async delTask(key: string) {\n    const { id, account: logAccount } = this.Ctx.req.userInfo\n    const task = await this.taskRepository.findOne({\n      userId: id,\n      k: key,\n      del: BOOLEAN.FALSE,\n    })\n\n    if (task) {\n      // \n      if (task.categoryKey !== 'trash') {\n        task.categoryKey = 'trash'\n      }\n      else {\n        // \n        task.del = BOOLEAN.TRUE\n      }\n      await this.taskRepository.update(task)\n    }\n\n    // \n    const logTaskName = task?.name\n    this.behaviorService.add(\n      'task',\n      ` :${logAccount} :${logTaskName}`,\n      {\n        account: logAccount,\n        name: logTaskName,\n      },\n    )\n  }\n\n  async updateTask(key: string, payload: { name?: string, category?: string }) {\n    const { name, category } = payload\n    const { id, account: logAccount } = this.Ctx.req.userInfo\n\n    const task = await this.taskRepository.findOne({\n      userId: id,\n      k: key,\n    })\n    if (task) {\n      if (name) {\n        task.name = name\n      }\n      if (category !== undefined) {\n        task.categoryKey = category\n      }\n      if (name || category !== undefined) {\n        await this.taskRepository.update(task)\n      }\n    }\n    this.behaviorService.add(\n      'task',\n      `/ :${logAccount} :${task.name} :${task.name}`,\n      {\n        account: logAccount,\n        oldName: task.name,\n        newName: task.name,\n      },\n    )\n  }\n}\n","import type { Context } from 'flash-wolves'\nimport { Inject, InjectCtx, Provide } from 'flash-wolves'\nimport { ObjectID, ObjectId } from 'mongodb'\nimport type { FindOptionsWhere } from 'typeorm'\nimport { In } from 'typeorm'\nimport dayjs from 'dayjs'\nimport LocalFileService from './localFileService'\nimport BehaviorService from './behaviorService'\nimport TokenService from './tokenService'\nimport TaskInfoService from './taskInfoService'\nimport type { Files, User } from '@/db/entity'\nimport { FileRepository } from '@/db/fileDb'\nimport type { File } from '@/db/model/file'\nimport { publicError } from '@/constants/errorMsg'\nimport type { LocalFileInfo } from '@/utils/localFileUtil'\nimport { calculateSize, getQiniuFileUrlExpiredTime } from '@/utils/userUtil'\nimport LocalUserDB from '@/utils/user-local-db'\nimport { addDownloadAction, findAction, updateAction } from '@/db/actionDb'\nimport type { DownloadActionData } from '@/db/model/action'\nimport { ActionType, DownloadStatus } from '@/db/model/action'\nimport { B2GB, formatPrice, formatSize, getUniqueKey, isSameInfo, normalizeFileName, percentageValue, shortLink } from '@/utils/stringUtil'\nimport { TaskRepository } from '@/db/taskDb'\nimport { UserRepository } from '@/db/userDb'\nimport { BOOLEAN } from '@/db/model/public'\nimport { findLog, timeToObjId } from '@/db/logDb'\nimport type { Log } from '@/db/model/log'\nimport type { DownloadLogAnalyzeItem } from '@/types'\nimport { diffMonth } from '@/utils/time-utils'\nimport { USER_POWER } from '@/db/model/user'\nimport { PeopleRepository } from '@/db/peopleDb'\n\n@Provide()\nexport default class FileService {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(FileRepository)\n  private fileRepository: FileRepository\n\n  @Inject(LocalFileService)\n  private localFileService: LocalFileService\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(TaskRepository)\n  private taskRepository: TaskRepository\n\n  @Inject(UserRepository)\n  private userRepository: UserRepository\n\n  @Inject(TokenService)\n  private tokenService: TokenService\n\n  @Inject(TaskInfoService)\n  private taskInfoService: TaskInfoService\n\n  @Inject(PeopleRepository)\n  private peopleRepository: PeopleRepository\n\n  async selectFilesLimitCount(options: Partial<Files>, count: number) {\n    return this.fileRepository.findWithLimitCount(options, count, {\n      id: 'DESC',\n    })\n  }\n\n  getOssKey(file: File) {\n    return `easypicker2/${file.task_key || file.taskKey}/${file.hash}/${\n      file.name\n    }`\n  }\n\n  /**\n   * \n   */\n  async getFileUsage(userId: number) {\n    // \n    const files = await this.fileRepository.findMany({\n      userId,\n    })\n\n    // \n    const ossFilesMap = await this.localFileService.getFilesMap(files)\n\n    return files.reduce((pre, file) => {\n      const ossKey = this.getOssKey(file)\n      const { categoryKey } = file\n\n      return (\n        pre\n        + ((ossFilesMap.get(ossKey) || ossFilesMap.get(categoryKey))?.fsize || 0)\n      )\n    }, 0)\n  }\n\n  async downloadOne(fileId: number) {\n    const { id: userId, account: logAccount } = this.ctx.req.userInfo\n    // TODO: \n    const file = await this.fileRepository.findOne({\n      userId,\n      id: fileId,\n    })\n\n    if (!file) {\n      this.behaviorService.add('file', ` :${logAccount} `, {\n        account: logAccount,\n      })\n      throw publicError.file.notExist\n    }\n    let k = this.getOssKey(file)\n    let isExist = false\n    // \n    if (file.categoryKey) {\n      isExist = await this.localFileService.judgeFileIsExist(file.categoryKey)\n    }\n\n    if (!isExist) {\n      isExist = await this.localFileService.judgeFileIsExist(k)\n    }\n    else {\n      k = file.categoryKey!\n    }\n\n    if (!isExist) {\n      this.behaviorService.add('file', ` :${logAccount} :${file.name} `, {\n        account: logAccount,\n        name: file.name,\n      })\n\n      throw publicError.file.notExist\n    }\n\n    const status = await this.localFileService.batchFileStatus([k])\n    const mimeType = status[0]?.data?.mimeType\n    // \n\n    //  1 \n    const expiredTime = getQiniuFileUrlExpiredTime(LocalUserDB.getSiteConfig()?.downloadOneExpired || 1)\n    const originUrl = this.localFileService.getDownloadUrl(k, expiredTime, this.ctx.req)\n\n    const result = await addDownloadAction({\n      userId,\n      type: ActionType.Download,\n      thingId: file.id,\n    })\n\n    const link = shortLink(result.insertedId, this.ctx.req)\n    const data: DownloadActionData = {\n      url: link,\n      originUrl,\n      status: DownloadStatus.SUCCESS,\n      ids: [file.id],\n      tip: file.name,\n      name: file.name,\n      size: file.size,\n      account: logAccount,\n      mimeType,\n      expiredTime: expiredTime * 1000,\n    }\n\n    await updateAction<DownloadActionData>(\n      { _id: ObjectID(result.insertedId) },\n      {\n        $set: {\n          data,\n        },\n      },\n    )\n    return {\n      link,\n      mimeType,\n    }\n  }\n\n  async batchDownload(ids: number[], zipName: string) {\n    const { id: userId, account: logAccount } = this.ctx.req.userInfo\n    const files = await this.fileRepository.findMany({\n      id: In(ids),\n      userId,\n    })\n    if (files.length === 0) {\n      this.behaviorService.add('file', ` :${logAccount}`, {\n        account: logAccount,\n      })\n      throw publicError.file.notExist\n    }\n    let keys = []\n    for (const file of files) {\n      const { categoryKey } = file\n      const key = this.getOssKey(file)\n      if (!categoryKey) {\n        keys.push(key)\n      }\n      // \n      if (categoryKey) {\n        const isOldExist = await this.localFileService.judgeFileIsExist(categoryKey)\n        if (isOldExist) {\n          keys.push(categoryKey)\n        }\n        else {\n          keys.push(key)\n        }\n      }\n    }\n\n    const filesStatus = await this.localFileService.batchFileStatus(keys)\n    let size = 0\n    keys = keys.filter((_, idx) => {\n      const { code } = filesStatus[idx]\n      if (code === 200) {\n        size += filesStatus[idx].data?.fsize || 0\n      }\n      return code === 200\n    })\n    if (keys.length === 0) {\n      this.behaviorService.add('file', ` :${logAccount} `, {\n        account: logAccount,\n      })\n      throw publicError.file.notExist\n    }\n\n    const filename = normalizeFileName(zipName) ?? `${getUniqueKey()}`\n    const value = await this.localFileService.makeZipWithKeys(keys, filename)\n    this.behaviorService.add('file', ` :${logAccount} :${keys.length} ${value}`, {\n      account: logAccount,\n      length: keys.length,\n      size,\n    })\n\n    await addDownloadAction({\n      userId,\n      type: ActionType.Compress,\n      data: {\n        status: DownloadStatus.ARCHIVE,\n        ids,\n        tip: `${filename}.zip (${keys.length})`,\n        archiveKey: value,\n      },\n    })\n    return {\n      k: value,\n    }\n  }\n\n  async downloadTemplate(filename: string, taskKey: string) {\n    const k = `easypicker2/${taskKey}_template/${filename}`\n    const isExist = await this.localFileService.judgeFileIsExist(k)\n    if (!isExist) {\n      this.behaviorService.add('file', ' ', {\n        data: this.ctx.req.query,\n      })\n      throw publicError.file.notExist\n    }\n\n    const task = await this.taskRepository.findOne({\n      k: taskKey,\n      del: BOOLEAN.FALSE,\n    })\n\n    if (!task) {\n      this.behaviorService.add('file', ' ', {\n        data: this.ctx.req.query,\n      })\n      throw publicError.file.notExist\n    }\n\n    const user = await this.userRepository.findOne({\n      id: task.userId,\n    })\n\n    const [fileInfo] = await this.localFileService.batchFileStatus([k])\n    const { mimeType, fsize } = fileInfo?.data || {}\n\n    //  1 \n    const expiredTime = getQiniuFileUrlExpiredTime(LocalUserDB.getSiteConfig()?.downloadOneExpired || 1)\n    const originUrl = this.localFileService.getDownloadUrl(k, expiredTime, this.ctx.req)\n\n    const result = await addDownloadAction({\n      userId: task.userId,\n      type: ActionType.TemplateDownload,\n      thingId: taskKey,\n    })\n\n    const link = shortLink(result.insertedId, this.ctx.req)\n    const data: DownloadActionData = {\n      url: link,\n      originUrl,\n      status: DownloadStatus.SUCCESS,\n      ids: [],\n      tip: filename,\n      name: filename,\n      size: fsize,\n      account: user.account,\n      mimeType,\n      expiredTime: expiredTime * 1000,\n    }\n\n    await updateAction<DownloadActionData>(\n      { _id: ObjectID(result.insertedId) },\n      {\n        $set: {\n          data,\n        },\n      },\n    )\n\n    return {\n      link,\n      mimeType,\n    }\n  }\n\n  async downloadCount(idList: number[]) {\n    //  downloadAction\n    // \n    if (!this.ctx.req.userInfo) {\n      throw new Error('')\n    }\n    \n    const actions = await findAction({\n      'userId': this.ctx.req.userInfo.id,\n      'data.status': {\n        $in: [DownloadStatus.ARCHIVE, DownloadStatus.SUCCESS, DownloadStatus.EXPIRED],\n      },\n      'data.ids': {\n        $in: idList,\n      },\n    })\n\n    //  action \n    // \n    // @ts-expect-error\n    const actionsIds = actions.map(v => v._id.toHexString())\n    const logs = await findLog({\n      'type': 'behavior',\n      'data.info.data.downloadActionId': { $in: actionsIds },\n    })\n\n    const values = idList.map((fileId) => {\n      const baseCount = actions\n        .filter(v => v.data.ids?.includes(fileId))\n        .reduce((pre, action) => {\n          // @ts-expect-error\n          const logCount = logs.filter(v => v.data?.info?.data?.downloadActionId === action._id.toHexString()).length\n          return pre + (logCount || 1)\n        }, 0)\n      return baseCount\n    })\n    return values\n  }\n\n  async downloadLog(account = '', ops?: {\n    startTime?: Date\n    endTime?: Date\n  }) {\n    const { startTime, endTime } = ops || {}\n    return findLog({\n      ...(startTime || endTime) && {\n        _id: {\n          ...startTime && { $gte: new ObjectId(timeToObjId(startTime)) },\n          ...endTime && { $lte: new ObjectId(timeToObjId(endTime)) },\n        },\n      },\n      'type': 'behavior',\n      'data.info.msg': { $regex: new RegExp(`^( :${account}| :${account}| :${account})`) },\n    })\n  }\n\n  getOSSFileSizeUntilNow(\n    fileList: Files[],\n    filesMap: Map<string, LocalFileInfo>,\n    ops?: {\n      startTime?: Date\n    },\n  ) {\n    const { startTime } = ops || {}\n    const sum = fileList.reduce((pre, file) => {\n      const ossKey = this.getOssKey(file)\n      const { categoryKey } = file\n      const fileSize = +file.size\n      const ossSize = (filesMap.get(ossKey) || filesMap.get(categoryKey))?.fsize || 0\n      // \n      if (!ossSize) {\n        const { ossDelTime } = file\n        //   \n        if (!ossDelTime) {\n          return pre\n        }\n        // \n        if (ossDelTime < startTime) {\n          return pre\n        }\n        //   \n        return pre + diffMonth(ossDelTime, startTime) * fileSize\n      }\n      // \n      return pre + diffMonth(Date.now(), Math.max(+new Date(file.date), +startTime)) * fileSize\n    }, 0)\n    return Math.round(sum)\n  }\n\n  analyzeDownloadLog(logs: Log[]) {\n    const oneFile = {\n      count: 0,\n      size: 0,\n    }\n    const compressFile = {\n      count: 0,\n      size: 0,\n    }\n\n    const templateFile = {\n      count: 0,\n      size: 0,\n    }\n\n    logs.forEach((v) => {\n      const { info } = v.data\n      const { msg } = info\n      const size = +info.data.size || 0\n      if (msg.startsWith(' :')) {\n        oneFile.count += 1\n        oneFile.size += size\n      }\n      else if (msg.startsWith(' :')) {\n        compressFile.count += 1\n        compressFile.size += size\n      }\n      else if (msg.startsWith(' :')) {\n        templateFile.count += 1\n        templateFile.size += size\n      }\n    })\n    return {\n      oneFile,\n      compressFile,\n      templateFile,\n    }\n  }\n\n  /**\n   * \n   * @param limitSize \n   * @param fileSize \n   */\n  limitUploadBySpace(limitSize: number, fileSize: number) {\n    const { limitSpace } = LocalUserDB.getSiteConfig()\n    return limitSpace && (limitSize === 0 || limitSize < fileSize)\n  }\n\n  limitUploadByWallet(balance: number) {\n    const { limitWallet } = LocalUserDB.getSiteConfig()\n    return limitWallet && balance <= 0\n  }\n\n  calculateQiniuPrice(download: {\n    one: DownloadLogAnalyzeItem\n    compress: DownloadLogAnalyzeItem\n    template: DownloadLogAnalyzeItem\n  }, ossSize: number) {\n    const { qiniuBackhaulTrafficPercentage, qiniuCompressPrice, qiniuBackhaulTrafficPrice, qiniuOSSPrice, qiniuCDNPrice } = LocalUserDB.getSiteConfig()\n    // \n    const OSSPrice = B2GB(ossSize) * qiniuOSSPrice\n    // \n    const compressPrice = B2GB(download.compress.size) * qiniuCompressPrice\n    const downloadSize = B2GB(\n      download.one.size\n      + download.compress.size\n      + download.template.size,\n    )\n    // \n    const backhaulTrafficPrice = downloadSize * qiniuBackhaulTrafficPercentage * qiniuBackhaulTrafficPrice\n    // CDN \n    const cdnPrice = downloadSize * qiniuCDNPrice\n\n    return {\n      ossPrice: formatPrice(OSSPrice),\n      compressPrice: formatPrice(compressPrice),\n      backhaulTrafficPrice: formatPrice(backhaulTrafficPrice),\n      cdnPrice: formatPrice(cdnPrice),\n      total: formatPrice(\n        +formatPrice(OSSPrice)\n        + +formatPrice(compressPrice)\n        + +formatPrice(backhaulTrafficPrice)\n        + +formatPrice(cdnPrice),\n      ),\n    }\n  }\n\n  addFile(file: Files) {\n    file.name = normalizeFileName(file.name)\n    file.date = new Date()\n    return this.fileRepository.insert(file)\n  }\n\n  async getUserFiles() {\n    const { id } = this.ctx.req.userInfo\n    const files = await this.fileRepository.findMany({\n      userId: id,\n      del: BOOLEAN.FALSE,\n    }, { order: { id: 'DESC' } })\n    return files\n  }\n\n  async findOneFile(ops: FindOptionsWhere<Files>) {\n    return this.fileRepository.findOne({\n      del: BOOLEAN.FALSE,\n      ...ops,\n    })\n  }\n\n  async deleteOneFile(file: Files) {\n    const { account: logAccount } = this.ctx.req.userInfo\n    if (!file) {\n      this.behaviorService.add('file', ` :${logAccount} `, {\n        account: logAccount,\n        fileId: file.id,\n      })\n      throw publicError.file.notExist\n    }\n    let k = `easypicker2/${file.taskKey}/${file.hash}/${file.name}`\n    // \n    if (file.categoryKey) {\n      k = file.categoryKey\n    }\n    const sameRecord = await this.fileRepository.findMany({\n      taskKey: file.taskKey,\n      hash: file.hash,\n      name: file.name,\n      del: BOOLEAN.FALSE,\n    })\n\n    const isRepeat = sameRecord.length > 1\n\n    // \n    if (!isRepeat) {\n      // \n      this.localFileService.deleteObjByKey(k)\n    }\n    if (!file.ossDelTime) {\n      file.ossDelTime = new Date()\n    }\n    file.del = BOOLEAN.TRUE\n    file.delTime = new Date()\n    await this.fileRepository.update(file)\n    this.behaviorService.add('file', ` :${logAccount} :${file.name} ${\n        isRepeat ? `${sameRecord.length - 1}` : 'OSS'\n      }`, {\n      account: logAccount,\n      name: file.name,\n      taskKey: file.taskKey,\n      hash: file.hash,\n    })\n  }\n\n  async getUserOverview(user: User, options?: Partial<{\n    files: Files[]\n    filesMap: Map<string, LocalFileInfo>\n    downloadLog: Log[]\n  }>) {\n    let { files, filesMap, downloadLog } = options || {}\n    const { moneyStartDay } = LocalUserDB.getSiteConfig()\n    if (!files) {\n      files = await this.fileRepository.findMany({\n        userId: user.id,\n      })\n    }\n    if (!filesMap) {\n      filesMap = await this.localFileService.getFilesMap(files)\n    }\n    if (!downloadLog) {\n      downloadLog = await this.downloadLog(user.account, {\n        startTime: new Date(moneyStartDay),\n      })\n    }\n    const fileInfo = files\n    let ossCount = 0\n    let originFileSize = 0\n    let AMonthAgoSize = 0\n    let AQuarterAgoSize = 0\n    let AHalfYearAgoSize = 0\n    const fileSize = fileInfo.reduce((pre, v) => {\n      const { date } = v\n      originFileSize += (+v.size || 0)\n      const ossKey = this.getOssKey(v)\n      const { fsize = 0 }\n          = filesMap.get(ossKey) || filesMap.get(v.categoryKey) || {}\n\n      if (fsize) {\n        ossCount += 1\n      }\n      if (dayjs(date).isBefore(dayjs().subtract(1, 'month'))) {\n        AMonthAgoSize += fsize\n      }\n      if (dayjs(date).isBefore(dayjs().subtract(3, 'month'))) {\n        AQuarterAgoSize += fsize\n      }\n      if (dayjs(date).isBefore(dayjs().subtract(6, 'month'))) {\n        AHalfYearAgoSize += fsize\n      }\n\n      return pre + fsize\n    }, 0)\n\n    const userTokens = await this.tokenService.getAllTokens(user.account)\n    if (!userTokens.length) {\n      this.tokenService.checkAllToken(userTokens, user.account)\n    }\n\n    const limitSize = calculateSize((user.power === USER_POWER.SUPER\n      ? Math.max(1024, user?.size)\n      : user?.size) ?? 2)\n\n    //  0 \n    const limitUpload = this.limitUploadBySpace(limitSize, fileSize)\n    const percentage\n        = percentageValue(fileSize, limitSize)\n\n    const { oneFile, compressFile, templateFile } = this.analyzeDownloadLog(\n      downloadLog,\n    )\n\n    // TODO =  + \n    // \n    const price = this.calculateQiniuPrice({\n      one: oneFile,\n      compress: compressFile,\n      template: templateFile,\n    }, this.getOSSFileSizeUntilNow(fileInfo, filesMap, {\n      startTime: new Date(moneyStartDay),\n    }))\n\n    const balance = +user.wallet - +price.total\n    const isAdmin = user.power === USER_POWER.SUPER\n    const limitWallet = this.limitUploadByWallet(balance)\n    return {\n      fileCount: fileInfo.length,\n      originFileSize,\n      ossCount,\n      limitSize:\n          user.power === USER_POWER.SUPER ? '' : formatSize(limitSize),\n      maxSize: limitSize,\n      limitUpload: isAdmin ? false : (limitWallet || limitUpload),\n      limitSpace: limitUpload,\n      limitWallet,\n      percentage,\n      resources: formatSize(fileSize),\n      monthAgoSize: formatSize(AMonthAgoSize),\n      quarterAgoSize: formatSize(AQuarterAgoSize),\n      halfYearSize: formatSize(AHalfYearAgoSize),\n      onlineCount: userTokens.length,\n      // \n      usage: fileSize,\n      lastLoginTime: +new Date(user.loginTime) || 0,\n      oneFile,\n      compressFile,\n      templateFile,\n      downloadCount: oneFile.count + compressFile.count + templateFile.count,\n      downloadSize: oneFile.size + compressFile.size + templateFile.size,\n      price,\n      cost: +price.total,\n      wallet: user.wallet || 0,\n      // \n      balance: balance.toFixed(2),\n    }\n  }\n\n  async withdrawFile(data) {\n    const { taskKey, taskName, filename, hash, peopleName, info } = data\n    const taskInfo = await this.taskInfoService.getTaskInfo(taskKey)\n    const limitPeople = taskInfo.people === BOOLEAN.TRUE\n\n    // \n    let files = await this.fileRepository.findMany({\n      del: BOOLEAN.FALSE,\n      taskKey,\n      taskName,\n      name: filename,\n      hash,\n    })\n\n    files = files.filter(file => isSameInfo(file.info, info))\n\n    const passFiles = files.filter(file => file.people === peopleName)\n\n    if (!passFiles.length) {\n      this.behaviorService.add('file', ` ${peopleName} :${filename} `, {\n        filename,\n        peopleName,\n        data,\n      })\n      throw publicError.file.notExist\n    }\n    const isDelOss = passFiles.length === files.length\n    // \n    // \n    if (isDelOss) {\n      const key = `easypicker2/${taskKey}/${hash}/${filename}`\n      this.localFileService.deleteObjByKey(key)\n    }\n    await this.fileRepository.updateSpecifyFields({\n      id: In(passFiles.map(file => file.id)),\n    }, {\n      del: BOOLEAN.TRUE,\n      ossDelTime: new Date(),\n      delTime: new Date(),\n    })\n    this.behaviorService.add('file', ` :${filename} :${\n      passFiles.length\n    } OSS:${isDelOss ? '' : ''}`, {\n      limitPeople,\n      isDelOss,\n      filesCount: files.length,\n      passFilesCount: passFiles.length,\n      filename,\n      peopleName,\n      data,\n    })\n\n    // \n    if (peopleName) {\n      const people = await this.peopleRepository.findOne({\n        name: peopleName,\n        status: 1,\n        taskKey,\n      })\n\n      if (!people) {\n        this.behaviorService.add('file', `:${peopleName} `, {\n          filename,\n          peopleName,\n          data,\n        })\n        throw publicError.file.notExist\n      }\n      people.status = (await this.fileRepository.findMany({\n        del: BOOLEAN.FALSE,\n        people: peopleName,\n        taskKey,\n      })).length\n        ? 1\n        : 0\n      people.submitDate = new Date()\n      await this.peopleRepository.update(people)\n    }\n  }\n\n  async batchDelete(ids: number[]) {\n    const { id: userId, account: logAccount } = this.ctx.req.userInfo\n    const files = await this.fileRepository.findMany({\n      del: BOOLEAN.FALSE,\n      userId,\n      id: In(ids),\n    })\n\n    if (files.length === 0) {\n      return\n    }\n    const keys = new Set<string>()\n\n    // TODO\n    // TODOO(n)\n    for (const file of files) {\n      const { name, taskKey, hash, categoryKey } = file\n      // \n      if (categoryKey) {\n        keys.add(categoryKey)\n      }\n      else {\n        // \n        const dbCount = await this.fileRepository.count({\n          del: BOOLEAN.FALSE,\n          taskKey,\n          hash,\n          name,\n        })\n\n        const delCount = files.filter(\n          v => v.taskKey === taskKey && v.hash === hash && v.name === name,\n        ).length\n        if (dbCount <= delCount) {\n          keys.add(this.getOssKey(file))\n        }\n      }\n    }\n\n    // \n    // TODO: \n    this.localFileService.batchDeleteFiles([...keys])\n    await this.fileRepository.updateSpecifyFields({\n      id: In(files.map(file => file.id)),\n    }, {\n      del: BOOLEAN.TRUE,\n      ossDelTime: new Date(),\n      delTime: new Date(),\n    })\n\n    this.behaviorService.add('file', ` :${logAccount} :${files.length} OSS:${keys.size}`, {\n      account: logAccount,\n      length: files.length,\n      ossCount: keys.size,\n    })\n  }\n\n  // TODO cookie \n  async checkSubmitInfo(data) {\n    const { taskKey, info, name = '' } = data\n\n    let files = await this.fileRepository.findMany({\n      del: BOOLEAN.FALSE,\n      taskKey,\n      people: name,\n    })\n    files = files.filter(v => isSameInfo(v.info, JSON.stringify(info)))\n    ;(async () => {\n      const task = await this.taskRepository.findOne({\n        k: taskKey,\n      })\n      if (task) {\n        this.behaviorService.add('file', `: ${files.length > 0 ? '' : ''} :${\n          task.name\n        } :${files.length}`, {\n          taskKey,\n          taskName: task.name,\n          info,\n          count: files.length,\n        })\n      }\n      else {\n        this.behaviorService.add('file', `:  ${taskKey} `, {\n          taskKey,\n          taskName: task.name,\n          info,\n        })\n      }\n    })()\n\n    return {\n      isSubmit: files.length > 0,\n      txt: '',\n    }\n  }\n}\n","import type { OkPacket } from 'mysql'\nimport { Provide } from 'flash-wolves'\nimport type { File } from './model/file'\nimport { Files } from './entity'\nimport { AppDataSource, BaseRepository } from '.'\nimport { query } from '@/lib/dbConnect/mysql'\nimport {\n  insertTableByModel,\n  selectTableByModel,\n  updateTableByModel,\n} from '@/utils/sqlUtil'\n\nexport function insertFile(file: File) {\n  const { sql, params } = insertTableByModel('files', file)\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function selectFilesNew(options: File, columns: string[] = []) {\n  const { sql, params } = selectTableByModel('files', {\n    data: options,\n    columns,\n    // \n    order: 'order by id desc',\n  })\n  return query<File[]>(sql, ...params)\n}\n\nexport function selectFiles(options: File, columns: string[] = []) {\n  const { sql, params } = selectTableByModel('files', {\n    data: {\n      del: 0,\n      ...options,\n    },\n    columns,\n    // \n    order: 'order by id desc',\n  })\n  return query<File[]>(sql, ...params)\n}\n\nexport function selectFilesLimitCount(options: File, count: number) {\n  const { sql, params } = selectTableByModel('files', {\n    data: options,\n    limit: count,\n    // \n    order: 'order by id desc',\n  })\n  return query<File[]>(sql, ...params)\n}\n\nexport function updateFileInfo(_query: File, file: File) {\n  const { sql, params } = updateTableByModel('files', file, _query)\n  return query<OkPacket>(sql, ...params)\n}\nexport function deleteFileRecord(file: File) {\n  // \n  // const originData = JSON.stringify({\n  //   userId: file.user_id,\n  //   categoryKey: file.category_key,\n  //   taskKey: file.task_key\n  // })\n  // const { sql, params } = updateTableByModel(\n  //   'files',\n  //   {\n  //     userId: 0,\n  //     taskKey: 'local_trash',\n  //     categoryKey: originData\n  //   },\n  //   {\n  //     id: file.id\n  //   }\n  // )\n  const { sql, params } = updateTableByModel(\n    'files',\n    {\n      del: 1,\n    },\n    {\n      id: file.id,\n    },\n  )\n  // \n  // const { sql, params } = deleteTableByModel('files', file)\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function deleteFiles(files: File[]) {\n  const ids = files.map(v => v.id)\n  // \n  // const { sql, params } = updateTableByModel(\n  //   'files',\n  //   {\n  //     userId: 0,\n  //     taskKey: 'local_trash'\n  //   },\n  //   {\n  //     id: ids\n  //   }\n  // )\n  const { sql, params } = updateTableByModel(\n    'files',\n    {\n      del: 1,\n    },\n    {\n      id: ids,\n    },\n  )\n  // \n  ;(async () => {\n    for (const f of files) {\n      await deleteFileRecord(f)\n    }\n  })()\n  return query<OkPacket>(sql, ...params)\n}\n\n@Provide()\nexport class FileRepository extends BaseRepository<Files> {\n  protected repository = AppDataSource.getRepository(Files)\n\n  protected entityName = Files.name\n\n  // \n}\n","import { FilterQuery, UpdateQuery } from 'mongodb'\nimport {\n  findCollection,\n  findCollectionCount,\n  insertCollection,\n  mongoDbQuery,\n  updateCollection\n} from '@/lib/dbConnect/mongodb'\nimport { Action, DownloadAction } from './model/action'\nimport { getUniqueKey } from '@/utils/stringUtil'\n\nexport function addAction(action: Partial<Action>) {\n  Object.assign<any, Partial<Action>>(action, {\n    id: getUniqueKey(),\n    date: new Date()\n  })\n  return insertCollection<any>('action', action)\n}\nexport function addDownloadAction(action: Partial<DownloadAction>) {\n  return addAction(action)\n}\n\nexport function findActionCount(query: FilterQuery<Action>) {\n  return findCollectionCount<Action>('action', query)\n}\n\nexport function findActionWithPageOffset(\n  startIdx: number,\n  pageSize: number,\n  query: FilterQuery<Action>\n) {\n  return mongoDbQuery<Action[]>((db, resolve) => {\n    db.collection<Action>('action')\n      .find(query)\n      .sort({ _id: -1 })\n      .skip(startIdx)\n      .limit(pageSize)\n      .toArray()\n      .then(resolve)\n  })\n}\n\nexport function findAction<T = any>(action: FilterQuery<Action<T>>) {\n  return findCollection<Action<T>>('action', action)\n}\n\nexport function updateAction<T = any>(\n  query: FilterQuery<Action<T>>,\n  action: UpdateQuery<Action<T>>\n) {\n  return updateCollection<Action<T>>('action', query, action)\n}\n","export enum ActionType {\n  /**\n   * \n   */\n  PRAISE,\n\n  /**\n   * \n   */\n  Download,\n\n  /**\n   * \n   */\n  Compress,\n\n  /**\n   * \n   */\n  DisabledRoute,\n\n  /**\n   * \n   */\n  TemplateDownload,\n}\nexport interface Action<T = any> {\n  id: string\n  type: ActionType\n  date: Date\n  userId?: string | number\n  /**\n   * id\n   * wishid\n   */\n  thingId?: string | number\n  ip?: string\n  data?: T\n}\n\nexport type PraiseAction = Action\n\nexport enum DownloadStatus {\n  /**\n   * \n   */\n  ARCHIVE,\n  /**\n   * \n   */\n  EXPIRED,\n  /**\n   * \n   */\n  SUCCESS,\n  /**\n   * \n   */\n  FAIL,\n}\nexport interface DownloadActionData {\n  status: DownloadStatus\n  ids: number[]\n  archiveKey?: string\n  tip?: string\n  url?: string\n  size?: number\n  error?: string\n  expiredTime?: number // \n  /**\n   *  OSS \n   */\n  originUrl?: string\n  account?: string\n  mimeType?: string\n  name?: string\n}\n\nexport type DownloadAction = Action<DownloadActionData>\n","import dayjs from 'dayjs'\n\nexport function diffMonth(end: any, start: any) {\n  return dayjs(new Date(end)).diff(dayjs(new Date(start)), 'month', true)\n}\n","import { OkPacket } from 'mysql'\nimport { Provide } from 'flash-wolves'\nimport { query } from '@/lib/dbConnect/mysql'\nimport {\n  deleteTableByModel,\n  insertTableByModelMany,\n  selectTableByModel,\n  updateTableByModel\n} from '@/utils/sqlUtil'\nimport { People } from './model/people'\nimport { People as PeopleEntity } from './entity'\nimport { BaseRepository, AppDataSource } from '.'\n\nexport function selectPeople(\n  options: V2Array<People>,\n  columns: string[] = ['name']\n) {\n  const { sql, params } = selectTableByModel('people', {\n    data: options,\n    columns\n  })\n\n  return query<People[]>(sql, ...params)\n}\n\nexport function insertPeople(people: People[], defaultData: People = {}) {\n  people.forEach((p) => {\n    Object.assign(p, defaultData, p)\n  })\n  const { sql, params } = insertTableByModelMany('people', people)\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function deletePeople(people: V2Array<People>) {\n  const { sql, params } = deleteTableByModel('people', people)\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function updatePeople(people: People, q: People) {\n  const { sql, params } = updateTableByModel('people', people, q)\n  return query<OkPacket>(sql, ...params)\n}\n\n@Provide()\nexport class PeopleRepository extends BaseRepository<PeopleEntity> {\n  protected repository = AppDataSource.getRepository(PeopleEntity)\n\n  protected entityName = PeopleEntity.name\n}\n","import process from 'node:process'\nimport type { Context } from 'flash-wolves'\nimport { Inject, InjectCtx, Provide, Response } from 'flash-wolves'\nimport { rEmail } from '@/utils/regExp'\nimport { UserError } from '@/constants/errorMsg'\nimport { randomNumStr } from '@/utils/randUtil'\nimport { BehaviorService, TokenService } from '@/service'\nimport { UserRepository } from '@/db/userDb'\nimport { getMailConfig, sendMail } from '@/utils/mailUtil'\nimport { LocalFileService } from '@/service'\nimport { getQiniuFileUrlExpiredTime } from '@/utils/userUtil'\nimport LocalUserDB from '@/utils/user-local-db'\n\n@Provide()\nexport default class PublicService {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(TokenService)\n  private tokenService: TokenService\n\n  @Inject(UserRepository)\n  private userRepository: UserRepository\n\n  @Inject(LocalFileService)\n  private localFileService: LocalFileService\n\n  /**\n   * \n   * @param email \n   * @param scene :\n   *  - register:  / \n   *  - login/reset:  / \n   *  - default: \n   */\n  async getVerifyCode(\n    email: string,\n    scene: 'register' | 'login' | 'reset' | 'default' = 'default',\n  ) {\n    // ,\n    if (!rEmail.test(email)) {\n      this.behaviorService.add(\n        'public',\n        ` :${email} `,\n        {\n          email,\n        },\n      )\n      throw UserError.email.fault\n    }\n\n    // /\n    if (scene === 'login' || scene === 'reset') {\n      let user = await this.userRepository.findOne({ email })\n      if (!user) {\n        user = await this.userRepository.findOne({ account: email })\n      }\n      if (!user) {\n        this.behaviorService.add(\n          'public',\n          ` :${email} `,\n          { email },\n        )\n        throw UserError.email.noExist\n      }\n    }\n    const code = randomNumStr(4)\n    const cfg = getMailConfig()\n    const htmlTemplate\n      = cfg.template\n      || `<p> EasyPicker  2 <strong>${code}</strong></p>`\n    const html = htmlTemplate.replace(/{{\\s*code\\s*}}/gi, code)\n    const maskedEmail = email.replace(\n      /(.{2}).+(@.+)/,\n      (_, prefix, suffix) => `${prefix}***${suffix}`,\n    )\n    this.behaviorService.add(\n      'public',\n      ` :${maskedEmail} :${code} `,\n      {\n        email: maskedEmail,\n        code,\n      },\n    )\n    await sendMail({\n      to: email,\n      subject: cfg.subject || 'EasyPicker ',\n      html,\n    })\n    this.tokenService.setVerifyCode(email, code)\n  }\n\n  reportPV() {\n    const { req } = this.ctx\n    const handler = (path?: string) => {\n      if (!path) {\n        return\n      }\n      try {\n        this.behaviorService.addPV(path)\n      }\n      catch (error) {\n        console.warn('[public/report/pv] skip pv log:', error?.message || error)\n      }\n    }\n    if (req.method === 'GET') {\n      handler(req.query?.path as string)\n      return Response.plain('<h1>ok</h1>', 'text/html;charset=utf-8')\n    }\n    handler(req.body?.path)\n  }\n\n  async checkEmailIsExist(email: string) {\n    if (!rEmail.test(email)) {\n      this.behaviorService.add(\n        'public',\n        ` :${email} `,\n        {\n          email,\n        },\n      )\n\n      return Response.failWithError(UserError.email.fault)\n    }\n    let user = await this.userRepository.findOne({ email })\n\n    if (!user) {\n      user = await this.userRepository.findOne({ account: email })\n    }\n    if (user) {\n      this.behaviorService.add(\n        'public',\n        ` :${email} `,\n        {\n          email,\n        },\n      )\n      throw UserError.email.exist\n    }\n    this.behaviorService.add(\n      'public',\n      ` :${email} `,\n      {\n        email,\n      },\n    )\n  }\n\n  async getTipImage(\n    key: string,\n    data: {\n      uid: number\n      name: string\n    }[],\n  ) {\n    const expiredTime = getQiniuFileUrlExpiredTime(LocalUserDB.getSiteConfig()?.downloadOneExpired || 1)\n    return Promise.all(\n      data.map(async (v) => {\n        const tipKey = `easypicker2/tip/${key}/${v.uid}/${v.name}`\n        const cover = await this.localFileService.getImagePreviewUrl(\n          tipKey,\n          'cover',\n          expiredTime,\n          this.ctx.req,\n        )\n        const preview = await this.localFileService.getImagePreviewUrl(\n          tipKey,\n          'preview',\n          expiredTime,\n          this.ctx.req,\n        )\n        return {\n          cover,\n          preview,\n        }\n      }),\n    )\n  }\n}\n","const { random, round } = Math\n\n/**\n * \n * @param length\n */\nexport function randomNumStr(length: number): string {\n  let str = ''\n  let i = 0\n  while (i < length) {\n    i += 1\n    str += round(random() * 100) % 10\n  }\n  return str\n}\n","import nodemailer, { Transporter } from 'nodemailer'\r\nimport LocalUserDB from './user-local-db'\r\n\r\nexport interface MailConfig {\r\n  smtpHost: string\r\n  smtpPort: string | number\r\n  useSSL: boolean\r\n  account: string\r\n  password: string\r\n  from?: string\r\n  senderName?: string\r\n  subject?: string\r\n  template?: string\r\n}\r\n\r\ninterface SendMailOptions {\r\n  to: string\r\n  subject?: string\r\n  text?: string\r\n  html?: string\r\n}\r\n\r\nlet transporter: Transporter | null = null\r\nlet transporterKey = ''\r\n\r\nfunction getConfig(): MailConfig {\r\n  const cfg = LocalUserDB.getUserConfigByType('mail')\r\n  if (!cfg || !cfg.smtpHost) {\r\n    throw new Error(' SMTP ')\r\n  }\r\n  return {\r\n    smtpHost: cfg.smtpHost,\r\n    smtpPort: cfg.smtpPort,\r\n    useSSL: Boolean(cfg.useSSL),\r\n    account: cfg.account,\r\n    password: cfg.password,\r\n    from: cfg.from,\r\n    senderName: cfg.senderName,\r\n    subject: cfg.subject,\r\n    template: cfg.template,\r\n  }\r\n}\r\n\r\nfunction buildTransporterKey(cfg: MailConfig) {\r\n  return [cfg.smtpHost, cfg.smtpPort, cfg.account, cfg.useSSL].join('-')\r\n}\r\n\r\nfunction createTransporter(cfg: MailConfig) {\r\n  return nodemailer.createTransport({\r\n    host: cfg.smtpHost,\r\n    port: Number(cfg.smtpPort),\r\n    secure: cfg.useSSL,\r\n    auth: {\r\n      user: cfg.account,\r\n      pass: cfg.password,\r\n    },\r\n  })\r\n}\r\n\r\nasync function ensureTransporter(cfg: MailConfig) {\r\n  const key = buildTransporterKey(cfg)\r\n  if (transporter && transporterKey === key) {\r\n    return transporter\r\n  }\r\n  transporter = createTransporter(cfg)\r\n  transporterKey = key\r\n  return transporter\r\n}\r\n\r\nexport async function sendMail(options: SendMailOptions, overrideConfig?: MailConfig) {\r\n  const cfg = overrideConfig || getConfig()\r\n  let tp: Transporter\r\n  if (overrideConfig) {\r\n    tp = createTransporter(cfg)\r\n  }\r\n  else {\r\n    tp = await ensureTransporter(cfg)\r\n  }\r\n  const subject = options.subject || cfg.subject || 'EasyPicker '\r\n  const html = options.html || cfg.template\r\n  const fromAddress = cfg.from || cfg.account\r\n  const sender = cfg.senderName ? `\"${cfg.senderName}\" <${fromAddress}>` : fromAddress\r\n  await tp.sendMail({\r\n    from: sender,\r\n    to: options.to,\r\n    subject,\r\n    text: options.text,\r\n    html,\r\n  })\r\n}\r\n\r\nexport function getMailConfig() {\r\n  return getConfig()\r\n}\r\n\r\nexport function resetMailTransporter() {\r\n  transporter = null\r\n  transporterKey = ''\r\n}\r\n\r\n","import { Inject, InjectCtx, Context, Provide } from 'flash-wolves'\nimport { CategoryRepository } from '@/db/categoryDb'\nimport BehaviorService from './behaviorService'\nimport { CategoryError } from '@/constants/errorMsg'\nimport { Category } from '@/db/entity'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport { TaskRepository } from '@/db/taskDb'\n\n@Provide()\nexport default class CategoryService {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(CategoryRepository)\n  private categoryRepository: CategoryRepository\n\n  @Inject(TaskRepository)\n  private taskRepository: TaskRepository\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  async createCategory(name: string) {\n    const { id: userId, account: logAccount } = this.ctx.req.userInfo\n    const categories = await this.categoryRepository.findMany({\n      userId,\n      name\n    })\n\n    // \n    if (categories.length !== 0) {\n      this.behaviorService.add(\n        'category',\n        `() :${logAccount} :${name}`,\n        {\n          name,\n          account: logAccount\n        }\n      )\n      throw CategoryError.exist\n    }\n    this.behaviorService.add(\n      'category',\n      ` :${logAccount} :${name}`,\n      {\n        name,\n        account: logAccount\n      }\n    )\n    const category = new Category()\n    category.userId = userId\n    category.name = name\n    category.k = getUniqueKey()\n    await this.categoryRepository.insert(category)\n  }\n\n  async getList() {\n    const { id: userId, account: logAccount } = this.ctx.req.userInfo\n    this.behaviorService.add('category', ` :${logAccount}`, {\n      account: logAccount\n    })\n\n    const categories = await this.categoryRepository.findMany({\n      userId\n    })\n    categories.forEach((v) => {\n      delete v.userId\n    })\n    return {\n      categories\n    }\n  }\n\n  async deleteCategory(key: string) {\n    const { id: userId, account: logAccount } = this.ctx.req.userInfo\n    const c = await this.categoryRepository.findOne({\n      userId,\n      k: key\n    })\n    if (c) {\n      await this.categoryRepository.delete({\n        id: c.id\n      })\n      // \n      await this.taskRepository.updateSpecifyFields(\n        {\n          categoryKey: key\n        },\n        {\n          categoryKey: 'default'\n        }\n      )\n      // \n      this.behaviorService.add(\n        'category',\n        ` :${logAccount} :${c.name}`,\n        {\n          account: logAccount,\n          name: c.name\n        }\n      )\n    }\n  }\n}\n","import { OkPacket } from 'mysql'\nimport { Provide } from 'flash-wolves'\nimport { query } from '@/lib/dbConnect/mysql'\nimport {\n  deleteTableByModel,\n  insertTableByModel,\n  selectTableByModel\n} from '@/utils/sqlUtil'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport { Category } from './model/category'\nimport { AppDataSource, BaseRepository } from '.'\nimport { Category as CategoryEntity } from './entity'\n\nexport function selectCategory(options: Category) {\n  const { sql, params } = selectTableByModel('category', {\n    data: options\n  })\n  return query<Category[]>(sql, ...params)\n}\n\nexport function insertCategory(category: Category) {\n  Object.assign(category, {\n    k: getUniqueKey()\n  })\n  const { sql, params } = insertTableByModel('category', category)\n  return query<OkPacket>(sql, ...params)\n}\n\nexport function deleteCategory(category: Category) {\n  const { sql, params } = deleteTableByModel('category', category)\n  return query<OkPacket>(sql, ...params)\n}\n\n@Provide()\nexport class CategoryRepository extends BaseRepository<CategoryEntity> {\n  protected repository = AppDataSource.getRepository(CategoryEntity)\n\n  protected entityName = CategoryEntity.name\n}\n","import { Inject, Provide } from 'flash-wolves'\nimport TokenService from './tokenService'\n\n@Provide()\nexport default class SuperUserService {\n  @Inject(TokenService)\n  private tokenService: TokenService\n\n  async logout(account: string) {\n    const tokens = await this.tokenService.getAllTokens(account)\n    for (const token of tokens) {\n      this.tokenService.expiredRedisKey(token)\n    }\n    this.tokenService.expiredRedisKey(this.tokenService.onlineTokenKey(account))\n    return account\n  }\n}\n","import { Context, Inject, InjectCtx, Provide } from 'flash-wolves'\nimport { In } from 'typeorm'\nimport { People } from '@/db/entity'\nimport { BehaviorService } from '@/service'\nimport { peopleError } from '@/constants/errorMsg'\nimport { PeopleRepository } from '@/db/peopleDb'\nimport { TaskRepository } from '@/db/taskDb'\nimport { TaskInfoRepository } from '@/db/taskInfoDb'\n\n@Provide()\nexport default class PeopleService {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(PeopleRepository)\n  private peopleRepository: PeopleRepository\n\n  @Inject(TaskRepository)\n  private taskRepository: TaskRepository\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(TaskInfoRepository)\n  private taskInfoRepository: TaskInfoRepository\n\n  async addPeople(key: string, name: string) {\n    const user = this.ctx.req.userInfo\n    const exist = !!(await this.peopleRepository.findOne({\n      taskKey: key,\n      userId: user.id,\n      name\n    }))\n\n    this.behaviorService.add(\n      'people',\n      `${exist ? '' : ''}: ${name}`,\n      {\n        name,\n        exist\n      }\n    )\n    if (exist) {\n      throw peopleError.exist\n    }\n\n    const people = new People()\n    people.name = name\n    people.taskKey = key\n    people.userId = user.id\n    await this.peopleRepository.insert(people)\n  }\n\n  async checkPeopleIsExist(key: string, name: string) {\n    const task = await this.taskRepository.findOne({\n      k: key\n    })\n    if (!task) {\n      return false\n    }\n    const people = await this.peopleRepository.findOne({\n      taskKey: key,\n      name\n    })\n\n    const exist = !!people\n    this.behaviorService.add(\n      'people',\n      ` :${task.name} :${name} :${\n        exist ? '' : ''\n      }`,\n      {\n        taskName: task.name,\n        name,\n        exist\n      }\n    )\n    return exist\n  }\n\n  async getUsefulTemplate(key: string) {\n    this.behaviorService.add('people', '', {\n      taskKey: key\n    })\n\n    const user = this.ctx.req.userInfo\n\n    const taskKeyList = (\n      await this.taskInfoRepository.findWithSpecifyColumn(\n        {\n          userId: user.id,\n          limitPeople: 1\n        },\n        ['taskKey']\n      )\n    )\n      .filter((v) => v.taskKey !== key)\n      .map((v) => v.taskKey)\n\n    if (!taskKeyList.length) {\n      return []\n    }\n\n    const taskInfo = await this.taskRepository.findWithSpecifyColumn(\n      {\n        k: In(taskKeyList)\n      },\n      ['k', 'name']\n    )\n\n    // \n    const people = await this.peopleRepository.findWithSpecifyColumn(\n      {\n        taskKey: In(taskKeyList)\n      },\n      ['taskKey', 'name']\n    )\n\n    const data = taskInfo.map((v) => {\n      const count = people.filter((p) => p.taskKey === v.k).length\n      return {\n        taskKey: v.k,\n        name: v.name,\n        count\n      }\n    })\n    return data\n  }\n\n  async importPeopleFromTpl(\n    taskKey: string,\n    tplKey: string,\n    type: 'override' | 'add'\n  ) {\n    const fail: string[] = []\n    const success: string[] = []\n    // \n    if (taskKey === tplKey) {\n      this.behaviorService.error(\n        '',\n        new Error('').stack\n      )\n      return {\n        success: success.length,\n        fail\n      }\n    }\n\n    const user = this.ctx.req.userInfo\n\n    // \n    const people = await this.peopleRepository.findWithSpecifyColumn(\n      {\n        taskKey: tplKey,\n        userId: user.id\n      },\n      ['name']\n    )\n    // \n    if (type === 'override') {\n      // \n      await this.peopleRepository.delete({\n        taskKey,\n        userId: user.id\n      })\n      success.push(...people.map((v) => v.name))\n    }\n    if (type === 'add') {\n      // \n      const nowPeople = (\n        await this.peopleRepository.findWithSpecifyColumn(\n          { userId: user.id, taskKey },\n          ['name']\n        )\n      ).map((v) => v.name)\n      for (const p of people) {\n        if (nowPeople.includes(p.name)) {\n          fail.push(p.name)\n        } else {\n          success.push(p.name)\n        }\n      }\n    }\n    if (success.length) {\n      await this.peopleRepository.insertMany(\n        success.map((name) => {\n          const p = new People()\n          p.name = name\n          p.taskKey = taskKey\n          p.userId = user.id\n          return p\n        })\n      )\n    }\n    this.behaviorService.add(\n      'people',\n      ` :${user.account} :${success.length} :${fail.length}`,\n      {\n        account: user.account,\n        success: success.length,\n        fail: fail.length\n      }\n    )\n\n    return {\n      success: success.length,\n      fail\n    }\n  }\n}\n","import { TokenService } from '@/service'\n/**\n * Token()\n */\nclass TokenUtil extends TokenService {\n  static instance: TokenUtil = null\n\n  static getInstance() {\n    if (!this.instance) {\n      this.instance = new TokenUtil()\n    }\n    return this.instance\n  }\n}\n\nexport default TokenUtil.getInstance()\n","import { FWRequest } from 'flash-wolves'\nimport tokenUtil from './tokenUtil'\n\nexport async function getUserInfo(req: FWRequest) {\n  if (!req.headers.token) {\n    return null\n  }\n  return tokenUtil.getUserInfo(req.headers.token as string)\n}\n\n/**\n * \n */\nexport function calculateSize(size: number) {\n  // GB\n  return size * 1024 * 1024 * 1024\n}\n\n/**\n * qiniuurl\n * @param duration \n * @returns ()\n */\nexport function getQiniuFileUrlExpiredTime(duration: number) {\n  return Math.floor(Date.now() / 1000) + 60 * duration\n}\n","// types\nimport type { Route } from 'flash-wolves'\n\n// router\nimport people from './modules/people'\n// import file from './modules/file'\n\n// \nconst routers = [people]\n\nexport default routers.reduce(\n  (pre: Route[], router) => pre.concat(router.getRoutes()),\n  [],\n)\n","import {\n  RouterController,\n  Post,\n  ReqBody,\n  FWRequest,\n  Get,\n  Put,\n  ReqParams,\n  Response\n} from 'flash-wolves'\nimport { WishStatus } from '@/db/model/wish'\nimport type { Wish } from '@/db/model/wish'\nimport { addWishData, findWish, updateWish } from '@/db/wishDb'\nimport { getObjectIdDate, getUniqueKey } from '@/utils/stringUtil'\nimport { addBehavior } from '@/db/logDb'\nimport { USER_POWER } from '@/db/model/user'\nimport { ReqIp } from '@/decorator'\nimport { addAction, findAction, findActionCount } from '@/db/actionDb'\nimport { ActionType } from '@/db/model/action'\n\nconst adminPower = { needLogin: true, userPower: USER_POWER.SUPER }\n// TODOmongoDB typeorm\n@RouterController('wish')\nexport default class WishController {\n  /**\n   * \n   */\n  @Post('add', { CORS: true })\n  async addWish(@ReqBody() body: Wish, req: FWRequest) {\n    addBehavior(req, {\n      module: 'wish',\n      msg: '',\n      data: body\n    })\n\n    const wish: Wish = {\n      ...body,\n      id: getUniqueKey(),\n      status: WishStatus.REVIEW\n    }\n    await addWishData(wish)\n  }\n\n  @Get('all', adminPower)\n  async getAllWish() {\n    const wishes = await findWish({})\n    // \n    wishes.sort((a, b) => {\n      const aDate = getObjectIdDate(a.id)\n      const bDate = getObjectIdDate(b.id)\n      return bDate - aDate\n    })\n    return wishes.map((wish) => {\n      const { title, des, status, id, contact } = wish\n      const createDate = getObjectIdDate(id)\n      return {\n        title,\n        des,\n        status,\n        id,\n        contact,\n        createDate\n      }\n    })\n  }\n\n  @Put('update', adminPower)\n  async updateWishStatus(\n    @ReqBody('id') id: string,\n    @ReqBody('status') status: WishStatus\n  ) {\n    await updateWish({ id }, { $set: { status } })\n    // \n    if (status === WishStatus.START) {\n      await updateWish({ id }, { $set: { startDate: new Date() } })\n    }\n    if (status === WishStatus.CLOSE || status === WishStatus.END) {\n      await updateWish({ id }, { $set: { endDate: new Date() } })\n    }\n  }\n\n  @Put('update/:id', adminPower)\n  async updateWishData(@ReqParams('id') id: string, @ReqBody() body: Wish) {\n    const { title, des } = body\n    await updateWish({ id }, { $set: { title, des } })\n  }\n\n  @Get('all/docs', { CORS: true })\n  async getDocsWish(@ReqIp() ip: string) {\n    const wishes = await findWish({\n      $or: [\n        { status: WishStatus.START },\n        { status: WishStatus.WAIT },\n        { status: WishStatus.END }\n      ]\n    })\n    const result = []\n    for (const wish of wishes) {\n      const { title, des, id, startDate, status } = wish\n      const count = await findActionCount({\n        thingId: wish.id,\n        type: ActionType.PRAISE\n      })\n      const alreadyPraise =\n        (await findActionCount({\n          thingId: wish.id,\n          type: ActionType.PRAISE,\n          ip\n        })) > 0\n      result.push({\n        title: status === WishStatus.END ? `() ${title}` : title,\n        des,\n        id,\n        startDate,\n        count,\n        alreadyPraise,\n        status\n      })\n    }\n    // \n    result.sort((a, b) => b.count - a.count)\n    return result\n  }\n\n  /**\n   * \n   */\n  @Post('praise/:id', { CORS: true })\n  async praiseWis(@ReqParams('id') id: string, @ReqIp() ip: string) {\n    const wishes = await findWish({ id })\n    if (!wishes.length) {\n      return Response.fail(-1, '')\n    }\n    const praiseData = await findAction({\n      ip,\n      thingId: id,\n      type: ActionType.PRAISE\n    })\n    if (praiseData.length) {\n      return Response.fail(1, '')\n    }\n    await addAction({\n      type: ActionType.PRAISE,\n      thingId: id,\n      ip\n    })\n  }\n}\n","export enum WishStatus {\n  /**\n   * \n   */\n  REVIEW,\n  /**\n   * \n   */\n  WAIT,\n  /**\n   * \n   */\n  START,\n  /**\n   * \n   */\n  END,\n  /**\n   * \n   */\n  CLOSE\n}\nexport interface Wish {\n  id: string\n  /**\n   * \n   */\n  title: string\n  /**\n   * \n   */\n  des: string\n  /**\n   * \n   */\n  contact?: string\n  /**\n   * \n   */\n  status: WishStatus\n  startDate: Date\n  endDate: Date\n}\n","import { FilterQuery, UpdateQuery } from 'mongodb'\nimport {\n  findCollection,\n  insertCollection,\n  updateCollection\n} from '@/lib/dbConnect/mongodb'\nimport { Wish } from './model/wish'\n\nexport function addWishData(wish: Wish) {\n  return insertCollection<Wish>('wish', wish)\n}\n\nexport function findWish(wish: FilterQuery<Wish>) {\n  return findCollection<Wish>('wish', wish)\n}\n\nexport function updateWish(query: FilterQuery<Wish>, wish: UpdateQuery<Wish>) {\n  return updateCollection<Wish>('wish', query, wish)\n}\n","import { RequestValue } from 'flash-wolves'\n\nexport function ReqIp() {\n  return RequestValue('_ip')\n}\n\nexport function ReqUserInfo() {\n  return RequestValue('_userinfo')\n}\n","import type {\n  FWRequest,\n} from 'flash-wolves'\nimport {\n  Delete,\n  Get,\n  Post,\n  ReqBody,\n  ReqParams,\n  ReqQuery,\n  RouterController,\n} from 'flash-wolves'\nimport type { FilterQuery } from 'mongodb'\nimport { ObjectId } from 'mongodb'\nimport { selectFilesNew } from '@/db/fileDb'\nimport {\n  addBehavior,\n  findLog,\n  findLogCount,\n  findLogReserve,\n  findLogWithPageOffset,\n  findLogWithTimeRange,\n  findPvLogWithRange,\n} from '@/db/logDb'\nimport type {\n  Log,\n  LogBehaviorData,\n  LogErrorData,\n  LogRequestData,\n  LogType,\n  PvData,\n} from '@/db/model/log'\nimport { USER_POWER } from '@/db/model/user'\nimport { selectAllUser } from '@/db/userDb'\nimport { batchDeleteFiles, getFileKeys } from '@/utils/qiniuUtil'\nimport { formatSize } from '@/utils/stringUtil'\nimport SuperService from '@/service/super'\nimport { addAction, findAction, updateAction } from '@/db/actionDb'\nimport { ActionType } from '@/db/model/action'\nimport LocalUserDB from '@/utils/user-local-db'\n\nconst power = {\n  userPower: USER_POWER.SUPER,\n  needLogin: true,\n}\n\nconst tempTxtFileReg = /\\d+-\\d+.txt$/\n@RouterController('super/overview')\nexport default class OverviewController {\n  private cacheLogs: Log[] = []\n\n  private filterLog(logs: Log[]) {\n    return logs.map((log) => {\n      const { type, data, id } = log\n      const date = new ObjectId(id).getTimestamp()\n      if (type === 'request') {\n        const d = data as LogRequestData\n\n        return {\n          id,\n          date,\n          type,\n          ip: d.ip,\n          msg: `${d.method} ${d.url} ${`${d.duration || 0}ms`}`,\n        }\n      }\n      if (type === 'behavior') {\n        const d = data as LogBehaviorData\n\n        return {\n          id,\n          date,\n          type,\n          msg:\n            (d?.info?.msg || '')\n            // \n            + ((d.info?.data?.size && ` ${formatSize(d.info?.data?.size)}`)\n            || ''),\n          ip: d?.req?.ip || '',\n        }\n      }\n\n      if (type === 'pv') {\n        const d = data as PvData\n\n        return {\n          id,\n          date,\n          type,\n          ip: d.ip,\n          msg: `${d.path}`,\n        }\n      }\n      const d = data as LogErrorData\n\n      // \n      return {\n        id,\n        date,\n        type,\n        ip: d?.req?.ip || '',\n        msg: d?.msg || '',\n      }\n    })\n  }\n\n  private isExpiredCompressSource(putTime: number) {\n    const { downloadCompressExpired } = LocalUserDB.getSiteConfig()\n    return Date.now() - putTime > 1000 * 60 * (downloadCompressExpired || 60)\n  }\n\n  /**\n   * \n   * TODO:\n   */\n  @Get('log/:id', power)\n  async getLogDetail(@ReqParams('id') id: string) {\n    const [log] = await findLog({ id })\n    delete log.data.userId\n    return log.data\n  }\n\n  @Get('count', power)\n  async getDataOverview() {\n    const now = new Date()\n    const nowDate = new Date(\n      `${now.getFullYear()}-${now.getMonth() + 1}-${now.getDate()} GMT+8`,\n    )\n    const users = await selectAllUser(['join_time'])\n    const userRecent = users.filter(\n      u => new Date(u.join_time) > nowDate,\n    ).length\n\n    const files = await selectFilesNew({}, ['date', 'size'])\n    const fileRecent = files.filter(f => new Date(f.date) > nowDate).length\n\n    // redis\n    const ossFiles = await SuperService.getOssFiles()\n\n    const logCount = await findLogCount({})\n    const logRecent = await findLogWithTimeRange(nowDate)\n\n    // \n    const pvList = await findLogReserve({\n      type: 'pv',\n    })\n    const uv = new Set(pvList.map(pv => pv.data.ip)).size\n    // \n    const todayPv = await findPvLogWithRange(nowDate)\n    const todayUv = new Set(todayPv.map(pv => pv.data.ip)).size\n\n    // redis\n    const compressData = await getFileKeys('easypicker2/temp_package')\n    const tempTxtFilesData = await getFileKeys('1').then(v =>\n      v.filter(v => tempTxtFileReg.test(v.key)),\n    )\n\n    return {\n      user: {\n        sum: users.length,\n        recent: userRecent,\n      },\n      file: {\n        server: {\n          sum: files.length,\n          recent: fileRecent,\n          size: formatSize(files.reduce((sum, f) => sum + f.size, 0)),\n        },\n        oss: {\n          sum: ossFiles.length,\n          size: formatSize(ossFiles.reduce((sum, f) => sum + f.fsize, 0)),\n        },\n      },\n      log: {\n        sum: logCount,\n        recent: logRecent.length,\n      },\n      pv: {\n        today: {\n          sum: todayPv.length,\n          uv: todayUv,\n        },\n        all: {\n          sum: pvList.length,\n          uv,\n        },\n      },\n      compress: {\n        all: {\n          sum: compressData.length + tempTxtFilesData.length,\n          size: formatSize(\n            compressData\n              .concat(tempTxtFilesData)\n              .reduce((sum, item) => sum + item.fsize, 0),\n          ),\n        },\n        expired: {\n          sum: compressData\n            .concat(tempTxtFilesData)\n            .filter(item =>\n              this.isExpiredCompressSource(item.putTime / 10000),\n            ).length,\n          size: formatSize(\n            compressData\n              .concat(tempTxtFilesData)\n              .filter(item =>\n                this.isExpiredCompressSource(item.putTime / 10000),\n              )\n              .reduce((sum, item) => sum + item.fsize, 0),\n          ),\n        },\n      },\n    }\n  }\n\n  @Delete('compress', power)\n  async clearExpiredCompress(req: FWRequest) {\n    // \n    const compressData = await getFileKeys('easypicker2/temp_package')\n    const expired = compressData\n      .filter(item => this.isExpiredCompressSource(item.putTime / 10000))\n      .map(v => v.key)\n    await batchDeleteFiles(expired, req)\n\n    // txt\n    const txtFiles = (await getFileKeys('1')).filter(v =>\n      tempTxtFileReg.test(v.key),\n    )\n    const expiredTxt = txtFiles\n      .filter(item => this.isExpiredCompressSource(item.putTime / 10000))\n      .map(v => v.key)\n    await batchDeleteFiles(expiredTxt, req)\n    addBehavior(req, {\n      module: 'super',\n      msg: ` ${expired.length + expiredTxt.length}`,\n      data: {\n        keys: expired.concat(expiredTxt),\n      },\n    })\n  }\n\n  /**\n   * \n   */\n  @Get('log', power)\n  async getAllLog() {\n    let logs = []\n    if (this.cacheLogs) {\n      logs = this.cacheLogs\n      findLogReserve({}).then((data) => {\n        this.cacheLogs = data\n      })\n    }\n    else {\n      logs = await findLogReserve({})\n      this.cacheLogs = logs\n    }\n    const result = this.filterLog(logs)\n\n    return {\n      logs: result,\n    }\n  }\n\n  /**\n   * \n   */\n  @Post('log', power)\n  async getPartLog(\n    @ReqBody('type') type: LogType,\n    @ReqBody('pageSize') size = 6,\n    @ReqBody('pageIndex') index = 1,\n    @ReqBody('search') search = '',\n  ) {\n    let query: FilterQuery<Log> = {\n      type,\n    }\n    if (search) {\n      switch (type) {\n        case 'behavior':\n          query = {\n            ...query,\n            $or: [\n              {\n                'data.info.msg': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n              {\n                'data.req.ip': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n            ],\n          }\n          break\n        case 'request':\n          query = {\n            ...query,\n            $or: [\n              {\n                'data.method': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n              {\n                'data.url': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n              {\n                'data.ip': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n            ],\n          }\n          break\n        case 'pv':\n          query = {\n            ...query,\n            $or: [\n              {\n                'data.path': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n              {\n                'data.ip': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n            ],\n          }\n          break\n        case 'error':\n          query = {\n            ...query,\n            $or: [\n              {\n                'data.req.ip': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n              {\n                'data.msg': {\n                  $regex: `.*${search}.*`,\n                },\n              },\n            ],\n          }\n          break\n        default:\n          break\n      }\n    }\n    const logCount = await findLogCount(query)\n    const logs = await findLogWithPageOffset((index - 1) * size, size, query)\n    return {\n      logs: this.filterLog(logs),\n      sum: logCount,\n    }\n  }\n\n  @Post('route/disabled', power)\n  async changeDisabledRoute(\n    @ReqBody('route') route: string,\n    @ReqBody('status') status: boolean,\n  ) {\n    const actions = await findAction({\n      type: ActionType.DisabledRoute,\n    })\n    const action = actions.find(v => v.data.route === route)\n    if (!action) {\n      await addAction({\n        type: ActionType.DisabledRoute,\n        data: {\n          route,\n          status,\n        },\n      })\n      return\n    }\n    await updateAction(\n      {\n        id: action.id,\n      },\n      {\n        $set: {\n          data: {\n            route,\n            status,\n          },\n        },\n      },\n    )\n  }\n\n  @Get('route/disabled')\n  async checkDisabledRoute(@ReqQuery('route') route: string) {\n    let actionStatus = false\n    try {\n      const actions = await findAction<{\n        route: string\n        status: boolean\n      }>({\n        type: ActionType.DisabledRoute,\n      })\n      const action = actions.find(v => v.data.route === route)\n      actionStatus = Boolean(action?.data?.status)\n    }\n    catch (error) {\n      console.warn('[super/route/disabled] skip disabled route check:', error?.message || error)\n    }\n    return {\n      status: actionStatus,\n    }\n  }\n}\n","import {\n  RouterController,\n  Post,\n  ReqBody,\n  ReqParams,\n  FWRequest,\n  Get,\n  Put,\n  InjectCtx,\n  Context,\n  Inject\n} from 'flash-wolves'\nimport { selectTasks } from '@/db/taskDb'\nimport { deletePeople, insertPeople, selectPeople } from '@/db/peopleDb'\nimport { addBehavior, addErrorLog } from '@/db/logDb'\nimport { getUserInfo } from '@/utils/userUtil'\nimport { selectTaskInfo } from '@/db/taskInfoDb'\nimport { ReqUserInfo } from '@/decorator'\nimport type { User } from '@/db/model/user'\nimport { BehaviorService, PeopleService } from '@/service'\nimport { wrapperCatchError } from '@/utils/context'\n\nconst power = {\n  needLogin: true\n}\n\n@RouterController('people')\nexport default class PeopleController {\n  @InjectCtx()\n  ctx: Context\n\n  @Inject(BehaviorService)\n  behaviorService: BehaviorService\n\n  @Inject(PeopleService)\n  peopleService: PeopleService\n\n  @Post('/add/:key', power)\n  async addPeople(\n    // TODO:\n    @ReqParams('key') key: string,\n    @ReqBody('name') name: string\n  ) {\n    try {\n      await this.peopleService.addPeople(key, name)\n    } catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  /**\n   * \n   */\n  @Post('/check/:key')\n  async checkPeopleIsExist(\n    @ReqBody('name') name: string,\n    @ReqParams('key') key: string\n  ) {\n    const exist = await this.peopleService.checkPeopleIsExist(key, name)\n    return {\n      exist\n    }\n  }\n\n  @Get('/template/:key', power)\n  async getUsefulTemplate(@ReqParams('key') taskKey: string) {\n    return this.peopleService.getUsefulTemplate(taskKey)\n  }\n\n  @Put('/template/:key', power)\n  async importPeopleFromTpl(\n    @ReqParams('key') taskKey: string,\n    @ReqBody('key') tplKey,\n    @ReqBody('type') type: 'override' | 'add'\n  ) {\n    return this.peopleService.importPeopleFromTpl(taskKey, tplKey, type)\n  }\n}\n","import { Response } from 'flash-wolves'\n\nexport function wrapperCatchError(err: any) {\n  const { code, msg, data } = err || {}\n  if (code && msg && data) {\n    return Response.fail(code, msg, data)\n  }\n\n  if (code && msg) {\n    return Response.failWithError(err)\n  }\n  throw err\n}\n","import type {\n  Context,\n  FWRequest,\n} from 'flash-wolves'\nimport {\n  Delete,\n  Get,\n  Inject,\n  InjectCtx,\n  Post,\n  Put,\n  ReqBody,\n  ReqParams,\n  ReqQuery,\n  Response,\n  RouterController,\n} from 'flash-wolves'\nimport { ObjectID } from 'mongodb'\nimport { addBehavior, addErrorLog } from '@/db/logDb'\nimport { selectFiles, updateFileInfo } from '@/db/fileDb'\nimport {\n  checkLocalCompressStatus,\n} from '@/utils/localFileUtil'\nimport { fileError, publicError } from '@/constants/errorMsg'\nimport type { User } from '@/db/model/user'\nimport { ReqUserInfo } from '@/decorator'\nimport { BehaviorService, FileService, TaskService, LocalFileService } from '@/service'\nimport { wrapperCatchError } from '@/utils/context'\nimport { findAction } from '@/db/actionDb'\nimport { ActionType, type DownloadActionData } from '@/db/model/action'\nimport { getQiniuFileUrlExpiredTime } from '@/utils/userUtil'\nimport LocalUserDB from '@/utils/user-local-db'\nimport type { Files } from '@/db/entity'\nimport { verifyDownloadToken, keyToLocalPath, getCompressedPath } from '@/utils/localFileUtil'\nimport { filesTempDir, filesCompressedDir } from '@/constants'\nimport formidable from 'formidable'\nimport fs from 'node:fs'\nimport path from 'node:path'\n// TODO: \n\nconst power = {\n  needLogin: true,\n}\n\nconst noLogin = {\n  needLogin: false,\n}\n\n@RouterController('file', power)\nexport default class FileController {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(FileService)\n  private fileService: FileService\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(TaskService)\n  private taskService: TaskService\n\n  @Inject(LocalFileService)\n  private localFileService: LocalFileService\n\n  /**\n   * \n   */\n  @Post('/image/preview')\n  async getPreviewURL(\n    @ReqBody('ids') idList: number[],\n    @ReqUserInfo() user: User,\n    req: FWRequest,\n  ) {\n    addBehavior(req, {\n      module: 'file',\n      msg: ` :${user.account}`,\n      data: {\n        account: user.account,\n        idList,\n      },\n    })\n    const files = await selectFiles(\n      {\n        id: idList as any,\n        userId: user.id,\n      },\n      ['task_key', 'name', 'hash'],\n    )\n    const keys = files.map(\n      file => `easypicker2/${file.task_key}/${file.hash}/${file.name}`,\n    )\n    const expiredTime = getQiniuFileUrlExpiredTime(LocalUserDB.getSiteConfig()?.downloadOneExpired || 1)\n\n    const filesStatus = await this.localFileService.batchFileStatus(keys)\n    const result = await Promise.all(\n      filesStatus.map(async (status, idx) => {\n        if (status.code === 200 && status.data?.mimeType?.includes('image')) {\n          const cover = await this.localFileService.getImagePreviewUrl(\n            keys[idx],\n            'cover',\n            expiredTime,\n            req,\n          )\n          const preview = await this.localFileService.getImagePreviewUrl(\n            keys[idx],\n            'preview',\n            expiredTime,\n            req,\n          )\n          return {\n            cover,\n            preview,\n          }\n        }\n        return {\n          cover: '',\n          preview:\n            'https://img.cdn.sugarat.top/mdImg/MTY0OTkwMDMxNTY4NA==649900315684',\n        }\n      }),\n    )\n    return result\n  }\n\n  @Post('/download/count')\n  async downloadCount(\n    @ReqBody('ids') idList: number[],\n  ) {\n    try {\n      return await this.fileService.downloadCount(idList)\n    }\n    catch (error) {\n      console.error(':', error)\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Put('/name/rewrite')\n  async rewriteFilename(\n    @ReqBody('id') id: number,\n    @ReqBody('name') newName: string,\n    @ReqUserInfo() user: User,\n    req: FWRequest,\n  ) {\n    const file = (await selectFiles({ id, userId: user.id }))[0]\n    if (!file) {\n      addBehavior(req, {\n        module: 'file',\n        msg: ` :${user.account} id:${id} :${newName}`,\n      })\n      return Response.failWithError(fileError.noPower)\n    }\n    // \n    const ossKey = `easypicker2/${file.task_key}/${file.hash}/${file.name}`\n    const newOssKey = `easypicker2/${file.task_key}/${file.hash}/${newName}`\n    const isOldExist = await this.localFileService.judgeFileIsExist(ossKey)\n    const isNewExist = await this.localFileService.judgeFileIsExist(newOssKey)\n    if (!isOldExist) {\n      return Response.failWithError(fileError.noOssFile)\n    }\n    if (isNewExist) {\n      return Response.failWithError(fileError.ossFileRepeat) // \n    }\n    // \n    const { keyToLocalPath } = await import('@/utils/localFileUtil')\n    const oldPath = keyToLocalPath(ossKey)\n    const newPath = keyToLocalPath(newOssKey)\n    const { ensureDir } = await import('@/utils/localFileUtil')\n    ensureDir(path.dirname(newPath))\n    fs.renameSync(oldPath, newPath)\n    // \n    await updateFileInfo({ id, userId: user.id }, { name: newName })\n    addBehavior(req, {\n      module: 'file',\n      msg: ` :${user.account} id:${id} :${newName}`,\n    })\n  }\n\n  /**\n   * ()\n   */\n  @Get('/list/withUrl')\n  async listWithUrl() {\n    const { id: userId } = this.ctx.req.userInfo\n    const files = await selectFiles({\n      userId,\n    })\n    const expiredTime = getQiniuFileUrlExpiredTime(LocalUserDB.getSiteConfig()?.downloadOneExpired || 1)\n    return {\n      files: files.map(v => ({\n        ...v,\n        download: this.localFileService.getDownloadUrl(\n          this.fileService.getOssKey(v),\n          expiredTime,\n          this.ctx.req,\n        ),\n      })),\n    }\n  }\n\n  @Get('/one')\n  async downloadOne(@ReqQuery('id') id: string) {\n    try {\n      return await this.fileService.downloadOne(+id)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  /**\n   * \n   */\n  @Get('/download/:key', noLogin)\n  async downloadFile(@ReqParams('key') key: string) {\n    console.log('===  ===')\n    console.log(' key:', key)\n    \n    //  ObjectID \n    let fileKey: string | null = null\n    let download: any = null\n\n    try {\n      ObjectID(key)\n      console.log('key  ObjectID')\n      //  ObjectID\n      const [downloadRecord] = await findAction<DownloadActionData>({\n        _id: ObjectID(key),\n      })\n      if (downloadRecord) {\n        download = downloadRecord\n        console.log(':', downloadRecord.data)\n        //  originUrl  key token \n        const originUrl = downloadRecord.data.originUrl\n        if (originUrl.includes('/file/compress')) {\n          //  URL\n          console.log(':', originUrl)\n          this.ctx.res.writeHead(302, { Location: originUrl })\n          this.ctx.res.end()\n          return\n        }\n        else if (originUrl.includes('/file/download/')) {\n          const token = originUrl.split('/file/download/')[1]\n          fileKey = verifyDownloadToken(token)\n          console.log(' originUrl  token:', token, 'fileKey:', fileKey)\n        }\n        else {\n          //  originUrl  key\n          fileKey = downloadRecord.data.originUrl.replace(/^https?:\\/\\/[^/]+/, '')\n          console.log(' originUrl  key:', fileKey)\n        }\n      }\n    }\n    catch {\n      //  ObjectID token \n      console.log('key  ObjectID token ')\n      fileKey = verifyDownloadToken(key)\n      console.log('token :', fileKey)\n      if (!fileKey) {\n        console.error('token key:', key)\n        console.error('token ')\n      }\n    }\n\n    //  token  key\n    if (fileKey) {\n      console.log(' key:', fileKey)\n      // \n      let localPath: string\n      if (fileKey.startsWith('thumbnails/')) {\n        const { getThumbnailPath, getPreviewPath } = await import('@/utils/localFileUtil')\n        //  key  key hash \n        // \n        localPath = path.join(process.cwd(), 'files-manage', fileKey)\n      }\n      else if (fileKey.startsWith('compressed/')) {\n        // \n        const fileName = fileKey.replace('compressed/', '')\n        localPath = path.join(filesCompressedDir, fileName)\n        console.log(':', localPath)\n      }\n      else {\n        localPath = keyToLocalPath(fileKey)\n      }\n\n      console.log(':', localPath)\n      console.log(':', fs.existsSync(localPath))\n\n      if (fs.existsSync(localPath)) {\n        const stats = fs.statSync(localPath)\n        const fileName = path.basename(localPath)\n        console.log(' - :', fileName, ':', stats.size)\n\n        // \n        if (download) {\n          const { account: logAccount, tip: tipName, mimeType, size: fileSize } = download.data\n          const logMap = {\n            [ActionType.Download]: '',\n            [ActionType.Compress]: '',\n            [ActionType.TemplateDownload]: '',\n          }\n\n          this.behaviorService.add('file', `${logMap[download.type]} :${logAccount} :${tipName || fileName} :${mimeType}`, {\n            account: logAccount,\n            downloadType: download.type,\n            name: tipName || fileName,\n            size: fileSize || stats.size,\n            mimeType,\n            downloadActionId: key,\n          })\n        }\n\n        // \n        console.log('')\n        \n        //  writeHead \n        this.ctx.res.writeHead(200, {\n          'Content-Type': 'application/octet-stream',\n          'Content-Disposition': `attachment; filename=\"${encodeURIComponent(fileName)}\"`,\n          'Content-Length': stats.size.toString(),\n          'Cache-Control': 'no-cache',\n          'Access-Control-Allow-Origin': '*',\n        })\n\n        // \n        const fileStream = fs.createReadStream(localPath)\n        \n        fileStream.on('open', () => {\n          console.log('')\n        })\n        \n        fileStream.on('data', (chunk) => {\n          console.log(':', chunk.length)\n        })\n        \n        fileStream.on('error', (err) => {\n          console.error(':', err)\n          if (!this.ctx.res.headersSent) {\n            this.ctx.res.writeHead(500, { 'Content-Type': 'application/json;charset=utf-8' })\n            this.ctx.res.end(JSON.stringify({ code: 500, msg: '' }))\n          } else {\n            this.ctx.res.destroy()\n          }\n        })\n\n        fileStream.on('end', () => {\n          console.log('')\n        })\n\n        // \n        this.ctx.res.on('finish', () => {\n          console.log('')\n        })\n\n        this.ctx.res.on('close', () => {\n          console.log('')\n          // \n          if (!fileStream.destroyed) {\n            fileStream.destroy()\n          }\n        })\n\n        //  pipe pipe \n        fileStream.pipe(this.ctx.res)\n        \n        //  Promise\n        // \n        return new Promise<void>((resolve) => {\n          fileStream.on('end', () => {\n            console.log('Promise resolve')\n            resolve()\n          })\n          fileStream.on('error', () => {\n            resolve() //  resolve\n          })\n        })\n      }\n    }\n\n    //  token \n    console.error(' - fileKey:', fileKey, 'key:', key)\n    this.behaviorService.add('file', `: ${key}`)\n    return Response.failWithError(publicError.request.errorParams)\n  }\n\n  @Post('/batch/down')\n  async batchDownload(@ReqBody() body) {\n    const { ids, zipName } = body\n    try {\n      const result = await this.fileService.batchDownload(ids, zipName)\n      // \n      const archiveKey = result.k\n      const expiredTime = Math.floor(Date.now() / 1000) + 3600 * 12\n      const downloadUrl = this.localFileService.getDownloadUrl(archiveKey, expiredTime, this.ctx.req)\n      return {\n        ...result,\n        downloadUrl, // \n      }\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  /**\n   *  key\n   *  / \n   */\n  @Get('/compress', noLogin)\n  async downloadCompressFile(@ReqQuery('key') key: string) {\n    console.log('===  ===')\n    console.log(' key:', key)\n    console.log(' URL:', this.ctx.req.url)\n    \n    if (!key) {\n      console.error(' key ')\n      return Response.failWithError(publicError.request.errorParams)\n    }\n    \n    //  URL  key\n    const decodedKey = decodeURIComponent(key)\n    console.log(' key:', decodedKey)\n    \n    // key  compressed/filename.zip\n    let localPath: string\n    if (decodedKey.startsWith('compressed/')) {\n      const fileName = decodedKey.replace('compressed/', '')\n      localPath = path.join(filesCompressedDir, fileName)\n    } else {\n      // \n      localPath = path.join(filesCompressedDir, decodedKey)\n    }\n\n    console.log(':', localPath)\n    console.log(':', fs.existsSync(localPath))\n\n    if (!fs.existsSync(localPath)) {\n      console.error(':', localPath)\n      return Response.failWithError(publicError.request.errorParams)\n    }\n\n    const stats = fs.statSync(localPath)\n    const fileName = path.basename(localPath)\n    console.log(' - :', fileName, ':', stats.size)\n\n    // \n    console.log('')\n    \n    this.ctx.res.writeHead(200, {\n      'Content-Type': 'application/zip',\n      'Content-Disposition': `attachment; filename=\"${encodeURIComponent(fileName)}\"`,\n      'Content-Length': stats.size.toString(),\n      'Cache-Control': 'no-cache',\n      'Access-Control-Allow-Origin': '*',\n    })\n\n    const fileStream = fs.createReadStream(localPath)\n\n    fileStream.on('error', (err) => {\n      console.error(':', err)\n      if (!this.ctx.res.headersSent) {\n        this.ctx.res.writeHead(500, { 'Content-Type': 'application/json;charset=utf-8' })\n        this.ctx.res.end(JSON.stringify({ code: 500, msg: '' }))\n      } else {\n        this.ctx.res.destroy()\n      }\n    })\n\n    fileStream.pipe(this.ctx.res)\n    \n    return new Promise<void>((resolve) => {\n      fileStream.on('end', () => {\n        console.log('')\n        resolve()\n      })\n      fileStream.on('error', () => {\n        resolve()\n      })\n    })\n  }\n\n  /**\n   * \n   */\n  @Get('/template', noLogin)\n  async downloadTemplate(@ReqQuery() query) {\n    const { template, key } = query\n    try {\n      return await this.fileService.downloadTemplate(template, key)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  /**\n   * \n   */\n  @Get('/token', noLogin)\n  getUploadToken() {\n    this.behaviorService.add('file', '')\n    return { \n      token: '',\n      uploadUrl: '/api/file/upload'\n    }\n  }\n\n  /**\n   * \n   */\n  @Post('/upload', noLogin)\n  async uploadFile(req: FWRequest) {\n    console.log('===  ===')\n    console.log('URL:', req.url)\n    console.log('Method:', req.method)\n    console.log('Content-Type:', req.headers['content-type'])\n    \n    return new Promise((resolve, reject) => {\n      const form = formidable({\n        multiples: false,\n        keepExtensions: true,\n        maxFileSize: 1024 * 1024 * 1024 * 5, // 5GB\n        uploadDir: filesTempDir, // \n      })\n\n      console.log('formidable , uploadDir:', filesTempDir)\n\n      form.parse(req, async (err, fields, files) => {\n        console.log('formidable parse ')\n        console.log('err:', err)\n        console.log('fields:', JSON.stringify(fields))\n        console.log('files:', files ? Object.keys(files) : 'null')\n        \n        if (err) {\n          console.error(':', err)\n          resolve(Response.fail(500, `: ${err.message}`))\n          return\n        }\n\n        const file = Array.isArray(files.file) ? files.file[0] : files.file\n        if (!file) {\n          console.error(', files:', files)\n          resolve(Response.fail(400, ''))\n          return\n        }\n\n        try {\n          // formidable  fields \n          const key = Array.isArray(fields.key) ? fields.key[0] : fields.key\n          if (!key || typeof key !== 'string') {\n            console.error(' key , fields:', fields)\n            resolve(Response.fail(400, ' key '))\n            return\n          }\n\n          console.log(', key:', key, 'filepath:', file.filepath, 'size:', file.size)\n\n          // \n          const saved = await this.localFileService.saveFile(key, file.filepath)\n          if (!saved) {\n            console.error(', key:', key)\n            resolve(Response.fail(500, ''))\n            return\n          }\n\n          console.log(', key:', key)\n\n          // \n          const info = await this.localFileService.getFileInfo(key)\n          if (info && info.mimeType.includes('image')) {\n            await this.localFileService.generateThumbnail(key)\n            await this.localFileService.generatePreview(key)\n          }\n\n          // \n          try {\n            fs.unlinkSync(file.filepath)\n          }\n          catch {\n            // \n          }\n\n          this.behaviorService.add('file', `: ${key}`, {\n            key,\n            size: file.size,\n            mimeType: file.mimetype,\n          })\n\n          //  { code: 0, data: {...}, msg: 'ok' }\n          const result = {\n            code: 0,\n            data: {\n              key,\n              hash: '',\n              fsize: file.size,\n            },\n            msg: 'ok',\n          }\n          console.log(':', JSON.stringify(result))\n          resolve(result)\n        }\n        catch (error) {\n          console.error(':', error)\n          resolve(Response.fail(500, `: ${error}`))\n        }\n      })\n\n      form.on('error', (err) => {\n        console.error('formidable :', err)\n        reject(err)\n      })\n    })\n  }\n\n  @Post('/info', noLogin)\n  async submitInfo(@ReqBody() data: Files) {\n    try {\n      const task = await this.taskService.getTaskByKey(data.taskKey)\n      if (!task) {\n        this.behaviorService.add('file', ': ', data)\n        throw publicError.request.errorParams\n      }\n\n      const { userId } = task\n      Object.assign<Files, Partial<Files>>(data, {\n        userId,\n        categoryKey: '',\n        people: data.people || '',\n        originName: data.originName || '',\n      })\n      await this.fileService.addFile(data)\n      this.behaviorService.add('file', `: :${data.name} `, data)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Get('/list')\n  async getAllUserFiles() {\n    const { account: logAccount } = this.ctx.req.userInfo\n    const files = await this.fileService.getUserFiles()\n    this.behaviorService.add('file', ` :${logAccount} `, {\n      logAccount,\n    })\n    return {\n      files: files.map(v => ({\n        ...v,\n        // \n        category_key: v.categoryKey,\n        origin_name: v.originName,\n        task_name: v.taskName,\n        task_key: v.taskKey,\n        size: +v.size,\n      })),\n    }\n  }\n\n  @Delete('/one')\n  async deleteOneFile(@ReqBody('id') id) {\n    const { id: userId } = this.ctx.req.userInfo\n    try {\n      const file = await this.fileService.findOneFile({\n        id,\n        userId,\n      })\n      await this.fileService.deleteOneFile(file)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Delete('/withdraw', noLogin)\n  async withdrawFile(@ReqBody() body) {\n    try {\n      await this.fileService.withdrawFile(body)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Delete('/batch/del')\n  async batchDelete(@ReqBody('ids') ids: number[]) {\n    try {\n      await this.fileService.batchDelete(ids)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  /**\n   * \n   */\n  @Post('/compress/status')\n  async compressStatus(@ReqBody('id') id: string, req: FWRequest) {\n    const data = checkLocalCompressStatus(id)\n    if (data.code === 3) {\n      addErrorLog(req, data.desc + data.error)\n      return Response.fail(500, data.desc + data.error)\n    }\n    return data\n  }\n\n  @Post('submit/people', noLogin)\n  async checkSubmitInfo(@ReqBody() body) {\n    const result = await this.fileService.checkSubmitInfo(body)\n    return result\n  }\n}\n","import {\n  Delete,\n  Get,\n  Inject,\n  Put,\n  ReqBody,\n  ReqParams,\n  RouterController,\n} from 'flash-wolves'\n\nimport { TaskInfoService } from '@/service'\nimport { wrapperCatchError } from '@/utils/context'\n\nconst power = {\n  needLogin: true,\n}\n\nconst notLogin = {\n  needLogin: false,\n}\n\n@RouterController('task_info', power)\nexport default class TaskInfoController {\n  @Inject(TaskInfoService)\n  private taskInfoService: TaskInfoService\n\n  @Get('/template/:key')\n  async getUsefulTemplate(@ReqParams('key') taskKey: string) {\n    return this.taskInfoService.getUseFullTemplate(taskKey)\n  }\n\n  // TODO\n  @Delete('/tip/image/:key')\n  async delTipImage(\n    @ReqBody('uid') uid: number,\n    @ReqBody('name') name: string,\n    @ReqParams('key') key: string,\n  ) {\n    try {\n      await this.taskInfoService.delTipImage({ uid, name, key })\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Get('/:key', notLogin)\n  getTaskInfo(@ReqParams('key') key: string) {\n    return this.taskInfoService.getTaskInfo(key)\n  }\n\n  @Put('/:key')\n  async updateTaskInfo(@ReqBody() body, @ReqParams('key') key: string) {\n    return this.taskInfoService.updateTaskInfo(body, key)\n  }\n}\n","import {\n  Get,\n  Inject,\n  Post,\n  ReqBody,\n  ReqQuery,\n  RouterController,\n} from 'flash-wolves'\n\nimport { PublicService } from '@/service'\nimport { wrapperCatchError } from '@/utils/context'\nimport { ReqUserInfo } from '@/decorator'\nimport { User } from '@/db/entity'\nimport { UserError } from '@/constants/errorMsg'\n\n@RouterController('public')\nexport default class PublicController {\n  @Inject(PublicService)\n  private publicService: PublicService\n\n  @Get('code')\n  async getVerCode(\n    @ReqQuery('email') email: string,\n    @ReqQuery('scene') scene: string,\n    @ReqUserInfo() user?: User,\n  ) {\n    const targetEmail = user?.email || email\n    try {\n      if (!targetEmail) {\n        throw UserError.email.noExist\n      }\n      const sceneKey\n        = (scene as 'register' | 'login' | 'reset' | 'default') || 'default'\n      await this.publicService.getVerifyCode(targetEmail, sceneKey)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Get('report/pv', {\n    CORS: true,\n  })\n  @Post('report/pv')\n  reportPv() {\n    return this.publicService.reportPV()\n  }\n\n  @Get('check/email')\n  async checkEmailIsExist(@ReqQuery('email') email: string) {\n    try {\n      await this.publicService.checkEmailIsExist(email)\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Post('tip/image')\n  getTipImage(\n    @ReqBody('key') key: string,\n    @ReqBody('data')\n    data: {\n      uid: number\n      name: string\n    }[],\n  ) {\n    return this.publicService.getTipImage(key, data)\n  }\n}\n","import type {\n  FWRequest,\n} from 'flash-wolves'\nimport {\n  Delete,\n  Get,\n  Inject,\n  Post,\n  Put,\n  ReqBody,\n  Response,\n  RouterController,\n} from 'flash-wolves'\nimport dayjs from 'dayjs'\nimport { In } from 'typeorm'\nimport { USER_POWER, USER_STATUS } from '@/db/model/user'\nimport type { User } from '@/db/model/user'\nimport {\n  UserRepository,\n  selectUserByAccount,\n  selectUserByEmail,\n  selectUserById,\n  updateUser,\n} from '@/db/userDb'\nimport { addBehavior, findLog } from '@/db/logDb'\nimport { rEmail, rPassword, rVerCode } from '@/utils/regExp'\nimport { encryption, formatSize, percentageValue } from '@/utils/stringUtil'\nimport { FileRepository, selectFiles } from '@/db/fileDb'\nimport { UserError } from '@/constants/errorMsg'\nimport FileService from '@/service/file'\nimport { batchDeleteFiles } from '@/utils/qiniuUtil'\nimport { MessageType } from '@/db/model/message'\nimport MessageService from '@/service/message'\nimport { ReqUserInfo } from '@/decorator'\nimport {\n  BehaviorService,\n  QiniuService,\n  SuperUserService,\n  TokenService,\n  FileService as newFileService,\n} from '@/service'\nimport { calculateSize } from '@/utils/userUtil'\nimport LocalUserDB from '@/utils/user-local-db'\n\nconst power = {\n  userPower: USER_POWER.SUPER,\n  needLogin: true,\n}\n\n@RouterController('super/user', power)\nexport default class SuperUserController {\n  @Inject(TokenService)\n  private tokenService: TokenService\n\n  @Inject(SuperUserService)\n  private superUserService: SuperUserService\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(UserRepository)\n  private userRepository: UserRepository\n\n  @Inject(QiniuService)\n  private qiniuService: QiniuService\n\n  @Inject(FileRepository)\n  private fileRepository: FileRepository\n\n  @Inject(newFileService)\n  private fileService: newFileService\n\n  @Post('message')\n  async sendMessage(\n    @ReqBody('type')\n    type: MessageType,\n    @ReqBody('text')\n    text: string,\n    @ReqUserInfo() user: User,\n    @ReqBody('target')\n    target?: number,\n  ) {\n    // \n    if ((type === MessageType.USER_PUSH && !target) || !text.trim()) {\n      return\n    }\n    if (type === MessageType.USER_PUSH) {\n      MessageService.sendMessage(user.id, target, text)\n    }\n    else if (type === MessageType.GLOBAL_PUSH) {\n      MessageService.sendGlobalMessage(user.id, text)\n    }\n  }\n\n  @Delete('logout')\n  async logout(@ReqBody('account') account: string) {\n    return this.superUserService.logout(account)\n  }\n\n  @Get('message', {\n    userPower: USER_POWER.NORMAL,\n  })\n  async getMessageList(@ReqUserInfo() user: User) {\n    const messageList = await MessageService.getMessageList(user.id)\n    return messageList.map((v) => {\n      return {\n        id: v.id,\n        type: v.type,\n        style: v.style,\n        date: v.date,\n        text: v.text,\n        read: v.read,\n      }\n    })\n  }\n\n  @Put('message', {\n    userPower: USER_POWER.NORMAL,\n  })\n  readMessage(@ReqUserInfo() user: User, @ReqBody('id') id: string) {\n    MessageService.readMessage(user.id, id)\n  }\n\n  /**\n   * \n   */\n  @Get('list')\n  async getUserList() {\n    // \n    const users = await this.userRepository.findMany({})\n    // \n    const files = await this.fileRepository.findMany({})\n    const { moneyStartDay } = LocalUserDB.getSiteConfig()\n    const filesMap = await this.qiniuService.getFilesMap(files)\n    const downloadLog = await this.fileService.downloadLog('', {\n      startTime: new Date(moneyStartDay),\n    })\n    // \n    for (const user of users) {\n      const fileInfo = files.filter(file => file.userId === user.id)\n      const overviewData = await this.fileService.getUserOverview(user, {\n        files: fileInfo,\n        filesMap,\n        downloadLog: downloadLog.filter((v => v.data?.info?.data?.account === user.account)),\n      })\n      Object.assign(user, overviewData)\n    }\n    const sumCost = users.reduce((acc, cur: any) => acc + cur.cost, 0)\n    return {\n      list: users.map((u) => {\n        const email = u?.email\n        const maskedEmail = email\n          ? email.replace(/(.{2}).+(@.+)/, (_, prefix, suffix) => `${prefix}***${suffix}`)\n          : ''\n        return {\n          ...u,\n          email: maskedEmail,\n        }\n      }),\n      sumCost: sumCost.toFixed(2),\n    }\n  }\n\n  @Delete('clear/oss')\n  async clearOssFiles(\n    @ReqBody('id') id: number,\n    @ReqBody('type')\n    type: 'month' | 'quarter' | 'half',\n    @ReqUserInfo()\n    userInfo: User,\n  ) {\n    const user = (await selectUserById(id))[0]\n    if (!user) {\n      return\n    }\n    const months = {\n      month: 1,\n      quarter: 3,\n      half: 6,\n    }\n    if (!months[type]) {\n      return\n    }\n    const beforeDate = dayjs().subtract(months[type], 'month')\n    const files = (\n      await selectFiles(\n        {\n          userId: id,\n        },\n        ['task_key', 'user_id', 'hash', 'name', 'date', 'id', 'oss_del_time'],\n      )\n    ).filter((v) => {\n      return dayjs(v.date).isBefore(beforeDate) && !v.oss_del_time\n    })\n    if (files.length === 0) {\n      return\n    }\n    const delKeys = files.map(FileService.getOssKey)\n    MessageService.sendMessage(\n      userInfo.id,\n      user.id,\n      MessageService.clearMessageFormat('', [\n        `<strong style=\"font-weight: bold; color: rgb(71, 193, 168);\"><span style=\"color:red;\"> ${months[type]} </span></strong>`,\n        'Thanks()',\n      ]),\n    )\n    batchDeleteFiles(delKeys)\n\n    // OSS\n    await this.fileRepository.updateSpecifyFields({\n      id: In(files.map(v => v.id)),\n    }, {\n      ossDelTime: new Date(),\n    })\n  }\n\n  /**\n   * \n   */\n  @Put('status')\n  async changeStatus(\n    @ReqBody('id') id: number,\n    @ReqBody('status') status: USER_STATUS,\n    @ReqBody('openTime') openTime: any,\n  ) {\n    if (status !== USER_STATUS.FREEZE) {\n      openTime = null\n    }\n    else {\n      openTime = new Date(new Date(openTime).getTime())\n    }\n    await updateUser(\n      {\n        status,\n        openTime,\n      },\n      {\n        id,\n      },\n    )\n  }\n\n  @Put('password')\n  async resetPassword(\n    @ReqBody('id') id: number,\n    @ReqBody('password') password: string,\n    req: FWRequest,\n  ) {\n    const user = await selectUserById(id)\n    if (!user.length || !rPassword.test(password)) {\n      addBehavior(req, {\n        module: 'super',\n        data: req.body,\n        msg: ': ',\n      })\n      return Response.fail(500, '')\n    }\n    delete req.body.password\n    addBehavior(req, {\n      module: 'super',\n      data: req.body,\n      msg: `: ${user[0].account}`,\n    })\n    await updateUser(\n      {\n        password: encryption(password),\n      },\n      {\n        id,\n      },\n    )\n  }\n\n  @Put('email')\n  async resetEmail(\n    @ReqBody('id') id: number,\n    @ReqBody('email') email: string,\n    @ReqBody('code') code: string,\n    @ReqUserInfo() operator: User,\n    req: FWRequest,\n  ) {\n    const user = await selectUserById(id)\n    if (!user.length || !rEmail.test(email) || !rVerCode.test(code)) {\n      addBehavior(req, {\n        module: 'super',\n        data: req.body,\n        msg: ': ',\n      })\n      return Response.fail(500, '')\n    }\n    if (!operator?.email) {\n      addBehavior(req, {\n        module: 'super',\n        data: req.body,\n        msg: ': ',\n      })\n      return Response.fail(500, '')\n    }\n    const realCode = await this.tokenService.getVerifyCode(operator.email)\n    if (realCode !== code) {\n      addBehavior(req, {\n        module: 'super',\n        data: req.body,\n        msg: ': ',\n      })\n      return Response.failWithError(UserError.code.fault)\n    }\n\n    let [otherUser] = await selectUserByEmail(email)\n    if (!otherUser) {\n      ;[otherUser] = await selectUserByAccount(email)\n    }\n    if (otherUser) {\n      addBehavior(req, {\n        module: 'super',\n        msg: `:  ${email} `,\n        data: req.body,\n      })\n      return Response.failWithError(UserError.email.exist)\n    }\n    this.tokenService.expiredVerifyCode(operator.email)\n    addBehavior(req, {\n      module: 'super',\n      data: req.body,\n      msg: `: ${user[0].account}`,\n    })\n    await updateUser(\n      {\n        email,\n      },\n      {\n        id,\n      },\n    )\n  }\n\n  @Put('size')\n  async changeSize(@ReqBody('id') id: number, @ReqBody('size') size: number) {\n    const user = await this.userRepository.findOne({\n      id,\n    })\n    this.behaviorService.add(\n      'super',\n      ` ${user.account} ${user.size} => ${size}GB`,\n      {\n        oldSize: user.size,\n        newSize: size,\n      },\n    )\n    user.size = size\n    await this.userRepository.update(user)\n  }\n\n  @Put('wallet')\n  async updateWalletValue(@ReqBody('id') id: number, @ReqBody('value') value: number) {\n    const user = await this.userRepository.findOne({\n      id,\n    })\n    this.behaviorService.add(\n      'super',\n      ` ${user.account} ${user.wallet} => ${value} `,\n      {\n        oldValue: user.wallet,\n        newValue: value,\n      },\n    )\n    user.wallet = value.toFixed(2)\n    await this.userRepository.update(user)\n  }\n}\n","import { File } from '@/db/model/file'\n\nclass FileService {\n  getOssKey(file: File) {\n    return `easypicker2/${file.task_key || file.taskKey}/${file.hash}/${\n      file.name\n    }`\n  }\n}\n\nexport default new FileService()\n","export enum MessageType {\n  GLOBAL_PUSH,\n  USER_PUSH\n}\n\nexport enum MessageStyle {\n  Dialog,\n  Notification,\n  MESSAGE,\n  Link\n}\n\nexport interface Message {\n  id: string\n  source: number\n  target: number\n  type: MessageType\n  style: MessageStyle\n  date: Date\n  text: string\n  read: boolean\n}\n","import {\n  findCollection,\n  insertCollection,\n  updateCollection\n} from '@/lib/dbConnect/mongodb'\nimport { getUniqueKey } from '@/utils/stringUtil'\nimport { Message, MessageStyle, MessageType } from '../db/model/message'\nimport { selectAllUser } from '../db/userDb'\n\nclass MessageService {\n  sendMessage(source: number, target: number, text: string) {\n    return insertCollection<Message>('message', {\n      id: getUniqueKey(),\n      source,\n      target,\n      type: MessageType.USER_PUSH,\n      style: MessageStyle.Dialog,\n      date: new Date(),\n      text,\n      read: false\n    })\n  }\n\n  async sendGlobalMessage(source: number, text: string) {\n    const users = await selectAllUser(['id'])\n    return insertCollection<Message>(\n      'message',\n      users.map((u) => {\n        return {\n          id: getUniqueKey(),\n          source,\n          target: u.id,\n          type: MessageType.GLOBAL_PUSH,\n          style: MessageStyle.Dialog,\n          date: new Date(),\n          text,\n          read: false\n        }\n      }),\n      true\n    )\n  }\n\n  getMessageList(userId: number) {\n    return findCollection<Message>('message', { target: userId }).then((v) => {\n      v.sort((a, b) => b.date.getTime() - a.date.getTime())\n      return v\n    })\n  }\n\n  readMessage(userId: number, msgId: string) {\n    return updateCollection<Message>(\n      'message',\n      { target: userId, id: msgId },\n      {\n        $set: {\n          read: true\n        }\n      }\n    )\n  }\n\n  clearMessageFormat(title: string, lines: string[], callMe = true) {\n    return `<section id=\"nice\" data-tool=\"mdnice\" data-website=\"https://www.mdnice.com\" style=\"font-size: 16px; color: black; padding: 0 10px; line-height: 1.6; word-spacing: 0px; letter-spacing: 0px; word-break: break-word; word-wrap: break-word; text-align: left; font-family: Optima-Regular, Optima, PingFangSC-light, PingFangTC-light, 'PingFang SC', Cambria, Cochin, Georgia, Times, 'Times New Roman', serif;\"><h2 data-tool=\"mdnice\" style=\"margin-top: 30px; padding: 0px; font-weight: bold; font-size: 22px; border-bottom: 2px solid rgb(89,89,89); margin-bottom: 30px; color: rgb(89,89,89);\"><span class=\"prefix\" style=\"display: none;\"></span><span class=\"content\" style=\"font-size: 22px; display: inline-block; border-bottom: 2px solid rgb(89,89,89);\">${title}</span><span class=\"suffix\"></span></h2>\n    ${lines\n      .map(\n        (v) =>\n          `<p data-tool=\"mdnice\" style=\"font-size: 16px; padding-top: 8px; padding-bottom: 8px; margin: 0; line-height: 26px; color: rgb(89,89,89);\"><strong style=\"font-weight: bold; color: rgb(71, 193, 168);\">${v}</p>`\n      )\n      .join('')}\n  ${\n    callMe\n      ? '<figure data-tool=\"mdnice\" style=\"margin: 0; margin-top: 10px; margin-bottom: 10px; display: flex; flex-direction: column; justify-content: center; align-items: center;\"><img src=\"https://img.cdn.sugarat.top/mdImg/MTY3ODAwMDI5NDY4NQ==678000294685\" alt style=\"display: block; margin: 0 auto; max-width: 100%;\"></figure>'\n      : ''\n  }\n  </section>`\n  }\n}\n\nexport default new MessageService()\n","import type {\n  Context,\n} from 'flash-wolves'\nimport {\n  Get,\n  Inject,\n  InjectCtx,\n  Post,\n  Put,\n  ReqBody,\n  Response,\n  RouterController,\n} from 'flash-wolves'\nimport { findAction } from '@/db/actionDb'\n\nimport { UserError } from '@/constants/errorMsg'\nimport { USER_POWER } from '@/db/model/user'\nimport LocalUserDB from '@/utils/user-local-db'\nimport {\n  BehaviorService,\n  FileService,\n  TokenService,\n  UserService,\n} from '@/service'\nimport { wrapperCatchError } from '@/utils/context'\nimport { User } from '@/db/entity'\nimport { ActionType } from '@/db/model/action'\nimport { calculateSize } from '@/utils/userUtil'\nimport { UserRepository } from '@/db/userDb'\nimport { formatSize } from '@/utils/stringUtil'\n\n@RouterController('user')\nexport default class UserController {\n  @Inject(UserService)\n  private userService: UserService\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(TokenService)\n  private tokenService: TokenService\n\n  @Inject(UserRepository)\n  private userRepository: UserRepository\n\n  @Inject(FileService)\n  private fileService: FileService\n\n  @InjectCtx()\n  private Ctx: Context\n\n  @Post('register')\n  async register(@ReqBody() body: any) {\n    try {\n      // \n      const [action] = await findAction<{\n        status: boolean\n      }>({\n        'type': ActionType.DisabledRoute,\n        'data.route': '/register',\n      })\n      if (action?.data?.status) {\n        this.behaviorService.add('user', ` ${body?.account}`, {\n          account: body?.account,\n        })\n        throw UserError.system.ban\n      }\n      const user = await this.userService.register(body)\n      const token = await this.tokenService.createTokenByUser(user)\n      return {\n        token,\n      }\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Post('login')\n  async login(\n    @ReqBody('account') account: string,\n    @ReqBody('pwd') pwd: string,\n  ) {\n    try {\n      if (!account || !pwd) {\n        return Response.failWithError(UserError.account.fault)\n      }\n\n      // \n      const systemUserConfigs = LocalUserDB.findUserConfig({\n        type: 'server',\n        key: 'USER',\n      }) || []\n      \n      const isSystemAccount = systemUserConfigs.length > 0 && systemUserConfigs.some(config => config?.value === account)\n      \n      console.log('[] :', {\n        account,\n        systemUsers: systemUserConfigs.map(c => c?.value).filter(Boolean),\n        isSystemAccount,\n        configCount: systemUserConfigs.length,\n      })\n      \n      if (isSystemAccount) {\n        const systemPwdConfigs = LocalUserDB.findUserConfig({ \n          type: 'server', \n          key: 'PWD' \n        }) || []\n        \n        const isRightPwd = systemPwdConfigs.length > 0 && systemPwdConfigs.some(config => config?.value === pwd)\n        \n        console.log('[] :', {\n          pwdLength: pwd?.length,\n          isRightPwd,\n          pwdConfigCount: systemPwdConfigs.length,\n        })\n        \n        if (isRightPwd) {\n          try {\n            const u = new User()\n            u.account = account\n            u.power = USER_POWER.SYSTEM\n            const token = await this.tokenService.createTokenByUser(u)\n            console.log('[] :', account)\n            return {\n              token,\n              system: true,\n            }\n          }\n          catch (tokenError) {\n            console.error('[]  token :', tokenError)\n            return Response.fail(500, '')\n          }\n        }\n        \n        console.log('[] :', account)\n        return Response.failWithError(UserError.pwd.fault)\n      }\n\n      // \n      const user = await this.userService.login(account, pwd)\n      const token = await this.tokenService.createTokenByUser(user)\n      return {\n        token,\n      }\n    }\n    catch (error: any) {\n      console.error('[] :', {\n        error: error?.message || error,\n        stack: error?.stack,\n        account,\n      })\n      \n      // \n      if (error?.code && error?.msg) {\n        return Response.failWithError(error)\n      }\n      \n      return wrapperCatchError(error)\n    }\n  }\n\n  @Get('logout', { needLogin: true })\n  async logout() {\n    const { account } = this.Ctx.req.userInfo\n    this.behaviorService.add('user', ` ${account}`, {\n      account,\n    })\n    this.tokenService.expiredToken(this.Ctx.req.headers.token as string)\n  }\n\n  @Post('login/code')\n  async loginByCode(@ReqBody() body) {\n    try {\n      const { code, email } = body\n      const user = await this.userService.loginByCode(email, code)\n      const token = await this.tokenService.createTokenByUser(user)\n      return {\n        token,\n      }\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Put('password')\n  async updatePassword(@ReqBody() body) {\n    try {\n      const user = await this.userService.updatePassword(body)\n      const token = await this.tokenService.createTokenByUser(user)\n      return {\n        token,\n      }\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Get('power/super', { needLogin: true })\n  async isSuperPower() {\n    const { power, account } = this.Ctx.req.userInfo\n    this.tokenService.refreshToken(this.Ctx.req.headers.token as string)\n    return {\n      power: power === USER_POWER.SUPER,\n      name: account,\n      system: power === USER_POWER.SYSTEM,\n    }\n  }\n\n  @Get('login', { needLogin: true })\n  async isLogin() {\n    return !!this.Ctx.req.userInfo\n  }\n\n  @Get('usage', { needLogin: true })\n  async getUsage() {\n    const user = await this.userRepository.findOne({\n      id: this.Ctx.req.userInfo.id,\n    })\n    const userOverview = await this.fileService.getUserOverview(user)\n    const { maxSize, usage, limitUpload, wallet, cost, limitSpace, limitWallet, price } = userOverview\n    if (limitSpace) {\n      this.behaviorService.add('user', ` ${user.account} `, {\n        space: formatSize(maxSize),\n        usage: formatSize(usage),\n      })\n    }\n    if (limitWallet) {\n      this.behaviorService.add('user', ` ${user.account} `, {\n        wallet,\n        cost,\n      })\n    }\n    return {\n      size: maxSize,\n      usage,\n      limitUpload,\n      wallet,\n      cost: cost.toFixed(2),\n      limitSpace,\n      limitWallet,\n      price: {\n        storage: price.ossPrice,\n        download: (+price.backhaulTrafficPrice + +price.cdnPrice + +price.compressPrice).toFixed(2),\n      },\n    }\n  }\n}\n","import fs from 'node:fs/promises'\nimport path from 'node:path'\nimport mysql from 'mysql'\nimport redis from 'redis'\nimport { MongoClient } from 'mongodb'\nimport {\n  Get,\n  Inject,\n  Post,\n  Put,\n  ReqBody,\n  ReqQuery,\n  RouterController,\n} from 'flash-wolves'\nimport { USER_POWER, USER_STATUS } from '@/db/model/user'\nimport { getRedisStatus } from '@/lib/dbConnect/redis'\nimport { getMongoDBStatus, refreshMongoDb } from '@/lib/dbConnect/mongodb'\nimport { getMysqlStatus, refreshPool } from '@/lib/dbConnect/mysql'\nimport { getQiniuStatus, refreshQinNiuConfig } from '@/utils/qiniuUtil'\nimport type { UserConfig } from '@/db/model/config'\nimport { UserConfigLabels } from '@/constants'\nimport LocalUserDB from '@/utils/user-local-db'\nimport { initTypeORM } from '@/db'\nimport { patchTable } from '@/utils/patch'\nimport type { GlobalSiteConfig } from '@/types'\nimport { encryption } from '@/utils/stringUtil'\nimport {\n  insertUser,\n  selectUserByAccount,\n  selectUserByEmail,\n  updateUser,\n} from '@/db/userDb'\nimport { rEmail } from '@/utils/regExp'\nimport { randomNumStr } from '@/utils/randUtil'\nimport { sendMail, getMailConfig, resetMailTransporter, type MailConfig } from '@/utils/mailUtil'\nimport { TokenService } from '@/service'\nimport { UserError } from '@/constants/errorMsg'\n\nconst AUTO_SQL_PATH = path.join(\n  process.cwd(),\n  'docs/sql/auto_create.sql',\n)\n\nlet cachedAutoCreateSql = ''\n\ninterface MysqlInitPayload {\n  host: string\n  port: string\n  database: string\n  username: string\n  password: string\n}\n\ninterface RedisConfigPayload {\n  host: string\n  port: string\n  password?: string\n}\n\ninterface MongoConfigPayload {\n  uri: string\n}\n\ninterface AdminPayload {\n  username: string\n  email: string\n  password: string\n}\n\ninterface MailConfigPayload {\n  smtpHost: string\n  smtpPort: string\n  useSSL: boolean\n  account: string\n  password: string\n  from?: string\n  senderName?: string\n  subject?: string\n  template?: string\n}\n\ninterface MailTestPayload {\n  target: string\n}\n\ninterface MailLiveTestPayload extends MailConfigPayload {\n  target: string\n}\n\ninterface FinishInitPayload {\n  email: string\n  mysql: {\n    host: string\n    port: string\n    database: string\n    username: string\n    password: string\n  }\n  admin: {\n    username: string\n    email: string\n    password: string\n  }\n}\n\nasync function loadAutoCreateSql() {\n  if (!cachedAutoCreateSql) {\n    cachedAutoCreateSql = await fs.readFile(AUTO_SQL_PATH, 'utf-8')\n  }\n  return cachedAutoCreateSql\n}\n\nfunction normalizeMysqlPayload(payload: MysqlInitPayload) {\n  return {\n    ...payload,\n    port: Number(payload.port) || 3306,\n  }\n}\n\nfunction normalizeRedisPayload(payload: RedisConfigPayload) {\n  return {\n    host: payload.host,\n    port: Number(payload.port) || 6379,\n    password: payload.password || '',\n  }\n}\n\nfunction parseMongoUri(uri: string) {\n  const parsed = new URL(uri)\n  const auth = Boolean(parsed.username)\n  return {\n    uri,\n    host: parsed.hostname,\n    port: Number(parsed.port) || 27017,\n    user: parsed.username ? decodeURIComponent(parsed.username) : '',\n    password: parsed.password ? decodeURIComponent(parsed.password) : '',\n    database: parsed.pathname?.replace('/', '') || 'admin',\n    auth,\n  }\n}\n\nfunction createMysqlConnection(payload: MysqlInitPayload, useDb = false) {\n  const cfg = normalizeMysqlPayload(payload)\n  const connectionConfig: mysql.ConnectionConfig = {\n    host: cfg.host,\n    port: cfg.port,\n    user: cfg.username,\n    password: cfg.password,\n    charset: 'utf8mb4_general_ci',\n    multipleStatements: true,\n  }\n  if (useDb) {\n    connectionConfig.database = cfg.database\n  }\n  return new Promise<mysql.Connection>((resolve, reject) => {\n    const connection = mysql.createConnection(connectionConfig)\n    connection.connect((err) => {\n      if (err) {\n        reject(err)\n        return\n      }\n      resolve(connection)\n    })\n  })\n}\n\nfunction exec(connection: mysql.Connection, sql: string) {\n  return new Promise<void>((resolve, reject) => {\n    connection.query(sql, (err) => {\n      if (err) {\n        reject(err)\n        return\n      }\n      resolve()\n    })\n  })\n}\n\nasync function ensureMysqlSchema(payload: MysqlInitPayload) {\n  const dbPayload = normalizeMysqlPayload(payload)\n  const connection = await createMysqlConnection(dbPayload)\n  try {\n    await exec(\n      connection,\n      `DROP DATABASE IF EXISTS \\`${dbPayload.database}\\``,\n    )\n    await exec(\n      connection,\n      `CREATE DATABASE IF NOT EXISTS \\`${dbPayload.database}\\` DEFAULT CHARACTER SET utf8mb4 COLLATE utf8mb4_general_ci`,\n    )\n  }\n  finally {\n    connection.end()\n  }\n\n  const dbConnection = await createMysqlConnection(dbPayload, true)\n  try {\n    const sql = await loadAutoCreateSql()\n    await exec(dbConnection, sql)\n  }\n  finally {\n    dbConnection.end()\n  }\n}\n\ntype ConfigEntry = {\n  type: UserConfig['type']\n  key: string\n  value: any\n  isSecret?: boolean\n}\n\nasync function saveConfigEntries(entries: ConfigEntry[]) {\n  for (const entry of entries) {\n    await LocalUserDB.setUserConfig({\n      type: entry.type,\n      key: entry.key,\n      value: entry.value,\n      isSecret: Boolean(entry.isSecret),\n    })\n  }\n  await LocalUserDB.updateLocalEnv()\n}\n\nasync function persistMysqlConfig(payload: MysqlInitPayload) {\n  const cfg = normalizeMysqlPayload(payload)\n  await saveConfigEntries([\n    { type: 'mysql', key: 'host', value: cfg.host },\n    { type: 'mysql', key: 'port', value: cfg.port },\n    { type: 'mysql', key: 'database', value: cfg.database },\n    { type: 'mysql', key: 'user', value: cfg.username },\n    { type: 'mysql', key: 'password', value: cfg.password, isSecret: true },\n  ])\n  await refreshPool()\n  try {\n    await initTypeORM()\n    await patchTable()\n  }\n  catch (error) {\n    console.log(' TypeORM , ', error?.message)\n  }\n}\n\nasync function testMysqlConnection(payload: MysqlInitPayload) {\n  const connection = await createMysqlConnection(payload)\n  try {\n    await exec(connection, 'SELECT 1')\n  }\n  finally {\n    connection.end()\n  }\n}\n\nfunction createRedisClient(payload: RedisConfigPayload) {\n  const cfg = normalizeRedisPayload(payload)\n  const options = cfg.password\n    ? {\n        password: cfg.password,\n      }\n    : undefined\n  const client = redis.createClient(cfg.port, cfg.host, options)\n  return { client, cfg }\n}\n\nasync function testRedisConnection(payload: RedisConfigPayload) {\n  const { client } = createRedisClient(payload)\n  return new Promise<void>((resolve, reject) => {\n    client.on('ready', () => {\n      client.quit()\n      resolve()\n    })\n    client.on('error', (err) => {\n      client.quit()\n      reject(err)\n    })\n  })\n}\n\nasync function persistRedisConfig(payload: RedisConfigPayload) {\n  const cfg = normalizeRedisPayload(payload)\n  await saveConfigEntries([\n    { type: 'redis', key: 'host', value: cfg.host },\n    { type: 'redis', key: 'port', value: cfg.port },\n    { type: 'redis', key: 'password', value: cfg.password, isSecret: true },\n    { type: 'redis', key: 'auth', value: Boolean(cfg.password) },\n  ])\n  process.env.REDIS_DB_HOST = cfg.host\n  process.env.REDIS_DB_PORT = String(cfg.port)\n  process.env.REDIS_DB_PASSWORD = cfg.password\n  process.env.REDIS_DB_NEED_AUTH = String(Boolean(cfg.password))\n}\n\nasync function testMongoConnection(payload: MongoConfigPayload) {\n  const client = await MongoClient.connect(payload.uri, {\n    useUnifiedTopology: true,\n    useNewUrlParser: true,\n  } as any)\n  await client.db().command({ ping: 1 })\n  await client.close()\n}\n\nasync function persistMongoConfig(payload: MongoConfigPayload) {\n  const cfg = parseMongoUri(payload.uri)\n  await saveConfigEntries([\n    { type: 'mongo', key: 'host', value: cfg.host },\n    { type: 'mongo', key: 'port', value: cfg.port },\n    { type: 'mongo', key: 'database', value: cfg.database },\n    { type: 'mongo', key: 'user', value: cfg.user },\n    { type: 'mongo', key: 'password', value: cfg.password, isSecret: Boolean(cfg.password) },\n    { type: 'mongo', key: 'auth', value: cfg.auth },\n    {\n      type: 'mongo',\n      key: 'uri',\n      value: cfg.uri,\n      isSecret: Boolean(cfg.password),\n    },\n  ])\n  process.env.MONGO_DB_HOST = cfg.host\n  process.env.MONGO_DB_PORT = String(cfg.port)\n  process.env.MONGO_DB_NAME = cfg.database\n  process.env.MONGO_DB_USER = cfg.user\n  process.env.MONGO_DB_PWD = cfg.password\n  process.env.MONGO_DB_NEED_AUTH = String(cfg.auth)\n  await refreshMongoDb()\n}\n\n@RouterController('config', { userPower: USER_POWER.SYSTEM, needLogin: true })\nexport default class UserController {\n  @Inject(TokenService)\n  private tokenService: TokenService\n\n  @Get('service/overview')\n  async getServiceStatus() {\n    const data = await Promise.all([\n      getQiniuStatus(),\n      getRedisStatus(),\n      getMysqlStatus(),\n      getMongoDBStatus(),\n    ])\n\n    const result = data.reduce((pre, cur) => {\n      const { type, ...rest } = cur\n      pre[type] = rest\n      return pre\n    }, {})\n    return result\n  }\n\n  @Post('init/mysql/test')\n  async testMysql(@ReqBody() payload: MysqlInitPayload) {\n    await testMysqlConnection(payload)\n  }\n\n  @Post('init/mysql')\n  async initializeMysql(@ReqBody() payload: MysqlInitPayload) {\n    await testMysqlConnection(payload)\n    await ensureMysqlSchema(payload)\n    await persistMysqlConfig(payload)\n  }\n\n  @Post('init/redis/test')\n  async testRedis(@ReqBody() payload: RedisConfigPayload) {\n    await testRedisConnection(payload)\n  }\n\n  @Post('init/redis')\n  async initializeRedis(@ReqBody() payload: RedisConfigPayload) {\n    await testRedisConnection(payload)\n    await persistRedisConfig(payload)\n  }\n\n  @Post('init/mongo/test')\n  async testMongo(@ReqBody() payload: MongoConfigPayload) {\n    await testMongoConnection(payload)\n  }\n\n  @Post('init/mongo')\n  async initializeMongo(@ReqBody() payload: MongoConfigPayload) {\n    await testMongoConnection(payload)\n    await persistMongoConfig(payload)\n  }\n\n  cleanUserConfig(cfg: UserConfig[]) {\n    return cfg.map((v) => {\n      const { key, isSecret, value, type } = v\n      return {\n        key,\n        value: isSecret ? '******' : value,\n        type,\n        label: UserConfigLabels[type][key],\n      }\n    })\n  }\n\n  @Get('service/config')\n  async getUserConfig() {\n    const mysql = this.cleanUserConfig(\n      LocalUserDB.findUserConfig({\n        type: 'mysql',\n      }),\n    )\n\n    const qiniu = this.cleanUserConfig(\n      LocalUserDB.findUserConfig({\n        type: 'qiniu',\n      }),\n    )\n\n    const mongo = this.cleanUserConfig(\n      LocalUserDB.findUserConfig({\n        type: 'mongo',\n      }),\n    )\n\n    return [\n      { title: 'MySQL', data: mysql },\n      { title: 'MongoDB', data: mongo },\n      { title: '', data: qiniu },\n    ]\n  }\n\n  @Post('init/admin')\n  async configureAdmin(@ReqBody() body: AdminPayload) {\n    const { username, email, password } = body\n    if (!username) {\n      throw UserError.account.fault\n    }\n    if (!rEmail.test(email)) {\n      throw UserError.email.fault\n    }\n    if (!password) {\n      throw UserError.pwd.fault\n    }\n    let admin = (await selectUserByAccount(username))[0]\n    if (!admin) {\n      admin = (await selectUserByEmail(email))[0]\n    }\n    const passwordHash = encryption(password)\n    if (admin) {\n      await updateUser(\n        {\n          account: username,\n          email,\n          password: passwordHash,\n          power: USER_POWER.SUPER,\n          status: USER_STATUS.NORMAL,\n        },\n        {\n          id: admin.id,\n        },\n      )\n      return\n    }\n    await insertUser({\n      account: username,\n      email,\n      password: passwordHash,\n      power: USER_POWER.SUPER,\n      status: USER_STATUS.NORMAL,\n      loginCount: 0,\n    })\n  }\n\n  @Post('init/admin/verification')\n  async sendAdminVerification(@ReqBody('email') email: string) {\n    if (!rEmail.test(email)) {\n      throw UserError.email.fault\n    }\n    const code = randomNumStr(4)\n    await sendMail({\n      to: email,\n      subject: 'EasyPicker ',\n      html: `<p> EasyPicker <strong>${code}</strong> 2 </p>`,\n    })\n    this.tokenService.setVerifyCode(email, code, 60 * 2)\n    return {\n      message: ` ${email}`,\n    }\n  }\n\n  @Post('init/finish')\n  async finishInitialization(@ReqBody() body: FinishInitPayload) {\n    const { email, mysql, admin } = body\n    if (!rEmail.test(email)) {\n      throw UserError.email.fault\n    }\n    const cfg = getMailConfig()\n    const html = `\n      <h2></h2>\n      <p></p>\n\n      <h3></h3>\n      <p>${admin.username}</p>\n      <p>${admin.password}</p>\n      <p>${admin.email}</p>\n\n      <hr />\n\n      <h3></h3>\n      <p>${mysql.host}:${mysql.port}</p>\n      <p>${mysql.database}</p>\n      <p>${mysql.username}</p>\n    `\n    await sendMail({\n      to: email,\n      subject: cfg.subject || '',\n      html,\n    })\n    return {\n      status: 'ok',\n    }\n  }\n\n  @Post('init/mail')\n  async configureMail(@ReqBody() body: MailConfigPayload) {\n    if (!body.smtpHost || !body.account || !body.password) {\n      throw UserError.account.fault\n    }\n    await saveConfigEntries([\n      { type: 'mail', key: 'smtpHost', value: body.smtpHost },\n      { type: 'mail', key: 'smtpPort', value: body.smtpPort },\n      { type: 'mail', key: 'useSSL', value: body.useSSL },\n      { type: 'mail', key: 'account', value: body.account },\n      { type: 'mail', key: 'password', value: body.password, isSecret: true },\n      { type: 'mail', key: 'from', value: body.from || body.account },\n      { type: 'mail', key: 'senderName', value: body.senderName || '' },\n      { type: 'mail', key: 'subject', value: body.subject || 'EasyPicker ' },\n      { type: 'mail', key: 'template', value: body.template || '' },\n    ])\n    resetMailTransporter()\n  }\n\n  @Post('init/mail/test')\n  async sendMailTest(@ReqBody() body: MailTestPayload) {\n    if (!rEmail.test(body.target)) {\n      throw UserError.email.fault\n    }\n    const cfg = getMailConfig()\n    await sendMail({\n      to: body.target,\n      subject: cfg.subject || 'EasyPicker ',\n      html: cfg.template\n        || '<p> SMTP </p>',\n    })\n  }\n\n  @Post('init/mail/test/live')\n  async sendMailLiveTest(@ReqBody() body: MailLiveTestPayload) {\n    const {\n      smtpHost,\n      smtpPort,\n      useSSL,\n      account,\n      password,\n      from,\n      senderName,\n      subject,\n      template,\n      target,\n    } = body\n    if (!smtpHost || !account || !password) {\n      throw UserError.account.fault\n    }\n    if (!rEmail.test(target)) {\n      throw UserError.email.fault\n    }\n    const mailConfig: MailConfig = {\n      smtpHost,\n      smtpPort,\n      useSSL,\n      account,\n      password,\n      from: from || account,\n      senderName,\n      subject,\n      template,\n    }\n    await sendMail({\n      to: target,\n      subject: subject || 'EasyPicker ',\n      html: template\n        || '<p> SMTP </p>',\n    }, mailConfig)\n  }\n\n  @Put('service/config')\n  async updateUserConfig(@ReqBody() data: Partial<UserConfig>) {\n    const wrapperValue = (key: string, v: any) => {\n      const num = ['port']\n      const bool = ['auth']\n      const boolString = ['imageCoverStyle', 'imagePreviewStyle']\n      if (num.includes(key)) {\n        return +v\n      }\n      if (bool.includes(key)) {\n        return String(true) === v\n      }\n      if (boolString.includes(key)) {\n        return String(false) === v ? '' : v\n      }\n      return v\n    }\n    await LocalUserDB.updateUserConfig(\n      {\n        type: data.type,\n        key: data.key,\n      },\n      {\n        value: wrapperValue(data.key, data.value),\n      },\n    )\n    if (data.type === 'mysql') {\n      await refreshPool()\n      try {\n        await initTypeORM()\n        await patchTable()\n      }\n      catch (error) {\n        // empty\n      }\n    }\n    if (data.type === 'qiniu') {\n      await refreshQinNiuConfig()\n    }\n    if (data.type === 'mongo') {\n      await refreshMongoDb()\n    }\n    await LocalUserDB.updateLocalEnv()\n  }\n\n  @Get('global', { needLogin: false, userPower: null })\n  async getGlobalConfig(@ReqQuery('type') key = 'site') {\n    const globalConfig = LocalUserDB.findUserConfig({\n      type: 'global',\n      key,\n    })\n    const siteConfig\n      = globalConfig[0]?.value\n      || (key === 'site' ? LocalUserDB.getSiteConfig() : {})\n      || {}\n    const filterKey: (keyof GlobalSiteConfig)[] = ['maxInputLength', 'openPraise', 'formLength', 'compressSizeLimit', 'needBindEmail', 'limitSpace', 'limitWallet', 'moneyStartDay', 'appName']\n    return filterKey.reduce((pre, cur) => {\n      pre[cur] = siteConfig[cur]\n      return pre\n    }, {})\n  }\n\n  @Get('global/all', { userPower: USER_POWER.SUPER })\n  async getAllGlobalConfig(@ReqQuery('type') key = 'site') {\n    const globalConfig = LocalUserDB.findUserConfig({\n      type: 'global',\n      key,\n    })\n    return globalConfig[0]?.value || (key === 'site' ? LocalUserDB.getSiteConfig() : {})\n  }\n\n  @Put('global', { userPower: USER_POWER.SUPER })\n  async updateGlobalConfig(@ReqBody() data) {\n    const { key, value } = data\n    await LocalUserDB.updateUserConfig(\n      {\n        type: 'global',\n        key,\n      },\n      {\n        value,\n      },\n    )\n  }\n}\n","import { appendFile } from 'node:fs/promises'\nimport process from 'node:process'\nimport { getUniqueKey } from './stringUtil'\nimport { refreshQinNiuConfig } from './qiniuUtil'\nimport LocalUserDB from './user-local-db'\nimport type { Category } from '@/db/model/category'\nimport type { File } from '@/db/model/file'\nimport type { TaskInfo } from '@/db/model/taskInfo'\nimport type { Task } from '@/db/model/task'\nimport type { People } from '@/db/model/people'\nimport type { User } from '@/db/model/user'\nimport { query, refreshPool } from '@/lib/dbConnect/mysql'\nimport type { UserConfigType } from '@/db/model/config'\nimport {\n  mongodbConfig,\n  mysqlConfig,\n  qiniuConfig,\n  redisConfig,\n} from '@/config'\nimport { refreshMongoDb } from '@/lib/dbConnect/mongodb'\nimport { initTypeORM } from '@/db'\nimport type { GlobalSiteConfig } from '@/types'\n\ntype TableName = 'task_info' | 'category' | 'files' | 'task' | 'people' | 'user'\ninterface DBTables {\n  task_info: TaskInfo\n  category: Category\n  files: File\n  task: Task\n  people: People\n  user: User\n}\n\ninterface TableField<T extends TableName> {\n  /**\n   * \n   */\n  fieldName: keyof DBTables[T]\n  /**\n   * \n   */\n  fieldType: string\n  /**\n   * \n   */\n  defaultValue: string | number\n  /**\n   * \n   */\n  comment: string\n  /**\n   * \n   */\n  lastUpdateTime?: boolean\n}\nasync function addTableField<T extends TableName>(\n  tableName: T,\n  field: TableField<T>,\n) {\n  const cfg = LocalUserDB.getUserConfigByType('mysql')\n  const dbName = cfg.database\n\n  const { fieldName, defaultValue, comment, fieldType, lastUpdateTime = false } = field\n\n  const checkFieldCountSql\n    = 'SELECT count(*) as count FROM information_schema.COLUMNS WHERE table_name = ? AND column_name = ? AND table_schema = ?'\n  const { count } = (\n    await query(checkFieldCountSql, tableName, `${String(fieldName)}`, dbName)\n  )[0]\n  if (count === 0) {\n    console.log(` ${tableName}.${String(fieldName)}`)\n    const sql = `ALTER TABLE ${tableName} ADD COLUMN ${String(\n          fieldName,\n        )} ${fieldType} DEFAULT ${defaultValue} ${lastUpdateTime ? 'ON UPDATE CURRENT_TIMESTAMP' : ''} COMMENT '${comment}'`\n    console.log(sql)\n    console.log(await query(sql))\n  }\n}\n\nasync function modifyTableField<T extends TableName>(\n  tableName: T,\n  field: Partial<TableField<T>>,\n) {\n  const cfg = LocalUserDB.getUserConfigByType('mysql')\n  const dbName = cfg.database\n  const { fieldName, fieldType } = field\n  const checkFieldCountSql\n    = 'SELECT count(*) as count FROM information_schema.COLUMNS WHERE table_name = ? AND column_name = ? AND table_schema = ?'\n  const { count } = (\n    await query(checkFieldCountSql, tableName, `${String(fieldName)}`, dbName)\n  )[0]\n  if (count === 0) {\n    console.log('', tableName, '', fieldName, fieldType)\n    return\n  }\n\n  const getColumnTypeSql\n    = 'SELECT * FROM information_schema.COLUMNS WHERE table_name = ? AND column_name = ? AND table_schema = ?'\n  const { COLUMN_TYPE: originType } = (\n    await query(getColumnTypeSql, tableName, `${String(fieldName)}`, dbName)\n  )[0]\n\n  if (originType !== fieldType) {\n    // TODO\n    if (fieldType === 'bigint' && originType.includes(fieldType)) {\n      return\n    }\n    console.log(` ${tableName}.${String(fieldName)}`)\n    console.log(\n      `ALTER TABLE ${tableName} MODIFY ${String(fieldName)} ${fieldType}`,\n    )\n    console.log(\n      await query(\n        `ALTER TABLE ${tableName} MODIFY ${String(fieldName)} ${fieldType}`,\n      ),\n    )\n  }\n}\n\nexport async function patchTable() {\n  const TenK = Math.round(1024 * 10)\n  await addTableField('task_info', {\n    fieldName: 'tip',\n    fieldType: 'text',\n    comment: '',\n    defaultValue: '',\n  })\n\n  await addTableField('files', {\n    fieldName: 'origin_name',\n    fieldType: 'varchar(1024)',\n    comment: '',\n    defaultValue: '',\n  })\n\n  await addTableField('task', {\n    fieldName: 'del',\n    fieldType: 'tinyint',\n    comment: '',\n    defaultValue: 0,\n  })\n\n  await addTableField('files', {\n    fieldName: 'del',\n    fieldType: 'tinyint',\n    comment: '',\n    defaultValue: 0,\n  })\n\n  await modifyTableField('task_info', {\n    fieldName: 'info',\n    fieldType: `varchar(${TenK})`,\n  })\n\n  await modifyTableField('files', {\n    fieldName: 'info',\n    fieldType: `varchar(${TenK})`,\n  })\n\n  await modifyTableField('task_info', {\n    fieldName: 'tip',\n    fieldType: 'text',\n  })\n\n  await modifyTableField('files', {\n    fieldName: 'size',\n    fieldType: 'bigint',\n  })\n\n  await addTableField('task_info', {\n    fieldName: 'bind_field',\n    fieldType: 'varchar(255)',\n    defaultValue: '\\'\\'',\n    comment: '',\n  })\n\n  await addTableField('user', {\n    fieldName: 'size',\n    fieldType: 'int',\n    defaultValue: 2,\n    comment: '',\n  })\n  await addTableField('user', {\n    fieldName: 'wallet',\n    fieldType: 'decimal(10,2)',\n    defaultValue: 2,\n    comment: '',\n  })\n\n  await addTableField('files', {\n    fieldName: 'oss_del_time',\n    fieldType: 'timestamp',\n    defaultValue: null,\n    comment: 'OSS',\n  })\n  await addTableField('files', {\n    fieldName: 'del_time',\n    fieldType: 'timestamp',\n    defaultValue: null,\n    comment: '',\n  })\n  await addTableField('files', {\n    fieldName: 'last_update_time',\n    fieldType: 'timestamp',\n    defaultValue: 'CURRENT_TIMESTAMP',\n    comment: '',\n    lastUpdateTime: true,\n  })\n}\n\nfunction getRandomUser() {\n  const key = getUniqueKey()\n  return `ep${key.slice(18, key.length)}`\n}\n\nfunction getRandomPassword() {\n  const key = getUniqueKey()\n  return key.slice(10, 18)\n}\n\nexport async function initUserConfig() {\n  // 1\n  let userAccount = LocalUserDB.findUserConfig({\n    type: 'server',\n    key: 'USER',\n  })?.[0]?.value\n  let userPWD = LocalUserDB.findUserConfig({ type: 'server', key: 'PWD' })?.[0]\n    ?.value\n  if (!userAccount || !userPWD) {\n    userAccount = getRandomUser()\n    userPWD = getRandomPassword()\n    LocalUserDB.addUserConfigData({\n      type: 'server',\n      key: 'USER',\n      value: userAccount,\n      isSecret: true,\n    })\n    LocalUserDB.addUserConfigData({\n      type: 'server',\n      key: 'PWD',\n      value: userPWD,\n      isSecret: true,\n    })\n  }\n  // \n  console.log('!!! !!! ', ':', userAccount, ':', userPWD)\n  console.log('!!! !!! ', ':', userAccount, ':', userPWD)\n  console.log('!!! !!! ', ':', userAccount, ':', userPWD)\n\n  const storeDbInfo = (type: UserConfigType, config: Record<string, any>) => {\n    const configList = LocalUserDB.findUserConfig({ type }) || []\n    Object.keys(config).forEach((key) => {\n      if (!configList.some(item => item.key === key)) {\n        // \n        console.log(`[LocalUserDB]  ${type}.${key}=${config[key]}`)\n        LocalUserDB.addUserConfigData({\n          type,\n          key,\n          value: config[key],\n          isSecret: ['password', 'secretKey'].includes(key),\n        })\n      }\n\n      if (config[key] instanceof Object) {\n        const oldConfig: any = configList.find(\n          item => item.key === key,\n        )?.value\n        // key\n        if (Object.keys(config[key]).some(k => oldConfig?.[k] === undefined)) {\n          const newValue = {\n            ...config[key],\n            ...oldConfig,\n          }\n          console.log(\n            `[LocalUserDB]  ${type}.${key}=${JSON.stringify(newValue)}`,\n          )\n          LocalUserDB.updateUserConfig(\n            {\n              type,\n              key,\n            },\n            {\n              value: newValue,\n            },\n          )\n        }\n      }\n    })\n  }\n  storeDbInfo('mysql', mysqlConfig)\n  storeDbInfo('mongo', mongodbConfig)\n  storeDbInfo('redis', redisConfig)\n  storeDbInfo('qiniu', qiniuConfig)\n  storeDbInfo('global', {\n    site: {\n      maxInputLength: 20, // \n      openPraise: false, // \n      formLength: 10, // \n      downloadOneExpired: 1, // min\n      downloadCompressExpired: 60, // min\n      compressSizeLimit: 10, // TODO: GB\n      needBindEmail: false, // \n      limitSpace: false, // \n      limitWallet: false, // \n      qiniuOSSPrice: 0.099, // \n      qiniuCDNPrice: 0.28, // CDN\n      qiniuBackhaulTrafficPrice: 0.15, // \n      qiniuBackhaulTrafficPercentage: 0.8, // \n      qiniuCompressPrice: 0.05, // \n      moneyStartDay: +new Date('2024-06-01'), // \n      appName: '', // \n    } as GlobalSiteConfig,\n  })\n  // \n  await LocalUserDB.updateCfg()\n  // \n  await LocalUserDB.updateLocalEnv()\n}\n\n/**\n *  user-config \n */\nexport function readyServerDepService() {\n  // TODO: \n  return Promise.all([\n    initTokenUtil(),\n    // 1. MySQL\n    initTypeORM(),\n    refreshPool(),\n    // 2. qiniu\n    refreshQinNiuConfig(),\n    // 4 mongodb\n    refreshMongoDb(),\n  ])\n\n  // \n  // 3. redis\n}\n\nexport function initTokenUtil() {\n  if (!process.env.TOKEN_PREFIX) {\n    // \n    const prefix = Math.random().toString(36).slice(2, 8)\n    process.env.TOKEN_PREFIX = `ep-token-${prefix}`\n    appendFile('.env.local', `\\nTOKEN_PREFIX=${process.env.TOKEN_PREFIX}`)\n  }\n}\n","import path from 'node:path'\nimport type { Context, FWRequest } from 'flash-wolves'\nimport { InjectCtx, Post, ReqBody, RouterController } from 'flash-wolves'\nimport type { FilterQuery } from 'mongodb'\nimport {\n  findActionCount,\n  findActionWithPageOffset,\n  updateAction,\n} from '@/db/actionDb'\nimport type {\n  Action,\n  DownloadAction,\n  DownloadActionData,\n} from '@/db/model/action'\nimport {\n  ActionType,\n  DownloadStatus,\n} from '@/db/model/action'\nimport {\n  checkLocalCompressStatus,\n  getCompressedFileInfo,\n} from '@/utils/localFileUtil'\nimport LocalFileService from '@/service/localFileService'\nimport { shortLink } from '@/utils/stringUtil'\nimport { Inject } from 'flash-wolves'\n\n@RouterController('action', {\n  needLogin: true,\n})\nexport default class ActionController {\n  @InjectCtx()\n  ctx!: Context\n\n  @Inject(LocalFileService)\n  private localFileService: LocalFileService\n\n  @Post('download/list')\n  async getDownloadActionList(\n    @ReqBody('pageSize') size: number,\n    @ReqBody('pageIndex') index: number,\n    @ReqBody('extraIds') ids: string[],\n  ) {\n    const pageIndex = +(index ?? 1)\n    const extraIds = ids ?? []\n    const pageSize = Math.max(+(size ?? 3), extraIds.length)\n    const user = this.ctx.req.userInfo\n    const query: FilterQuery<Action> = {\n      $or: [\n        ...extraIds.map(e => ({ id: e })),\n        { type: ActionType.Download },\n        { type: ActionType.Compress },\n      ],\n      userId: user.id,\n    }\n    const count = await findActionCount(query)\n    const actions: DownloadAction[] = await findActionWithPageOffset(\n      (pageIndex - 1) * pageSize,\n      pageSize,\n      query,\n    )\n    // \n    const now = Date.now()\n    const expiredHours = 12\n    const oneHour = 1000 * 60 * 60\n    for (const action of actions) {\n      let needUpdate = false\n      // \n      if (action.data.status === DownloadStatus.SUCCESS) {\n        const pass = Math.floor((now - +action.date) / oneHour)\n        if (action.data.expiredTime && now > action.data.expiredTime) {\n          action.data.status = DownloadStatus.EXPIRED\n          needUpdate = true\n        }\n        else if (pass >= expiredHours) {\n          action.data.status = DownloadStatus.EXPIRED\n          needUpdate = true\n        }\n      }\n\n      // \n      if (action.data.status === DownloadStatus.ARCHIVE) {\n        console.log(', archiveKey:', action.data.archiveKey)\n        const data = checkLocalCompressStatus(action.data.archiveKey || '')\n        console.log(':', data)\n        if (data.error) {\n          console.error(':', data.error)\n          action.data.status = DownloadStatus.FAIL\n          action.data.error = data.error\n          needUpdate = true\n        }\n        if (data.code === 0 && data.key) {\n          console.log(', ')\n          // \n          const fileInfo = getCompressedFileInfo(data.key)\n          console.log(':', fileInfo)\n          if (fileInfo) {\n            action.data.status = DownloadStatus.SUCCESS\n            // 12\n            const expiredTime = Math.floor(Date.now() / 1000) + 3600 * 12\n\n            //  key  token\n            //  / \n            const origin = this.ctx.req.headers.origin || this.ctx.req.headers.referer || 'http://localhost:3000'\n            const baseUrl = new URL(origin).origin\n            const encodedKey = encodeURIComponent(data.key)\n            //  /api  /file/compress /api/file/compress\n            action.data.originUrl = `${baseUrl}/file/compress?key=${encodedKey}`\n            console.log(':', action.data.originUrl)\n            // @ts-expect-error\n            action.data.url = shortLink(action._id, this.ctx.req)\n            action.data.size = fileInfo.fsize\n            action.data.expiredTime = expiredTime * 1000\n            const filename = path.parse(fileInfo.key).name\n            action.data.name = filename\n            action.data.account = user.account\n            action.data.mimeType = fileInfo.mimeType\n            // \n            // \n            needUpdate = true\n            console.log(' SUCCESS')\n          }\n          else {\n            console.error(', key:', data.key)\n            action.data.status = DownloadStatus.FAIL\n            action.data.error = ''\n            needUpdate = true\n          }\n        }\n      }\n      // \n      if (needUpdate) {\n        updateAction<DownloadActionData>(\n          { id: action.id },\n          {\n            $set: {\n              data: {\n                ...action.data,\n              },\n            },\n          },\n        )\n      }\n    }\n\n    // \n    return {\n      sum: count,\n      pageIndex: index,\n      pageSize: size,\n      actions: actions.map(v => ({\n        id: v.id,\n        type: v.type,\n        status: v.data.status,\n        url: v.data.url,\n        tip: v.data.tip,\n        date: +v.date,\n        size: v.data.size,\n        error: v.data.error,\n      })),\n    }\n  }\n}\n","import type {\n  Context,\n} from 'flash-wolves'\nimport {\n  Delete,\n  Get,\n  Inject,\n  InjectCtx,\n  Post,\n  Put,\n  ReqBody,\n  ReqParams,\n  RouterController,\n} from 'flash-wolves'\nimport { BehaviorService, FileService, TaskService } from '@/service'\nimport { Task } from '@/db/entity'\nimport { wrapperCatchError } from '@/utils/context'\nimport { UserRepository } from '@/db/userDb'\nimport { calculateSize } from '@/utils/userUtil'\nimport { USER_POWER } from '@/db/model/user'\nimport { formatSize } from '@/utils/stringUtil'\nimport LocalUserDB from '@/utils/user-local-db'\n\nconst needLogin = {\n  needLogin: true,\n}\n@RouterController('task', needLogin)\nexport default class TaskController {\n  @InjectCtx()\n  private Ctx: Context\n\n  @Inject(TaskService)\n  private taskService: TaskService\n\n  @Inject(BehaviorService)\n  private behaviorService: BehaviorService\n\n  @Inject(UserRepository)\n  private userRepository: UserRepository\n\n  @Inject(FileService)\n  private fileService: FileService\n\n  /**\n   * \n   */\n  @Post('create')\n  async createTask(@ReqBody() payload) {\n    const { name, category } = payload\n    const { id, account: logAccount } = this.Ctx.req.userInfo\n    const task = new Task()\n    task.name = name\n    task.categoryKey = category || ''\n    task.userId = id\n\n    await this.taskService.createTask(task)\n    this.behaviorService.add(\n      'task',\n      ` :${logAccount} :${name} `,\n      {\n        account: logAccount,\n        name,\n      },\n    )\n  }\n\n  @Get('')\n  async getTasks() {\n    const { id, account } = this.Ctx.req.userInfo\n    return this.taskService.getTasks(id, account)\n  }\n\n  @Get('/:key', { needLogin: false })\n  async getTaskByKey(@ReqParams('key') key: string) {\n    try {\n      const data = await this.taskService.getTaskByKey(key)\n      const user = await this.userRepository.findOne({\n        id: data.userId,\n      })\n\n      // user.size = 0\n      // user.power = USER_POWER.NORMAL\n      const userOverview = await this.fileService.getUserOverview(user)\n      const { maxSize, usage, limitUpload, wallet, cost, limitSpace, limitWallet } = userOverview\n      if (limitSpace) {\n        this.behaviorService.add('user', ` ${user.account} `, {\n          space: formatSize(maxSize),\n          usage: formatSize(usage),\n        })\n      }\n      if (limitWallet) {\n        this.behaviorService.add('user', ` ${user.account} `, {\n          wallet,\n          cost,\n        })\n      }\n      return {\n        ...data,\n        limitUpload,\n      }\n    }\n    catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Delete('/:key')\n  delTask(@ReqParams('key') key: string) {\n    return this.taskService.delTask(key)\n  }\n\n  @Put('/:key')\n  updateTask(@ReqParams('key') key: string, @ReqBody() payload) {\n    return this.taskService.updateTask(key, payload)\n  }\n}\n","import {\n  Context,\n  Delete,\n  Get,\n  Inject,\n  InjectCtx,\n  Post,\n  ReqBody,\n  ReqParams,\n  RouterController\n} from 'flash-wolves'\nimport { CategoryService } from '@/service'\nimport { wrapperCatchError } from '@/utils/context'\n\n@RouterController('category', { needLogin: true })\nexport default class CategoryController {\n  @InjectCtx()\n  private ctx: Context\n\n  @Inject(CategoryService)\n  private categoryService: CategoryService\n\n  @Post('/create')\n  async createCategory(@ReqBody('name') name: string) {\n    try {\n      await this.categoryService.createCategory(name)\n    } catch (error) {\n      return wrapperCatchError(error)\n    }\n  }\n\n  @Get('')\n  getList() {\n    return this.categoryService.getList()\n  }\n\n  @Delete('/:key')\n  deleteCategory(@ReqParams('key') key: string) {\n    return this.categoryService.deleteCategory(key)\n  }\n}\n","import Wish from './wish'\nimport Overview from './super/overview'\nimport People from './people'\nimport file from './file'\nimport TaskInfo from './taskInfo'\nimport Public from './public'\nimport SuperUser from './super/user'\nimport User from './user'\nimport ConfigService from './config'\nimport Action from './action'\nimport Task from './task'\nimport Category from './category'\n\nexport default [\n  Wish,\n  Overview,\n  People,\n  file,\n  TaskInfo,\n  Public,\n  SuperUser,\n  User,\n  ConfigService,\n  Action,\n  Task,\n  Category\n]\n","import { Middleware } from 'flash-wolves'\nimport { publicError } from '@/constants/errorMsg'\nimport { addBehavior } from '@/db/logDb'\nimport { USER_POWER } from '@/db/model/user'\nimport { getUserInfo } from '@/utils/userUtil'\nimport tokenUtil from '@/utils/tokenUtil'\n\nconst systemWhiteList = ['/user/logout', '/user/power/super']\n\nconst interceptor: Middleware = async (req, res) => {\n  // \n  if ((req as any)._handled) {\n    return\n  }\n  \n  // \n  if (!req.route) {\n    return\n  }\n  \n  const { meta } = req.route\n  if (!meta || Object.keys(meta).length === 0) return\n  const { needLogin, userPower, CORS } = meta\n  if (CORS) {\n    res.setHeader('Access-Control-Allow-Origin', '*')\n    res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS')\n    res.setHeader('Access-Control-Allow-Headers', '*')\n    res.setHeader('Access-Control-Allow-Credentials', 'true')\n  }\n\n  const loginUserInfo = await getUserInfo(req)\n  if (\n    needLogin &&\n    (!req.headers.token ||\n      ![USER_POWER.SUPER, USER_POWER.SYSTEM, USER_POWER.NORMAL].includes(\n        loginUserInfo?.power\n      ))\n  ) {\n    addBehavior(req, {\n      module: 'interceptor',\n      msg: `, path:${req.url}`,\n      data: {\n        url: req.url\n      }\n    })\n    res.failWithError(publicError.request.notLogin)\n    return\n  }\n\n  // \n  if ([USER_POWER.SUPER, USER_POWER.SYSTEM].includes(userPower)) {\n    if (loginUserInfo?.power !== userPower) {\n      addBehavior(req, {\n        module: 'interceptor',\n        msg: `, path:${req.url} `,\n        data: {\n          url: req.url\n        }\n      })\n      res.failWithError(publicError.request.notLogin)\n      return\n    }\n  }\n\n  if (needLogin) {\n    // \n    if (\n      loginUserInfo?.power === USER_POWER.SYSTEM &&\n      userPower !== USER_POWER.SYSTEM &&\n      // \n      !systemWhiteList.includes(req.url)\n    ) {\n      addBehavior(req, {\n        module: 'interceptor',\n        msg: `, path:${req.url} `,\n        data: {\n          url: req.url\n        }\n      })\n      res.failWithError(publicError.request.notLogin)\n      return\n    }\n\n    // \n    if (!loginUserInfo) {\n      res.failWithError(publicError.request.notLogin)\n      return\n    }\n    // \n    req.userInfo = loginUserInfo\n\n    if (loginUserInfo?.power !== USER_POWER.SYSTEM) {\n      // Check\n      tokenUtil.checkOnlineUser(\n        loginUserInfo.account,\n        loginUserInfo,\n        req.headers.token as string\n      )\n    }\n  }\n}\nexport default interceptor\n","import { Middleware } from 'flash-wolves'\nimport formidable from 'formidable'\nimport { existsSync, mkdirSync } from 'fs'\nimport { uploadFileDir } from '@/constants'\nimport { getClientIp } from '@/db/logDb'\nimport { getUserInfo } from '@/utils/userUtil'\nimport { ObjectID } from 'mongodb'\nimport { findAction } from '@/db/actionDb'\nimport type { DownloadActionData } from '@/db/model/action'\nimport { verifyDownloadToken, keyToLocalPath } from '@/utils/localFileUtil'\nimport fs from 'node:fs'\nimport path from 'node:path'\n\n// \nconst allowOrigins = [\n  'http://localhost:8080',\n  'https://ep2.sugarat.top',\n  'https://ep2.dev.sugarat.top'\n]\n\nif (!existsSync(uploadFileDir)) {\n  mkdirSync(uploadFileDir)\n}\n\nconst interceptor: Middleware = async (req, res) => {\n  // CORS\n  const { method } = req\n  req.startTime = Date.now()\n  \n  // \n  if (req.url?.includes('/file/download/')) {\n    console.log('===  ===')\n    console.log('URL:', req.url)\n    console.log('Method:', method)\n  }\n  \n  if (allowOrigins.includes(req.headers.origin)) {\n    // \n  }\n  \n  //  Content-Type\n  if (req.url?.includes('/file/upload') || req.url?.includes('/file/download/')) {\n    //  Content-Type\n  } else {\n    // \n    res.setHeader('Content-Type', 'application/json;charset=utf-8')\n  }\n  // \n  if (method === 'OPTIONS') {\n    res.statusCode = 204\n    res.setHeader('Access-Control-Allow-Origin', '*')\n    res.setHeader('Access-Control-Allow-Methods', 'GET,POST,PUT,DELETE,OPTIONS')\n    res.setHeader('Access-Control-Allow-Headers', '*')\n    res.setHeader('Access-Control-Allow-Credentials', 'true')\n    res.end()\n    return\n  }\n\n  // \n\n  //  - \n  if (req.url === '/file/upload' && method === 'POST') {\n    console.log('===  ===')\n    const { filesTempDir } = await import('@/constants')\n    const form = formidable({\n      multiples: false,\n      keepExtensions: true,\n      maxFileSize: 1024 * 1024 * 1024 * 5, // 5GB\n      uploadDir: filesTempDir,\n    })\n\n    const p = new Promise((resolve, reject) => {\n      form.parse(req, async (err, fields, files) => {\n        if (err) {\n          console.error(':', err)\n          res.writeHead(500, { 'Content-Type': 'application/json' })\n          res.end(JSON.stringify({ code: 500, msg: `: ${err.message}` }))\n          reject(err)\n          return\n        }\n\n        const file = Array.isArray(files.file) ? files.file[0] : files.file\n        if (!file) {\n          console.error(', files:', files)\n          res.writeHead(400, { 'Content-Type': 'application/json' })\n          res.end(JSON.stringify({ code: 400, msg: '' }))\n          reject(new Error(''))\n          return\n        }\n\n        try {\n          const key = Array.isArray(fields.key) ? fields.key[0] : fields.key\n          if (!key || typeof key !== 'string') {\n            console.error(' key , fields:', fields)\n            res.writeHead(400, { 'Content-Type': 'application/json' })\n            res.end(JSON.stringify({ code: 400, msg: ' key ' }))\n            reject(new Error(' key '))\n            return\n          }\n\n          console.log(', key:', key, 'filepath:', file.filepath, 'size:', file.size)\n\n          // \n          const { keyToLocalPath, ensureDir, getFileInfo, getThumbnailPath, getPreviewPath } = await import('@/utils/localFileUtil')\n          const fs = await import('node:fs')\n          const path = await import('node:path')\n          const sharp = await import('sharp')\n          \n          const localPath = keyToLocalPath(key)\n          ensureDir(path.dirname(localPath))\n          \n          // \n          if (!fs.existsSync(file.filepath)) {\n            console.error(':', file.filepath)\n            res.writeHead(500, { 'Content-Type': 'application/json' })\n            res.end(JSON.stringify({ code: 500, msg: '' }))\n            reject(new Error(''))\n            return\n          }\n\n          // \n          fs.copyFileSync(file.filepath, localPath)\n          \n          // \n          if (!fs.existsSync(localPath)) {\n            console.error(':', localPath)\n            res.writeHead(500, { 'Content-Type': 'application/json' })\n            res.end(JSON.stringify({ code: 500, msg: '' }))\n            reject(new Error(''))\n            return\n          }\n\n          console.log(', key:', key, 'size:', fs.statSync(localPath).size)\n\n          // \n          const info = getFileInfo(localPath)\n          if (info && info.mimeType.includes('image')) {\n            try {\n              const thumbnailPath = getThumbnailPath(key)\n              ensureDir(path.dirname(thumbnailPath))\n              await sharp.default(localPath)\n                .resize(200, 200, {\n                  fit: 'cover',\n                  position: 'center',\n                })\n                .jpeg({ quality: 80 })\n                .toFile(thumbnailPath)\n\n              const previewPath = getPreviewPath(key)\n              ensureDir(path.dirname(previewPath))\n              await sharp.default(localPath)\n                .resize(1200, 1200, {\n                  fit: 'inside',\n                  withoutEnlargement: true,\n                })\n                .jpeg({ quality: 85 })\n                .toFile(previewPath)\n            }\n            catch (error) {\n              console.error(':', error)\n            }\n          }\n\n          // \n          try {\n            const fs = await import('node:fs')\n            fs.unlinkSync(file.filepath)\n          }\n          catch {\n            // \n          }\n\n          const result = {\n            code: 0,\n            data: {\n              key,\n              hash: '',\n              fsize: file.size,\n            },\n            msg: 'ok',\n          }\n          console.log(':', JSON.stringify(result))\n          res.writeHead(200, { 'Content-Type': 'application/json' })\n          res.end(JSON.stringify(result))\n          resolve(result)\n        }\n        catch (error) {\n          console.error(':', error)\n          res.writeHead(500, { 'Content-Type': 'application/json' })\n          res.end(JSON.stringify({ code: 500, msg: `: ${error}` }))\n          reject(error)\n        }\n      })\n\n      form.on('error', (err) => {\n        console.error('formidable :', err)\n        res.writeHead(500, { 'Content-Type': 'application/json' })\n        res.end(JSON.stringify({ code: 500, msg: `: ${err.message}` }))\n        reject(err)\n      })\n    })\n\n    try {\n      await p\n    }\n    catch (error) {\n      //  Promise \n    }\n    return // \n  }\n\n  // \n  // API\n  if (req.url === '/public/upload') {\n    const form = formidable({\n      multiples: true,\n      uploadDir: uploadFileDir,\n      keepExtensions: true\n    })\n    const p = new Promise((resolve, reject) => {\n      form.parse(req, (err, fields, files) => {\n        if (err) {\n          reject(err)\n        }\n        res.writeHead(200, { 'Content-Type': 'application/json' })\n        const data = {\n          name: files.file.newFilename,\n          size: files.file.size,\n          type: files.file.mimetype\n        }\n        res.end(JSON.stringify({ code: 0, data, msg: 'ok' }, null, 2))\n        resolve('ok')\n      })\n    })\n    try {\n      await p\n    } catch (error) {\n      res.end(JSON.stringify({ code: 500, msg: error }))\n    }\n  }\n\n  // ip @ReqIp \n  Object.defineProperty(req, '_ip', {\n    value: getClientIp(req)\n  })\n\n  // userInfo@ReqUserInfo\n  Object.defineProperty(req, '_userinfo', {\n    value: await getUserInfo(req)\n  })\n}\nexport default interceptor\n","import { Middleware } from 'flash-wolves'\nimport { addRequestLog } from '@/db/logDb'\n\nconst interceptor: Middleware = async (req, res) => {\n  // \n  if ((req as any)._handled) {\n    // \n    ;(req as any).route = null\n    return\n  }\n  \n  addRequestLog(req, res)\n}\nexport default interceptor\n","import { RuntimeErrorInterceptor } from 'flash-wolves'\nimport { addErrorLog } from '@/db/logDb'\n\nconst interceptor: RuntimeErrorInterceptor = async (req, res, err) => {\n  // \n  if (res.headersSent) {\n    console.log('')\n    return\n  }\n  \n  // \n  if ((req as any)._handled) {\n    return\n  }\n  \n  addErrorLog(req, err.toString(), err.stack)\n}\nexport default interceptor\n"]}